<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8" />
<title>三聯收據產生器</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* ========= 設計變數 ========= */
:root{
  --brand-500:#A1C6EA; --brand-600:#8FB9E2;
  --secondary-500:#BBD1EA; --secondary-600:#A8C5E6;
  --clear-500:#DAE3E5; --clear-600:#CFD9DC;

  --text-strong:#1f2937; --text-normal:#374151; --text-mute:#6b7280;
  --border:#d1d5db; --bg-page:#f0f2f5; --bg-card:#ffffff;

  --font-sans:"Microsoft JhengHei","微軟正黑體","Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;

  --radius-md:8px; --radius-lg:12px;
  --shadow-sm:0 1px 3px rgba(0,0,0,.08); --shadow-lg:0 4px 20px rgba(0,0,0,.12);

  --focus-ring:0 0 0 3px rgba(106,154,255,.25); --focus-border:#6a9aff;

  /* 收據 layout 變數（可由面板即時調整） */
  --cut:#555; --line:#6f757a;
  --gap-between:6mm; --gap-col:5mm; --cut-inset:3mm;
}
/* ========= 基礎 ========= */
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:var(--font-sans); background:var(--bg-page);
  margin:0; padding:0; display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
  color:var(--text-normal);
}
.container{ background:var(--bg-card); padding:2rem; margin:2rem 1rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.12); max-width:980px; width:100%;}
h1{margin:0 0 1rem 0; color:#0056b3; text-align:center; font-weight:800;}
label{font-weight:700; display:block; color:#555; margin-bottom:.5rem;}
/* ========= 表單 ========= */
.input-area{ max-width:820px; margin:0 auto 24px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.08);}
.grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
.col-3{ grid-column:span 3; } .col-6{ grid-column:span 6; } .col-12{ grid-column:span 12; }
textarea,.input-area input[type="text"],.input-area input[type="date"], .input-area select{
  width:100%; height:2.75rem; padding:0 .9rem; border-radius:8px; border:1px solid var(--border); font-size:16px; background:#fff; transition:border-color .2s, box-shadow .2s;
}
textarea{ min-height:200px; height:auto; resize:vertical; padding:.6rem; line-height:1.5; font-family:var(--font-mono); }
textarea:focus,.input-area input[type="text"]:focus,.input-area input[type="date"]:focus,.input-area select:focus{ outline:none; border-color:var(--focus-border)!important; box-shadow:0 0 0 3px rgba(106,154,255,.25); }
/* ========= 按鈕 ========= */
button{ display:inline-flex; align-items:center; justify-content:center; min-height:2.9rem; padding:0 1.25rem; font-size:17px; font-weight:700; border:none; border-radius:8px; cursor:pointer; color:#17324A; background:#A1C6EA; transition:background-color .15s ease, transform .12s ease, box-shadow .2s; box-shadow:0 1px 3px rgba(0,0,0,.08);}
button:hover{background:#8FB9E2; transform:translateY(-2px)}
button:active{transform:translateY(-1px)}
button:focus{outline:none; box-shadow:0 0 0 3px rgba(106,154,255,.25)}
.btn-secondary{ background:#BBD1EA; } .btn-secondary:hover{ background:#A8C5E6; }
.btn-clear{ background:#DAE3E5; } .btn-clear:hover{ background:#CFD9DC; }
.btn-row{ display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:.5rem; }
.btn-row > button{ width:200px; }
/* ========= 提醒框（新增） ========= */
.warn{
  display:none; /* 有內容才顯示 */
  background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12;
  border-radius:8px; padding:10px 12px; margin:10px auto 0; max-width:820px;
}
.warn b{ color:#9a3412; }
.warn ul{ margin:6px 0 0 18px; padding:0; }
.warn .close{ float:right; background:none; border:none; font-size:18px; cursor:pointer; color:#9a3412; }
/* ========= 列印區 ========= */
.print-area{ margin-top:18px; }
/* 面板 */
.tuner{ max-width:820px; margin:0 auto 14px auto; background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px 16px; box-shadow:0 1px 3px rgba(0,0,0,.08);}
.tuner h2{ margin:0 0 8px 0; font-size:16px; color:#17324A; }
.tuner .row{ display:grid; grid-template-columns:160px 1fr 70px 90px; gap:10px; align-items:center; margin:8px 0; }
.tuner label{ margin:0; color:#374151; font-weight:700; }
.tuner input[type="range"]{ width:100%; }
.tuner .val{ text-align:right; color:#111; font-variant-numeric:tabular-nums; }
.tuner .hint{ font-size:12px; color:#6b7280; margin-top:6px; }
@media print{ .tuner,.warn{ display:none !important; } }
/* 頁面/卡片 */
.page{ position:relative; background:#fff; border:1px solid var(--border); border-radius:10px; padding:8mm 4mm; margin:0 auto 12px auto; display:grid; grid-template-rows:repeat(4,1fr); row-gap:var(--gap-between); page-break-after:always;}
.page:last-child{ page-break-after:auto; }
.student-block{ position:relative; min-height:0; }
.page .student-block:not(:last-child)::after{ content:""; position:absolute; left:var(--cut-inset); right:var(--cut-inset); bottom:calc(-0.5 * var(--gap-between)); border-bottom:2px dashed var(--cut); }
.triplet-grid{ display:grid; grid-template-columns:30mm 55fr 45fr; gap:var(--gap-col); align-items:stretch; height:100%; }
.receipt{ border:1px solid var(--line); border-radius:8px; padding:7px; display:flex; flex-direction:column; gap:3px; background:#fff; position:relative; }
.receipt-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding-bottom:3px; border-bottom:1px solid var(--line);}
.title{ font-weight:800; font-size:15px; color:#17324A; }
.tag{ font-size:11px; color:#374151; background:#f0f4f8; padding:1px 6px; border-radius:999px; border:1px solid #e2e8f0; }
.meta{ font-size:12px; color:#555; display:flex; flex-wrap:wrap; gap:8px; }
.row{ display:flex; align-items:flex-start; gap:6px; margin:2px 0; line-height:1.22; }
.row label{ width:66px; font-size:12.5px; color:#555; margin:0; }
.row .val{ flex:1; font-size:15.5px; }
.money{ font-weight:800; color:#c80000; }
.note{ color:#444; white-space:pre-wrap; }

/* ===== 第三聯（存根）專屬：字體與行距變小，讓四人份穩妥塞入 A4 ===== */
.receipt[data-copy="slip"]{ padding:5px; }
.receipt[data-copy="slip"] .meta{ display:none; }
.receipt[data-copy="slip"] .row{ flex-direction:column; gap:1px; margin:1px 0; line-height:1.12; }
.receipt[data-copy="slip"] .row label{ width:auto; min-width:unset; font-size:11px; }
.receipt[data-copy="slip"] .row .val{ font-size:12px; }
.receipt[data-copy="slip"] .title{ font-size:12px; }

/* 簽名區 */
.sign-area{ display:flex; justify-content:space-between; gap:10px; margin-top:6px; border-top:1px dashed var(--line); padding-top:6px; }
.sign-box{ display:flex; align-items:center; gap:8px; flex:1; }
.sign-label{ width:auto; min-width:max-content; font-size:12.5px; color:#555; }
.sign-line{ flex:1; border-bottom:1px solid var(--line); height:26px; }
.tiny{ font-size:11px; color:#666; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
/* 垂直切線 */
.cut-v::after{ content:""; position:absolute; top:-2px; bottom:-2px; right:calc(-0.5 * var(--gap-col)); border-right:2px dashed var(--cut); }

/* ===== 列印模式 ===== */
@media print{
  html{ font-size:12pt; } body{ background:#fff; }
  .input-area, .btn-row, h1{ display:none !important; }
  .container{ box-shadow:none; margin:0; padding:0; max-width:none; }
  @page{ size:A4 portrait; margin:12mm; }

  /* 關鍵修正：避免第一頁上邊界多出空白，確保前後頁對齊 */
  .print-area{ margin-top:0 !important; }

  .page{ border:0; border-radius:0; padding:0 2mm 0 0; margin:0; display:grid; grid-template-rows:repeat(4,1fr); row-gap:var(--gap-between); }
  .triplet-grid{ gap:var(--gap-col); grid-template-columns:30mm 55fr 45fr; }
  .receipt{ padding:5px; border-color:#666; }
  .row label{ width:60px; font-size:10.5pt; }
  .row .val{ font-size:11.5pt; }
  .title{ font-size:12pt; }

  /* 第三聯（存根）在列印時再更精簡一點點字級與行距 */
  .receipt[data-copy="slip"] .row label{ font-size:9pt; }
  .receipt[data-copy="slip"] .row .val{ font-size:10pt; }
  .receipt[data-copy="slip"] .title{ font-size:10.5pt; }
}
</style>
</head>
<body>
  <div class="container">
    <h1>三聯式 代收收據產生器</h1>

    <div class="input-area">
      <div class="grid">
        <div class="col-3">
          <label>收費區間</label>
          <input type="text" id="feePeriod" placeholder="例：2025年11月" />
        </div>
        <div class="col-3">
          <label>繳費期限</label>
          <input type="date" id="deadline" />
        </div>
        <div class="col-6">
          <label>代收項目（如：11月羊奶費／11月餐費）</label>
          <input type="text" id="feeItem" placeholder="例：11月羊奶費 或 11月餐費" />
        </div>

        <div class="col-3">
          <label>資料格式</label>
          <select id="modeSelect" aria-label="資料格式">
            <option value="auto" selected>自動判斷</option>
            <option value="meal">餐費版（班級／姓名／金額／預繳金額）</option>
            <option value="milk">羊奶版（班級／姓名／訂購日期或金額／羊奶袋／口味／備註）</option>
          </select>
        </div>
        <div class="col-9">
          <label>共用備註（可留空）</label>
          <input type="text" id="globalNote" placeholder="例：請準時繳費，逾期依規定加收手續費" />
        </div>

        <div class="col-12">
          <label>貼上名單</label>
          <textarea id="pasteArea" placeholder="【餐費版】班級	姓名	金額	預繳金額
1A	王小明	1200	0
2B	林小花	1200	300

【羊奶版】班級	姓名	訂購日期或金額	羊奶袋	口味	備註
1A	馬晨皓	700	否	鮮乳	
1A	許耀文	700	是	草莓	
2B	巫采珊	700	是		原味羊奶  溫熱的
3A	Angela	2025年11月，每週一、二、四	否	可可	"></textarea>
          <div style="font-size:13px;color:#6b7280;margin-top:6px;">
            ● 建議列印：邊界選「<b>最小值</b>」、關閉頁首/頁尾。本頁以 <code>@page</code> 固定 12mm；若仍吃邊，縮放 95–97%。<br>
            ● 餐費版會自動把「金額＋預繳金額」合併顯示於金額欄；預繳為 0 則只顯示金額。
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button id="btnGenerate">生成收據</button>
        <button class="btn-secondary" id="btnPrint">列印 / PDF</button>
        <button class="btn-clear" id="btnClear">清空資料</button>
        <span id="previewCount" style="margin-left:8px;"></span>
      </div>

      <!-- 提醒框：只在需要時顯示 -->
      <div id="warnBox" class="warn" role="alert"></div>
    </div>

    <div class="tuner" id="tuner">
      <h2>印前間距控制</h2>
      <div class="row">
        <label for="gapBetween">縫距（上下 gap）</label>
        <input type="range" id="gapBetween" min="4" max="12" step="1">
        <div class="val"><span id="gapBetweenVal">6</span> mm</div>
        <button type="button" id="btnPresetLoose" class="btn-clear">鬆版 8 / 6 / 3</button>
      </div>
      <div class="row">
        <label for="gapCol">欄距（三聯間距）</label>
        <input type="range" id="gapCol" min="3" max="10" step="1">
        <div class="val"><span id="gapColVal">5</span> mm</div>
        <button type="button" id="btnPresetStd" class="btn-clear">標準 6 / 5 / 3</button>
      </div>
      <div class="row">
        <label for="cutInset">切線內縮距</label>
        <input type="range" id="cutInset" min="2" max="6" step="1">
        <div class="val"><span id="cutInsetVal">3</span> mm</div>
        <button type="button" id="btnReset" class="btn-secondary">重置為目前版</button>
      </div>
      <div class="hint">滑桿會即時更新預覽；列印時此面板不會出現在紙上。</div>
    </div>

    <div class="print-area" id="printArea" aria-live="polite"></div>
  </div>

  <!-- ===== 三聯模板 ===== -->
  <template id="tripletTemplate">
    <div class="student-block">
      <div class="triplet-grid">
        <div class="receipt cut-v" data-copy="slip">
          <div class="receipt-header"><div class="title">存根</div><div class="tag">第三聯</div></div>
          <div class="row"><label>學生姓名</label><div class="val name"></div></div>
          <div class="row"><label>班級</label><div class="val klass"></div></div>
          <div class="row"><label>代收項目</label><div class="val item"></div></div>
          <div class="row"><label>金額</label><div class="val money amount"></div></div>
          <div class="row"><label>備註</label><div class="val note"></div></div>
        </div>
        <div class="receipt cut-v" data-copy="parent">
          <div class="receipt-header"><div class="title">家長收據</div><div class="tag">第二聯</div></div>
          <div class="meta"><span class="period"></span></div>
          <div class="row"><label>學生姓名</label><div class="val name"></div></div>
          <div class="row"><label>班級</label><div class="val klass"></div></div>
          <div class="row"><label>代收項目</label><div class="val item"></div></div>
          <div class="row"><label>金額</label><div class="val money amount"></div></div>
          <div class="row"><label>備註</label><div class="val note"></div></div>
          <div class="tiny">※ 本聯為家長留存，收據請保留六個月</div>
          <div class="sign-area">
            <div class="sign-box"><div class="sign-label">經辦簽收</div><div class="sign-line"></div></div>
            <div class="sign-box"><div class="sign-label">日期</div><div class="sign-line"></div></div>
          </div>
        </div>
        <div class="receipt" data-copy="notice">
          <div class="receipt-header"><div class="title">繳費通知</div><div class="tag">第一聯</div></div>
          <div class="meta"><span class="period"></span></div>
          <div class="row"><label>學生姓名</label><div class="val name"></div></div>
          <div class="row"><label>班級</label><div class="val klass"></div></div>
          <div class="row"><label>代收項目</label><div class="val item"></div></div>
          <div class="row"><label>金額</label><div class="val money amount"></div></div>
          <div class="row"><label>備註</label><div class="val note"></div></div>
          <div class="row"><label>繳費期限</label><div class="val deadline"></div></div>
          <div class="tiny">※ 如對金額或項目有疑問，請於三日內與我們聯繫。</div>
        </div>
      </div>
    </div>
  </template>

<script>
/* ===== 小工具 ===== */
const $  = (s,c=document)=>c.querySelector(s);
const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));

function pad(n){ return String(n).padStart(2,'0'); }
function nextMonthInfo(base=new Date()){
  const y=base.getFullYear(), m=base.getMonth();
  const firstNext = new Date(y, m+1, 1);
  const periodLabel = `${firstNext.getFullYear()}年${firstNext.getMonth()+1}月`;
  let due = new Date(firstNext.getFullYear(), firstNext.getMonth(), 10);
  const day=due.getDay();
  if(day===6) due.setDate(due.getDate()+2);
  else if(day===0) due.setDate(due.getDate()+1);
  const dueStr = `${due.getFullYear()}-${pad(due.getMonth()+1)}-${pad(due.getDate())}`;
  return { periodLabel, dueStr };
}

function detectDelimiter(sample){
  const tab=(sample.match(/\t/g)||[]).length, comma=(sample.match(/,/g)||[]).length;
  return tab>=comma?'\t':',';
}

/* 金額判斷 / 轉數字 / 格式化 */
function isAmountLike(raw){
  const s = String(raw||'').trim();
  if(!s) return false;
  return /^(?:NT\$?\s*)?\$?\s*\d{1,3}(?:,\d{3})*(?:\.\d+)?(?:\s*元)?$/i.test(s)
      || /^\d+(?:\.\d+)?$/.test(s);
}
function toNumberFromAmount(v){
  if(!isAmountLike(v)) return { valid:false, num:0 };
  const n = Number(String(v).replace(/[^\d.]/g,'')) || 0;
  return { valid:true, num: n };
}
function formatAmount(v){
  const raw = String(v??'').trim();
  if(raw==='' || raw==='NaN') return '—';
  if (isAmountLike(raw)) {
    const n = Number(raw.replace(/[^\d.]/g,'')) || 0;
    return '$ ' + Math.round(n).toLocaleString('zh-Hant-TW',{maximumFractionDigits:0});
  }
  if (typeof v === 'number' && isFinite(v)) {
    return '$ ' + Math.round(v).toLocaleString('zh-Hant-TW',{maximumFractionDigits:0});
  }
  return raw;
}
function formatAmountWithBreakdown(total, fee, prepay){
  const t = Math.round(Number(total) || 0);
  const f = Math.round(Number(fee)   || 0);
  const p = Math.round(Number(prepay)|| 0);
  if (t <= 0) return '—';
  const totalStr = '$ ' + t.toLocaleString('zh-Hant-TW', { maximumFractionDigits: 0 });
  return p>0 ? `${totalStr}=餐費${f}+預收${p}` : totalStr;
}

/* 只把「是 / Y / YES」當作要袋 */
function normalizeBag(v){
  const s=String(v||'').trim();
  return /^(\u662f|Y|YES)$/i.test(s);
}

/* === 解析 ===
  mode: 'auto' | 'meal' | 'milk'
  - meal: 班級/姓名/金額(/預繳金額)
  - milk: 班級/姓名/訂購日期或金額/羊奶袋/口味/備註
*/
function parseRows(text, mode='auto'){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return [];
  const d=detectDelimiter(lines[0]);
  const split=(line)=>line.split(d).map(s=>s.trim());

  const head = split(lines[0]);
  const hasHeaderMilk = head.some(v=>/羊奶袋|口味|備註/i.test(v)) && head.some(v=>/姓名/.test(v));
  const hasHeaderMeal = head.some(v=>/金額/.test(v)) || head.some(v=>/預繳|預收/.test(v));
  const body = (hasHeaderMilk || hasHeaderMeal) ? lines.slice(1) : lines;

  let chosen = mode;
  if (mode==='auto'){
    if (hasHeaderMilk) chosen='milk';
    else if (hasHeaderMeal) chosen='meal';
    else {
      // 嘗試看第一列資料決定
      const probe = split(body[0] || '');
      const aLike = isAmountLike(probe[2]);
      const pLike = isAmountLike(probe[3]);
      chosen = (probe.length>=4 && (aLike || pLike)) ? 'meal' : 'milk';
    }
  }

  if (chosen==='meal'){
    // 班級/姓名/金額(/預繳金額)
    return body.map(line=>{
      const p=split(line);
      const klass = p[0]||'';
      const name  = p[1]||'';
      const amtRaw= p[2]||'0';
      const preRaw= p[3]||'0';
      const {valid:va, num:fee} = toNumberFromAmount(amtRaw);
      const {valid:vp, num:pre} = toNumberFromAmount(preRaw);
      return {
        klass, name,
        amountRaw: amtRaw, prepayRaw: preRaw,
        amountNum: va?fee:0, prepayNum: vp?pre:0,
        totalNum: (va?fee:0) + (vp?pre:0),
        // 兼容欄位（供共用的填充方法使用）
        bagYes:false, flavor:'', special:'', planText:''
      };
    });
  }else{
    // 羊奶六欄：第三欄可為金額或方案文字
    return body.map(line=>{
      const p=split(line);
      const klass = p[0]||'';
      const name  = p[1]||'';
      const col3  = p[2]||'';
      const {valid:va, num:fee} = toNumberFromAmount(col3);
      return {
        klass, name,
        amountRaw: va? col3 : '', prepayRaw: '0',
        amountNum: va? fee : 0, prepayNum: 0,
        totalNum:  va? fee : 0,
        bagYes: normalizeBag(p[3]),
        flavor: p[4]||'',
        special:p[5]||'',
        planText: va? '' : col3  // 若不是金額，就當成方案/日期文字
      };
    });
  }
}

/* 排序：先班級再姓名（支援漢字筆畫排序） */
function sortByClassName(rows){
  const collator=new Intl.Collator('zh-Hant-u-co-stroke',{numeric:true,sensitivity:'base'});
  return rows.sort((a,b)=>{
    const c1=collator.compare(a.klass||'～～～',b.klass||'～～～');
    return c1!==0?c1:collator.compare(a.name||'',b.name||'');
  });
}

/* 分頁：每頁 4 位 */
function chunk4(arr){ const pages=[]; for(let i=0;i<arr.length;i+=4) pages.push(arr.slice(i,i+4)); return pages; }

/* 填入三聯 */
function fillTriplet(node,data,globals){
  $$('.period',node).forEach(e=>e.textContent = globals.feePeriod?`收費區間 ${globals.feePeriod}`:'');
  $$('.name',node).forEach(e=>e.textContent  = data.name || '（未填）');
  $$('.klass',node).forEach(e=>e.textContent = data.klass || '—');
  $$('.item',node).forEach(e=>e.textContent  = globals.feeItem || '（未填）');

  // 金額：若有預繳>0 顯示分解；否則顯示單筆金額；羊奶若第三欄是文字→金額顯示 —
  (function(){
    const fee   = (typeof data.amountNum === 'number' && isFinite(data.amountNum)) ? data.amountNum : 0;
    const pre   = (typeof data.prepayNum === 'number' && isFinite(data.prepayNum)) ? data.prepayNum : 0;
    const total = (typeof data.totalNum  === 'number' && isFinite(data.totalNum )) ? data.totalNum  : (fee + pre);

    const txt = formatAmountWithBreakdown(total, fee, pre);
    $$('.amount', node).forEach(e => e.textContent = txt);
  })();

  // 備註：方案/日期（若有） + 口味 + +袋 + 特殊備註 + 全域備註
  const parts=[];
  const plan = String(data.planText||'').trim();
  if(plan) parts.push(plan);
  const flavor = String(data.flavor||'').trim();
  if(flavor) parts.push(flavor);
  if(data.bagYes) parts.push('+袋');
  const special = String(data.special||'').trim();
  if(special) parts.push(special);
  let noteStr = parts.join(' ');
  if(globals.globalNote) noteStr = noteStr ? noteStr + '；' + globals.globalNote : globals.globalNote;
  $$('.note',node).forEach(e=>e.textContent  = noteStr || '—');

  $$('.deadline',node).forEach(e=>e.textContent = globals.deadline || '—');
}

/* ===== 主流程 ===== */
const printArea = document.getElementById('printArea');
const template  = document.getElementById('tripletTemplate');

function generate(){
  const mode = document.getElementById('modeSelect').value || 'auto';
  const rows0=parseRows(document.getElementById('pasteArea').value, mode);
  printArea.innerHTML='';
  const globals={
    feePeriod: document.getElementById('feePeriod').value.trim(),
    deadline:  document.getElementById('deadline').value,
    feeItem:   document.getElementById('feeItem').value.trim(),
    globalNote:document.getElementById('globalNote').value.trim()
  };
  if(rows0.length===0){
    document.getElementById('previewCount').textContent='尚未產生任何收據，請先貼上名單。';
    const wb=document.getElementById('warnBox'); wb.style.display='none'; wb.innerHTML='';
    return;
  }
  const rows = sortByClassName(rows0);
  const pages= chunk4(rows);
  pages.forEach(group=>{
    const page=document.createElement('div'); page.className='page';
    group.forEach(r=>{
      const node=template.content.cloneNode(true);
      fillTriplet(node,r,globals);
      page.appendChild(node);
    });
    printArea.appendChild(page);
  });
  document.getElementById('previewCount').textContent=`共 ${rows.length} 位；每頁 4 位，共 ${pages.length} 頁。`;

  /* === 提醒：僅在「餐費版」模式下檢查非金額欄位 === */
  const warnBox = document.getElementById('warnBox');
  if (mode==='meal' || mode==='auto'){
    const bad = rows.filter(r=>{
      const hasAmt = String(r.amountRaw||'').trim()!=='';
      const hasPre = String(r.prepayRaw||'').trim()!=='';
      const badAmt = hasAmt && !isAmountLike(r.amountRaw);
      const badPre = hasPre && !isAmountLike(r.prepayRaw);
      return badAmt || badPre;
    });
    if (bad.length){
      alert(`⚠️ 發現 ${bad.length} 筆「金額或預繳金額不是金額格式」。\n可辨識者會納入計算，其餘視為 0。\n請檢查提醒清單。`);
      const items = bad.map(x=>{
        const amt = String(x.amountRaw||'').replace(/</g,'&lt;') || '（空白）';
        const pre = String(x.prepayRaw||'').replace(/</g,'&lt;') || '（空白）';
        const kl  = x.klass || '—';
        return `<li>${kl} - ${x.name || '（未填）'}：金額=<b>${amt}</b>；預繳=<b>${pre}</b></li>`;
      }).join('');
      warnBox.innerHTML = `
        <button class="close" aria-label="關閉" title="關閉提醒">&times;</button>
        <div><b>⚠️ 提醒：</b>共有 <b>${bad.length}</b> 筆 <b>金額/預繳</b>非金額格式；系統僅會將可辨識的數字納入合計（其餘視為 0 ）。</div>
        <ul>${items}</ul>
      `;
      warnBox.style.display='block';
      warnBox.querySelector('.close').addEventListener('click', ()=>{ warnBox.style.display='none'; });
    }else{
      warnBox.style.display='none';
      warnBox.innerHTML='';
    }
  }else{
    // 羊奶版不需要金額格式提醒（第三欄可能是方案文字）
    warnBox.style.display='none';
    warnBox.innerHTML='';
  }
}

/* 面板滑桿連動 */
function getMMVar(name){
  const cs=getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  const m = cs.match(/([\d.]+)\s*mm/i); return m? parseFloat(m[1]) : 0;
}
function setMMVar(name, num){ document.documentElement.style.setProperty(name, num+'mm'); }
function initTuner(){
  const gapBetween = document.getElementById('gapBetween');
  const gapCol     = document.getElementById('gapCol');
  const cutInset   = document.getElementById('cutInset');
  const gapBetweenVal = document.getElementById('gapBetweenVal');
  const gapColVal     = document.getElementById('gapColVal');
  const cutInsetVal   = document.getElementById('cutInsetVal');
  gapBetween.value = getMMVar('--gap-between') || 6;
  gapCol.value     = getMMVar('--gap-col') || 5;
  cutInset.value   = getMMVar('--cut-inset') || 3;
  gapBetweenVal.textContent = gapBetween.value;
  gapColVal.textContent     = gapCol.value;
  cutInsetVal.textContent   = cutInset.value;
  gapBetween.addEventListener('input', e => { gapBetweenVal.textContent = e.target.value; setMMVar('--gap-between', +e.target.value); });
  gapCol.addEventListener('input', e => { gapColVal.textContent = e.target.value; setMMVar('--gap-col', +e.target.value); });
  cutInset.addEventListener('input', e => { cutInsetVal.textContent = e.target.value; setMMVar('--cut-inset', +e.target.value); });
  document.getElementById('btnPresetLoose').addEventListener('click', ()=>{ gapBetween.value=8; gapBetween.dispatchEvent(new Event('input')); gapCol.value=6; gapCol.dispatchEvent(new Event('input')); cutInset.value=3; cutInset.dispatchEvent(new Event('input')); });
  document.getElementById('btnPresetStd').addEventListener('click',  ()=>{ gapBetween.value=6; gapBetween.dispatchEvent(new Event('input')); gapCol.value=5; gapCol.dispatchEvent(new Event('input')); cutInset.value=3; cutInset.dispatchEvent(new Event('input')); });
  document.getElementById('btnReset').addEventListener('click',     ()=>{ gapBetween.value=6; gapBetween.dispatchEvent(new Event('input')); gapCol.value=5; gapCol.dispatchEvent(new Event('input')); cutInset.value=3; cutInset.dispatchEvent(new Event('input')); });
}

/* 預設值（下個月） */
document.addEventListener('DOMContentLoaded', ()=>{
  const {periodLabel,dueStr}=nextMonthInfo(new Date());
  document.getElementById('feePeriod').value = periodLabel;
  document.getElementById('deadline').value  = dueStr;
  if (document.getElementById('pasteArea').value.trim().length > 0) generate();
  initTuner();
});

/* 事件 */
document.getElementById('btnGenerate').addEventListener('click', generate);
document.getElementById('btnPrint').addEventListener('click', ()=>{ if(!printArea.children.length) generate(); requestAnimationFrame(()=>window.print()); });
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('pasteArea').value='';
  document.getElementById('previewCount').textContent='';
  document.getElementById('warnBox').style.display='none';
  document.getElementById('warnBox').innerHTML='';
  document.getElementById('pasteArea').focus();
});
</script>
</body>
</html>
