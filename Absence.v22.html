<!DOCTYPE html>   
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>假別統計工具v22</title>
    <style>
        /*算卡:可計算剩餘年假，加入家庭照顧假*/
        /* 全局樣式 */
        body {
            font-family: "Segoe UI", "微軟正黑體", sans-serif;
            background-color:#D4DCDB;
            padding: 1.5em;
            color: #333;
        }

        label {
            margin-right: 0.5em;
        }
        h2 {
           color: #333; /* 配合全頁字體顏色 */
           border-left: 6px solid #3c82f6; /* 標題的色塊配合全頁字體顏色 */
           padding-left: 12px;
           margin-bottom: 20px;
        }
        :root {
            --w-date: 2em;
            --w-weekday: 2em;
            --w-day: 2em;
            --w-hour: 4em;
            --w-minutes: 4em;
            --w-punch: 8em;
            --w-special: 15em;
        }
        /*統一兩種統計結果的字體大小*/
        #resultsLeave,
        #vacationBreakdown {
            font-size: 16px;
            font-family: "Segoe UI", "微軟正黑體", sans-serif;
            line-height: 1.6;
        }
        /* 統一按鈕樣式 */
        .btn {
        padding: 0.5em 1.2em;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin: 0.3em;
        }
        /* 藍色按鈕 */
        .btn-blue {
            background-color: #3c82f6;
        }
        .btn-blue:hover {
            background-color: #2563eb;
        }
        /* 綠色按鈕（如：匯入） */
        .btn-green {
            background-color: #10b981;
        }
        .btn-green:hover {
            background-color: #0e9f6e;
        }
        /* 灰色按鈕（如：複製、次要操作） */
        .btn-gray {
            background-color: #6b7280;
        }
        .btn-gray:hover {
            background-color: #4b5563;
        }
        table {
            table-layout: fixed;
            width: 100%;
            max-width: 1200px;
            margin: 1.5em 0;  /* ✅ 改成上下間距 1.5em，左右不置中 */
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 0.6em;
            text-align: center;
        }
        th {
            background-color: #f0f4f8;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr.sunday {
            background-color: #ffe5e5;
        }
        tr.saturday {
            background-color: #e5f0ff;
        }
        input[type="checkbox"] {
            transform: scale(1.3);
        }
        input[type="text"] {
            width: 6em;
            padding: 0.3em;
            margin-right: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="number"] {
            width: 4em;
            padding: 0.2em;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 1em;
        }

        /* 每欄寬度設定 */
        /* 每欄寬度設定（集中管理） */
         table th:nth-child(1), table td:nth-child(1) { width: var(--w-date); }     /* 日期（如 7/12） */
         table th:nth-child(2), table td:nth-child(2) { width: var(--w-weekday); }  /* 星期（如 (日)） */

        /* 天（day）欄 */
         table th:nth-child(3), table td:nth-child(3),   /* 特休(天) */
         table th:nth-child(5), table td:nth-child(5),   /* 事假(天) */
         table th:nth-child(7), table td:nth-child(7),   /* 病假(天) */
         table th:nth-child(14), table td:nth-child(14)  /* 喪假(天) */
         { width: var(--w-day); }

        /* 時（hour）欄 */
         table th:nth-child(4), table td:nth-child(4),   /* 特休(時) */
         table th:nth-child(6), table td:nth-child(6),   /* 事假(時) */
         table th:nth-child(8), table td:nth-child(8),   /* 病假(時) */
         table th:nth-child(12), table td:nth-child(12), /* 生理假(時) */
         table th:nth-child(13), table td:nth-child(13), /* 家庭照顧假(時) */
         table th:nth-child(15), table td:nth-child(15), /* 喪假(時) */
         table th:nth-child(16), table td:nth-child(16)  /* 超時(時) */
         { width: var(--w-hour); }

        /* 其他欄 */
         table th:nth-child(9), table td:nth-child(9)   { width: var(--w-minutes); } /* 遲到扣(分鐘) */
         table th:nth-child(10), table td:nth-child(10) { width: var(--w-minutes); } /* 遲到三次五分鐘內(分鐘) */
         table th:nth-child(11), table td:nth-child(11) { width: var(--w-punch); }   /* 漏打卡 */
         table th:nth-child(17), table td:nth-child(17) { width: var(--w-special); } /* 婚／產／陪產／產檢假（綜合欄） */


        .totals {
            margin-top: 20px;
            white-space: pre-wrap;
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px dashed #ccc;
            font-size: 1.2em; /* 特休加減統計區文字大小 */
            font-family: "Segoe UI", "微軟正黑體", sans-serif; /* 避免預設變 monospace */
            line-height: 1.6;
        }


        tr.weekend-row:hover {
            background-color: #A29093;
        }
        tr.error-row {
            background-color: #ffe6e6 !important; /* 淡紅色 */
            border: 2px solid #d33; /* 強調邊框 */
        }

        .date-input {
            width: 80px;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center; /* 水平對齊 */
            gap: 4px; /* 調整間距 */
            flex-wrap: wrap;
            max-width: 150px;    
        }
        .special-leave-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-wrap: nowrap;
        }
        .no-wrap-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            gap: 4px; /* 元件間距 */
        }


        
    </style>
</head>
<body>
    <h2>假別登記與統計工具</h2>
    <label>老師姓名：<input type="text" id="teacherNameLeave" style="width: 100px" placeholder="例如：張正華" oninput="calculateLeave()"></label>
    <label>年份：<input type="number" id="yearInput" value="" min="2000" max="2100"></label>
    <label>月份（1~12）：<input type="number" id="monthInput" value="" min="1" max="12"></label><br><br>
    <label>月初結餘：⛱️特休補休（天）：</label>
    <input type="number" id="remainVacationDays" style="width: 80px" placeholder="例如：2" oninput="calculateLeave()">
    <label>⛱️特休補休（時）：</label>
    <input type="number" id="remainVacationHours" style="width: 80px" placeholder="例如：6" oninput="calculateLeave()">
    <div id="formArea"></div>
    <h3>統計結果（如未更新，空白處點一下，再按複製）：</h3>
    <div class="totals" id="resultsLeave" contenteditable="true"></div>
    <button class="btn btn-gray" onclick="copyResultsLeave()">📋 複製上面文字</button>
    <button class="btn btn-green" onclick="importToAll()">➔ 匯入 假別登記表格 與 不支薪計算</button>
    <button class="btn btn-gray" onclick="toggleBalanceInfo()">📌 顯示 / 隱藏特休補休計算說明</button>
    <div id="balanceDetails" style="display: none;">
    <pre class="totals" id="vacationBreakdown" contenteditable="true"></pre>
    </div>

    <div style="margin-top: 30px; padding: 15px; background-color: #f7f6f4; border-radius: 16px;">
    <h3 style="margin-bottom: 10px; color: #5a5a5a;">📄 缺勤分析結果</h3>
    <iframe
    id="absenceFrame"
    src="https://zh22331997.github.io/salary-calculator/ExportAbsence.html"
    width="100%"
    height="600"
    style="border: 4px solid #c2b9b0; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);">
    </iframe>
    </div>

    <div id="toast" style="
     position: fixed;
     bottom: 20px;
     left: 50%;
     transform: translateX(-50%);
     background-color: #323232;
     color: white;
     padding: 10px 20px;
     border-radius: 8px;
     font-size: 0.95em;
     opacity: 0;
     transition: opacity 0.5s ease;
     z-index: 1000;
     pointer-events: none;
     ">提示訊息</div>
     <hr>

    <h2>事病假 或 遲到 不計薪計算器</h2>

    <label>老師姓名（可留空）：</label>
    <input type="text" id="nameSalary" style="width: 100px" placeholder="例如：張正華"><br>

    <label>原始月薪：</label>
    <input type="number" id="salary" style="width: 100px;" placeholder="例如：32000"><br>

    <label>事假（天）：</label>
    <input type="number" id="leaveDaysSalary" style="width: 60px" placeholder="0">

    <label>事假（小時）：</label>
    <input type="number" id="leaveHoursSalary" style="width: 60px" placeholder="0">

    <label>家庭照顧假（小時）：</label>
    <input type="number" id="caregiverHoursSalary" style="width: 60px" placeholder="0"><br>

    <label>病假（天）：</label>
    <input type="number" id="sickDaysSalary" style="width: 60px" placeholder="0">

    <label>病假（小時）：</label>
    <input type="number" id="sickHoursSalary" style="width: 60px" placeholder="0">

    <label>生理假（小時）：</label>
    <input type="number" id="menstrualHoursSalary" style="width: 60px" placeholder="0"><br>

    <label>超過三次5分鐘的遲到（分鐘）：</label>
    <input type="number" id="lateMinutesSalary" style="width: 60px" placeholder="0"><br>
    
    <label>💰折現（天）：</label>
    <input type="number" id="cashOutDaysSalary" style="width: 60px" placeholder="0" oninput="calculateLeave()">

    <label>💰折現（小時）：</label>
    <input type="number" id="cashOutHoursSalary" style="width: 60px" placeholder="0" oninput="calculateLeave()"><br>
    

    <button class="btn btn-blue" onclick="calculateSalaryDeduction()">計算不支薪</button>
    <br><br>
    <div id="salaryResult"></div>
    <button class="btn btn-gray" onclick="copyResultsSalary()">📋 複製算式</button>


<script>
    // --- 工具函數 (Utility Functions) ---
    /**
     * 將值解析為浮點數，若無法解析則返回 0。
     * @param {string|number} value - 要解析的值。
     * @returns {number} 解析後的數字或 0。
     */
    function parseNumber(value) {
        const num = parseFloat(value);
        return isNaN(num) ? 0 : num;
    }

    /**
     * 格式化假別記錄的顯示字串。
     * @param {object} entry - 假別記錄物件，包含 date 和時間/天數單位。
     * @param {'minutes'|'hours'|'days'} unit - 假別的時間單位。
     * @returns {string} 格式化後的字串。
     */
    function formatEntry(entry, unit) {
    const value = entry[unit];
    if (value === undefined || value === null) return '';  // 👉 若沒資料就不輸出

    let unitText = '';
    if (unit === 'minutes') unitText = '分';
    else if (unit === 'hours') unitText = '時';
    else if (unit === 'days') unitText = '天';

    return `(${entry.date} ${value}${unitText})`;
}


    /**
     * 顯示短暫的提示訊息。
     * @param {string} message - 要顯示的訊息。
     * @param {number} duration - 訊息顯示的時間（毫秒）。
     */
    function showToast(message, duration = 2500) {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = message;
            toast.style.opacity = 1;
            setTimeout(() => {
                toast.style.opacity = 0;
            }, duration);
        } else {
            console.warn("Toast 元素未找到，訊息：", message);
        }
    }

    /**
     * 根據日期字串獲取星期文字。
     * @param {string} dateStr - 日期字串，格式為 "月/日"。
     * @returns {string} 星期文字（如 "日", "一"）。
     */
    function getWeekdayString(dateStr) {
        const [month, day] = dateStr.split("/").map(Number);
        const year = parseInt(document.getElementById("yearInput").value);
        const date = new Date(year, month - 1, day);
        const weekdays = ["日", "一", "二", "三", "四", "五", "六"];
        return weekdays[date.getDay()];
    }

    /**
     * 驗證輸入框的值，確保數字正確且不超過限制。
     * @param {HTMLInputElement} input - 數字輸入框元素。
     */
    function validateInput(input) {
        let value = parseFloat(input.value) || 0;

        if (value < 0) {
            showToast("數值不能是負數！");
            input.value = 0;
            return;
        }

        const dataType = input.getAttribute("data-type");
        if (dataType) {
            if  (dataType.includes("hour") && value > 8) {
                showToast("每格最多填寫 8 小時！");
                input.value = 8;
            }
        }
    }

    /**
     * 獲取指定 ID 元素的數值，若無則返回 0。
     * @param {string} id - 元素 ID。
     * @returns {number} 元素值。
     */
    function getValue(id) {
        const element = document.getElementById(id);
        return element ? parseNumber(element.value) : 0;
    }


    // --- 全局狀態 (Global State) ---
    // 全局變數用於儲存記錄，以便匯入和顯示
    let leaveRecords = []; // 事假
    let sickRecords = [];  // 病假
    let lateRecords = [];  // 遲到（扣薪）
    let lateNoDeductRecords = []; // 遲到不扣（全勤緩衝）
    let punchCardMissRecords = []; // 漏打卡
    let menstrualRecords = [];     // 生理假
    let caregiverRecords = [];     // 家庭照顧假
    let vacationRecords = [];      // 特休/補休
    let funeralRecords = [];       // 喪假
    let overtimeRecords = [];      // 超時
    let specialLeaves = {          // 婚／產／陪產／產檢假
        '婚假': { records: [], days: 0, hours: 0 },
        '產假': { records: [], days: 0, hours: 0 },
        '陪產假': { records: [], days: 0, hours: 0 },
        '產檢假': { records: [], days: 0, hours: 0 }
    };

    // --- 事件處理與邏輯 (Event Handlers & Logic) ---

    /**
     * 檢查天數假別的衝突，並禁用/啟用其他輸入欄位。
     * @param {HTMLInputElement} currentCheckbox - 當前操作的 checkbox 元素。
     */
    // ✅ 單格衝突檢查
    function checkLeaveDayConflict(currentCheckbox) {
    const currentRow = currentCheckbox.closest('tr');

    // 所有「一般假別」的天 checkbox
    const dayTypeCheckboxes = currentRow.querySelectorAll('input[type="checkbox"][data-type$="-day"]');

    // 特殊假別的「一天」checkbox（.special-leave-day 類別）
    const specialDayCheckbox = currentRow.querySelector('.special-leave-day');

    // 總共勾選了幾個「一天」假
    let dayLeaveCount = 0;

    dayTypeCheckboxes.forEach(cb => {
        if (cb.checked && !cb.disabled) dayLeaveCount++;
    });

    if (specialDayCheckbox && specialDayCheckbox.checked && !specialDayCheckbox.disabled) {
        dayLeaveCount++;
    }

    if (dayLeaveCount > 1) {
        showToast(`⚠️ 同一天不能同時請多種「一天」的假別`);
        currentCheckbox.checked = false;
        return;
    }

    // 如果勾選了天假 → 禁用所有時數輸入欄位（包括特殊假的時）
    const hourInputs = currentRow.querySelectorAll('input[type="number"], input[name="punch-card-miss"]');
    if (currentCheckbox.checked) {
        hourInputs.forEach(input => {
            input.disabled = true;
            input.value = '';
        });

        // 清除特殊假別的「時」欄位
        const specialHour = currentRow.querySelector('.special-leave-hour');
        if (specialHour) {
            specialHour.disabled = true;
            specialHour.value = '';
        }
    } else {
        hourInputs.forEach(input => input.disabled = false);
        const specialHour = currentRow.querySelector('.special-leave-hour');
        if (specialHour) specialHour.disabled = false;
    }

    calculateLeave(); // 更新計算
    }
    /**
     * 處理特殊假別 select 的變更：清除原本的勾選與數值，並觸發檢查。
     */
    function handleSpecialLeaveTypeChange(selectElement) {
        const td = selectElement.closest('td');
        const dayCheckbox = td.querySelector('.special-leave-day');
        const hourInput = td.querySelector('.special-leave-hour');
        if (dayCheckbox) {
            dayCheckbox.checked = false;
        }
        if (hourInput) {
            hourInput.value = '';
        }
        checkLeaveDayConflict(dayCheckbox);
    }
/**
 * 檢查整列請假總量不可超過一天或 8 小時。
 * @param {HTMLTableRowElement} row - 表格的某一列。
 * @returns {boolean} - 是否通過檢查。
 */
    // ✅ 整列假別總量防呆
    function validateRowTotal(row) {
    let totalDays = 0;
    let totalHours = 0;
    row.classList.remove("error-row"); // ✅ 每次驗證先清除錯誤樣式

    const date = row.querySelector("td:first-child")?.innerText || "（未知日期）";

    const dayCheckboxes = row.querySelectorAll("input[type='checkbox'][data-type$='-day'], .special-leave-day");
    dayCheckboxes.forEach(cb => {
        if (cb.checked && !cb.disabled) totalDays += 1;
    });

    const hourInputs = row.querySelectorAll("input[type='number'][data-type$='hour'], .special-leave-hour");
    hourInputs.forEach(input => {
        if (!input.disabled) {
            const val = parseFloat(input.value);
            if (!isNaN(val)) totalHours += val;
        }
    });

    if (totalDays > 1) {
        row.classList.add("error-row");
        showToast(`⚠️ ${date} 同一天不能請超過 1 天的假！`);
        return false;
    }
    if (totalDays === 1 && totalHours > 0) {
        row.classList.add("error-row");
        showToast(`⚠️ ${date} 已請 1 天，不可再填時數！`);
        return false;
    }
    if (totalDays === 0 && totalHours > 8) {
        row.classList.add("error-row");
        showToast(`⚠️ ${date} 單日時數不能超過 8 小時！`);
        return false;
    }

    return true;
}


    /**
     * 生成月份的日期表格。
     */
     function generateTable() {
    const year = parseInt(document.getElementById("yearInput").value);
    const month = parseInt(document.getElementById("monthInput").value);
    const daysInMonth = new Date(year, month, 0).getDate();

    const weekDays = ["日", "一", "二", "三", "四", "五", "六"];
    let html = `
        <table>
            <thead>
                <tr>
                    <th>日期</th><th>星期</th>
                    <th>特休<br>補休<br>(天)</th><th>特休<br>補休<br>(時)</th>
                    <th>事假<br>(天)</th><th>事假<br>(時)</th>
                    <th>病假<br>(天)</th><th>病假<br>(時)</th>
                    <th>遲到扣<br>(分鐘)</th><th>遲到三次五分鐘內<br>(分鐘)</th>
                    <th>漏打卡</th>
                    <th>生理假<br>(時)</th>
                    <th>家庭照顧假<br>(時)</th>
                    <th>喪假<br>(天)</th><th>喪假<br>(時)</th>
                    <th>超時<br>(時)</th>
                    <th>婚／產／陪產／產檢假（時）</th>
                </tr>
            </thead>
            <tbody>
    `;

    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const displayDate = `${month}/${day}`;
        const dayOfWeek = date.getDay();
        const weekendClass = dayOfWeek === 6 ? "saturday" : dayOfWeek === 0 ? "sunday" : "";

        html += `
            <tr class="weekend-row ${weekendClass}">
                <td>${displayDate}</td>
                <td>(${weekDays[dayOfWeek]})</td>
                ${generateLeaveCells("v", displayDate, true)}
                ${generateLeaveCells("p", displayDate)}
                ${generateLeaveCells("s", displayDate)}
                ${generateLateCells(displayDate)}
                ${generatePunchCardMissCell(displayDate)}
                ${generateHourOnlyCell("m", displayDate)}
                ${generateHourOnlyCell("cg", displayDate)}   
                ${generateLeaveCells("f", displayDate)}
                ${generateHourOnlyCell("overtime", displayDate)}
                <td>${generateSpecialLeaveCell(displayDate)}</td>
            </tr>
        `;
    }

    html += '</tbody></table>';
    document.getElementById("formArea").innerHTML = html;
    document.getElementById("resultsLeave").innerText = '';
    calculateLeave();
}
function generateLeaveCells(type, date, withValidateRow = false) {
    const validate = withValidateRow ? "validateRowTotal(this.closest('tr'));" : "";
    return `
        <td>
            <input type="checkbox" name="leave-${type}" data-type="${type}-day" value="1" onchange="checkLeaveDayConflict(this)">
            <input type="hidden" name="leave-${type}-date" value="${date}">
        </td>
        <td>
            <input type="number" name="leave-${type}" data-type="${type}-hour" onchange="validateInput(this); ${validate} calculateLeave();">
            <input type="hidden" name="leave-${type}-date" value="${date}">
        </td>
    `;
}

function generateLateCells(date) {
    return `
        <td>
            <input type="number" name="late" data-type="late-min" onchange="validateInput(this); calculateLeave();">
            <input type="hidden" name="late-date" value="${date}">
        </td>
        <td>
            <input type="number" name="late-no-deduct" data-type="late-no-deduct-min" onchange="validateInput(this); calculateLeave();">
            <input type="hidden" name="late-no-deduct-date" value="${date}">
        </td>
    `;
}

function generatePunchCardMissCell(date) {
    return `
        <td>
            <div class="checkbox-group">
                <label><input type="checkbox" name="punch-card-miss" data-type="punch-in" data-date="${date}" onchange="calculateLeave()">上班</label>
                <label><input type="checkbox" name="punch-card-miss" data-type="punch-out" data-date="${date}" onchange="calculateLeave()">下班</label>
            </div>
        </td>
    `;
}

function generateHourOnlyCell(type, date) {
    return `
        <td>
            <input type="number" name="${type}" data-type="${type}-hour" onchange="validateInput(this); calculateLeave();">
            <input type="hidden" name="${type}-date" value="${date}">
        </td>
    `;
}

function generateSpecialLeaveCell(date) {
    return `
        <div class="no-wrap-cell">
            <select class="special-leave-type" onchange="handleSpecialLeaveTypeChange(this)">
                <option value="">—</option>
                <option value="婚假">婚假</option>
                <option value="產假">產假</option>
                <option value="陪產假">陪產假</option>
                <option value="產檢假">產檢假</option>
            </select>
            <label><input type="checkbox" class="special-leave-day" onchange="validateRowTotal(this.closest('tr')); calculateLeave()">1天</label>
            <input type="number" class="special-leave-hour" min="0" max="8" step="0.5" placeholder="時" onchange="validateInput(this); validateRowTotal(this.closest('tr')); calculateLeave()">
        </div>
    `;
}

/**
 * 統一格式輸出統計段落
 * @param {string} label - 假別名稱
 * @param {number} days - 請假天數
 * @param {number} hours - 請假時數
 * @param {Array} records - 明細陣列
 * @returns {string} 統一格式段落
 */
function appendResultBlock(label, days = 0, hours = 0, records = [], warning = "") {
    // 👉 特別處理「遲到」
    if (label === "遲到") {
        const minuteTotal = records
            .filter(r => typeof r.minutes === 'number')
            .reduce((sum, r) => sum + r.minutes, 0);

        if (minuteTotal === 0) return '';

        const minuteEntries = records
            .filter(r => typeof r.minutes === 'number')
            .map(r => formatEntry(r, 'minutes'))
            .filter(e => e)
            .join("、");

        return `💸 ${label}：${minuteTotal} 分    ${minuteEntries}\n`;
    }

    // 👉 若天與時都為 0，就略過該項
    if (!days && !hours) return '';

    // ✅ 動態組合「x 天 y 時」的部分
    const dayPart = days ? `${days} 天` : '';
    const hourPart = hours ? `${hours} 時` : '';
    const dayHourDisplay = [dayPart, hourPart].filter(Boolean).join(" ");

    let unpaidLeaves = ["事假", "病假", "生理假", "家庭照顧假", "遲到"];
    let emoji = unpaidLeaves.includes(label) ? "💸" : "✅";
    let result = `${emoji} ${label}：${dayHourDisplay}`;


    const dayEntries = records.filter(r => r.days).map(r => formatEntry(r, 'days'));
    const hourEntries = records.filter(r => r.hours).map(r => formatEntry(r, 'hours'));
    const minuteEntries = records.filter(r => r.minutes).map(r => formatEntry(r, 'minutes'));

    const details = [...dayEntries, ...hourEntries, ...minuteEntries].filter(e => e).join("、");

    if (details) result += `    ${details}`;
    if (warning) result += ` ${warning}`;

    return result + '\n';
}



    /**
     * 計算所有假別的總和並顯示結果。
     */
    // ✅ 主計算函式
    function calculateLeave() {
    const rows = document.querySelectorAll("#formArea table tbody tr");

    // 🔁 每次重新計算前，清掉所有錯誤紅框
    rows.forEach(row => {
    row.classList.remove("error-row");
    row.classList.remove("warned-incomplete-special-leave"); 
});



    // 重設所有統計記錄
    leaveRecords = [];
    sickRecords = [];
    lateRecords = [];
    lateNoDeductRecords = [];
    punchCardMissRecords = [];
    menstrualRecords = [];
    caregiverRecords = [];
    vacationRecords = [];
    funeralRecords = [];
    overtimeRecords = [];
    for (const type in specialLeaves) {
        specialLeaves[type] = { records: [], days: 0, hours: 0 };
    }

    let totalVDays = 0, totalVHours = 0;
    let totalPDays = 0, totalPHours = 0;
    let totalSDays = 0, totalSHours = 0;
    let totalLateMinutes = 0;
    let totalLateNoDeductMinutes = 0;
    let totalPunchInCount = 0, totalPunchOutCount = 0;
    let totalMHours = 0;
    let totalCGHours = 0;   
    let totalFDays = 0, totalFHours = 0;
    let totalOtHours = 0;

    rows.forEach(row => {
        if (!validateRowTotal(row)) {
        return; // ⚠️ 若單列驗證沒通過，就不要處理該列
        }
        const date = row.querySelector("td:first-child").innerText;
        const weekday = getWeekdayString(date);

        const getVal = (selector) => {
            const input = row.querySelector(selector);
            return input && !input.disabled ? parseNumber(input.value) : 0;
        };

        const isChecked = (selector) => {
            const checkbox = row.querySelector(selector);
            return checkbox && !checkbox.disabled && checkbox.checked;
        };

        // 特休補休
        if (isChecked("input[data-type='v-day']")) {
            totalVDays += 1;
            vacationRecords.push({ days: 1, date, weekday });
        }
        const vHourVal = getVal("input[data-type='v-hour']");
        if (vHourVal > 0) {
            totalVHours += vHourVal;
            vacationRecords.push({ hours: vHourVal, date, weekday });
        }

        // 事假
        if (isChecked("input[data-type='p-day']")) {
            totalPDays += 1;
            leaveRecords.push({ days: 1, date, weekday });
        }
        const pHourVal = getVal("input[data-type='p-hour']");
        if (pHourVal > 0) {
            totalPHours += pHourVal;
            leaveRecords.push({ hours: pHourVal, date, weekday });
        }

        // 病假
        if (isChecked("input[data-type='s-day']")) {
            totalSDays += 1;
            sickRecords.push({ days: 1, date, weekday });
        }
        const sHourVal = getVal("input[data-type='s-hour']");
        if (sHourVal > 0) {
            totalSHours += sHourVal;
            sickRecords.push({ hours: sHourVal, date, weekday });
        }

        // 遲到
        const lateMinVal = getVal("input[data-type='late-min']");
        if (lateMinVal > 0) {
            totalLateMinutes += lateMinVal;
            lateRecords.push({ minutes: lateMinVal, date, weekday });
        }

        const lateNoDeductMinVal = getVal("input[data-type='late-no-deduct-min']");
        if (lateNoDeductMinVal > 0) {
            totalLateNoDeductMinutes += lateNoDeductMinVal;
            lateNoDeductRecords.push({ minutes: lateNoDeductMinVal, date, weekday });
        }

        const punchIn = row.querySelector("input[name='punch-card-miss'][data-type='punch-in']");
        const punchOut = row.querySelector("input[name='punch-card-miss'][data-type='punch-out']");
        if (punchIn && punchIn.checked && !punchIn.disabled) {
            punchCardMissRecords.push({ type: "上班", date, weekday });
            totalPunchInCount++;
        }
        if (punchOut && punchOut.checked && !punchOut.disabled) {
            punchCardMissRecords.push({ type: "下班", date, weekday });
            totalPunchOutCount++;
        }

        const mHourVal = getVal("input[data-type='m-hour']");
        if (mHourVal > 0) {
            totalMHours += mHourVal;
            menstrualRecords.push({ hours: mHourVal, date, weekday });
        }

        const cgHourVal = getVal("input[data-type='cg-hour']");
        if (cgHourVal > 0) {
            totalCGHours += cgHourVal;
            caregiverRecords.push({ hours: cgHourVal, date, weekday });
        }


        if (isChecked("input[data-type='f-day']")) {
            totalFDays += 1;
            funeralRecords.push({ days: 1, date, weekday });
        }
        const fHourVal = getVal("input[data-type='f-hour']");
        if (fHourVal > 0) {
            totalFHours += fHourVal;
            funeralRecords.push({ hours: fHourVal, date, weekday });
        }

        const otHourVal = getVal("input[data-type='overtime-hour']");
        if (otHourVal > 0) {
            totalOtHours += otHourVal;
            overtimeRecords.push({ hours: otHourVal, date, weekday });
        }

        const typeSelect = row.querySelector(".special-leave-type");
        const selectedType = typeSelect?.value || "";
        const dayChecked = isChecked(".special-leave-day");
        const hourValue = getVal(".special-leave-hour");

        if (selectedType) {
    if (dayChecked && hourValue > 0) {
        showToast(`⚠️ ${date} ${selectedType} 不可同時勾選一天與時數`);
    } else if (dayChecked) {
        specialLeaves[selectedType].days += 1;
        specialLeaves[selectedType].records.push({ days: 1, date, weekday });
    } else if (hourValue > 0) {
        specialLeaves[selectedType].hours += hourValue;
        specialLeaves[selectedType].records.push({ hours: hourValue, date, weekday });
    } else {
        // ✅ 若選了假別，但未填內容，提示一次
        if (!row.classList.contains("warned-incomplete-special-leave")) {
            showToast(`📌 ${date} 已選「${selectedType}」，請勾選一天或填入時數`);
            row.classList.add("warned-incomplete-special-leave");
        }
    }
}



    });

    // 📊 開始呈現統計結果
    const name = document.getElementById("teacherNameLeave").value.trim();
    let result = name ? `${name}\n` : "";

    const format = (records, unit) => records.map(e => formatEntry(e, unit)).join("、");

    result += appendResultBlock("特休/補休", totalVDays, totalVHours, vacationRecords);
    result += appendResultBlock("超時", 0, totalOtHours, overtimeRecords);



    // 全勤緩衝
    const totalNoDeductMinutes = lateNoDeductRecords.reduce((sum, r) => sum + (r.minutes || 0), 0);
    const totalMissPunches = punchCardMissRecords.length;

if (totalNoDeductMinutes || totalMissPunches) {
    result += `✅ 全勤緩衝：`;
    if (totalNoDeductMinutes > 0) {
        result += `遲到不扣 ${totalNoDeductMinutes} 分 ${format(lateNoDeductRecords, "minutes")}`;
    }
    if (totalMissPunches > 0) {
        if (totalNoDeductMinutes > 0) result += "，";
        result += `漏打卡 ${totalMissPunches} 次 ${punchCardMissRecords.map(r => `(${r.date} ${r.type})`).join("、")}`;
    }
    const totalBuffer = lateNoDeductRecords.length + totalMissPunches;
    if (totalBuffer > 3) result += " ⚠️ 超過 3 次，全勤取消";
    result += "\n";
}
    result += appendResultBlock("遲到", 0, 0, lateRecords);
    result += appendResultBlock("事假", totalPDays, totalPHours, leaveRecords);
    result += appendResultBlock("病假", totalSDays, totalSHours, sickRecords);
    result += appendResultBlock("生理假", 0, totalMHours, menstrualRecords, totalMHours > 8 ? "⚠️ 生理假超過限額！" : "");
    result += appendResultBlock("家庭照顧假", 0, totalCGHours, caregiverRecords);
    result += appendResultBlock("喪假", totalFDays, totalFHours, funeralRecords);

    Object.entries(specialLeaves).forEach(([type, data]) => {
    result += appendResultBlock(type, data.days, data.hours, data.records);
    });

    // 💡 重要：特休補休餘額計算
    const originalVacationDays = getValue("remainVacationDays");
    const originalVacationHours = getValue("remainVacationHours");

    let rawRemainingDays = originalVacationDays - totalVDays;
    let rawRemainingHours = originalVacationHours + totalOtHours - totalVHours;

    while (rawRemainingHours < 0 && rawRemainingDays > 0) {
        rawRemainingHours += 8;
        rawRemainingDays -= 1;
    }

    rawRemainingHours = Math.floor(rawRemainingHours * 100) / 100;

    const balanceWarning = (rawRemainingDays < 0 || rawRemainingHours < 0) ? " ⚠️" : "";

    let vacationSummary = '';
    vacationSummary += `特休補休計算說明：\n`;
    vacationSummary += `前月結餘：${originalVacationDays} 天 ${originalVacationHours} 時\n`;
    vacationSummary += `扣本月用：-${totalVDays} 天 -${totalVHours} 時\n`;
    vacationSummary += `本月超時：+${totalOtHours} 時\n`;
    vacationSummary += `本月結餘：${rawRemainingDays} 天 ${rawRemainingHours} 時${balanceWarning}\n`;

    // 顯示在另外一個區塊
    document.getElementById("vacationBreakdown").innerText = vacationSummary;
    

    if (rawRemainingDays < 0 || rawRemainingHours < 0) {
        showToast("⚠️ 特休補休透支了，請注意！");
    }
    result += `📌 特休補休結餘：${rawRemainingDays} 天 ${rawRemainingHours} 時${balanceWarning}\n`;

    document.getElementById("resultsLeave").innerText = result;
}


    /**
     * 複製假別統計結果到剪貼簿。
     */
    function copyResultsLeave() {
        const resultText = document.getElementById("resultsLeave").innerText;
        if (!resultText) {
            showToast("⚠️ 尚未產生結果");
            return;
        }
        navigator.clipboard.writeText(resultText).then(() => {
            showToast("已複製統計結果！");
        }).catch(() => {
            showToast("複製失敗，請手動選取內容！");
        });
    }

    /**
     * 將假別統計結果匯入不計薪計算區塊。
     */
    function importLeaveResults() {
        // 從全局變數獲取已統計的數據
        const totalLeaveDays = leaveRecords.filter(r => r.days).reduce((sum, r) => sum + r.days, 0);
        const totalLeaveHours = leaveRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);
        const totalCaregiverHours = caregiverRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);
        const totalSickDays = sickRecords.filter(r => r.days).reduce((sum, r) => sum + r.days, 0);
        const totalSickHours = sickRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);
        const totalLateMinutes = lateRecords.filter(r => r.minutes).reduce((sum, r) => sum + r.minutes, 0);
        const totalMenstrualHours = menstrualRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);

        // 填入薪資計算區塊的輸入框
        document.getElementById("leaveDaysSalary").value = totalLeaveDays;
        document.getElementById("leaveHoursSalary").value = totalLeaveHours;
        document.getElementById("caregiverHoursSalary").value = totalCaregiverHours;
        document.getElementById("sickDaysSalary").value = totalSickDays;
        document.getElementById("sickHoursSalary").value = totalSickHours;
        document.getElementById("lateMinutesSalary").value = totalLateMinutes;
        document.getElementById("menstrualHoursSalary").value = totalMenstrualHours;

        const teacherNameLeave = document.getElementById("teacherNameLeave").value.trim();
        if (teacherNameLeave) {
            document.getElementById("nameSalary").value = teacherNameLeave;
        }

        showToast("假別統計結果已匯入不計薪計算！");
    }

    /**
     * 計算薪資扣款。
     */
    function calculateSalaryDeduction() {
        const name = document.getElementById("nameSalary").value.trim();
        const salary = getValue("salary"); // 月薪

        if (salary <= 0) {
            document.getElementById("salaryResult").innerText = "⚠️ 請填入原始月薪";
            return;
        }

        // 從輸入框獲取假別天數/時數
        const leaveDays = getValue("leaveDaysSalary");
        const leaveHours = getValue("leaveHoursSalary");
        const sickDays = getValue("sickDaysSalary");
        const sickHours = getValue("sickHoursSalary");
        const lateMinutes = getValue("lateMinutesSalary");
        const menstrualHours = getValue("menstrualHoursSalary");
        const caregiverHours = getValue("caregiverHoursSalary");
        const cashOutDays = getValue("cashOutDaysSalary");
        const cashOutHours = getValue("cashOutHoursSalary");

        // 生成詳細記錄註釋
        const leaveDaysNote = leaveRecords.filter(r => r.days).map(record => `（${record.date} ${record.days}天）`).join('');
        const leaveHoursNote = leaveRecords.filter(r => r.hours).map(record => `（${record.date} ${record.hours}時）`).join('');
        const sickDaysNote = sickRecords.filter(r => r.days).map(record => `（${record.date} ${record.days}天）`).join('');
        const sickHoursNote = sickRecords.filter(r => r.hours).map(record => `（${record.date} ${record.hours}時）`).join('');
        const lateNote = lateRecords.map(record => `（${record.date} ${record.minutes}分）`).join('');
        const menstrualNote = menstrualRecords.map(record => `（${record.date} ${record.hours}時）`).join('');
        const caregiverNote = caregiverRecords.map(record => `（${record.date} ${record.hours}時）`).join('');


        // 計算原始未取整的扣款金額
        const rawLeaveDayDeduct = (salary / 30) * leaveDays;
        const rawLeaveHourDeduct = (salary / 30 / 8) * leaveHours;
        const rawCaregiverHourDeduct = (salary / 30 / 8) * caregiverHours; // 家庭照顧假(時)：與事假相同
        const rawSickDayDeduct = (salary / 30 / 2) * sickDays; // 半薪
        const rawSickHourDeduct = (salary / 30 / 8 / 2) * sickHours; // 半薪
        const rawLateDeduct = (salary / 30 / 8 / 60) * lateMinutes; 
        const rawMenstrualDeduct = (salary / 30 / 8 / 2) * menstrualHours; // 半薪

        // 計算原始未取整的折現金額
        const rawCashOutDayBonus = (salary / 30) * cashOutDays;
        const rawCashOutHourBonus = (salary / 30 / 8) * cashOutHours;

        // 最終加總時再進行四捨五入
        const totalDeduct = Math.round(
        rawLeaveDayDeduct + rawLeaveHourDeduct +
        rawSickDayDeduct + rawSickHourDeduct +
        rawLateDeduct + rawMenstrualDeduct +
        rawCaregiverHourDeduct
        );

        const totalCashOutBonus = Math.round(rawCashOutDayBonus + rawCashOutHourBonus);

        let formula = `${name ? name + "：" : ""}明細如下：\n`;

        // 顯示扣薪明細
        if (leaveDays) formula += `➖事假 ${leaveDays}天 × ${salary}/30 = ${Math.round(rawLeaveDayDeduct)}元 ${leaveDaysNote}\n`;
        if (leaveHours) formula += `➖事假 ${leaveHours}時 × ${salary}/30/8 = ${Math.round(rawLeaveHourDeduct)}元 ${leaveHoursNote}\n`;
        if (caregiverHours) formula += `➖家庭照顧假 ${caregiverHours}時 × ${salary}/30/8 = ${Math.round(rawCaregiverHourDeduct)}元 ${caregiverNote}\n`;
        if (sickDays) formula += `➖病假 ${sickDays}天 × ${salary}/30/2 = ${Math.round(rawSickDayDeduct)}元 ${sickDaysNote}\n`;
        if (sickHours) formula += `➖病假 ${sickHours}時 × ${salary}/30/8/2 = ${Math.round(rawSickHourDeduct)}元 ${sickHoursNote}\n`;
        if (lateMinutes) formula += `➖遲到 ${lateMinutes}分 × ${salary}/30/8/60 = ${Math.round(rawLateDeduct)}元 ${lateNote}\n`;
        if (menstrualHours) formula += `➖生理假 ${menstrualHours}時 × ${salary}/30/8/2 = ${Math.round(rawMenstrualDeduct)}元 ${menstrualNote}\n`;

        formula += `不支薪金額：${totalDeduct} 元\n`;

        // 顯示折現明細
        if (cashOutDays) formula += `➕折現 ${cashOutDays}天 × ${salary}/30 = ${Math.round(rawCashOutDayBonus)}元\n`;
        if (cashOutHours) formula += `➕折現 ${cashOutHours}時 × ${salary}/30/8 = ${Math.round(rawCashOutHourBonus)}元\n`;
        if (cashOutDays || cashOutHours) formula += `折現總金額：${totalCashOutBonus} 元\n`;

        document.getElementById("salaryResult").innerText = formula;
    }

    /**
     * 複製薪資計算結果到剪貼簿。
     */
    function copyResultsSalary() {
        const text = document.getElementById("salaryResult").innerText;
        if (!text) {
            showToast("⚠️ 尚未產生結果");
            return;
        }
        navigator.clipboard.writeText(text)
            .then(() => showToast("✅ 已複製算式！"))
            .catch(err => showToast("❌ 複製失敗：" + err));
    }
    function importToAll() {
     // 先重新計算，確保 resultsLeave 與各全域記錄是最新
     calculateLeave();

     // 先把統計數據匯入到「不支薪」區塊
     importLeaveResults();

     // 再送到 iframe（缺勤分析頁）
     sendToIframe();

     showToast("✅ 已匯入缺勤分析與不支薪計算");
    }


    /**
     * 將假別數據發送給 iframe。
     */
    function sendToIframe() {
        const data = (document.getElementById('resultsLeave').innerText || '').trim();
        if (!data) {
            showToast("⚠️ 沒有可傳送的統計資料，請先輸入或點表格欄位讓系統重算");
            return;
        }
        
        const iframe = document.getElementById('absenceFrame');
        if (!iframe || !iframe.contentWindow) {
            showToast("⚠️ 找不到缺勤分析的 iframe（absenceFrame）");
            return;
        }
        
        if (!window.absenceFrameReady) {
            showToast("⌛️ 分析頁面尚在載入中，稍後再試");
            return;
        }
        
        iframe.contentWindow.postMessage(
            { type: 'IMPORT_LEAVE_DATA', payload: data },
            'https://zh22331997.github.io' // 必須精準匹配 iframe 的來源
             );
            }



    // --- DOM 加載完成後初始化 (Initialization on DOMContentLoaded) ---
    window.addEventListener("DOMContentLoaded", () => {
        // 設定預設月份為上個月
        let now = new Date();
        let prevMonth = now.getMonth(); // 0 = 一月

        if (prevMonth === 0) { // 如果現在是一月，則上個月是去年十二月
            document.getElementById("monthInput").value = 12;
            document.getElementById("yearInput").value = now.getFullYear() - 1;
        } else {
            document.getElementById("monthInput").value = prevMonth;
            document.getElementById("yearInput").value = now.getFullYear();
        }

        // 設定年份為當前年份
        document.getElementById("yearInput").value = new Date().getFullYear();

        generateTable(); // 初始化時生成表格

        // 監聽年份和月份的變化，重新生成表格
        document.getElementById("yearInput").addEventListener("change", generateTable);
        document.getElementById("monthInput").addEventListener("change", generateTable);

        // 禁止滾輪改變數字輸入框的值
        document.addEventListener('wheel', function(e) {
            if (document.activeElement && document.activeElement.type === 'number') {
                e.preventDefault(); // 阻止滾輪預設行為
                document.activeElement.blur(); // 移除 focus 避免數值被改動
            }
        }, { passive: false });

        // 讓父頁知道 iframe 什麼時候載好
        const absFrame = document.getElementById('absenceFrame');
        window.absenceFrameReady = false;
        if (absFrame) {
                        absFrame.addEventListener('load', () => {
    window.absenceFrameReady = true;
  });
}
   



    });
    function toggleBalanceInfo() {
    const block = document.getElementById("balanceDetails");
    block.style.display = block.style.display === "none" ? "block" : "none";
}
</script>
</body>
</html>

