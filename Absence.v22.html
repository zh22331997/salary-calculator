<!DOCTYPE html>   
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å‡åˆ¥çµ±è¨ˆå·¥å…·v22</title>
    <style>
        /*ç®—å¡:å¯è¨ˆç®—å‰©é¤˜å¹´å‡ï¼ŒåŠ å…¥å®¶åº­ç…§é¡§å‡*/
        /* å…¨å±€æ¨£å¼ */
        body {
            font-family: "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background-color:#D4DCDB;
            padding: 1.5em;
            color: #333;
        }

        label {
            margin-right: 0.5em;
        }
        h2 {
           color: #333; /* é…åˆå…¨é å­—é«”é¡è‰² */
           border-left: 6px solid #3c82f6; /* æ¨™é¡Œçš„è‰²å¡Šé…åˆå…¨é å­—é«”é¡è‰² */
           padding-left: 12px;
           margin-bottom: 20px;
        }
        :root {
            --w-date: 2em;
            --w-weekday: 2em;
            --w-day: 2em;
            --w-hour: 4em;
            --w-minutes: 4em;
            --w-punch: 8em;
            --w-special: 15em;
        }
        /*çµ±ä¸€å…©ç¨®çµ±è¨ˆçµæœçš„å­—é«”å¤§å°*/
        #resultsLeave,
        #vacationBreakdown {
            font-size: 16px;
            font-family: "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            line-height: 1.6;
        }
        /* çµ±ä¸€æŒ‰éˆ•æ¨£å¼ */
        .btn {
        padding: 0.5em 1.2em;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin: 0.3em;
        }
        /* è—è‰²æŒ‰éˆ• */
        .btn-blue {
            background-color: #3c82f6;
        }
        .btn-blue:hover {
            background-color: #2563eb;
        }
        /* ç¶ è‰²æŒ‰éˆ•ï¼ˆå¦‚ï¼šåŒ¯å…¥ï¼‰ */
        .btn-green {
            background-color: #10b981;
        }
        .btn-green:hover {
            background-color: #0e9f6e;
        }
        /* ç°è‰²æŒ‰éˆ•ï¼ˆå¦‚ï¼šè¤‡è£½ã€æ¬¡è¦æ“ä½œï¼‰ */
        .btn-gray {
            background-color: #6b7280;
        }
        .btn-gray:hover {
            background-color: #4b5563;
        }
        table {
            table-layout: fixed;
            width: 100%;
            max-width: 1200px;
            margin: 1.5em 0;  /* âœ… æ”¹æˆä¸Šä¸‹é–“è· 1.5emï¼Œå·¦å³ä¸ç½®ä¸­ */
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 0.6em;
            text-align: center;
        }
        th {
            background-color: #f0f4f8;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr.sunday {
            background-color: #ffe5e5;
        }
        tr.saturday {
            background-color: #e5f0ff;
        }
        input[type="checkbox"] {
            transform: scale(1.3);
        }
        input[type="text"] {
            width: 6em;
            padding: 0.3em;
            margin-right: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="number"] {
            width: 4em;
            padding: 0.2em;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 1em;
        }

        /* æ¯æ¬„å¯¬åº¦è¨­å®š */
        /* æ¯æ¬„å¯¬åº¦è¨­å®šï¼ˆé›†ä¸­ç®¡ç†ï¼‰ */
         table th:nth-child(1), table td:nth-child(1) { width: var(--w-date); }     /* æ—¥æœŸï¼ˆå¦‚ 7/12ï¼‰ */
         table th:nth-child(2), table td:nth-child(2) { width: var(--w-weekday); }  /* æ˜ŸæœŸï¼ˆå¦‚ (æ—¥)ï¼‰ */

        /* å¤©ï¼ˆdayï¼‰æ¬„ */
         table th:nth-child(3), table td:nth-child(3),   /* ç‰¹ä¼‘(å¤©) */
         table th:nth-child(5), table td:nth-child(5),   /* äº‹å‡(å¤©) */
         table th:nth-child(7), table td:nth-child(7),   /* ç—…å‡(å¤©) */
         table th:nth-child(14), table td:nth-child(14)  /* å–ªå‡(å¤©) */
         { width: var(--w-day); }

        /* æ™‚ï¼ˆhourï¼‰æ¬„ */
         table th:nth-child(4), table td:nth-child(4),   /* ç‰¹ä¼‘(æ™‚) */
         table th:nth-child(6), table td:nth-child(6),   /* äº‹å‡(æ™‚) */
         table th:nth-child(8), table td:nth-child(8),   /* ç—…å‡(æ™‚) */
         table th:nth-child(12), table td:nth-child(12), /* ç”Ÿç†å‡(æ™‚) */
         table th:nth-child(13), table td:nth-child(13), /* å®¶åº­ç…§é¡§å‡(æ™‚) */
         table th:nth-child(15), table td:nth-child(15), /* å–ªå‡(æ™‚) */
         table th:nth-child(16), table td:nth-child(16)  /* è¶…æ™‚(æ™‚) */
         { width: var(--w-hour); }

        /* å…¶ä»–æ¬„ */
         table th:nth-child(9), table td:nth-child(9)   { width: var(--w-minutes); } /* é²åˆ°æ‰£(åˆ†é˜) */
         table th:nth-child(10), table td:nth-child(10) { width: var(--w-minutes); } /* é²åˆ°ä¸‰æ¬¡äº”åˆ†é˜å…§(åˆ†é˜) */
         table th:nth-child(11), table td:nth-child(11) { width: var(--w-punch); }   /* æ¼æ‰“å¡ */
         table th:nth-child(17), table td:nth-child(17) { width: var(--w-special); } /* å©šï¼ç”¢ï¼é™ªç”¢ï¼ç”¢æª¢å‡ï¼ˆç¶œåˆæ¬„ï¼‰ */


        .totals {
            margin-top: 20px;
            white-space: pre-wrap;
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px dashed #ccc;
            font-size: 1.2em; /* ç‰¹ä¼‘åŠ æ¸›çµ±è¨ˆå€æ–‡å­—å¤§å° */
            font-family: "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", sans-serif; /* é¿å…é è¨­è®Š monospace */
            line-height: 1.6;
        }


        tr.weekend-row:hover {
            background-color: #A29093;
        }
        tr.error-row {
            background-color: #ffe6e6 !important; /* æ·¡ç´…è‰² */
            border: 2px solid #d33; /* å¼·èª¿é‚Šæ¡† */
        }

        .date-input {
            width: 80px;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center; /* æ°´å¹³å°é½Š */
            gap: 4px; /* èª¿æ•´é–“è· */
            flex-wrap: wrap;
            max-width: 150px;    
        }
        .special-leave-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-wrap: nowrap;
        }
        .no-wrap-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            gap: 4px; /* å…ƒä»¶é–“è· */
        }


        
    </style>
</head>
<body>
    <h2>å‡åˆ¥ç™»è¨˜èˆ‡çµ±è¨ˆå·¥å…·</h2>
    <label>è€å¸«å§“åï¼š<input type="text" id="teacherNameLeave" style="width: 100px" placeholder="ä¾‹å¦‚ï¼šå¼µæ­£è¯" oninput="calculateLeave()"></label>
    <label>å¹´ä»½ï¼š<input type="number" id="yearInput" value="" min="2000" max="2100"></label>
    <label>æœˆä»½ï¼ˆ1~12ï¼‰ï¼š<input type="number" id="monthInput" value="" min="1" max="12"></label><br><br>
    <label>æœˆåˆçµé¤˜ï¼šâ›±ï¸ç‰¹ä¼‘è£œä¼‘ï¼ˆå¤©ï¼‰ï¼š</label>
    <input type="number" id="remainVacationDays" style="width: 80px" placeholder="ä¾‹å¦‚ï¼š2" oninput="calculateLeave()">
    <label>â›±ï¸ç‰¹ä¼‘è£œä¼‘ï¼ˆæ™‚ï¼‰ï¼š</label>
    <input type="number" id="remainVacationHours" style="width: 80px" placeholder="ä¾‹å¦‚ï¼š6" oninput="calculateLeave()">
    <div id="formArea"></div>
    <h3>çµ±è¨ˆçµæœï¼ˆå¦‚æœªæ›´æ–°ï¼Œç©ºç™½è™•é»ä¸€ä¸‹ï¼Œå†æŒ‰è¤‡è£½ï¼‰ï¼š</h3>
    <div class="totals" id="resultsLeave" contenteditable="true"></div>
    <button class="btn btn-gray" onclick="copyResultsLeave()">ğŸ“‹ è¤‡è£½ä¸Šé¢æ–‡å­—</button>
    <button class="btn btn-green" onclick="importToAll()">â” åŒ¯å…¥ å‡åˆ¥ç™»è¨˜è¡¨æ ¼ èˆ‡ ä¸æ”¯è–ªè¨ˆç®—</button>
    <button class="btn btn-gray" onclick="toggleBalanceInfo()">ğŸ“Œ é¡¯ç¤º / éš±è—ç‰¹ä¼‘è£œä¼‘è¨ˆç®—èªªæ˜</button>
    <div id="balanceDetails" style="display: none;">
    <pre class="totals" id="vacationBreakdown" contenteditable="true"></pre>
    </div>

    <div style="margin-top: 30px; padding: 15px; background-color: #f7f6f4; border-radius: 16px;">
    <h3 style="margin-bottom: 10px; color: #5a5a5a;">ğŸ“„ ç¼ºå‹¤åˆ†æçµæœ</h3>
    <iframe
    id="absenceFrame"
    src="https://zh22331997.github.io/salary-calculator/ExportAbsence.html"
    width="100%"
    height="600"
    style="border: 4px solid #c2b9b0; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);">
    </iframe>
    </div>

    <div id="toast" style="
     position: fixed;
     bottom: 20px;
     left: 50%;
     transform: translateX(-50%);
     background-color: #323232;
     color: white;
     padding: 10px 20px;
     border-radius: 8px;
     font-size: 0.95em;
     opacity: 0;
     transition: opacity 0.5s ease;
     z-index: 1000;
     pointer-events: none;
     ">æç¤ºè¨Šæ¯</div>
     <hr>

    <h2>äº‹ç—…å‡ æˆ– é²åˆ° ä¸è¨ˆè–ªè¨ˆç®—å™¨</h2>

    <label>è€å¸«å§“åï¼ˆå¯ç•™ç©ºï¼‰ï¼š</label>
    <input type="text" id="nameSalary" style="width: 100px" placeholder="ä¾‹å¦‚ï¼šå¼µæ­£è¯"><br>

    <label>åŸå§‹æœˆè–ªï¼š</label>
    <input type="number" id="salary" style="width: 100px;" placeholder="ä¾‹å¦‚ï¼š32000"><br>

    <label>äº‹å‡ï¼ˆå¤©ï¼‰ï¼š</label>
    <input type="number" id="leaveDaysSalary" style="width: 60px" placeholder="0">

    <label>äº‹å‡ï¼ˆå°æ™‚ï¼‰ï¼š</label>
    <input type="number" id="leaveHoursSalary" style="width: 60px" placeholder="0">

    <label>å®¶åº­ç…§é¡§å‡ï¼ˆå°æ™‚ï¼‰ï¼š</label>
    <input type="number" id="caregiverHoursSalary" style="width: 60px" placeholder="0"><br>

    <label>ç—…å‡ï¼ˆå¤©ï¼‰ï¼š</label>
    <input type="number" id="sickDaysSalary" style="width: 60px" placeholder="0">

    <label>ç—…å‡ï¼ˆå°æ™‚ï¼‰ï¼š</label>
    <input type="number" id="sickHoursSalary" style="width: 60px" placeholder="0">

    <label>ç”Ÿç†å‡ï¼ˆå°æ™‚ï¼‰ï¼š</label>
    <input type="number" id="menstrualHoursSalary" style="width: 60px" placeholder="0"><br>

    <label>è¶…éä¸‰æ¬¡5åˆ†é˜çš„é²åˆ°ï¼ˆåˆ†é˜ï¼‰ï¼š</label>
    <input type="number" id="lateMinutesSalary" style="width: 60px" placeholder="0"><br>
    
    <label>ğŸ’°æŠ˜ç¾ï¼ˆå¤©ï¼‰ï¼š</label>
    <input type="number" id="cashOutDaysSalary" style="width: 60px" placeholder="0" oninput="calculateLeave()">

    <label>ğŸ’°æŠ˜ç¾ï¼ˆå°æ™‚ï¼‰ï¼š</label>
    <input type="number" id="cashOutHoursSalary" style="width: 60px" placeholder="0" oninput="calculateLeave()"><br>
    

    <button class="btn btn-blue" onclick="calculateSalaryDeduction()">è¨ˆç®—ä¸æ”¯è–ª</button>
    <br><br>
    <div id="salaryResult"></div>
    <button class="btn btn-gray" onclick="copyResultsSalary()">ğŸ“‹ è¤‡è£½ç®—å¼</button>


<script>
    // --- å·¥å…·å‡½æ•¸ (Utility Functions) ---
    /**
     * å°‡å€¼è§£æç‚ºæµ®é»æ•¸ï¼Œè‹¥ç„¡æ³•è§£æå‰‡è¿”å› 0ã€‚
     * @param {string|number} value - è¦è§£æçš„å€¼ã€‚
     * @returns {number} è§£æå¾Œçš„æ•¸å­—æˆ– 0ã€‚
     */
    function parseNumber(value) {
        const num = parseFloat(value);
        return isNaN(num) ? 0 : num;
    }

    /**
     * æ ¼å¼åŒ–å‡åˆ¥è¨˜éŒ„çš„é¡¯ç¤ºå­—ä¸²ã€‚
     * @param {object} entry - å‡åˆ¥è¨˜éŒ„ç‰©ä»¶ï¼ŒåŒ…å« date å’Œæ™‚é–“/å¤©æ•¸å–®ä½ã€‚
     * @param {'minutes'|'hours'|'days'} unit - å‡åˆ¥çš„æ™‚é–“å–®ä½ã€‚
     * @returns {string} æ ¼å¼åŒ–å¾Œçš„å­—ä¸²ã€‚
     */
    function formatEntry(entry, unit) {
    const value = entry[unit];
    if (value === undefined || value === null) return '';  // ğŸ‘‰ è‹¥æ²’è³‡æ–™å°±ä¸è¼¸å‡º

    let unitText = '';
    if (unit === 'minutes') unitText = 'åˆ†';
    else if (unit === 'hours') unitText = 'æ™‚';
    else if (unit === 'days') unitText = 'å¤©';

    return `(${entry.date} ${value}${unitText})`;
}


    /**
     * é¡¯ç¤ºçŸ­æš«çš„æç¤ºè¨Šæ¯ã€‚
     * @param {string} message - è¦é¡¯ç¤ºçš„è¨Šæ¯ã€‚
     * @param {number} duration - è¨Šæ¯é¡¯ç¤ºçš„æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰ã€‚
     */
    function showToast(message, duration = 2500) {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = message;
            toast.style.opacity = 1;
            setTimeout(() => {
                toast.style.opacity = 0;
            }, duration);
        } else {
            console.warn("Toast å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¨Šæ¯ï¼š", message);
        }
    }

    /**
     * æ ¹æ“šæ—¥æœŸå­—ä¸²ç²å–æ˜ŸæœŸæ–‡å­—ã€‚
     * @param {string} dateStr - æ—¥æœŸå­—ä¸²ï¼Œæ ¼å¼ç‚º "æœˆ/æ—¥"ã€‚
     * @returns {string} æ˜ŸæœŸæ–‡å­—ï¼ˆå¦‚ "æ—¥", "ä¸€"ï¼‰ã€‚
     */
    function getWeekdayString(dateStr) {
        const [month, day] = dateStr.split("/").map(Number);
        const year = parseInt(document.getElementById("yearInput").value);
        const date = new Date(year, month - 1, day);
        const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        return weekdays[date.getDay()];
    }

    /**
     * é©—è­‰è¼¸å…¥æ¡†çš„å€¼ï¼Œç¢ºä¿æ•¸å­—æ­£ç¢ºä¸”ä¸è¶…éé™åˆ¶ã€‚
     * @param {HTMLInputElement} input - æ•¸å­—è¼¸å…¥æ¡†å…ƒç´ ã€‚
     */
    function validateInput(input) {
        let value = parseFloat(input.value) || 0;

        if (value < 0) {
            showToast("æ•¸å€¼ä¸èƒ½æ˜¯è² æ•¸ï¼");
            input.value = 0;
            return;
        }

        const dataType = input.getAttribute("data-type");
        if (dataType) {
            if  (dataType.includes("hour") && value > 8) {
                showToast("æ¯æ ¼æœ€å¤šå¡«å¯« 8 å°æ™‚ï¼");
                input.value = 8;
            }
        }
    }

    /**
     * ç²å–æŒ‡å®š ID å…ƒç´ çš„æ•¸å€¼ï¼Œè‹¥ç„¡å‰‡è¿”å› 0ã€‚
     * @param {string} id - å…ƒç´  IDã€‚
     * @returns {number} å…ƒç´ å€¼ã€‚
     */
    function getValue(id) {
        const element = document.getElementById(id);
        return element ? parseNumber(element.value) : 0;
    }


    // --- å…¨å±€ç‹€æ…‹ (Global State) ---
    // å…¨å±€è®Šæ•¸ç”¨æ–¼å„²å­˜è¨˜éŒ„ï¼Œä»¥ä¾¿åŒ¯å…¥å’Œé¡¯ç¤º
    let leaveRecords = []; // äº‹å‡
    let sickRecords = [];  // ç—…å‡
    let lateRecords = [];  // é²åˆ°ï¼ˆæ‰£è–ªï¼‰
    let lateNoDeductRecords = []; // é²åˆ°ä¸æ‰£ï¼ˆå…¨å‹¤ç·©è¡ï¼‰
    let punchCardMissRecords = []; // æ¼æ‰“å¡
    let menstrualRecords = [];     // ç”Ÿç†å‡
    let caregiverRecords = [];     // å®¶åº­ç…§é¡§å‡
    let vacationRecords = [];      // ç‰¹ä¼‘/è£œä¼‘
    let funeralRecords = [];       // å–ªå‡
    let overtimeRecords = [];      // è¶…æ™‚
    let specialLeaves = {          // å©šï¼ç”¢ï¼é™ªç”¢ï¼ç”¢æª¢å‡
        'å©šå‡': { records: [], days: 0, hours: 0 },
        'ç”¢å‡': { records: [], days: 0, hours: 0 },
        'é™ªç”¢å‡': { records: [], days: 0, hours: 0 },
        'ç”¢æª¢å‡': { records: [], days: 0, hours: 0 }
    };

    // --- äº‹ä»¶è™•ç†èˆ‡é‚è¼¯ (Event Handlers & Logic) ---

    /**
     * æª¢æŸ¥å¤©æ•¸å‡åˆ¥çš„è¡çªï¼Œä¸¦ç¦ç”¨/å•Ÿç”¨å…¶ä»–è¼¸å…¥æ¬„ä½ã€‚
     * @param {HTMLInputElement} currentCheckbox - ç•¶å‰æ“ä½œçš„ checkbox å…ƒç´ ã€‚
     */
    // âœ… å–®æ ¼è¡çªæª¢æŸ¥
    function checkLeaveDayConflict(currentCheckbox) {
    const currentRow = currentCheckbox.closest('tr');

    // æ‰€æœ‰ã€Œä¸€èˆ¬å‡åˆ¥ã€çš„å¤© checkbox
    const dayTypeCheckboxes = currentRow.querySelectorAll('input[type="checkbox"][data-type$="-day"]');

    // ç‰¹æ®Šå‡åˆ¥çš„ã€Œä¸€å¤©ã€checkboxï¼ˆ.special-leave-day é¡åˆ¥ï¼‰
    const specialDayCheckbox = currentRow.querySelector('.special-leave-day');

    // ç¸½å…±å‹¾é¸äº†å¹¾å€‹ã€Œä¸€å¤©ã€å‡
    let dayLeaveCount = 0;

    dayTypeCheckboxes.forEach(cb => {
        if (cb.checked && !cb.disabled) dayLeaveCount++;
    });

    if (specialDayCheckbox && specialDayCheckbox.checked && !specialDayCheckbox.disabled) {
        dayLeaveCount++;
    }

    if (dayLeaveCount > 1) {
        showToast(`âš ï¸ åŒä¸€å¤©ä¸èƒ½åŒæ™‚è«‹å¤šç¨®ã€Œä¸€å¤©ã€çš„å‡åˆ¥`);
        currentCheckbox.checked = false;
        return;
    }

    // å¦‚æœå‹¾é¸äº†å¤©å‡ â†’ ç¦ç”¨æ‰€æœ‰æ™‚æ•¸è¼¸å…¥æ¬„ä½ï¼ˆåŒ…æ‹¬ç‰¹æ®Šå‡çš„æ™‚ï¼‰
    const hourInputs = currentRow.querySelectorAll('input[type="number"], input[name="punch-card-miss"]');
    if (currentCheckbox.checked) {
        hourInputs.forEach(input => {
            input.disabled = true;
            input.value = '';
        });

        // æ¸…é™¤ç‰¹æ®Šå‡åˆ¥çš„ã€Œæ™‚ã€æ¬„ä½
        const specialHour = currentRow.querySelector('.special-leave-hour');
        if (specialHour) {
            specialHour.disabled = true;
            specialHour.value = '';
        }
    } else {
        hourInputs.forEach(input => input.disabled = false);
        const specialHour = currentRow.querySelector('.special-leave-hour');
        if (specialHour) specialHour.disabled = false;
    }

    calculateLeave(); // æ›´æ–°è¨ˆç®—
    }
    /**
     * è™•ç†ç‰¹æ®Šå‡åˆ¥ select çš„è®Šæ›´ï¼šæ¸…é™¤åŸæœ¬çš„å‹¾é¸èˆ‡æ•¸å€¼ï¼Œä¸¦è§¸ç™¼æª¢æŸ¥ã€‚
     */
    function handleSpecialLeaveTypeChange(selectElement) {
        const td = selectElement.closest('td');
        const dayCheckbox = td.querySelector('.special-leave-day');
        const hourInput = td.querySelector('.special-leave-hour');
        if (dayCheckbox) {
            dayCheckbox.checked = false;
        }
        if (hourInput) {
            hourInput.value = '';
        }
        checkLeaveDayConflict(dayCheckbox);
    }
/**
 * æª¢æŸ¥æ•´åˆ—è«‹å‡ç¸½é‡ä¸å¯è¶…éä¸€å¤©æˆ– 8 å°æ™‚ã€‚
 * @param {HTMLTableRowElement} row - è¡¨æ ¼çš„æŸä¸€åˆ—ã€‚
 * @returns {boolean} - æ˜¯å¦é€šéæª¢æŸ¥ã€‚
 */
    // âœ… æ•´åˆ—å‡åˆ¥ç¸½é‡é˜²å‘†
    function validateRowTotal(row) {
    let totalDays = 0;
    let totalHours = 0;
    row.classList.remove("error-row"); // âœ… æ¯æ¬¡é©—è­‰å…ˆæ¸…é™¤éŒ¯èª¤æ¨£å¼

    const date = row.querySelector("td:first-child")?.innerText || "ï¼ˆæœªçŸ¥æ—¥æœŸï¼‰";

    const dayCheckboxes = row.querySelectorAll("input[type='checkbox'][data-type$='-day'], .special-leave-day");
    dayCheckboxes.forEach(cb => {
        if (cb.checked && !cb.disabled) totalDays += 1;
    });

    const hourInputs = row.querySelectorAll("input[type='number'][data-type$='hour'], .special-leave-hour");
    hourInputs.forEach(input => {
        if (!input.disabled) {
            const val = parseFloat(input.value);
            if (!isNaN(val)) totalHours += val;
        }
    });

    if (totalDays > 1) {
        row.classList.add("error-row");
        showToast(`âš ï¸ ${date} åŒä¸€å¤©ä¸èƒ½è«‹è¶…é 1 å¤©çš„å‡ï¼`);
        return false;
    }
    if (totalDays === 1 && totalHours > 0) {
        row.classList.add("error-row");
        showToast(`âš ï¸ ${date} å·²è«‹ 1 å¤©ï¼Œä¸å¯å†å¡«æ™‚æ•¸ï¼`);
        return false;
    }
    if (totalDays === 0 && totalHours > 8) {
        row.classList.add("error-row");
        showToast(`âš ï¸ ${date} å–®æ—¥æ™‚æ•¸ä¸èƒ½è¶…é 8 å°æ™‚ï¼`);
        return false;
    }

    return true;
}


    /**
     * ç”Ÿæˆæœˆä»½çš„æ—¥æœŸè¡¨æ ¼ã€‚
     */
     function generateTable() {
    const year = parseInt(document.getElementById("yearInput").value);
    const month = parseInt(document.getElementById("monthInput").value);
    const daysInMonth = new Date(year, month, 0).getDate();

    const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    let html = `
        <table>
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th><th>æ˜ŸæœŸ</th>
                    <th>ç‰¹ä¼‘<br>è£œä¼‘<br>(å¤©)</th><th>ç‰¹ä¼‘<br>è£œä¼‘<br>(æ™‚)</th>
                    <th>äº‹å‡<br>(å¤©)</th><th>äº‹å‡<br>(æ™‚)</th>
                    <th>ç—…å‡<br>(å¤©)</th><th>ç—…å‡<br>(æ™‚)</th>
                    <th>é²åˆ°æ‰£<br>(åˆ†é˜)</th><th>é²åˆ°ä¸‰æ¬¡äº”åˆ†é˜å…§<br>(åˆ†é˜)</th>
                    <th>æ¼æ‰“å¡</th>
                    <th>ç”Ÿç†å‡<br>(æ™‚)</th>
                    <th>å®¶åº­ç…§é¡§å‡<br>(æ™‚)</th>
                    <th>å–ªå‡<br>(å¤©)</th><th>å–ªå‡<br>(æ™‚)</th>
                    <th>è¶…æ™‚<br>(æ™‚)</th>
                    <th>å©šï¼ç”¢ï¼é™ªç”¢ï¼ç”¢æª¢å‡ï¼ˆæ™‚ï¼‰</th>
                </tr>
            </thead>
            <tbody>
    `;

    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const displayDate = `${month}/${day}`;
        const dayOfWeek = date.getDay();
        const weekendClass = dayOfWeek === 6 ? "saturday" : dayOfWeek === 0 ? "sunday" : "";

        html += `
            <tr class="weekend-row ${weekendClass}">
                <td>${displayDate}</td>
                <td>(${weekDays[dayOfWeek]})</td>
                ${generateLeaveCells("v", displayDate, true)}
                ${generateLeaveCells("p", displayDate)}
                ${generateLeaveCells("s", displayDate)}
                ${generateLateCells(displayDate)}
                ${generatePunchCardMissCell(displayDate)}
                ${generateHourOnlyCell("m", displayDate)}
                ${generateHourOnlyCell("cg", displayDate)}   
                ${generateLeaveCells("f", displayDate)}
                ${generateHourOnlyCell("overtime", displayDate)}
                <td>${generateSpecialLeaveCell(displayDate)}</td>
            </tr>
        `;
    }

    html += '</tbody></table>';
    document.getElementById("formArea").innerHTML = html;
    document.getElementById("resultsLeave").innerText = '';
    calculateLeave();
}
function generateLeaveCells(type, date, withValidateRow = false) {
    const validate = withValidateRow ? "validateRowTotal(this.closest('tr'));" : "";
    return `
        <td>
            <input type="checkbox" name="leave-${type}" data-type="${type}-day" value="1" onchange="checkLeaveDayConflict(this)">
            <input type="hidden" name="leave-${type}-date" value="${date}">
        </td>
        <td>
            <input type="number" name="leave-${type}" data-type="${type}-hour" onchange="validateInput(this); ${validate} calculateLeave();">
            <input type="hidden" name="leave-${type}-date" value="${date}">
        </td>
    `;
}

function generateLateCells(date) {
    return `
        <td>
            <input type="number" name="late" data-type="late-min" onchange="validateInput(this); calculateLeave();">
            <input type="hidden" name="late-date" value="${date}">
        </td>
        <td>
            <input type="number" name="late-no-deduct" data-type="late-no-deduct-min" onchange="validateInput(this); calculateLeave();">
            <input type="hidden" name="late-no-deduct-date" value="${date}">
        </td>
    `;
}

function generatePunchCardMissCell(date) {
    return `
        <td>
            <div class="checkbox-group">
                <label><input type="checkbox" name="punch-card-miss" data-type="punch-in" data-date="${date}" onchange="calculateLeave()">ä¸Šç­</label>
                <label><input type="checkbox" name="punch-card-miss" data-type="punch-out" data-date="${date}" onchange="calculateLeave()">ä¸‹ç­</label>
            </div>
        </td>
    `;
}

function generateHourOnlyCell(type, date) {
    return `
        <td>
            <input type="number" name="${type}" data-type="${type}-hour" onchange="validateInput(this); calculateLeave();">
            <input type="hidden" name="${type}-date" value="${date}">
        </td>
    `;
}

function generateSpecialLeaveCell(date) {
    return `
        <div class="no-wrap-cell">
            <select class="special-leave-type" onchange="handleSpecialLeaveTypeChange(this)">
                <option value="">â€”</option>
                <option value="å©šå‡">å©šå‡</option>
                <option value="ç”¢å‡">ç”¢å‡</option>
                <option value="é™ªç”¢å‡">é™ªç”¢å‡</option>
                <option value="ç”¢æª¢å‡">ç”¢æª¢å‡</option>
            </select>
            <label><input type="checkbox" class="special-leave-day" onchange="validateRowTotal(this.closest('tr')); calculateLeave()">1å¤©</label>
            <input type="number" class="special-leave-hour" min="0" max="8" step="0.5" placeholder="æ™‚" onchange="validateInput(this); validateRowTotal(this.closest('tr')); calculateLeave()">
        </div>
    `;
}

/**
 * çµ±ä¸€æ ¼å¼è¼¸å‡ºçµ±è¨ˆæ®µè½
 * @param {string} label - å‡åˆ¥åç¨±
 * @param {number} days - è«‹å‡å¤©æ•¸
 * @param {number} hours - è«‹å‡æ™‚æ•¸
 * @param {Array} records - æ˜ç´°é™£åˆ—
 * @returns {string} çµ±ä¸€æ ¼å¼æ®µè½
 */
function appendResultBlock(label, days = 0, hours = 0, records = [], warning = "") {
    // ğŸ‘‰ ç‰¹åˆ¥è™•ç†ã€Œé²åˆ°ã€
    if (label === "é²åˆ°") {
        const minuteTotal = records
            .filter(r => typeof r.minutes === 'number')
            .reduce((sum, r) => sum + r.minutes, 0);

        if (minuteTotal === 0) return '';

        const minuteEntries = records
            .filter(r => typeof r.minutes === 'number')
            .map(r => formatEntry(r, 'minutes'))
            .filter(e => e)
            .join("ã€");

        return `ğŸ’¸ ${label}ï¼š${minuteTotal} åˆ†    ${minuteEntries}\n`;
    }

    // ğŸ‘‰ è‹¥å¤©èˆ‡æ™‚éƒ½ç‚º 0ï¼Œå°±ç•¥éè©²é …
    if (!days && !hours) return '';

    // âœ… å‹•æ…‹çµ„åˆã€Œx å¤© y æ™‚ã€çš„éƒ¨åˆ†
    const dayPart = days ? `${days} å¤©` : '';
    const hourPart = hours ? `${hours} æ™‚` : '';
    const dayHourDisplay = [dayPart, hourPart].filter(Boolean).join(" ");

    let unpaidLeaves = ["äº‹å‡", "ç—…å‡", "ç”Ÿç†å‡", "å®¶åº­ç…§é¡§å‡", "é²åˆ°"];
    let emoji = unpaidLeaves.includes(label) ? "ğŸ’¸" : "âœ…";
    let result = `${emoji} ${label}ï¼š${dayHourDisplay}`;


    const dayEntries = records.filter(r => r.days).map(r => formatEntry(r, 'days'));
    const hourEntries = records.filter(r => r.hours).map(r => formatEntry(r, 'hours'));
    const minuteEntries = records.filter(r => r.minutes).map(r => formatEntry(r, 'minutes'));

    const details = [...dayEntries, ...hourEntries, ...minuteEntries].filter(e => e).join("ã€");

    if (details) result += `    ${details}`;
    if (warning) result += ` ${warning}`;

    return result + '\n';
}



    /**
     * è¨ˆç®—æ‰€æœ‰å‡åˆ¥çš„ç¸½å’Œä¸¦é¡¯ç¤ºçµæœã€‚
     */
    // âœ… ä¸»è¨ˆç®—å‡½å¼
    function calculateLeave() {
    const rows = document.querySelectorAll("#formArea table tbody tr");

    // ğŸ” æ¯æ¬¡é‡æ–°è¨ˆç®—å‰ï¼Œæ¸…æ‰æ‰€æœ‰éŒ¯èª¤ç´…æ¡†
    rows.forEach(row => {
    row.classList.remove("error-row");
    row.classList.remove("warned-incomplete-special-leave"); 
});



    // é‡è¨­æ‰€æœ‰çµ±è¨ˆè¨˜éŒ„
    leaveRecords = [];
    sickRecords = [];
    lateRecords = [];
    lateNoDeductRecords = [];
    punchCardMissRecords = [];
    menstrualRecords = [];
    caregiverRecords = [];
    vacationRecords = [];
    funeralRecords = [];
    overtimeRecords = [];
    for (const type in specialLeaves) {
        specialLeaves[type] = { records: [], days: 0, hours: 0 };
    }

    let totalVDays = 0, totalVHours = 0;
    let totalPDays = 0, totalPHours = 0;
    let totalSDays = 0, totalSHours = 0;
    let totalLateMinutes = 0;
    let totalLateNoDeductMinutes = 0;
    let totalPunchInCount = 0, totalPunchOutCount = 0;
    let totalMHours = 0;
    let totalCGHours = 0;   
    let totalFDays = 0, totalFHours = 0;
    let totalOtHours = 0;

    rows.forEach(row => {
        if (!validateRowTotal(row)) {
        return; // âš ï¸ è‹¥å–®åˆ—é©—è­‰æ²’é€šéï¼Œå°±ä¸è¦è™•ç†è©²åˆ—
        }
        const date = row.querySelector("td:first-child").innerText;
        const weekday = getWeekdayString(date);

        const getVal = (selector) => {
            const input = row.querySelector(selector);
            return input && !input.disabled ? parseNumber(input.value) : 0;
        };

        const isChecked = (selector) => {
            const checkbox = row.querySelector(selector);
            return checkbox && !checkbox.disabled && checkbox.checked;
        };

        // ç‰¹ä¼‘è£œä¼‘
        if (isChecked("input[data-type='v-day']")) {
            totalVDays += 1;
            vacationRecords.push({ days: 1, date, weekday });
        }
        const vHourVal = getVal("input[data-type='v-hour']");
        if (vHourVal > 0) {
            totalVHours += vHourVal;
            vacationRecords.push({ hours: vHourVal, date, weekday });
        }

        // äº‹å‡
        if (isChecked("input[data-type='p-day']")) {
            totalPDays += 1;
            leaveRecords.push({ days: 1, date, weekday });
        }
        const pHourVal = getVal("input[data-type='p-hour']");
        if (pHourVal > 0) {
            totalPHours += pHourVal;
            leaveRecords.push({ hours: pHourVal, date, weekday });
        }

        // ç—…å‡
        if (isChecked("input[data-type='s-day']")) {
            totalSDays += 1;
            sickRecords.push({ days: 1, date, weekday });
        }
        const sHourVal = getVal("input[data-type='s-hour']");
        if (sHourVal > 0) {
            totalSHours += sHourVal;
            sickRecords.push({ hours: sHourVal, date, weekday });
        }

        // é²åˆ°
        const lateMinVal = getVal("input[data-type='late-min']");
        if (lateMinVal > 0) {
            totalLateMinutes += lateMinVal;
            lateRecords.push({ minutes: lateMinVal, date, weekday });
        }

        const lateNoDeductMinVal = getVal("input[data-type='late-no-deduct-min']");
        if (lateNoDeductMinVal > 0) {
            totalLateNoDeductMinutes += lateNoDeductMinVal;
            lateNoDeductRecords.push({ minutes: lateNoDeductMinVal, date, weekday });
        }

        const punchIn = row.querySelector("input[name='punch-card-miss'][data-type='punch-in']");
        const punchOut = row.querySelector("input[name='punch-card-miss'][data-type='punch-out']");
        if (punchIn && punchIn.checked && !punchIn.disabled) {
            punchCardMissRecords.push({ type: "ä¸Šç­", date, weekday });
            totalPunchInCount++;
        }
        if (punchOut && punchOut.checked && !punchOut.disabled) {
            punchCardMissRecords.push({ type: "ä¸‹ç­", date, weekday });
            totalPunchOutCount++;
        }

        const mHourVal = getVal("input[data-type='m-hour']");
        if (mHourVal > 0) {
            totalMHours += mHourVal;
            menstrualRecords.push({ hours: mHourVal, date, weekday });
        }

        const cgHourVal = getVal("input[data-type='cg-hour']");
        if (cgHourVal > 0) {
            totalCGHours += cgHourVal;
            caregiverRecords.push({ hours: cgHourVal, date, weekday });
        }


        if (isChecked("input[data-type='f-day']")) {
            totalFDays += 1;
            funeralRecords.push({ days: 1, date, weekday });
        }
        const fHourVal = getVal("input[data-type='f-hour']");
        if (fHourVal > 0) {
            totalFHours += fHourVal;
            funeralRecords.push({ hours: fHourVal, date, weekday });
        }

        const otHourVal = getVal("input[data-type='overtime-hour']");
        if (otHourVal > 0) {
            totalOtHours += otHourVal;
            overtimeRecords.push({ hours: otHourVal, date, weekday });
        }

        const typeSelect = row.querySelector(".special-leave-type");
        const selectedType = typeSelect?.value || "";
        const dayChecked = isChecked(".special-leave-day");
        const hourValue = getVal(".special-leave-hour");

        if (selectedType) {
    if (dayChecked && hourValue > 0) {
        showToast(`âš ï¸ ${date} ${selectedType} ä¸å¯åŒæ™‚å‹¾é¸ä¸€å¤©èˆ‡æ™‚æ•¸`);
    } else if (dayChecked) {
        specialLeaves[selectedType].days += 1;
        specialLeaves[selectedType].records.push({ days: 1, date, weekday });
    } else if (hourValue > 0) {
        specialLeaves[selectedType].hours += hourValue;
        specialLeaves[selectedType].records.push({ hours: hourValue, date, weekday });
    } else {
        // âœ… è‹¥é¸äº†å‡åˆ¥ï¼Œä½†æœªå¡«å…§å®¹ï¼Œæç¤ºä¸€æ¬¡
        if (!row.classList.contains("warned-incomplete-special-leave")) {
            showToast(`ğŸ“Œ ${date} å·²é¸ã€Œ${selectedType}ã€ï¼Œè«‹å‹¾é¸ä¸€å¤©æˆ–å¡«å…¥æ™‚æ•¸`);
            row.classList.add("warned-incomplete-special-leave");
        }
    }
}



    });

    // ğŸ“Š é–‹å§‹å‘ˆç¾çµ±è¨ˆçµæœ
    const name = document.getElementById("teacherNameLeave").value.trim();
    let result = name ? `${name}\n` : "";

    const format = (records, unit) => records.map(e => formatEntry(e, unit)).join("ã€");

    result += appendResultBlock("ç‰¹ä¼‘/è£œä¼‘", totalVDays, totalVHours, vacationRecords);
    result += appendResultBlock("è¶…æ™‚", 0, totalOtHours, overtimeRecords);



    // å…¨å‹¤ç·©è¡
    const totalNoDeductMinutes = lateNoDeductRecords.reduce((sum, r) => sum + (r.minutes || 0), 0);
    const totalMissPunches = punchCardMissRecords.length;

if (totalNoDeductMinutes || totalMissPunches) {
    result += `âœ… å…¨å‹¤ç·©è¡ï¼š`;
    if (totalNoDeductMinutes > 0) {
        result += `é²åˆ°ä¸æ‰£ ${totalNoDeductMinutes} åˆ† ${format(lateNoDeductRecords, "minutes")}`;
    }
    if (totalMissPunches > 0) {
        if (totalNoDeductMinutes > 0) result += "ï¼Œ";
        result += `æ¼æ‰“å¡ ${totalMissPunches} æ¬¡ ${punchCardMissRecords.map(r => `(${r.date} ${r.type})`).join("ã€")}`;
    }
    const totalBuffer = lateNoDeductRecords.length + totalMissPunches;
    if (totalBuffer > 3) result += " âš ï¸ è¶…é 3 æ¬¡ï¼Œå…¨å‹¤å–æ¶ˆ";
    result += "\n";
}
    result += appendResultBlock("é²åˆ°", 0, 0, lateRecords);
    result += appendResultBlock("äº‹å‡", totalPDays, totalPHours, leaveRecords);
    result += appendResultBlock("ç—…å‡", totalSDays, totalSHours, sickRecords);
    result += appendResultBlock("ç”Ÿç†å‡", 0, totalMHours, menstrualRecords, totalMHours > 8 ? "âš ï¸ ç”Ÿç†å‡è¶…éé™é¡ï¼" : "");
    result += appendResultBlock("å®¶åº­ç…§é¡§å‡", 0, totalCGHours, caregiverRecords);
    result += appendResultBlock("å–ªå‡", totalFDays, totalFHours, funeralRecords);

    Object.entries(specialLeaves).forEach(([type, data]) => {
    result += appendResultBlock(type, data.days, data.hours, data.records);
    });

    // ğŸ’¡ é‡è¦ï¼šç‰¹ä¼‘è£œä¼‘é¤˜é¡è¨ˆç®—
    const originalVacationDays = getValue("remainVacationDays");
    const originalVacationHours = getValue("remainVacationHours");

    let rawRemainingDays = originalVacationDays - totalVDays;
    let rawRemainingHours = originalVacationHours + totalOtHours - totalVHours;

    while (rawRemainingHours < 0 && rawRemainingDays > 0) {
        rawRemainingHours += 8;
        rawRemainingDays -= 1;
    }

    rawRemainingHours = Math.floor(rawRemainingHours * 100) / 100;

    const balanceWarning = (rawRemainingDays < 0 || rawRemainingHours < 0) ? " âš ï¸" : "";

    let vacationSummary = '';
    vacationSummary += `ç‰¹ä¼‘è£œä¼‘è¨ˆç®—èªªæ˜ï¼š\n`;
    vacationSummary += `å‰æœˆçµé¤˜ï¼š${originalVacationDays} å¤© ${originalVacationHours} æ™‚\n`;
    vacationSummary += `æ‰£æœ¬æœˆç”¨ï¼š-${totalVDays} å¤© -${totalVHours} æ™‚\n`;
    vacationSummary += `æœ¬æœˆè¶…æ™‚ï¼š+${totalOtHours} æ™‚\n`;
    vacationSummary += `æœ¬æœˆçµé¤˜ï¼š${rawRemainingDays} å¤© ${rawRemainingHours} æ™‚${balanceWarning}\n`;

    // é¡¯ç¤ºåœ¨å¦å¤–ä¸€å€‹å€å¡Š
    document.getElementById("vacationBreakdown").innerText = vacationSummary;
    

    if (rawRemainingDays < 0 || rawRemainingHours < 0) {
        showToast("âš ï¸ ç‰¹ä¼‘è£œä¼‘é€æ”¯äº†ï¼Œè«‹æ³¨æ„ï¼");
    }
    result += `ğŸ“Œ ç‰¹ä¼‘è£œä¼‘çµé¤˜ï¼š${rawRemainingDays} å¤© ${rawRemainingHours} æ™‚${balanceWarning}\n`;

    document.getElementById("resultsLeave").innerText = result;
}


    /**
     * è¤‡è£½å‡åˆ¥çµ±è¨ˆçµæœåˆ°å‰ªè²¼ç°¿ã€‚
     */
    function copyResultsLeave() {
        const resultText = document.getElementById("resultsLeave").innerText;
        if (!resultText) {
            showToast("âš ï¸ å°šæœªç”¢ç”Ÿçµæœ");
            return;
        }
        navigator.clipboard.writeText(resultText).then(() => {
            showToast("å·²è¤‡è£½çµ±è¨ˆçµæœï¼");
        }).catch(() => {
            showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–å…§å®¹ï¼");
        });
    }

    /**
     * å°‡å‡åˆ¥çµ±è¨ˆçµæœåŒ¯å…¥ä¸è¨ˆè–ªè¨ˆç®—å€å¡Šã€‚
     */
    function importLeaveResults() {
        // å¾å…¨å±€è®Šæ•¸ç²å–å·²çµ±è¨ˆçš„æ•¸æ“š
        const totalLeaveDays = leaveRecords.filter(r => r.days).reduce((sum, r) => sum + r.days, 0);
        const totalLeaveHours = leaveRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);
        const totalCaregiverHours = caregiverRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);
        const totalSickDays = sickRecords.filter(r => r.days).reduce((sum, r) => sum + r.days, 0);
        const totalSickHours = sickRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);
        const totalLateMinutes = lateRecords.filter(r => r.minutes).reduce((sum, r) => sum + r.minutes, 0);
        const totalMenstrualHours = menstrualRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);

        // å¡«å…¥è–ªè³‡è¨ˆç®—å€å¡Šçš„è¼¸å…¥æ¡†
        document.getElementById("leaveDaysSalary").value = totalLeaveDays;
        document.getElementById("leaveHoursSalary").value = totalLeaveHours;
        document.getElementById("caregiverHoursSalary").value = totalCaregiverHours;
        document.getElementById("sickDaysSalary").value = totalSickDays;
        document.getElementById("sickHoursSalary").value = totalSickHours;
        document.getElementById("lateMinutesSalary").value = totalLateMinutes;
        document.getElementById("menstrualHoursSalary").value = totalMenstrualHours;

        const teacherNameLeave = document.getElementById("teacherNameLeave").value.trim();
        if (teacherNameLeave) {
            document.getElementById("nameSalary").value = teacherNameLeave;
        }

        showToast("å‡åˆ¥çµ±è¨ˆçµæœå·²åŒ¯å…¥ä¸è¨ˆè–ªè¨ˆç®—ï¼");
    }

    /**
     * è¨ˆç®—è–ªè³‡æ‰£æ¬¾ã€‚
     */
    function calculateSalaryDeduction() {
        const name = document.getElementById("nameSalary").value.trim();
        const salary = getValue("salary"); // æœˆè–ª

        if (salary <= 0) {
            document.getElementById("salaryResult").innerText = "âš ï¸ è«‹å¡«å…¥åŸå§‹æœˆè–ª";
            return;
        }

        // å¾è¼¸å…¥æ¡†ç²å–å‡åˆ¥å¤©æ•¸/æ™‚æ•¸
        const leaveDays = getValue("leaveDaysSalary");
        const leaveHours = getValue("leaveHoursSalary");
        const sickDays = getValue("sickDaysSalary");
        const sickHours = getValue("sickHoursSalary");
        const lateMinutes = getValue("lateMinutesSalary");
        const menstrualHours = getValue("menstrualHoursSalary");
        const caregiverHours = getValue("caregiverHoursSalary");
        const cashOutDays = getValue("cashOutDaysSalary");
        const cashOutHours = getValue("cashOutHoursSalary");

        // ç”Ÿæˆè©³ç´°è¨˜éŒ„è¨»é‡‹
        const leaveDaysNote = leaveRecords.filter(r => r.days).map(record => `ï¼ˆ${record.date} ${record.days}å¤©ï¼‰`).join('');
        const leaveHoursNote = leaveRecords.filter(r => r.hours).map(record => `ï¼ˆ${record.date} ${record.hours}æ™‚ï¼‰`).join('');
        const sickDaysNote = sickRecords.filter(r => r.days).map(record => `ï¼ˆ${record.date} ${record.days}å¤©ï¼‰`).join('');
        const sickHoursNote = sickRecords.filter(r => r.hours).map(record => `ï¼ˆ${record.date} ${record.hours}æ™‚ï¼‰`).join('');
        const lateNote = lateRecords.map(record => `ï¼ˆ${record.date} ${record.minutes}åˆ†ï¼‰`).join('');
        const menstrualNote = menstrualRecords.map(record => `ï¼ˆ${record.date} ${record.hours}æ™‚ï¼‰`).join('');
        const caregiverNote = caregiverRecords.map(record => `ï¼ˆ${record.date} ${record.hours}æ™‚ï¼‰`).join('');


        // è¨ˆç®—åŸå§‹æœªå–æ•´çš„æ‰£æ¬¾é‡‘é¡
        const rawLeaveDayDeduct = (salary / 30) * leaveDays;
        const rawLeaveHourDeduct = (salary / 30 / 8) * leaveHours;
        const rawCaregiverHourDeduct = (salary / 30 / 8) * caregiverHours; // å®¶åº­ç…§é¡§å‡(æ™‚)ï¼šèˆ‡äº‹å‡ç›¸åŒ
        const rawSickDayDeduct = (salary / 30 / 2) * sickDays; // åŠè–ª
        const rawSickHourDeduct = (salary / 30 / 8 / 2) * sickHours; // åŠè–ª
        const rawLateDeduct = (salary / 30 / 8 / 60) * lateMinutes; 
        const rawMenstrualDeduct = (salary / 30 / 8 / 2) * menstrualHours; // åŠè–ª

        // è¨ˆç®—åŸå§‹æœªå–æ•´çš„æŠ˜ç¾é‡‘é¡
        const rawCashOutDayBonus = (salary / 30) * cashOutDays;
        const rawCashOutHourBonus = (salary / 30 / 8) * cashOutHours;

        // æœ€çµ‚åŠ ç¸½æ™‚å†é€²è¡Œå››æ¨äº”å…¥
        const totalDeduct = Math.round(
        rawLeaveDayDeduct + rawLeaveHourDeduct +
        rawSickDayDeduct + rawSickHourDeduct +
        rawLateDeduct + rawMenstrualDeduct +
        rawCaregiverHourDeduct
        );

        const totalCashOutBonus = Math.round(rawCashOutDayBonus + rawCashOutHourBonus);

        let formula = `${name ? name + "ï¼š" : ""}æ˜ç´°å¦‚ä¸‹ï¼š\n`;

        // é¡¯ç¤ºæ‰£è–ªæ˜ç´°
        if (leaveDays) formula += `â–äº‹å‡ ${leaveDays}å¤© Ã— ${salary}/30 = ${Math.round(rawLeaveDayDeduct)}å…ƒ ${leaveDaysNote}\n`;
        if (leaveHours) formula += `â–äº‹å‡ ${leaveHours}æ™‚ Ã— ${salary}/30/8 = ${Math.round(rawLeaveHourDeduct)}å…ƒ ${leaveHoursNote}\n`;
        if (caregiverHours) formula += `â–å®¶åº­ç…§é¡§å‡ ${caregiverHours}æ™‚ Ã— ${salary}/30/8 = ${Math.round(rawCaregiverHourDeduct)}å…ƒ ${caregiverNote}\n`;
        if (sickDays) formula += `â–ç—…å‡ ${sickDays}å¤© Ã— ${salary}/30/2 = ${Math.round(rawSickDayDeduct)}å…ƒ ${sickDaysNote}\n`;
        if (sickHours) formula += `â–ç—…å‡ ${sickHours}æ™‚ Ã— ${salary}/30/8/2 = ${Math.round(rawSickHourDeduct)}å…ƒ ${sickHoursNote}\n`;
        if (lateMinutes) formula += `â–é²åˆ° ${lateMinutes}åˆ† Ã— ${salary}/30/8/60 = ${Math.round(rawLateDeduct)}å…ƒ ${lateNote}\n`;
        if (menstrualHours) formula += `â–ç”Ÿç†å‡ ${menstrualHours}æ™‚ Ã— ${salary}/30/8/2 = ${Math.round(rawMenstrualDeduct)}å…ƒ ${menstrualNote}\n`;

        formula += `ä¸æ”¯è–ªé‡‘é¡ï¼š${totalDeduct} å…ƒ\n`;

        // é¡¯ç¤ºæŠ˜ç¾æ˜ç´°
        if (cashOutDays) formula += `â•æŠ˜ç¾ ${cashOutDays}å¤© Ã— ${salary}/30 = ${Math.round(rawCashOutDayBonus)}å…ƒ\n`;
        if (cashOutHours) formula += `â•æŠ˜ç¾ ${cashOutHours}æ™‚ Ã— ${salary}/30/8 = ${Math.round(rawCashOutHourBonus)}å…ƒ\n`;
        if (cashOutDays || cashOutHours) formula += `æŠ˜ç¾ç¸½é‡‘é¡ï¼š${totalCashOutBonus} å…ƒ\n`;

        document.getElementById("salaryResult").innerText = formula;
    }

    /**
     * è¤‡è£½è–ªè³‡è¨ˆç®—çµæœåˆ°å‰ªè²¼ç°¿ã€‚
     */
    function copyResultsSalary() {
        const text = document.getElementById("salaryResult").innerText;
        if (!text) {
            showToast("âš ï¸ å°šæœªç”¢ç”Ÿçµæœ");
            return;
        }
        navigator.clipboard.writeText(text)
            .then(() => showToast("âœ… å·²è¤‡è£½ç®—å¼ï¼"))
            .catch(err => showToast("âŒ è¤‡è£½å¤±æ•—ï¼š" + err));
    }
    function importToAll() {
     // å…ˆé‡æ–°è¨ˆç®—ï¼Œç¢ºä¿ resultsLeave èˆ‡å„å…¨åŸŸè¨˜éŒ„æ˜¯æœ€æ–°
     calculateLeave();

     // å…ˆæŠŠçµ±è¨ˆæ•¸æ“šåŒ¯å…¥åˆ°ã€Œä¸æ”¯è–ªã€å€å¡Š
     importLeaveResults();

     // å†é€åˆ° iframeï¼ˆç¼ºå‹¤åˆ†æé ï¼‰
     sendToIframe();

     showToast("âœ… å·²åŒ¯å…¥ç¼ºå‹¤åˆ†æèˆ‡ä¸æ”¯è–ªè¨ˆç®—");
    }


    /**
     * å°‡å‡åˆ¥æ•¸æ“šç™¼é€çµ¦ iframeã€‚
     */
    function sendToIframe() {
        const data = (document.getElementById('resultsLeave').innerText || '').trim();
        if (!data) {
            showToast("âš ï¸ æ²’æœ‰å¯å‚³é€çš„çµ±è¨ˆè³‡æ–™ï¼Œè«‹å…ˆè¼¸å…¥æˆ–é»è¡¨æ ¼æ¬„ä½è®“ç³»çµ±é‡ç®—");
            return;
        }
        
        const iframe = document.getElementById('absenceFrame');
        if (!iframe || !iframe.contentWindow) {
            showToast("âš ï¸ æ‰¾ä¸åˆ°ç¼ºå‹¤åˆ†æçš„ iframeï¼ˆabsenceFrameï¼‰");
            return;
        }
        
        if (!window.absenceFrameReady) {
            showToast("âŒ›ï¸ åˆ†æé é¢å°šåœ¨è¼‰å…¥ä¸­ï¼Œç¨å¾Œå†è©¦");
            return;
        }
        
        iframe.contentWindow.postMessage(
            { type: 'IMPORT_LEAVE_DATA', payload: data },
            'https://zh22331997.github.io' // å¿…é ˆç²¾æº–åŒ¹é… iframe çš„ä¾†æº
             );
            }



    // --- DOM åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ– (Initialization on DOMContentLoaded) ---
    window.addEventListener("DOMContentLoaded", () => {
        // è¨­å®šé è¨­æœˆä»½ç‚ºä¸Šå€‹æœˆ
        let now = new Date();
        let prevMonth = now.getMonth(); // 0 = ä¸€æœˆ

        if (prevMonth === 0) { // å¦‚æœç¾åœ¨æ˜¯ä¸€æœˆï¼Œå‰‡ä¸Šå€‹æœˆæ˜¯å»å¹´åäºŒæœˆ
            document.getElementById("monthInput").value = 12;
            document.getElementById("yearInput").value = now.getFullYear() - 1;
        } else {
            document.getElementById("monthInput").value = prevMonth;
            document.getElementById("yearInput").value = now.getFullYear();
        }

        // è¨­å®šå¹´ä»½ç‚ºç•¶å‰å¹´ä»½
        document.getElementById("yearInput").value = new Date().getFullYear();

        generateTable(); // åˆå§‹åŒ–æ™‚ç”Ÿæˆè¡¨æ ¼

        // ç›£è½å¹´ä»½å’Œæœˆä»½çš„è®ŠåŒ–ï¼Œé‡æ–°ç”Ÿæˆè¡¨æ ¼
        document.getElementById("yearInput").addEventListener("change", generateTable);
        document.getElementById("monthInput").addEventListener("change", generateTable);

        // ç¦æ­¢æ»¾è¼ªæ”¹è®Šæ•¸å­—è¼¸å…¥æ¡†çš„å€¼
        document.addEventListener('wheel', function(e) {
            if (document.activeElement && document.activeElement.type === 'number') {
                e.preventDefault(); // é˜»æ­¢æ»¾è¼ªé è¨­è¡Œç‚º
                document.activeElement.blur(); // ç§»é™¤ focus é¿å…æ•¸å€¼è¢«æ”¹å‹•
            }
        }, { passive: false });

        // è®“çˆ¶é çŸ¥é“ iframe ä»€éº¼æ™‚å€™è¼‰å¥½
        const absFrame = document.getElementById('absenceFrame');
        window.absenceFrameReady = false;
        if (absFrame) {
                        absFrame.addEventListener('load', () => {
    window.absenceFrameReady = true;
  });
}
   



    });
    function toggleBalanceInfo() {
    const block = document.getElementById("balanceDetails");
    block.style.display = block.style.display === "none" ? "block" : "none";
}
</script>
</body>
</html>

