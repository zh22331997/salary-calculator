<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>打卡紀錄分析（合併 PT 工時計算）</title>
<style>
/* ===== Compact theme ===== */
*,*::before,*::after{box-sizing:border-box}
:root{
  --bg:#f7f7fb; --card:#fff; --ink:#1f2937; --muted:#6b7280; --border:#e5e7eb;
  --fs:14px; --lh:1.4;
  --s1:6px; --s2:8px; --s3:10px; --s4:12px;
  --r-sm:8px; --r-md:12px;
}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","Segoe UI",Roboto,Arial,"PingFang TC","Microsoft JhengHei","Helvetica Neue",sans-serif;font-size:var(--fs);line-height:var(--lh)}
.wrap{max-width:1200px;margin:24px auto;padding:0 var(--s3)}
.title{display:flex;align-items:center;justify-content:space-between;gap:var(--s3);flex-wrap:wrap}
.title h1{margin:0;font-size:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r-md);box-shadow:0 1px 3px rgba(0,0,0,.04);padding:var(--s4)}
.row{display:flex;gap:var(--s3);align-items:center;flex-wrap:wrap}
label{font-size:12px;color:#334155;margin-bottom:var(--s1);display:block}
input[type=text],textarea{width:100%;border:1px solid var(--border);border-radius:var(--r-md);padding:8px 10px;font-size:var(--fs)}
textarea{height:220px;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;resize:vertical}
button{appearance:none;border:0;border-radius:var(--r-sm);background:#e3f2fd;color:#1565c0;padding:8px 12px;font-weight:600;cursor:pointer;display:inline-flex;gap:8px}
button:hover{background:#cde5fd}
button.secondary{background:#f1f5f9;color:#334155}
button.secondary:hover{background:#e2e8f0}
button.pill{padding:4px 8px;border-radius:999px;font-size:12px}
.muted{color:var(--muted);font-size:12px;margin-top:6px}
.breakdown{white-space:pre-wrap} /* 第4欄明細換行更漂亮 */

table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:var(--fs);line-height:1.35}
th,td{border:1px solid var(--border);padding:6px 8px;vertical-align:middle}
th{background:#f3f4f6;text-align:left}
.hint{font-size:12px;color:var(--muted)}
.danger{color:#dc2626;font-weight:700}

/* wrap 最後一欄可換行 */
#out table td:last-child,#out table th:last-child{overflow-wrap:anywhere;word-break:break-word}

/* 可編輯欄位 */
.editable{background:#fffdf5}
.editable:focus{outline:2px solid #fde68a}
/* === Tables: shared column widths & alignment === */
:root{
  /* 主表 / PT工時 共用欄寬 */
  --w-ym: 90px;
  --w-branch: 120px;
  --w-name: 120px;
  --w-type: 160px;
  --w-subtotal: 120px;

  /* 不支薪明細 表的欄寬（姓名沿用主表） */
  --w-nopay-salary: 120px;
  --w-nopay-info: 320px;     /* 你可再調大/小 */
  --w-nopay-detail: 360px;   /* 你可再調大/小 */
  --w-nopay-full: 110px;
}

/* 數字右對齊（小計／工時／金額） */
td.num, th.num{ text-align:right }

/* 讓表格永遠使用固定欄寬（避免因內容長度而撐開） */
#out table{ table-layout: fixed }

/* toast */
.toast-wrap{position:fixed;right:16px;bottom:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.12);max-width:520px;font-size:13px}
.toast b{color:#fca5a5}
</style>
</head>
<body>
<div class="wrap">
  <div class="title"><h1>貼上打卡之星匯出的「打卡紀錄」</h1></div>
  <div class="muted">先輸入 PT 姓名（可多位），再貼上打卡資料，一鍵同時完成分析與 PT 工時計算。一天工時固定 <b>8 小時</b>（僅供請假/加班換算用）。</div>

  <div class="card" style="margin-top:12px">
    <div class="row">
      <div style="flex:1;min-width:280px">
        <label for="names">PT 姓名（逗號、空白或頓號分隔）</label>
        <input id="names" type="text" placeholder="例如：張正華, 王小明" />
      </div>
    </div>
    <div style="margin-top:12px">
      <label for="raw">打卡紀錄（含或不含表頭；欄位以 Tab 或兩個以上空白分隔）</label>
      <textarea id="raw" placeholder="在這裡貼上原始資料"></textarea>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="run">整理＋計算</button>
      <button id="clear" class="secondary">清空</button>
    </div>
  </div>

  <div id="out" class="card" style="margin-top:12px">
    <div class="hint">尚未輸出。</div>
  </div>
</div>

<div id="toast" class="toast-wrap" aria-live="polite"></div>

<script>
/* ===== 全域錯誤攔截 ===== */
window.addEventListener('error', e => {
  try { toast(`程式錯誤：<b>${e.message}</b>，詳見 Console。`, 8000); } catch(_) { alert(e.message); }
});
window.addEventListener('unhandledrejection', e => {
  try { toast(`非預期錯誤：<b>${(e.reason && e.reason.message) || e.reason}</b>`, 8000); } catch(_) {}
});

(function(){
  const $ = s=>document.querySelector(s);

  /* ===== 參數 ===== */
  const DAY_HRS = 8;                 // 一天 8 小時
  const PAY_DIV_DAYS = 30;           // 請假扣薪天數基準
  const FREE_LATE_COUNT = 3;         // 遲到免扣筆數
  const FREE_LATE_MIN   = 5;         // 遲到免扣分鐘（<=5）
  const COUNT_TYPES = new Set(["漏打卡","非出勤日打卡","其他異常"]);
  // 全不支
  const FULL_UNPAID_TYPES = new Set(["事假","家庭照顧假"]);
  // 半薪不支
  const HALF_UNPAID_TYPES = new Set(["病假","有薪病假","生理假"]);

  const HEADERS_DEFAULT = [
    "員工編號","姓名","部門","打卡日期","日期類別","班別","表定上班時間","表定下班時間",
    "休息時間","表定工時","打卡工時","計薪基準工時","上班打卡時間","遲到","下班打卡時間","早退",
    "出勤異常","提早上班原因","上班打卡方式","上班打卡地點","上班地點異常，不在範圍內的原因",
    "延後下班原因","下班打卡方式","下班打卡地點","下班地點異常，不在範圍內的原因",
    "請假時間","請假時數","假別","加班時間","加班時數"
  ];

  /* ===== 綁定按鈕 ===== */
  const btnRun = $("#run");
  if (btnRun) btnRun.addEventListener("click", () => { try { run(); } catch (err){ console.error(err); toast(`執行失敗：<b>${err.message}</b>`, 8000);} });
  else toast('找不到 id="run" 的按鈕', 6000);

  $("#clear").addEventListener("click", ()=>{
    $("#names").value=""; $("#raw").value=""; $("#out").innerHTML='<div class="hint">尚未輸出。</div>';
  });
  $("#names").addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); run(); } });

  /* ===== 主程序 ===== */
  function run(){
    const wantedNames = ($("#names").value||"").trim().split(/[,\s、，]+/).map(s=>s.trim()).filter(Boolean);
    const text = ($("#raw").value||"").trim();
    const out = $("#out");
    if(!text){ out.innerHTML = '<div class="hint">（請先貼上打卡資料）</div>'; return; }

    const {headers, rows, err} = tsvParse(text);
    if(err){ out.innerHTML = `<div style="color:#dc2626">解析失敗：${err}</div>`; return; }

    // 欄位映射
    const H_DATE   = pickHeader(headers,/打卡日期/,"打卡日期");
    const H_NAME   = pickHeader(headers,/姓名/,"姓名");
    const H_BRANCH = pickHeader(headers,/分校|部門/,"部門");
    const H_LEAVE_H    = pickHeader(headers,/請假時數/,"請假時數");
    const H_LEAVE_KIND = pickHeader(headers,/假別/,"假別");
    const H_OT_H     = pickHeader(headers,/^(加班時數|加班工時)$/,"加班時數");
    const H_OT_TIME  = pickHeader(headers,/^加班時間$/,"加班時間");
    const H_ABN   = pickHeader(headers,/出勤異常/,"出勤異常");
    const H_EARLY_REASON = pickHeader(headers,/提早上班原因/,"提早上班原因");
    const H_LATE_REASON  = pickHeader(headers,/延後下班原因/,"延後下班原因");
    const H_IN    = pickHeader(headers,/上班打卡時間/,"上班打卡時間");
    const H_OUT   = pickHeader(headers,/下班打卡時間/,"下班打卡時間");

    const aggMap   = new Map();    // 主表彙總 ym|branch|name|type -> rec
    const workAgg  = new Map();    // PT 工時計算 ym|branch|name -> {hours, detail}
    const missingPairs = [];       // 缺成對
    const allCombos = new Set();   // 所有人 ym|branch|name

    // 掃描資料
    rows.forEach(r=>{
      const dateStr = (r[H_DATE]||"").trim();
      const ym = toYM(dateStr);
      const md = toMD(dateStr);
      const name = (r[H_NAME]||"").trim();
      const branch = (r[H_BRANCH]||"").trim();
      const abn = (r[H_ABN]||"").trim();
      if(!ym || !name) return;
      allCombos.add(`${ym}|${branch}|${name}`);

      // 打卡配對：上班進位、下班捨去（30 分）
      const inMin  = parseHM(String(r[H_IN]||""));
      const outMin = parseHM(String(r[H_OUT]||""));
      if (inMin!=null && outMin!=null){
        const inAdj  = Math.ceil(inMin/30)*30;
        const outAdj = Math.floor(outMin/30)*30;
        const durMins = Math.max(0, outAdj - inAdj);
        const durHrs  = durMins/60;
        if (durHrs>0){
          const k = `${ym}|${branch}|${name}`;
          const rec = workAgg.get(k) || {ym, branch, name, hours:0, detail:[] };
          rec.hours += durHrs;
          rec.detail.push(`${md} ${fmtHours(durHrs)}`);
          workAgg.set(k, rec);
        }
      }else if ((inMin==null) !== (outMin==null)){
        const which = (inMin==null) ? "缺上班" : "缺下班";
        missingPairs.push({ym,branch,name,md,which,rawIn:String(r[H_IN]||"—"),rawOut:String(r[H_OUT]||"—")});
      }

      // 請假（小時計）
      const leaveKind = (r[H_LEAVE_KIND]||"").replace(/\s/g,"");
      const leaveH = hhmmToHours(r[H_LEAVE_H]);
      if(leaveKind && leaveKind!=="--" && leaveH>0){
        addAgg(aggMap, ym, branch, name, leaveKind, leaveH, `${md} ${fmtHours(leaveH)}`);
      }

      // 加班
      const otFromTime = hhmmToHours(r[H_OT_TIME]);
      const otH = H_OT_H && r[H_OT_H] ? toNumber(r[H_OT_H]) : 0;
      const ot = (otFromTime || 0) > 0 ? otFromTime : otH;
      if (ot>0) addAgg(aggMap, ym, branch, name, "超時", ot, `${md} ${fmtHours(ot)}`);

      // 招生(加班)偵測
      const reasonText = String(r[H_EARLY_REASON]||"") + " " + String(r[H_LATE_REASON]||"");
      if (/招生/.test(reasonText)){
        let otRecruit=0;
        const m = reasonText.match(/招生.*?(\d+(?:\.\d+)?)\s*小時/);
        if (m) otRecruit = Number(m[1]);
        if (otRecruit>0) addAgg(aggMap, ym, branch, name, "招生(加班)", otRecruit, `${md} ${fmtHours(otRecruit)}`);
        else addAgg(aggMap, ym, branch, name, "招生(待確認)", {cnt:1}, `${md} 招生？小時`, true);
      }

      // 出勤異常
      if (abn && abn!=="--"){
        const parts = String(abn).split(/、/).map(s=>s.trim()).filter(Boolean);
        parts.forEach(p=>{
          let m = p.match(/遲到\s*(\d+)\s*分/);
          if (m){ const mins=+m[1]; const typ=/不扣/.test(p)?"遲到(不扣)":"遲到(要扣)";
            addAgg(aggMap, ym, branch, name, typ, {mins,cnt:1}, `${md} ${mins}分鐘`, true); return;}
          m = p.match(/早退\s*(\d+)\s*分/);
          if (m){ const mins=+m[1]; addAgg(aggMap, ym, branch, name, "早退",{mins,cnt:1}, `${md} ${mins}分鐘`, true); return;}
          m = p.match(/曠職\s*(\d+)\s*分/);
          if (m){ const mins=+m[1]; addAgg(aggMap, ym, branch, name, "曠職",{mins,cnt:1}, `${md} ${mins}分鐘`, true); return;}

          // 漏打卡計次
          const timesM = p.match(/(\d+)\s*次/);
          let totalTimes = timesM ? Number(timesM[1]) : 0;
          const upMiss   = (p.match(/上班未打卡/gi)||[]).length;
          const downMiss = (p.match(/下班未打卡/gi)||[]).length;
          const plainMiss= (!upMiss && !downMiss) ? (p.match(/漏打卡/gi)||[]).length : 0;
          if (!timesM) totalTimes = upMiss + downMiss + plainMiss;
          if (totalTimes>0){
            for(let i=0;i<upMiss;i++)   addAgg(aggMap, ym, branch, name, "漏打卡",{miss:1}, `${md} 上班`, true);
            for(let i=0;i<downMiss;i++) addAgg(aggMap, ym, branch, name, "漏打卡",{miss:1}, `${md} 下班`, true);
            for(let i=0;i<Math.max(0,totalTimes-upMiss-downMiss);i++)
              addAgg(aggMap, ym, branch, name, "漏打卡",{miss:1}, `${md}`, true);
            return;
          }
          if (/時間由忘打卡單建立/.test(p)){
            const when = /上班/.test(p) ? "上班" : (/下班/.test(p) ? "下班" : "");
            addAgg(aggMap, ym, branch, name, "補打卡單",{cnt:1}, `${md} ${when}`, true); return;
          }
          if (p && p!=="--" && !/非出勤日打卡/.test(p)){
            addAgg(aggMap, ym, branch, name, "其他異常",{cnt:1}, `${md} ${p}`, true);
          }
        });
      }
    }); // foreach rows

    // 遲到免扣（<=5 分鐘取最多 3 筆）
    for (const [key, rec] of aggMap.entries()){
      const [ym, branch, name, typ] = key.split("|");
      if (typ==="遲到(要扣)" && Array.isArray(rec._lateEvents) && rec._lateEvents.length){
        const cands = rec._lateEvents.filter(e=>e.mins>0 && e.mins<=FREE_LATE_MIN)
                                     .sort((a,b)=> (b.mins-a.mins) || a.detail.localeCompare(b.detail));
        const waived = cands.slice(0, FREE_LATE_COUNT);
        const set = new Set(waived.map(e=>e.detail));
        let mSum=0,cnt=0;
        waived.forEach(e=>{
          mSum+=e.mins; cnt++;
          addAgg(aggMap, ym, branch, name, "遲到(不扣)", {mins:e.mins,cnt:1}, `${e.detail}（免扣）`, true);
        });
        rec.totalMins=Math.max(0,rec.totalMins-mSum);
        rec.count=Math.max(0,rec.count-cnt);
        rec.detail=rec.detail.filter(d=>!set.has(d));
        aggMap.set(key,rec);
      }
    }

    // 主表輸出
    const rowsOut = [];
    for (const [key, val] of aggMap.entries()){
      const [ym, branch, name, typ] = key.split("|");
      let subtotal="", remark="";
      if (typ==="招生(待確認)"){
        subtotal="？小時"; remark=val.detail.join("、");
        rowsOut.push([ym,branch,name,typ,subtotal,remark]); continue;
      }
      if (COUNT_TYPES.has(typ)){
        if ((val.count||0)===0) continue;
        subtotal=`${val.count} 次`; remark=val.detail.join("、");
        rowsOut.push([ym,branch,name,typ,subtotal,remark]); continue;
      }
      if (/^(?:遲到|早退|曠職)/.test(typ)){
        if ((val.totalMins||0)===0 && (val.count||0)===0) continue;
        subtotal=`${val.totalMins} 分鐘（${val.count} 次）`;
        remark=val.detail.join("、");
        rowsOut.push([ym,branch,name,typ,subtotal,remark]); continue;
      }
      const hours = Number(val.totalHours||0);
      if (hours===0) continue;
      subtotal = fmtHours(hours);
      remark   = val.detail.join("、");
      rowsOut.push([ym,branch,name,typ,subtotal,remark]);
    }
    rowsOut.sort((a,b)=> a[0].localeCompare(b[0]) || a[1].localeCompare(b[1]) || a[2].localeCompare(b[2]) || a[3].localeCompare(b[3]));

    // 非全勤名單（只用於扣全勤標示）
    const notFullMap = new Map();
    for (const [k,v] of aggMap.entries()){
      const [ym, branch, name, typ] = k.split("|");
      const key2 = `${ym}|${branch}|${name}`;
      const rec = notFullMap.get(key2)||{ym,branch,name,reasons:[]};
      if (typ==="遲到(要扣)" && (v.count||0)>0) rec.reasons.push(`遲到(要扣)${v.count}次`);
      if ((typ==="事假"||typ==="病假"||typ==="有薪病假") && (v.totalHours||0)>0) rec.reasons.push(`${typ}${fmtHoursNum(v.totalHours)}小時`);
      if (typ==="漏打卡" && (v.count||0)>3) rec.reasons.push(`漏打卡${v.count}次`);
      notFullMap.set(key2,rec);
    }
    const notFullRows = [...notFullMap.values()].filter(x=>x.reasons.length>0);

    // PT 工時（加上缺成對提醒）
    const yms = new Set([...workAgg.values()].map(r=>r.ym));
    const latestYM = [...yms].sort().pop();
    const ptRows=[];
    if (latestYM){
      const list = [...workAgg.values()].filter(r=>r.ym===latestYM);
      const setWanted = new Set(wantedNames);
      const baseList = (setWanted.size>0) ? list.filter(r=>setWanted.has(r.name)) : list;

      const missByPerson = new Map();
      missingPairs.filter(m=>m.ym===latestYM).forEach(m=>{
        const k = `${m.branch}|${m.name}`;
        const arr = missByPerson.get(k)||[]; arr.push(m.md+" "+m.which); missByPerson.set(k,arr);
      });
      baseList.forEach(x=>{
        const key = `${x.branch}|${x.name}`;
        const warns = missByPerson.get(key)||[];
        if (warns.length) x.detail.push(`⚠️ 缺成對 ${warns.length} 筆：${warns.join("、")}`);
      });

      const found = new Set(baseList.map(r=>r.name));
      if (setWanted.size>0){
        wantedNames.forEach(n=>{ if(!found.has(n)) ptRows.push({ym:latestYM,branch:"—",name:n,hours:0,detail:["（未找到成對上下班打卡）"]}); });
      }
      ptRows.push(...baseList);
      ptRows.sort((a,b)=> a.branch.localeCompare(b.branch)||a.name.localeCompare(b.name));
    }

    /* ===== 畫面輸出 ===== */
    let html = "";

    // 主表
    const headerRow = ["年月","分校","姓名","假別/類型","小計","備註"];
    const thead = `<thead><tr>${
    headerRow.map((h,i)=>`<th${i===4?' class="num"':''}>${h}</th>`).join("")
    }</tr></thead>`;
    const tbody = `<tbody>${
      rowsOut.map(r=>`<tr>${
      r.map((c,i)=>{
      const isDanger = (i===3 && /^(早退|曠職)$/.test(String(c)));
      const isNum = (i===4); // 第5欄：小計
      const cls = [isDanger?'danger':'', isNum?'num':''].filter(Boolean).join(' ');
      return `<td${cls?` class="${cls}"`:''}>${escapeHtml(c)}</td>`;
      }).join("")
     }</tr>`).join("")
    }</tbody>`;

    const colgroupMain = `<colgroup>
      <col style="width:var(--w-ym)">
      <col style="width:var(--w-branch)">
      <col style="width:var(--w-name)">
      <col style="width:var(--w-type)">
      <col style="width:var(--w-subtotal)">
      <col style="width:auto">
    </colgroup>`;

    html += `<div class="hint" style="margin-bottom:8px">
      共 ${rowsOut.length} 列，
      <button id="copyTSV" class="pill">複製給Candy的表格</button>
      <button id="copyAllTSV" class="pill">複製給Candy+PT總時數表格</button>
      可貼回 Google Sheet。
      </div>
      <div style="overflow:auto"><table data-kind="main">${colgroupMain}${thead}${tbody}</table></div>`;


    // PT 工時
       if (ptRows.length>0){
       const headerPT = ["年月","分校","姓名","本月工時","每日明細"];
    // 表頭第 4 欄（本月工時）右對齊
       const theadPT = `<thead><tr>${
       headerPT.map((h,i)=>`<th${i===3?' class="num"':''}>${h}</th>`).join("")
       }</tr></thead>`;

    // 表身第 4 欄加上 class="num"
       const tbodyPT = `<tbody>${
       ptRows.map(r=>`<tr>
       <td>${escapeHtml(r.ym)}</td>
       <td>${escapeHtml(r.branch)}</td>
       <td>${escapeHtml(r.name)}</td>
       <td class="num">${escapeHtml(fmtHoursNum(r.hours))}</td>
       <td>${escapeHtml(r.detail.join("、"))}</td>
         </tr>`).join("")
       }</tbody>`;

  // 套用共用欄寬
  const colgroupPT = `<colgroup>
    <col style="width:var(--w-ym)">
    <col style="width:var(--w-branch)">
    <col style="width:var(--w-name)">
    <col style="width:var(--w-subtotal)">
    <col style="width:auto">
  </colgroup>`;

  html += `<div class="hint" style="margin:16px 0 8px">
    本月（${escapeHtml(latestYM||"—")}）PT 工時彙總，共 ${ptRows.length} 筆
  </div>
  <div style="overflow:auto; margin-bottom:16px">
    <table data-kind="pt">${colgroupPT}${theadPT}${tbodyPT}</table>
  </div>`;
  }


    // 不支薪送財務總表
    if (latestYM){
      const getHours = (ym, branch, name, typ) => {
        const rec = aggMap.get(`${ym}|${branch}|${name}|${typ}`);
        return rec ? Number(rec.totalHours||0) : 0;
      };
      const getLateMins = (ym, branch, name) => {
        const rec = aggMap.get(`${ym}|${branch}|${name}|遲到(要扣)`);
        return rec ? Number(rec.totalMins || 0) : 0;
      };

      const everyoneThisMonth = [...new Set(
        [...allCombos].map(k=>k.split("|")).filter(([ym])=>ym===latestYM).map(([ym,branch,name])=>`${branch}|${name}`)
      )];
      const notFullSet = new Set(
        (notFullRows||[]).filter(r=>r.ym===latestYM).map(r=>`${r.ym}|${r.branch}|${r.name}`)
      );

      const rowsPay = [];
      for (const key of everyoneThisMonth) {
        const [branch, name] = key.split("|");
        const hLeave      = getHours(latestYM,branch,name,"事假");
        const hCare       = getHours(latestYM,branch,name,"家庭照顧假");
        const hSick       = getHours(latestYM,branch,name,"病假");
        const hPaidSick   = getHours(latestYM,branch,name,"有薪病假");
        const hMenstrual  = getHours(latestYM,branch,name,"生理假");
        const lateMin     = getLateMins(latestYM,branch,name);

        const parts = [];
        if (hLeave)     parts.push(`事假 ${fmtHoursNum(hLeave)}小時`);
        if (hCare)      parts.push(`家庭照顧假 ${fmtHoursNum(hCare)}小時`);
        if (hSick)      parts.push(`病假 ${fmtHoursNum(hSick)}小時（半薪）`);
        if (hPaidSick)  parts.push(`有薪病假 ${fmtHoursNum(hPaidSick)}小時（半薪）`);
        if (hMenstrual) parts.push(`生理假 ${fmtHoursNum(hMenstrual)}小時（半薪）`);
        if (lateMin)    parts.push(`遲到 ${lateMin}分`);

        const 扣全勤 = notFullSet.has(`${latestYM}|${branch}|${name}`) ? "是" : "否";
        rowsPay.push({
          name,
          info: parts.join("、") || "—",
          hLeave,hCare,hSick,hPaidSick,hMenstrual,lateMin,
          扣全勤
        });
      }

      if (rowsPay.length){
        const headerPay = ["姓名","本薪","各種不支薪假別天數/時數(含遲到要扣)","不支薪明細 不支薪總額","是否扣全勤"];
        const colPay = `<colgroup>
          <col style="width:120px">
          <col style="width:120px"><col>
          <col style="width:280px">
          <col style="width:110px">
        </colgroup>`;
        const theadPay = `<thead><tr>${headerPay.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
        const tbodyPay = `<tbody>${
          rowsPay.map(r=>`<tr
              data-hleave="${r.hLeave||0}"
              data-hcare="${r.hCare||0}"
              data-hsick="${r.hSick||0}"
              data-hpaidsick="${r.hPaidSick||0}"
              data-hmenstrual="${r.hMenstrual||0}"
              data-late="${r.lateMin||0}">
            <td>${escapeHtml(r.name)}</td>
            <td contenteditable="plaintext-only" class="editable" data-col="salary" title="輸入月薪"></td>
            <td>${escapeHtml(r.info)}</td>
            <td class="breakdown" data-col="nopayDetail" contenteditable="false"></td>
            <td>${escapeHtml(r.扣全勤)}</td>
          </tr>`).join("")
        }</tbody>`;

        html += `
          <div class="hint" style="margin:16px 0 8px">
            不支薪明細表（${escapeHtml(latestYM)}）
            <button id="copyNoPayTSV" class="pill" style="margin-left:8px">複製不支薪明細表（TSV）</button>
          </div>
          <div style="overflow:auto; margin-bottom:16px">
            <table id="noPayTable">${colPay}${theadPay}${tbodyPay}</table>
          </div>`;
      }
    }

    $("#out").innerHTML = html;

    /* ===== 綁定：主表/整頁複製 ===== */
    const lastTSV = [ ["年月","分校","姓名","假別/類型","小計","備註"], ...rowsOut ]
      .map(cols=>cols.map(v=>String(v??"").replaceAll("\t"," ")).join("\t")).join("\n");
    $("#out #copyTSV")?.addEventListener("click", ()=>{
    navigator.clipboard.write([
    new ClipboardItem({
      "text/html": new Blob([`<table>${thead}${tbody}</table>`], { type: "text/html" }),
      "text/plain": new Blob([lastTSV], { type: "text/plain" })
    })
  ]).then(()=>toast("已複製給Candy的表，可貼到 Google Sheet！", 3000));
});


    const allTSVParts = [];
    allTSVParts.push("【給Candy的表】");
    allTSVParts.push(lastTSV);
    if (typeof ptRows!=="undefined" && ptRows.length>0){
      const headerPT = ["年月","分校","姓名","本月工時(小時)","每日明細(整點半點上下班，漏打卡提醒)"];
      const rowsPT = ptRows.map(r => [r.ym, r.branch, r.name, fmtHoursNum(r.hours), r.detail.join("、")]);
      allTSVParts.push("【PT工時彙總】");
      allTSVParts.push([headerPT, ...rowsPT].map(cols=>cols.join("\t")).join("\n"));
    }
    $("#out #copyAllTSV")?.addEventListener("click", ()=>navigator.clipboard.writeText(allTSVParts.join("\n\n")).then(()=>toast("已複製全部表格！", 3000)));

    /* ===== 不支薪：計算 & 複製 ===== */
    const table = document.querySelector("#noPayTable");
    if (table){
      const money = n => formatMoney(Math.floor(Number(n)||0)); // 明細顯示四捨；總額 floor
      const perHour = (salary)=> salary/(PAY_DIV_DAYS*DAY_HRS);
      const perMin  = (salary)=> perHour(salary)/60;

      table.addEventListener("input", (e)=>{
        const td = e.target.closest('[data-col="salary"]');
        if (!td) return;

        const tr     = td.parentElement;
        const salary = parseMoney(td.innerText);
        const hLeave     = Number(tr.dataset.hleave||0);
        const hCare      = Number(tr.dataset.hcare||0);
        const hSick      = Number(tr.dataset.hsick||0);
        const hPaidSick  = Number(tr.dataset.hpaidsick||0);
        const hMenstrual = Number(tr.dataset.hmenstrual||0);
        const late       = Number(tr.dataset.late||0);
        const cell   = tr.querySelector('[data-col="nopayDetail"]');

        if (!(salary>0)){ cell.textContent=""; cell.removeAttribute("data-total"); return; }

        const hourly    = salary / (PAY_DIV_DAYS * DAY_HRS);
        const perMinute = hourly / 60;

        const rawLeave    = hourly * hLeave;
        const rawCare     = hourly * hCare;
        const rawSick     = hourly * 0.5 * hSick;
        const rawPaidSick = hourly * 0.5 * hPaidSick;
        const rawMens     = hourly * 0.5 * hMenstrual;
        const rawLate     = perMinute * late;

        const total = Math.floor(rawLeave + rawCare + rawSick + rawPaidSick + rawMens + rawLate);

        const lines = [];
        const round = (n)=> formatMoney(Math.round(n));
        if (hLeave)     lines.push(`➖事假 ${hLeave}時 × ${salary}/30/8 = ${round(rawLeave)}元`);
        if (hCare)      lines.push(`➖家庭照顧假 ${hCare}時 × ${salary}/30/8 = ${round(rawCare)}元`);
        if (hSick)      lines.push(`➖病假 ${hSick}時 × ${salary}/30/8/2 = ${round(rawSick)}元`);
        if (hPaidSick)  lines.push(`➖有薪病假 ${hPaidSick}時 × ${salary}/30/8/2 = ${round(rawPaidSick)}元`);
        if (hMenstrual) lines.push(`➖生理假 ${hMenstrual}時 × ${salary}/30/8/2 = ${round(rawMens)}元`);
        if (late)       lines.push(`➖遲到 ${late}分 × ${salary}/30/8/60 = ${round(rawLate)}元`);
        lines.push(`不支薪金額：${formatMoney(total)} 元`);

        cell.textContent = lines.join("\n");
        cell.setAttribute("data-total", String(total));
      });

      // 如果本薪已填，初始化一次
      table.querySelectorAll('tr').forEach(tr=>{
        const salTd = tr.querySelector('[data-col="salary"]');
        if (salTd && salTd.innerText.trim()) salTd.dispatchEvent(new Event('input', {bubbles:true}));
      });

      // 複製 TSV（照你要的欄序）
      const btn = document.querySelector("#out #copyNoPayTSV");
      btn && btn.addEventListener("click", ()=>{
        const header = ["姓名","本薪","各種不支薪假別時數(含遲到要扣)","不支薪明細 不支薪總額","是否扣全勤"];
        const rows = [];
        const tb = table.querySelector("tbody");
        tb.querySelectorAll("tr").forEach(tr=>{
          const tds   = Array.from(tr.querySelectorAll("td"));
          const name  = (tds[0]?.innerText||"").trim();
          const sal   = (tds[1]?.innerText||"").trim();
          const info  = (tds[2]?.innerText||"").trim();
          const det   = (tds[3]?.innerText||"").trim();  // 明細+總額（單一欄）
          const full  = (tds[4]?.innerText||"").trim();
          rows.push([name, sal, info, det, full]);
        });
        const tsv = [header, ...rows]
          .map(r=>r.map(v=>String(v??"").replaceAll("\t"," ")).join("\t"))
          .join("\n");
        navigator.clipboard.writeText(tsv).then(()=>toast("已複製不支薪明細表",3000));
      });
    }
  } // end run

  /* ===== 小工具 ===== */
  function pickHeader(headers, pattern, fallback){ return headers.find(h=>pattern.test(h)) || fallback; }
  function tsvParse(text){
    const lines = text.split(/\r?\n/).filter(x => x.trim().length > 0);
    if (!lines.length) return {headers:[], rows:[], err:"空白內容"};
    const hasTab = /\t/.test(lines[0]);           // Tab 優先，否則 2+ 空白
    const splitter = hasTab ? /\t/ : /\s{2,}/;
    const firstCols = lines[0].split(splitter);
    const headerLike = firstCols.some(c => /員工編號|姓名|打卡日期|請假時數|假別|加班時數|出勤異常/.test(c));
    const headers = headerLike ? firstCols.map(h => h.trim()) : HEADERS_DEFAULT.slice();
    const dataLines = headerLike ? lines.slice(1) : lines;
    const rows = dataLines.map(l => {
      const cols = l.split(splitter);
      const o = {}; headers.forEach((h,i) => o[h] = (cols[i] ?? "").trim());
      return o;
    });
    return {headers, rows, err:null};
  }

  function toNumber(v){ const s=String(v??""); if (/[~:]/.test(s)) return 0; const m=s.match(/-?\d+(?:\.\d+)?/); return m?Number(m[0]):0; }
  function hhmmToHours(v){
    const s=String(v||"").trim(); const m=s.match(/^(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?$/);
    if(!m) return toNumber(s); const h=+m[1]||0, min=+m[2]||0, sec=+m[3]||0; return h + min/60 + sec/3600;
  }
  function toYM(s){ const m=String(s).match(/(\d{4})[\/\-](\d{1,2})/); return m?`${m[1]}-${String(m[2]).padStart(2,'0')}`:(s||""); }
  function toMD(s){ const m=String(s).match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/); return m?Number(m[2])+"/"+Number(m[3]):(s||""); }
  function parseHM(s){ const m=String(s||"").match(/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/); if(!m) return null; const hh=Math.min(23,Math.max(0,+m[1]||0)); const mm=Math.min(59,Math.max(0,+m[2]||0)); return hh*60+mm; }
  function fmtHoursNum(h){ const n=Number(h||0); return (Math.round(n*10)/10).toString(); }
  function fmtHours(h){ return `${fmtHoursNum(h)} 小時`; }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
  function formatMoney(n){ return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
  function parseMoney(s){ return Number(String(s).replace(/[,\s]/g,""))||0; }

  function addAgg(map, ym, branch, name, typ, val, detailStr){
    const normalizedTyp = (typ==="補打卡單") ? "漏打卡" : typ;
    const key = `${ym}|${branch}|${name}|${normalizedTyp}`;
    const rec = map.get(key) || { totalHours:0, totalMins:0, count:0, detail:[], _detailSet:new Set(), _lateEvents:[] };
    const isObj = val && typeof val==="object";
    const dkey = (detailStr||"").trim();
    if (dkey && rec._detailSet.has(dkey)){ map.set(key,rec); return; }

    if (typeof val==="number"){
      rec.totalHours += val;
      rec.detail.push(detailStr);
    }else if (isObj){
      if ("mins" in val){ rec.totalMins += (val.mins||0); rec.count += (val.cnt||1); rec.detail.push(detailStr);
        if (/^遲到/.test(normalizedTyp)) rec._lateEvents.push({mins:Number(val.mins||0), detail:detailStr});
      }
      if ("miss" in val){ rec.count += (val.miss||1); rec.detail.push(detailStr); }
      if ("cnt" in val && !("mins" in val) && !("miss" in val)){ rec.count += (val.cnt||1); rec.detail.push(detailStr); }
    }
    if (dkey) rec._detailSet.add(dkey);
    map.set(key,rec);
  }

})(); // IIFE

/* ===== Toast ===== */
function toast(msg, ms=3000){
  const wrap=document.getElementById("toast"); if(!wrap) return;
  const el=document.createElement("div"); el.className="toast"; el.innerHTML=msg;
  el.addEventListener("click",()=>{ el.parentNode && el.parentNode.removeChild(el); });
  wrap.appendChild(el);
  el.style.opacity="0";
  setTimeout(()=>{ el.style.transition="opacity .3s"; el.style.opacity="1"; }, 50);
  const delay=Math.max(300,ms)-300;
  setTimeout(()=>{ if(el.parentNode) el.style.opacity="0"; }, delay);
  setTimeout(()=>{ el.parentNode && el.parentNode.removeChild(el); }, Math.max(300,ms));
}
</script>
</body>
</html>
