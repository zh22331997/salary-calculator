<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8" />
<title>三聯收據產生器</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* =========================
   Design System (Tokens)
   ========================= */
:root{
  --brand-500:#A1C6EA; --brand-600:#8FB9E2;
  --secondary-500:#BBD1EA; --secondary-600:#A8C5E6;
  --clear-500:#DAE3E5; --clear-600:#CFD9DC;

  --text-strong:#1f2937; --text-normal:#374151; --text-mute:#6b7280;
  --border:#d1d5db; --border-strong:#9ca3af;
  --bg-page:#f0f2f5; --bg-card:#ffffff; --bg-info:#f8fbff; --bg-info-border:#e1eefc;

  --font-sans:"Microsoft JhengHei","微軟正黑體","Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;

  --radius-sm:6px; --radius-md:8px; --radius-lg:12px;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.08);
  --shadow-md:0 2px 10px rgba(0,0,0,0.10);
  --shadow-lg:0 4px 20px rgba(0,0,0,0.12);

  --space-1:.25rem; --space-2:.5rem; --space-3:.75rem; --space-4:1rem; --space-5:1.25rem; --space-6:1.5rem;
  --input-height:2.75rem; --btn-height:2.9rem;

  --focus-ring:0 0 0 3px rgba(106,154,255,0.25);
  --focus-border:#6a9aff;

  --btn-text:#17324A;

  /* 收據 layout 變數 */
  --cut:#555;         /* 可撕線顏色 */
  --line:#6f757a;     /* 卡片邊框 */
  --gap-between:5mm;  /* 每個人上下間距（預覽=列印） */
}

/* =========================
   Base
   ========================= */
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:var(--font-sans);
  background:var(--bg-page);
  margin:0; padding:0;
  display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
  color:var(--text-normal);
}
.container{
  background:var(--bg-card); padding:2rem; margin:2rem 1rem; border-radius:var(--radius-lg);
  box-shadow:var(--shadow-lg); max-width:980px; width:100%;
}
h1{margin:0 0 var(--space-4); color:#0056b3; text-align:center; font-weight:800;}
label{font-weight:700; display:block; color:#555; margin-bottom:.5rem;}

/* =========================
   表單/輸入
   ========================= */
.input-area{
  max-width:820px; margin:0 auto 24px auto; background:#fff; padding:20px;
  border-radius:var(--radius-md); box-shadow:var(--shadow-sm);
}
.grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
.col-3{ grid-column:span 3; } .col-6{ grid-column:span 6; } .col-12{ grid-column:span 12; }

textarea,
.input-area input[type="text"],
.input-area input[type="date"]{
  width:100%;
  height:var(--input-height);
  padding:0 var(--space-4);
  border-radius:var(--radius-md);
  border:1px solid var(--border);
  font-size:16px; background:#fff; color:var(--text-normal);
  transition:border-color .2s, box-shadow .2s, background-color .2s;
}
textarea{
  height:auto; min-height:200px; resize:vertical;
  padding:var(--space-3); line-height:1.5; font-family:var(--font-mono);
}
textarea:focus,
.input-area input[type="text"]:focus,
.input-area input[type="date"]:focus{
  outline:none; border-color:var(--focus-border)!important; box-shadow:var(--focus-ring);
}

/* =========================
   按鈕（統一組件）
   ========================= */
button{
  display:inline-flex; align-items:center; justify-content:center;
  min-height:var(--btn-height); padding:0 var(--space-5);
  font-size:17px; font-weight:700; border:none; border-radius:var(--radius-md);
  cursor:pointer; color:var(--btn-text); background:var(--brand-500);
  transition:background-color .15s ease, transform .12s ease, box-shadow .2s;
  box-shadow:var(--shadow-sm);
}
button:hover{background:var(--brand-600); transform:translateY(-2px)}
button:active{transform:translateY(-1px)}
button:focus{outline:none; box-shadow:var(--focus-ring)}

.btn-secondary{ background:var(--secondary-500); color:var(--btn-text); }
.btn-secondary:hover{ background:var(--secondary-600); }
.btn-clear{ background:var(--clear-500); color:var(--btn-text); }
.btn-clear:hover{ background:var(--clear-600); }

.btn-row{ display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:.5rem; }
.btn-row > button{ width:200px; margin:0; }

/* =========================
   列印區（四等高收據）
   ========================= */
.print-area{ margin-top:18px; }

.page{
  background:#fff; border:1px solid var(--border); border-radius:10px;
  padding:8mm 4mm; margin:0 auto 12px auto;
  display:grid; grid-template-rows:repeat(4,1fr); row-gap:var(--gap-between);
  page-break-after:always;
}
.page:last-child{ page-break-after:auto; }

.student-block{ position:relative; min-height:0; }
.page .student-block:not(:last-child)::after{
  content:""; position:absolute; left:-4mm; right:-4mm; bottom:calc(-0.5 * var(--gap-between));
  border-bottom:2px dashed var(--cut);
}

.triplet-grid{
  display:grid; grid-template-columns:30mm 55fr 45fr; gap:4mm; align-items:stretch; height:100%;
}

.receipt{
  border:1px solid var(--line); border-radius:8px; padding:7px;
  display:flex; flex-direction:column; gap:3px; background:#fff; position:relative;
}
.receipt-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding-bottom:3px; border-bottom:1px solid var(--line);}
.title{ font-weight:800; font-size:15px; color:#17324A; }
.tag{ font-size:11px; color:#374151; background:#f0f4f8; padding:1px 6px; border-radius:999px; border:1px solid #e2e8f0; }
.meta{ font-size:12px; color:#555; display:flex; flex-wrap:wrap; gap:8px; }
.row{ display:flex; align-items:flex-start; gap:6px; margin:2px 0; line-height:1.22; }
.row label{ width:66px; font-size:12.5px; color:#555; margin:0; }
.row .val{ flex:1; font-size:15.5px; }
.money{ font-weight:800; color:#c80000; }
.note{ color:#444; white-space:pre-wrap; }

.receipt[data-copy="slip"] .meta{ display:none; }
.receipt[data-copy="slip"] .row{ flex-direction:column; gap:1px; margin:2px 0; }
.receipt[data-copy="slip"] .row label{ width:auto; min-width:unset; font-size:12px; }
.receipt[data-copy="slip"] .row .val{ font-size:14px; }

.sign-area{ display:flex; justify-content:space-between; gap:10px; margin-top:6px; border-top:1px dashed var(--line); padding-top:6px; }
.sign-box{ display:flex; align-items:center; gap:8px; flex:1; }
.sign-label{ width:auto; min-width:max-content; font-size:12.5px; color:#555; }
.sign-line{ flex:1; border-bottom:1px solid var(--line); height:26px; }
.tiny{ font-size:11px; color:#666; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.cut-right::after{ content:""; position:absolute; top:-2px; bottom:-2px; right:-2.5mm; border-right:2px dashed var(--cut); }

/* 列印模式緊湊化（確保 100% 能放下 A4） */
@media print{
  html{ font-size:12pt; }
  body{ background:#fff; }

  /* ✅ 只隱藏表單與按鈕，不要藏掉容器（否則 printArea 也不見） */
  .input-area, .btn-row, h1{ display:none !important; }

  /* 讓容器在列印時撐滿頁面、移除投影與多餘留白 */
  .container{ box-shadow:none; margin:0; padding:0; max-width:none; }

  @page{ size:A4 portrait; margin:10mm; }

  .page{
    border:0; border-radius:0; padding:0; margin:0;
    display:grid; grid-template-rows:repeat(4,1fr); row-gap:var(--gap-between);
  }
  .triplet-grid{ gap:3mm; grid-template-columns:30mm 55fr 45fr; }
  .receipt{ padding:5px; border-color:#666; }
  .row label{ width:60px; font-size:10.5pt; }
  .row .val{ font-size:11.5pt; }
  .title{ font-size:12pt; }
  .sign-line{ height:26px; }
}
</style>
</head>

<body>
  <div class="container">
    <h1>三聯式 代收收據產生器</h1>

    <div class="input-area">
      <div class="grid">
        <div class="col-3">
          <label>收費區間</label>
          <input type="text" id="feePeriod" placeholder="例：2025年11月" />
        </div>
        <div class="col-3">
          <label>繳費期限</label>
          <input type="date" id="deadline" />
        </div>
        <div class="col-6">
          <label>代收項目(幾月餐費 或 幾月羊奶費)</label>
          <input type="text" id="feeItem" placeholder="例：11月羊奶費" />
        </div>
        <div class="col-12">
          <label>共用備註（可留空）</label>
          <input type="text" id="globalNote" placeholder="例：請準時繳費，逾期依規定加收手續費" />
        </div>

        <div class="col-12">
          <label>貼上名單（可含標題列：班級／姓名／金額／備註）</label>
          <textarea id="pasteArea"
  placeholder="班級	姓名	金額	備註
1A	愛莉娜	700	—
1A	黃穎穎	700	—
2A	Kitty	700	—
2B	張琪琪	700	—">
</textarea>
          <div style="font-size:13px;color:#6b7280;margin-top:6px;">
            ● 列印請設：邊界「無」或「最小值」、關閉頁首/頁尾（本頁以 <code>@page</code> 控制 10mm），調整縮放、確認可印出一頁四人。
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button id="btnGenerate">生成收據</button>
        <button class="btn-secondary" id="btnPrint">列印 / PDF</button>
        <button class="btn-clear" id="btnClear">清空資料</button>
        <span id="previewCount" style="margin-left:8px;"></span>
      </div>
    </div>

    <div class="print-area" id="printArea" aria-live="polite"></div>
  </div>

  <!-- ===== 三聯模板 ===== -->
  <template id="tripletTemplate">
    <div class="student-block">
      <div class="triplet-grid">
        <!-- 第三聯：機構存根（含金額） -->
        <div class="receipt cut-right" data-copy="slip">
          <div class="receipt-header"><div class="title">存根</div><div class="tag">第三聯</div></div>
          <div class="row"><label>學生姓名</label><div class="val name"></div></div>
          <div class="row"><label>班級</label><div class="val klass"></div></div>
          <div class="row"><label>代收項目</label><div class="val item"></div></div>
          <div class="row"><label>金額</label><div class="val money amount"></div></div>
          <div class="row"><label>備註</label><div class="val note"></div></div>
        </div>

        <!-- 第二聯：家長收據 -->
        <div class="receipt cut-right" data-copy="parent">
          <div class="receipt-header"><div class="title">家長收據</div><div class="tag">第二聯</div></div>
          <div class="meta"><span class="period"></span></div>
          <div class="row"><label>學生姓名</label><div class="val name"></div></div>
          <div class="row"><label>班級</label><div class="val klass"></div></div>
          <div class="row"><label>代收項目</label><div class="val item"></div></div>
          <div class="row"><label>金額</label><div class="val money amount"></div></div>
          <div class="row"><label>備註</label><div class="val note"></div></div>
          <div class="tiny">※ 本聯為家長留存，收據請保留六個月</div>
        <!-- ⬇⬇ 在這裡插入簽名區 ⬇⬇ -->
          <div class="sign-area">
          <div class="sign-box">
          <div class="sign-label">經辦簽收</div>
          <div class="sign-line"></div>
        </div>
          <div class="sign-box">
            <div class="sign-label">日期</div>
            <div class="sign-line"></div>
          </div>
        </div>
        <!-- ⬆⬆ 在這裡插入簽名區 ⬆⬆ -->
        </div>

        <!-- 第一聯：繳費通知 -->
        <div class="receipt" data-copy="notice">
          <div class="receipt-header"><div class="title">繳費通知</div><div class="tag">第一聯</div></div>
          <div class="meta"><span class="period"></span></div>
          <div class="row"><label>學生姓名</label><div class="val name"></div></div>
          <div class="row"><label>班級</label><div class="val klass"></div></div>
          <div class="row"><label>代收項目</label><div class="val item"></div></div>
          <div class="row"><label>金額</label><div class="val money amount"></div></div>
          <div class="row"><label>備註</label><div class="val note"></div></div>
          <div class="row"><label>繳費期限</label><div class="val deadline"></div></div>
          <div class="tiny">※ 如對金額或項目有疑問，請於三日內與我們聯繫。</div>
        </div>
      </div>
    </div>
  </template>

<script>
/* ===== 小工具 ===== */
const $  = (s,c=document)=>c.querySelector(s);
const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));

function pad(n){ return String(n).padStart(2,'0'); }
function nextMonthInfo(base=new Date()){
  const y=base.getFullYear(), m=base.getMonth();
  const firstNext = new Date(y, m+1, 1);
  const periodLabel = `${firstNext.getFullYear()}年${firstNext.getMonth()+1}月`;
  let due = new Date(firstNext.getFullYear(), firstNext.getMonth(), 10);
  const day=due.getDay();
  if(day===6) due.setDate(due.getDate()+2);        // 六→一
  else if(day===0) due.setDate(due.getDate()+1);   // 日→一
  const dueStr = `${due.getFullYear()}-${pad(due.getMonth()+1)}-${pad(due.getDate())}`;
  return { periodLabel, dueStr };
}

function detectDelimiter(sample){
  const tab=(sample.match(/\t/g)||[]).length, comma=(sample.match(/,/g)||[]).length;
  return tab>=comma?'\t':',';
}

/* 支援標題列（班級／姓名／金額／備註）：若第一行含這些詞視為標題並略過 */
function parseRows(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return [];
  const d=detectDelimiter(lines[0]);
  const first=lines[0].split(d).map(v=>v.trim());
  const hasHeader=first.some(v=>/班級|姓名|金額|備註/i.test(v));
  const rows=(hasHeader?lines.slice(1):lines).map(line=>{
    const p=line.split(d).map(s=>s.trim());
    return { klass:p[0]||'', name:p[1]||'', amount:p[2]||'', note:p[3]||'' };
  });
  return rows;
}

function sortByClassName(rows){
  const collator=new Intl.Collator('zh-Hant-u-co-stroke',{numeric:true,sensitivity:'base'});
  return rows.sort((a,b)=>{
    const c1=collator.compare(a.klass||'～～～',b.klass||'～～～');
    return c1!==0?c1:collator.compare(a.name||'',b.name||'');
  });
}

function formatMoney(v){
  const num=Number(String(v).replace(/[^\d.-]/g,''))||0;
  return 'NT$ '+num.toLocaleString('zh-Hant-TW',{maximumFractionDigits:0});
}

function chunk4(arr){ const pages=[]; for(let i=0;i<arr.length;i+=4) pages.push(arr.slice(i,i+4)); return pages; }

function fillTriplet(node,data,globals){
  $$('.period',node).forEach(e=>e.textContent = globals.feePeriod?`收費區間 ${globals.feePeriod}`:'');
  $$('.name',node).forEach(e=>e.textContent  = data.name || '（未填）');
  $$('.klass',node).forEach(e=>e.textContent = data.klass || '—');
  $$('.item',node).forEach(e=>e.textContent  = globals.feeItem || '（未填）');
  $$('.amount',node).forEach(e=>e.textContent= formatMoney(data.amount));
  const mergedNote=[data.note,globals.globalNote].filter(Boolean).join('；');
  $$('.note',node).forEach(e=>e.textContent  = mergedNote || '—');
  $$('.deadline',node).forEach(e=>e.textContent = globals.deadline || '—');
}

/* ===== 主流程 ===== */
const printArea = $('#printArea');
const template  = $('#tripletTemplate');

function generate(){
  const rows0=parseRows($('#pasteArea').value);
  printArea.innerHTML='';

  const globals={
    feePeriod: $('#feePeriod').value.trim(),
    deadline:  $('#deadline').value,
    feeItem:   $('#feeItem').value.trim(),
    globalNote:$('#globalNote').value.trim()
  };

  if(rows0.length===0){
    $('#previewCount').textContent='尚未產生任何收據，請先貼上名單。';
    return;
  }

  const rows = sortByClassName(rows0);
  const pages= chunk4(rows);

  pages.forEach(group=>{
    const page=document.createElement('div'); page.className='page';
    group.forEach(r=>{
      const node=template.content.cloneNode(true);
      fillTriplet(node,r,globals);
      page.appendChild(node);
    });
    printArea.appendChild(page);
  });

  $('#previewCount').textContent=`共 ${rows.length} 位；每頁 4 位，共 ${pages.length} 頁。`;
}

/* 預設帶入：下個月收費區間＋期限（週末順延)*/
document.addEventListener('DOMContentLoaded', ()=>{
  const {periodLabel,dueStr}=nextMonthInfo(new Date());
  $('#feePeriod').value = periodLabel;
  $('#deadline').value  = dueStr;

  // 有貼名單才自動產生預覽；空白就只顯示 placeholder
  if ($('#pasteArea').value.trim().length > 0) {
    generate();
  }
});

/* 事件 */
$('#btnGenerate').addEventListener('click', generate);
$('#btnPrint').addEventListener('click', ()=>{
  if(!printArea.children.length) generate();
  // 給瀏覽器 1 個影格時間把 DOM 放進去，再叫出列印
  requestAnimationFrame(()=>window.print());
});
$('#btnClear').addEventListener('click', ()=>{
  $('#pasteArea').value='';
  $('#previewCount').textContent='';
  $('#pasteArea').focus();
});
</script>
</body>
</html>
