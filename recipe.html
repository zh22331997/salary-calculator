<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8" />
<title>三聯收據產生器｜A4邊界1公分・每頁四位・第三聯30mm（間距強化）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --ink:#222;
    --muted:#676a6e;
    --line:#6f757a;  /* 邊框 */
    --cut:#555;      /* 可撕式虛線 */
    --font:"Noto Sans TC","PingFang TC","Heiti TC",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;

    /* 你可以改這兩個數字微調列印間距與高度（mm） */
    --print-person-height:64.5mm;
    --print-gap-between:1.8mm;
  }
  html,body{ margin:0; padding:0; background:#f4f5f7; color:var(--ink); font-family:var(--font); font-size:15px; }
  .container{ max-width:1100px; margin:16px auto 56px; padding:0 12px; }
  h1{ font-size:22px; margin:0 0 6px; }
  .subtitle{ color:var(--muted); margin-bottom:10px; }

  .panel{
    background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px; margin-bottom:12px;
  }
  .grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:10px; }
  .col-3{ grid-column:span 3; } .col-6{ grid-column:span 6; } .col-12{ grid-column:span 12; }

  label{ font-size:13px; color:var(--muted); display:block; margin:0 0 4px; }
  input[type="text"], input[type="date"], textarea{
    width:100%; box-sizing:border-box; padding:8px 10px; border:1px solid var(--line); border-radius:8px; font-size:15px; background:#fff;
  }
  textarea{ min-height:120px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Noto Sans TC",monospace; white-space:pre; }
  input::placeholder, textarea::placeholder{ color:#999; }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; align-items:center;}
  button{ border:0; padding:8px 12px; border-radius:8px; font-size:14px; cursor:pointer; }
  .preview-count{ font-size:13px; color:#muted; margin-left:auto; }

  .print-area{ margin-top:12px; }

  /* 一頁容器 */
  .page{
    background:#fff; border:1px solid var(--line); border-radius:10px; padding:8mm 4mm; margin-bottom:12px;
    page-break-after:always;
  }
  .page:last-child{ page-break-after:auto; }

  /* 預覽：把每個人之間的距離拉大一些（不影響列印固定高計算） */
  .student-block{ position:relative; margin:0 0 5mm 0; }
  .page .student-block:not(:last-child)::after{
    content:""; position:absolute; left:-4mm; right:-4mm; bottom:-2mm; border-bottom:2px dashed var(--cut);
  }

  /* 欄寬：第三聯固定30mm；剩餘寬度 55%（第二聯）＋45%（第一聯） */
  .triplet-grid{
    display:grid; grid-template-columns:30mm 55fr 45fr; gap:4mm; align-items:stretch;
  }

  /* 卡片外觀（緊湊） */
  .receipt{
    border:1px solid var(--line); border-radius:8px; padding:7px; display:flex; flex-direction:column; gap:3px; background:#fff; position:relative;
  }
  .receipt-header{
    display:flex; justify-content:space-between; align-items:center; gap:8px; padding-bottom:3px; border-bottom:1px solid var(--line);
  }
  .title{ font-weight:700; font-size:15px; }
  .tag{ font-size:11px; color:#555; background:#f0f2f3; padding:1px 6px; border-radius:999px; border:1px solid #e2e5e8; }

  .meta{ font-size:12px; color:#555; display:flex; flex-wrap:wrap; gap:8px; }
  .row{ display:flex; align-items:flex-start; gap:6px; margin:2px 0; line-height:1.22; }
  .row label{ width:66px; font-size:12.5px; color:#555; margin:0; }
  .row .val{ flex:1; font-size:15.5px; }
  .money{ font-weight:700; }
  .note{ color:#444; white-space:pre-wrap; }

  /* 第三聯：單欄 */
  .receipt[data-copy="slip"] .meta{ display:none; }
  .receipt[data-copy="slip"] .row{ flex-direction:column; gap:1px; margin:2px 0; }
  .receipt[data-copy="slip"] .row label{ width:auto; min-width:unset; font-size:12px; }
  .receipt[data-copy="slip"] .row .val{ font-size:14px; }

  /* 第二聯：簽名區 */
  .sign-area{
    display:flex; justify-content:space-between; gap:10px; margin-top:6px;
    border-top:1px dashed var(--line); padding-top:6px;
  }
  .sign-box{ display:flex; align-items:center; gap:8px; flex:1; }
  .sign-label{ width:auto; min-width:max-content; font-size:12.5px; color:#555; }
  .sign-line{ flex:1; border-bottom:1px solid var(--line); height:28px; }

  .tiny{ font-size:11px; color:#666; margin-top:2px; }

  /* 垂直可撕線：第三聯與第二聯後方 */
  .cut-right::after{
    content:""; position:absolute; top:-2px; bottom:-2px; right:-2.5mm; border-right:2px dashed var(--cut);
  }

  /* ===== 列印：A4 邊界 10mm、字級≥12pt、四等份固定高度＋額外留白 ===== */
  @media print{
    html{ font-size:12pt; }
    body{ background:#fff; }
    .panel, .subtitle, .actions, .header-area{ display:none !important; }
    .container{ max-width:none; margin:0; padding:0; }

    @page{ size:A4 portrait; margin:10mm; } /* 上下左右各 1 公分 */

    .page{ border:0; border-radius:0; padding:3mm 0; margin:0; }

    /* 可用高：297-20=277mm；扣 page padding 6mm ≈ 271mm。
       我們採：每人固定 var(--print-person-height)；
       前三位加 var(--print-gap-between) 的間距，總和仍 < 271mm。 */
    .student-block{ margin:0; height:var(--print-person-height); }
    .page .student-block:not(:last-child){ margin-bottom:var(--print-gap-between); }
    .page .student-block:not(:last-child)::after{ left:0; right:0; bottom:0; border-bottom:2px dashed var(--cut); }

    .triplet-grid{ gap:3.5mm; grid-template-columns:30mm 55fr 45fr; }
    .receipt{ border-color:#666; padding:6px; }
    .row{ margin:2px 0; gap:5px; line-height:1.2; }
    .row label{ font-size:10.5pt; width:64px; }
    .row .val{ font-size:12pt; }
    .tag{ font-size:10pt; }
    .title{ font-size:12.5pt; }
    .sign-line{ border-bottom-color:#555; height:28px; }
    .cut-right::after{ border-right-color:#555; top:0; bottom:0; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header-area">
      <h1>三聯收據產生器（A4 邊界 1 公分・每頁四位）</h1>
      <div class="subtitle">欄寬：第三聯固定 30mm → 第二聯 55% → 第一聯 45%｜可撕式虛線＋額外留白</div>
    </div>

    <div class="panel">
      <div class="grid">
        <div class="col-3">
          <label>收費區間</label>
          <input type="text" id="feePeriod" placeholder="例：2025年11月" />
        </div>
        <div class="col-3">
          <label>繳費期限</label>
          <input type="date" id="deadline" />
        </div>
        <div class="col-6">
          <label>代收項目（本月統一）</label>
          <input type="text" id="feeItem" placeholder="例：11月羊奶費" />
        </div>
        <div class="col-12">
          <label>共用備註（可留空）</label>
          <input type="text" id="globalNote" placeholder="例：請準時繳費，逾期依規定加收手續費" />
        </div>
        <div class="col-12">
          <label>貼上名單（固定欄位：<b>班級【tab】姓名【tab】金額【tab】備註(可選)</b>）</label>
          <textarea id="pasteArea" placeholder="1A\t黃凱琪\t700\t—\n教職員\t張老師\t1200\t—\n2A\t王小美\t650\n..."></textarea>
          <div style="font-size:12px;color:#666;margin-top:4px;">
            ● 自動依「班級→姓名」排序；金額可含 <code>NT$</code>、<code>$</code>、<code>元</code>。<br/>
            ● 列印時：關閉「頁首及頁尾」、縮放 100%，邊界由本頁控制為 10mm。
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" id="btnGenerate">生成收據</button>
        <button class="btn-outline" id="btnPrint">預覽 / 列印（PDF）</button>
        <span class="preview-count" id="previewCount"></span>
      </div>
    </div>

    <div class="print-area" id="printArea" aria-live="polite"></div>
  </div>

  <!-- 三聯模板：第三聯（slip）→ 第二聯（parent）→ 第一聯（notice） -->
  <template id="tripletTemplate">
    <div class="student-block">
      <div class="triplet-grid">
        <!-- 第三聯：機構存根 -->
        <div class="receipt cut-right" data-copy="slip">
          <div class="receipt-header">
            <div class="title">機構存根</div>
            <div class="tag">第三聯</div>
          </div>
          <div class="row"><label>學生姓名</label><div class="val name"></div></div>
          <div class="row"><label>班級</label><div class="val klass"></div></div>
          <div class="row"><label>代收項目</label><div class="val item"></div></div>
          <div class="row"><label>備註</label><div class="val note"></div></div>
        </div>

        <!-- 第二聯：家長收據 -->
        <div class="receipt cut-right" data-copy="parent">
          <div class="receipt-header">
            <div class="title">家長收據</div>
            <div class="tag">第二聯</div>
          </div>
          <div class="meta"><span class="period"></span></div>
          <div class="row"><label>學生姓名</label><div class="val name"></div></div>
          <div class="row"><label>班級</label><div class="val klass"></div></div>
          <div class="row"><label>代收項目</label><div class="val item"></div></div>
          <div class="row"><label>金額</label><div class="val money amount"></div></div>
          <div class="row"><label>備註</label><div class="val note"></div></div>
          <div class="tiny">※ 本聯為家長留存，收據請保留六個月</div>
          <div class="sign-area">
            <div class="sign-box">
              <div class="sign-label">經辦簽收</div>
              <div class="sign-line"></div>
            </div>
            <div class="sign-box">
              <div class="sign-label">日期</div>
              <div class="sign-line"></div>
            </div>
          </div>
        </div>

        <!-- 第一聯：繳費通知 -->
        <div class="receipt" data-copy="notice">
          <div class="receipt-header">
            <div class="title">繳費通知</div>
            <div class="tag">第一聯</div>
          </div>
          <div class="meta"><span class="period"></span></div>
          <div class="row"><label>學生姓名</label><div class="val name"></div></div>
          <div class="row"><label>班級</label><div class="val klass"></div></div>
          <div class="row"><label>代收項目</label><div class="val item"></div></div>
          <div class="row"><label>金額</label><div class="val money amount"></div></div>
          <div class="row"><label>備註</label><div class="val note"></div></div>
          <div class="row"><label>繳費期限</label><div class="val deadline"></div></div>
          <div class="tiny">※ 如對金額或項目有疑問，請於三日內與我們聯繫。</div>
        </div>
      </div>
    </div>
  </template>

<script>
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const printArea = $('#printArea');
  const template = $('#tripletTemplate');

  /* ===== 預設：下個月的收費區間與期限（10日，遇週末順延） ===== */
  function pad(n){ return n.toString().padStart(2,'0'); }
  function nextMonthInfo(base=new Date()){
    const y = base.getFullYear();
    const m = base.getMonth();
    const firstNext = new Date(y, m+1, 1);
    const periodLabel = `${firstNext.getFullYear()}年${firstNext.getMonth()+1}月`;
    let due = new Date(firstNext.getFullYear(), firstNext.getMonth(), 10);
    const day = due.getDay();
    if(day === 6){ due.setDate(due.getDate()+2); }  // 六 → 週一
    else if(day === 0){ due.setDate(due.getDate()+1); } // 日 → 週一
    const dueStr = `${due.getFullYear()}-${pad(due.getMonth()+1)}-${pad(due.getDate())}`;
    return { periodLabel, dueStr };
  }

  /* ===== 解析/格式化 ===== */
  function formatMoney(v){
    const num = Number(String(v).replace(/[^\d.-]/g,'') || 0);
    return 'NT$ ' + num.toLocaleString('zh-Hant-TW', { maximumFractionDigits: 0 });
  }
  function detectDelimiter(sample){
    const tab = (sample.match(/\t/g) || []).length;
    const comma = (sample.match(/,/g) || []).length;
    return tab >= comma ? '\t' : ',';
  }
  function looksLikeAmount(s){
    return /^[^\d-]*-?\s*\d[\d,.\s]*[^\d]*$/.test(s || '');
  }

  // 固定：班級, 姓名, 金額, 備註(可選)
  function parseRows(text){
    return text
      .split(/\r?\n/)
      .map(l => l.trim())
      .filter(l => l.length>0)
      .map(line=>{
        const d = detectDelimiter(line);
        const p = line.split(d).map(s=>s.trim());
        let klass='', name='', amount='', note='';
        if(p.length>=3){
          klass=p[0]||''; name=p[1]||''; amount=p[2]||''; note=p[3]||'';
        }
        return { klass, name, amount, note };
      });
  }

  // 依班級→姓名排序
  function sortByClassName(rows){
    const collator = new Intl.Collator('zh-Hant-u-co-stroke', { numeric:true, sensitivity:'base' });
    return rows.sort((a,b)=>{
      const ka = a.klass || '～～～';
      const kb = b.klass || '～～～';
      const c1 = collator.compare(ka, kb);
      if(c1 !== 0) return c1;
      return collator.compare(a.name || '', b.name || '');
    });
  }

  // 每頁 4 位
  function chunk4(arr){
    const pages = [];
    for(let i=0; i<arr.length; i+=4){ pages.push(arr.slice(i, i+4)); }
    return pages;
  }

  function fillTriplet(node, data, globals){
    const {feePeriod, deadline, feeItem, globalNote} = globals;
    $$('.period', node).forEach(e => e.textContent = feePeriod ? `收費區間 ${feePeriod}` : '');
    $$('.name', node).forEach(e => e.textContent = data.name || '（未填）');
    $$('.klass', node).forEach(e => e.textContent = data.klass || '—');
    $$('.item', node).forEach(e => e.textContent = feeItem || '（未填）');
    $$('.amount', node).forEach(e => e.textContent = formatMoney(data.amount));
    const mergedNote = [data.note, globalNote].filter(Boolean).join('；');
    $$('.note', node).forEach(e => e.textContent = mergedNote || '—');
    $$('.deadline', node).forEach(e => e.textContent = deadline || '—');
  }

  function generate(){
    const rows0 = parseRows($('#pasteArea').value);
    printArea.innerHTML = '';

    const globals = {
      feePeriod: $('#feePeriod').value.trim(),
      deadline: $('#deadline').value,
      feeItem: $('#feeItem').value.trim(),
      globalNote: $('#globalNote').value.trim()
    };

    if(rows0.length === 0){
      $('#previewCount').textContent = '尚未產生任何收據。請先貼上名單。';
      return;
    }

    const rows = sortByClassName(rows0);
    const pages = chunk4(rows);

    pages.forEach(group => {
      const page = document.createElement('div');
      page.className = 'page';
      group.forEach(r => {
        const node = template.content.cloneNode(true);
        fillTriplet(node, r, globals);
        page.appendChild(node);
      });
      printArea.appendChild(page);
    });

    $('#previewCount').textContent = `共 ${rows.length} 位（已依班級→姓名排序）；每頁 4 位，共 ${pages.length} 頁。`;
  }

  // 預設帶入：下個月收費區間與期限（週末順延）
  (function initDefaults(){
    const { periodLabel, dueStr } = nextMonthInfo(new Date());
    $('#feePeriod').value = periodLabel;
    $('#deadline').value  = dueStr;
  })();

  $('#btnGenerate')?.addEventListener('click', generate);
  $('#btnPrint')?.addEventListener('click', ()=>{
    if(!printArea.children.length){ generate(); }
    window.print();
  });
</script>
</body>
</html>
