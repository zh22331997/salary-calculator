<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8" />
<title>繳費通知產生器</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --brand-500:#A1C6EA; --brand-600:#8FB9E2;
  --secondary-500:#BBD1EA; --secondary-600:#A8C5E6;
  --clear-500:#DAE3E5; --clear-600:#CFD9DC;

  --text-strong:#1f2937; --text-normal:#374151; --text-mute:#6b7280;
  --border:#d1d5db; --bg-page:#f0f2f5; --bg-card:#ffffff;

  --font-sans:"Microsoft JhengHei","微軟正黑體","Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;

  /* 預覽用（列印時會覆蓋） */
  --gap-between:6mm; --gap-col:6mm;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:var(--font-sans); background:var(--bg-page);
  margin:0; padding:0; display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
  color:var(--text-normal);
}
.container{ background:var(--bg-card); padding:2rem; margin:2rem 1rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.12); max-width:980px; width:100%;}
h1{margin:0 0 1rem 0; color:#0056b3; text-align:center; font-weight:800;}
label{font-weight:700; display:block; color:#555; margin:.25rem 0 .5rem;}
.input-area{ max-width:980px; margin:0 auto 24px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.08);}
.grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
.col-3{ grid-column:span 3; } .col-4{ grid-column:span 4; } .col-6{ grid-column:span 6; } .col-12{ grid-column:span 12; }

textarea,.input-area input[type="text"],.input-area input[type="date"]{
  width:100%; height:2.75rem; padding:0 .9rem; border-radius:8px; border:1px solid var(--border);
  font-size:16px; background:#fff; transition:border-color .2s, box-shadow .2s;
}
textarea{ min-height:200px; height:auto; resize:vertical; padding:.6rem; line-height:1.5; font-family:var(--font-mono); }
textarea:focus,.input-area input[type="text"]:focus,.input-area input[type="date"]:focus{ outline:none; border-color:#6a9aff!important; box-shadow:0 0 0 3px rgba(106,154,255,.25); }

button{
  display:inline-flex; align-items:center; justify-content:center; min-height:2.9rem; padding:0 1.25rem;
  font-size:17px; font-weight:700; border:none; border-radius:8px; cursor:pointer; color:#17324A;
  background:#A1C6EA; transition:background-color .15s ease, transform .12s ease, box-shadow .2s; box-shadow:0 1px 3px rgba(0,0,0,.08);
}
button:hover{background:#8FB9E2; transform:translateY(-2px)}
button:active{transform:translateY(-1px)}
.btn-secondary{ background:#BBD1EA; } .btn-secondary:hover{ background:#A8C5E6; }
.btn-clear{ background:#DAE3E5; } .btn-clear:hover{ background:#CFD9DC; }
.btn-row{ display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:.5rem; }
.btn-row > button{ width:200px; }

.print-area{ margin-top:18px; } /* 預覽美觀；列印會設為0 */

/* 頁面：A4 一頁 2×4 共 8 張 */
.page{
  position:relative; background:#fff; border:1px solid var(--border); border-radius:10px;
  padding:6mm; margin:0 auto 12px auto;
  display:grid; grid-template-columns:1fr 1fr; grid-template-rows:repeat(4,1fr);
  column-gap:var(--gap-col); row-gap:var(--gap-between);
  page-break-after:always;
}
.page:last-child{ page-break-after:auto; }

/* 單張卡片 */
.receipt{
  border:1px solid #6f757a; border-radius:8px; padding:6px;
  display:flex; flex-direction:column; gap:3px; background:#fff; page-break-inside:avoid;
}
.receipt-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding-bottom:3px; border-bottom:1px solid #6f757a;}
.title{ font-weight:800; font-size:15px; color:#17324A; }
.meta{ font-size:12px; color:#555; display:flex; flex-wrap:wrap; gap:8px; }
.row{ display:flex; align-items:flex-start; gap:6px; margin:2px 0; line-height:1.22; }
.row label{ width:66px; font-size:12.5px; color:#555; margin:0; }
.row .val{ flex:1; font-size:15.5px; }
.amount{ font-weight:800; color:#c80000; }
.payinfo{ margin-top:4px; padding-top:6px; border-top:1px dashed #9aa3ab; font-size:11.5px; color:#374151; line-height:1.35; }
.payinfo .mono{ font-family:var(--font-mono); letter-spacing:.2px; }
.tiny{ font-size:11px; color:#666; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* ===== 列印緊湊版（確保放得下 8 張） ===== */
@media print{
  html{ font-size:11.5pt; } /* 稍降整體字級 */
  body{ background:#fff; }
  h1,.input-area,.btn-row{ display:none !important; }
  .container{ box-shadow:none; margin:0 !important; padding:0 !important; max-width:none; }
  .print-area{ margin-top:0 !important; }   /* 修第一頁上留白 */
  .page:first-child{ margin-top:0 !important; }

  /* 1) 砍小頁邊；2) 用整數 mm 做列距；3) 卡片更緊湊 */
  @page{ size:A4 portrait; margin:10mm; }

  :root{
    --gap-between:6mm;   /* 四列間 3 個縫距 → ((297-20)-3*6)/4 ≈ 63.25mm，每列更好放 */
    --gap-col:6mm;

    --page-w:210mm; --page-h:297mm; --page-m:10mm;
    --cols:2; --rows:4;
    --card-w: calc((var(--page-w) - 2*var(--page-m) - (var(--cols) - 1)*var(--gap-col)) / var(--cols));
    --card-h: calc((var(--page-h) - 2*var(--page-m) - (var(--rows) - 1)*var(--gap-between)) / var(--rows));
  }

  .page{
    border:0; border-radius:0; padding:0; margin:0;
    grid-template-columns:repeat(2, var(--card-w));
    grid-template-rows:repeat(4, var(--card-h));
    column-gap:var(--gap-col); row-gap:var(--gap-between);
  }
  .receipt{
    width:var(--card-w); height:var(--card-h);
    padding:4px; border-color:#666; overflow:hidden; /* 避免內容撐高 */
  }
  .title{ font-size:11.5pt; }
  .row label{ width:58px; font-size:9.8pt; }
  .row .val{ font-size:10.8pt; }
  .meta{ font-size:9.6pt; }
  .payinfo{ font-size:9.6pt; line-height:1.28; }
  .tiny{ font-size:9.2pt; }
}
</style>
</head>
<body>
  <div class="container">
    <h1>繳費通知產生器</h1>

    <div class="input-area">
      <div class="grid">
        <div class="col-12">
          <label>貼上名單（班級	姓名	金額	是否袋	 口味	備註）缺少欄位自動留白</label>
          <textarea id="pasteArea" placeholder="班級	姓名	金額	是否袋	  口味	備註
1A	馬晨皓	700	否	鮮乳	
1A	許耀文	700	是	草莓	
2B	巫采珊	700	是		原味羊奶  溫熱的
3A	Angela	2025年11月，每週一、二、四	否	可可	"></textarea>
          <div style="font-size:13px;color:#6b7280;margin-top:6px;">
            ● 列印用 100%（實際大小），關閉頁首/頁尾。此版已為「緊湊列印」以確保 A4 固定 8 張。
          </div>
        </div>

        <div class="col-3">
          <label>收費區間</label>
          <input type="text" id="feePeriod" placeholder="例：2025年12月" />
        </div>
        <div class="col-3">
          <label>繳費期限</label>
          <input type="date" id="deadline" />
        </div>
        <div class="col-6">
          <label>代收項目</label>
          <input type="text" id="feeItem" placeholder="例：12月羊奶費" />
        </div>

        <!-- 匯款 / 轉帳資訊 -->
        <div class="col-4">
          <label>匯款戶名</label>
          <input type="text" id="payName" value="凱勝文理技藝短期補習班" />
        </div>
        <div class="col-4">
          <label>銀行 / 分行</label>
          <input type="text" id="payBank" value="玉山銀行808雙和分行" />
        </div>
        <div class="col-4">
          <label>匯款帳號</label>
          <input type="text" id="payAccount" value="0129940060389" />
        </div>
        <div class="col-12">
          <label>匯款提醒文字</label>
          <input type="text" id="payNote" value="匯款後請提供末五碼、匯款金額、繳費項目" />
        </div>

        <div class="col-12">
          <label>共用備註（可留空）</label>
          <input type="text" id="globalNote" placeholder="例：請準時繳費，逾期依規定加收手續費" />
        </div>
      </div>

      <div class="btn-row">
        <button id="btnGenerate">生成通知</button>
        <button class="btn-secondary" id="btnPrint">列印 / PDF</button>
        <button class="btn-clear" id="btnClear">清空資料</button>
        <span id="previewCount" style="margin-left:8px;"></span>
      </div>

      <div id="warnBox" class="warn" role="alert" style="display:none;"></div>
    </div>

    <div class="print-area" id="printArea" aria-live="polite"></div>
  </div>

  <!-- 單張卡片模板 -->
  <template id="cardTemplate">
    <div class="receipt">
      <div class="receipt-header"><div class="title">繳費通知</div></div>
      <div class="meta"><span class="period"></span></div>
      <div class="row"><label>學生姓名</label><div class="val name"></div></div>
      <div class="row"><label>班級</label><div class="val klass"></div></div>
      <div class="row"><label>代收項目</label><div class="val item"></div></div>
      <div class="row"><label>金額</label><div class="val amount"></div></div>
      <div class="row"><label>備註</label><div class="val note"></div></div>
      <div class="row"><label>繳費期限</label><div class="val deadline"></div></div>

      <div class="payinfo">
        <div>【匯款/轉帳】戶名：<span class="mono pay-name"></span></div>
        <div>銀行：<span class="mono pay-bank"></span>　帳號：<span class="mono pay-account"></span></div>
        <div class="pay-note"></div>
      </div>

      <div class="tiny">※ 如對金額或項目有疑問，請於三日內與我們聯繫。</div>
    </div>
  </template>

<script>
/* 小工具 */
const $  = (s,c=document)=>c.querySelector(s);
const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));
function pad(n){ return String(n).padStart(2,'0'); }

/* 下一個月份的 10 日（遇週末順延到週一） */
function nextMonth10thBusinessDay(base=new Date()){
  const y=base.getFullYear(), m=base.getMonth();
  const target=new Date(y, m+1, 10);
  const day=target.getDay();
  if(day===6) target.setDate(target.getDate()+2);
  if(day===0) target.setDate(target.getDate()+1);
  return `${target.getFullYear()}-${pad(target.getMonth()+1)}-${pad(target.getDate())}`;
}
/* 下一個月份標籤（例：2025年12月） */
function nextMonthLabel(base=new Date()){
  const y=base.getFullYear(), m=base.getMonth();
  const d=new Date(y, m+1, 1);
  return `${d.getFullYear()}年${d.getMonth()+1}月`;
}
/* 分隔偵測 */
function detectDelimiter(sample){
  const tab=(sample.match(/\t/g)||[]).length, comma=(sample.match(/,/g)||[]).length;
  return tab>=comma?'\t':',';
}
/* 只把「是 / Y / YES」視為要袋 */
function normalizeBag(v){
  const s=String(v||'').trim();
  return /^(\u662f|Y|YES)$/i.test(s);
}
/* 解析 4～6 欄：班級／姓名／金額／袋／口味／備註（缺少自動留白） */
function parseRows(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return [];
  const d=detectDelimiter(lines[0]);
  const first=lines[0].split(d).map(v=>v.trim());
  const hasHeader=first.some(v=>/班級|姓名|金額|袋|口味|備註/i.test(v));
  const body=(hasHeader?lines.slice(1):lines);

  return body.map(line=>{
    const p=line.split(d).map(s=>s.trim());
    return {
      klass:   p[0]||'',
      name:    p[1]||'',
      amount:  p[2]||'',
      bagYes:  normalizeBag(p[3]),
      flavor:  p[4]||'',
      special: p[5]||''
    };
  });
}
/* 金額格式判斷與顯示 */
function isAmountLike(raw){
  const s = String(raw||'').trim();
  if(!s) return false;
  return /^(?:NT\$?\s*)?\$?\s*\d{1,3}(?:,\d{3})*(?:\.\d+)?(?:\s*元)?$/i.test(s)
      || /^\d+(?:\.\d+)?$/.test(s);
}
function formatAmount(v){
  const raw = String(v||'').trim();
  if(!raw) return '—';
  if (isAmountLike(raw)) {
    const n = Number(raw.replace(/[^\d.]/g,'')) || 0;
    return 'NT$ ' + Math.round(n).toLocaleString('zh-Hant-TW',{maximumFractionDigits:0});
  }
  return raw;
}
/* 排序：班級 → 姓名 */
function sortByClassName(rows){
  const collator=new Intl.Collator('zh-Hant-u-co-stroke',{numeric:true,sensitivity:'base'});
  return rows.sort((a,b)=>{
    const c1=collator.compare(a.klass||'～～～',b.klass||'～～～');
    return c1!==0?c1:collator.compare(a.name||'',b.name||'');
  });
}
/* 固定每頁 8 張；最後一頁不足補空卡 */
function toPagesOf8(arr){
  const out=[]; for(let i=0;i<arr.length;i+=8) out.push(arr.slice(i,i+8));
  return out.map(pg=>{
    const filled=[...pg];
    while(filled.length<8) filled.push({klass:'',name:'',amount:'',bagYes:false,flavor:'',special:'',__blank:true});
    return filled;
  });
}
/* 填入卡片內容 */
function fillCard(node,data,globals,pay){
  $('.period',node).textContent = globals.feePeriod?`收費區間 ${globals.feePeriod}`:'';
  $('.name',node).textContent   = data.name || (data.__blank?'':'（未填）');
  $('.klass',node).textContent  = data.klass || (data.__blank?'':'—');
  $('.item',node).textContent   = globals.feeItem || (data.__blank?'':'—');
  $('.amount',node).textContent = data.__blank ? '' : formatAmount(data.amount);

  const parts=[];
  const flavor = String(data.flavor||'').trim();
  if(flavor) parts.push(flavor);
  if(data.bagYes) parts.push('+袋');
  const special = String(data.special||'').trim();
  if(special) parts.push(special);
  let noteStr = parts.join(' ');
  if(globals.globalNote) noteStr = noteStr ? noteStr + '；' + globals.globalNote : globals.globalNote;
  $('.note',node).textContent   = data.__blank ? '' : (noteStr || '—');

  $('.deadline',node).textContent = globals.deadline || (data.__blank?'':'—');

  // 匯款/轉帳
  $('.pay-name',node).textContent    = pay.name || '';
  $('.pay-bank',node).textContent    = pay.bank || '';
  $('.pay-account',node).textContent = pay.account || '';
  $('.pay-note',node).textContent    = pay.note || '';
}

/* 主流程 */
const printArea = document.getElementById('printArea');
const template  = document.getElementById('cardTemplate');

function generate(){
  const rows0=parseRows(document.getElementById('pasteArea').value);
  printArea.innerHTML='';
  const globals={
    feePeriod: document.getElementById('feePeriod').value.trim(),
    deadline:  document.getElementById('deadline').value,
    feeItem:   document.getElementById('feeItem').value.trim(),
    globalNote:document.getElementById('globalNote').value.trim()
  };
  const pay={
    name:    document.getElementById('payName').value.trim(),
    bank:    document.getElementById('payBank').value.trim(),
    account: document.getElementById('payAccount').value.trim(),
    note:    document.getElementById('payNote').value.trim()
  };

  if(rows0.length===0){
    document.getElementById('previewCount').textContent='尚未產生任何通知，請先貼上名單。';
    return;
  }
  const rows = sortByClassName(rows0);
  const pages= toPagesOf8(rows);

  pages.forEach(group=>{
    const page=document.createElement('div'); page.className='page';
    group.forEach(r=>{
      const node=template.content.cloneNode(true);
      fillCard(node,r,globals,pay);
      page.appendChild(node);
    });
    printArea.appendChild(page);
  });
  document.getElementById('previewCount').textContent=`共 ${rows.length} 位；每頁固定 8 位，共 ${pages.length} 頁。`;

  /* 金額為文字提醒（僅針對非空卡） */
  const textAmt = rows.filter(r => {
    const raw = String(r.amount||'').trim();
    return raw && !isAmountLike(raw);
  });
  const warnBox = document.getElementById('warnBox');
  if (textAmt.length){
    alert(`⚠️ 發現 ${textAmt.length} 筆「金額為文字」資料。\n這些會直接以原文顯示在金額欄。\n若需結帳金額，請把第 3 欄改成數字（例如 700）。`);
    warnBox.style.display='block';
    warnBox.textContent = `提醒：共有 ${textAmt.length} 筆金額為文字（非金額格式）。`;
  }else{
    warnBox.style.display='none';
    warnBox.textContent='';
  }
}

/* 預設：帶入下一月標籤與 10 日（遇週末順延） */
document.addEventListener('DOMContentLoaded', ()=>{
  const today=new Date();
  const periodInput = document.getElementById('feePeriod');
  const deadlineInput= document.getElementById('deadline');
  if(!periodInput.value)  periodInput.value  = nextMonthLabel(today);
  if(!deadlineInput.value)deadlineInput.value= nextMonth10thBusinessDay(today);
});

/* 事件 */
document.getElementById('btnGenerate').addEventListener('click', generate);
document.getElementById('btnPrint').addEventListener('click', ()=>{
  if(!printArea.children.length) generate();
  requestAnimationFrame(()=>window.print());
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('pasteArea').value='';
  document.getElementById('previewCount').textContent='';
  document.getElementById('warnBox').style.display='none';
  document.getElementById('warnBox').textContent='';
  document.getElementById('pasteArea').focus();
});
</script>
</body>
</html>
