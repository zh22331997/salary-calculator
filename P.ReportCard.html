<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å€‹äººæˆç¸¾å–®ç”¢ç”Ÿå™¨</title>
  <style>
/* =========================
   Design System (Tokens)
   ========================= */
:root{
  --brand-500:#A1C6EA; --brand-600:#8FB9E2;
  --secondary-500:#BBD1EA; --secondary-600:#A8C5E6;
  --clear-500:#DAE3E5; --clear-600:#CFD9DC;

  --text-strong:#1f2937; --text-normal:#374151; --text-mute:#6b7280;
  --border:#d1d5db; --border-strong:#9ca3af;
  --bg-page:#f0f2f5; --bg-card:#ffffff; --bg-info:#f8fbff; --bg-info-border:#e1eefc;

  --font-sans:"Microsoft JhengHei","å¾®è»Ÿæ­£é»‘é«”","Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;

  --radius-sm:6px; --radius-md:8px; --radius-lg:12px;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.08);
  --shadow-md:0 2px 10px rgba(0,0,0,0.10);
  --shadow-lg:0 4px 20px rgba(0,0,0,0.12);

  --space-1:.25rem; --space-2:.5rem; --space-3:.75rem; --space-4:1rem; --space-5:1.25rem; --space-6:1.5rem;
  --input-height:2.75rem; --btn-height:2.9rem;

  --focus-ring:0 0 0 3px rgba(106,154,255,0.25);
  --focus-border:#6a9aff;

  --btn-text:#17324A;
}

/* =========================
   Baseï¼ˆä¸å‹•åŸç‰ˆé¢ï¼Œåªåšé¢¨æ ¼ä¸€è‡´ï¼‰
   ========================= */
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:var(--font-sans);
  background:var(--bg-page);
  margin:0; padding:0;
  color:var(--text-normal);
}
#controls{
  background:var(--bg-card);
  padding:2rem; margin:2rem auto 1rem; border-radius:var(--radius-lg);
  box-shadow:var(--shadow-lg); max-width:1100px; width:calc(100% - 2rem);
}
h2{margin:0 0 var(--space-4); color:#0056b3; text-align:center; font-weight:800;}
h3{color:var(--text-strong); border-bottom:2px solid #e0e0e0; padding-bottom:.5rem; margin-top:1.25rem; margin-bottom:.75rem;}
label{font-weight:700; color:#555;}
p{color:#444; font-size:.95rem; line-height:1.6}

/* è¡¨å–®å…ƒä»¶ï¼ˆé¢¨æ ¼ä¸€è‡´ï¼‰ */
textarea, input, select{
  font-family:inherit; font-size:16px;
}
textarea,
input[type="text"],
input[type="number"],
select{
  width:100%; height:var(--input-height); padding:0 var(--space-4);
  border-radius:var(--radius-md); border:1px solid var(--border);
  background:#fff; transition:border-color .2s, box-shadow .2s;
}
textarea{
  height:auto; min-height:160px; padding:var(--space-3);
  line-height:1.5; font-family:var(--font-mono);
}
textarea:focus, input:focus, select:focus{ outline:none; border-color:var(--focus-border)!important; box-shadow:var(--focus-ring); }

/* ä¸‹æ‹‰å¤–è§€ï¼ˆè—ï¼‰ */
select{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  cursor:pointer; color:#fff; background:#4e73df; border-color:#4e73df;
  padding-right:2.2rem;
  background-image:
    linear-gradient(45deg,transparent 50%,#fff 50%),
    linear-gradient(135deg,#fff 50%,transparent 50%);
  background-position: calc(100% - 16px) calc(50% - 3px), calc(100% - 11px) calc(50% - 3px);
  background-size:6px 6px; background-repeat:no-repeat;
}
select:hover{background:#2e59d9; border-color:#2e59d9}

/* æŒ‰éˆ• */
button{
  display:inline-flex; align-items:center; justify-content:center;
  min-height:var(--btn-height); padding:0 var(--space-5);
  font-size:17px; font-weight:700; border:none; border-radius:var(--radius-md);
  cursor:pointer; color:var(--btn-text);
  background:var(--brand-500); box-shadow:var(--shadow-sm);
  transition:background-color .15s ease, transform .12s ease, box-shadow .2s;
}
button:hover{background:var(--brand-600); transform:translateY(-2px)}
button:active{transform:translateY(-1px)}
.btn-secondary{ background:var(--secondary-500); }
.btn-secondary:hover{ background:var(--secondary-600); }
.btn-clear{ background:var(--clear-500); }
.btn-clear:hover{ background:var(--clear-600); }
.btn-row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:.75rem; }

/* æˆç¸¾è¡¨æ ¼ï¼ˆç¶­æŒçµæ§‹ï¼Œé¢¨æ ¼ä¸€è‡´ï¼‰ */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  overflow:hidden;
  box-shadow:var(--shadow-sm);
}
th, td{
  border:1px solid var(--border);
  text-align:center;
  padding:6px;
  font-size:14px;
}
th{ background:var(--bg-info); color:var(--text-strong); border-color:var(--bg-info-border); }

.small-text{ font-size:10pt; color:var(--text-mute); }
.red-title{ color:#b91c1c; font-weight:bold; margin-top:10px; }

/* === åŸæœ¬ .b5 ç‰ˆé¢ï¼šä¸ä¿®æ”¹å°ºå¯¸ === */
.b5 {
  width: 50%;
  float: left;
  box-sizing: border-box;
  page-break-inside: avoid;
  page-break-before: avoid;
  break-inside: avoid;
  height: 100%;
  min-height: 100%;
  padding: 1.5cm;
  margin: 0.5cm;
  background: white;
  border: 1px solid #ccc;
  box-shadow: 0 0 4px rgba(0,0,0,.2);
}

/* è€å¸«çš„è©±ï¼šä¿ç•™æ›è¡Œ + æœ«å°¾å¤šä¸€ç©ºè¡Œï¼ˆç¶­æŒé»‘æ¡†ï¼‰ */
.teacher-box{
  border:1px solid black; padding:8px; white-space:pre-line; line-height:1.6;
}
.teacher-box::after{ content:"\A"; white-space:pre; }

/* ç°½åå€æ•´å¡Šç„¡æ¡†ç·š */
.signature-table{ border:none!important; box-shadow:none!important; background:transparent!important; margin-top:12px; }
.signature-table td, .signature-table th{ border:none!important; background:transparent!important; }

/* =========================
   åˆ—å°ï¼šæ©«å¼ B4ã€å…©å¼µä½µæ’ä¸€é 
   ========================= */
@page { size:B4 landscape; margin:0.5cm; }
@media print{
  html, body{ width:100%; height:100%; margin:0; padding:0; background:#fff; }
  #controls{ display:none!important; }
  /* è®“å…©å¼µå›ºå®šä½µæ’ï¼šä½¿ç”¨ flex-wrapï¼Œä¸¦æŠŠ .b5 é‚Šè·åœ¨åˆ—å°æ™‚æ­¸é›¶é¿å…æ“ ä¸é€²å» */
  #output{ display:flex; flex-wrap:wrap; justify-content:space-between; align-items:flex-start; }
  .b5{
    width:17.6cm !important;
    height:25cm !important;
    margin:0 !important;
    padding:1.5cm !important;
    page-break-inside: avoid;
    border:1px solid #000;
    box-shadow:none;
  }
  textarea, input, select{ border:none; color:#000; }
}
/* === æ¢å¾© select åŸæ¨£å¼ï¼ˆç™½åº•ã€é»‘å­—ã€è‡ªå‹•å¯¬åº¦ï¼‰ === */
select {
  appearance: auto;
  -webkit-appearance: auto;
  -moz-appearance: auto;
  background: #fff;
  color: #000;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 0 0.5rem;
  height: var(--input-height);
  cursor: pointer;
}

/* æ»‘éæˆ–èšç„¦æ™‚ç¶­æŒç°¡æ½”é‚Šæ¡†æ•ˆæœ */
select:hover {
  border-color: var(--focus-border);
}

select:focus {
  outline: none;
  border-color: var(--focus-border);
  box-shadow: var(--focus-ring);
}
/* === ä¿®æ­£æ¨™é¡Œå€çš„ select æ¨£å¼ï¼ˆæ¢å¾©åŸæ¨£æ’ç‰ˆï¼‰=== */
h2 select,
p select {
  appearance: auto !important;
  -webkit-appearance: auto !important;
  -moz-appearance: auto !important;
  background: #fff !important;
  color: #000 !important;
  border: 1px solid var(--border) !important;
  border-radius: 4px !important;
  padding: 0 0.3rem !important;
  height: 1.8rem !important;
  font-size: 14px !important;
  vertical-align: middle !important;
  width: auto !important;
}

  </style>
</head>

<body>

<div id="controls">
  <h2>æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘
    <select id="branch">
      <option>æ°¸å¹³</option><option>ç§€æœ—</option><option>æ¸…æ°´</option><option>æ°¸å’Œ</option><option>æ±Ÿç¿ </option>
    </select>åˆ†æ ¡
  </h2>

  <p style="text-align:center">
    <input id="schoolYear" size="4" readonly>å­¸å¹´
    <select id="grade"><option>ä¸€</option><option>äºŒ</option><option>ä¸‰</option><option>å››</option><option>äº”</option><option selected>å…­</option></select>å¹´ç´š
    <select id="semester"><option>ä¸Š</option><option>ä¸‹</option></select>å­¸æœŸ
    <select id="examType"><option>ä¸­</option><option>æœ«</option></select>è€ƒ å­¸ç”Ÿæˆç¸¾å–®
  </p>

  <h3>è«‹å¾EXCELè²¼ä¸Šå…¨ç­æˆç¸¾è³‡æ–™ï¼ˆå«æ¨™é¡Œåˆ—ï¼‰</h3>
  <textarea id="rawInput" placeholder="å§“å\åœ‹èª\æ•¸å­¸\è‡ªç„¶\ç¤¾æœƒ\è‹±æ–‡"></textarea>

  <h3>è«‹å¾EXCELè²¼ä¸Šç­å¹³å‡æˆç¸¾ï¼ˆä¸å«æ¨™é¡Œåˆ—ï¼Œè«‹å‹™å¿…ä¾ç…§ä¸‹åˆ—é †åº)</h3>
  <textarea id="avgPaste" placeholder="ä¸€äºŒå¹´ç´šï¼šåœ‹èª\æ•¸å­¸\ç¸½åˆ†\å¹³å‡ï¼›ä¸‰ï½å…­å¹´ç´šï¼šåœ‹èª\æ•¸å­¸\è‡ªç„¶\ç¤¾æœƒ\è‹±æ–‡\ç¸½åˆ†\å¹³å‡"></textarea>

  <div class="small-text" style="margin-top:6px">
    æ­£è¯ç­æ’å‰ <input id="targetIndex" type="number" value="5" style="width:60px; height:2rem"> åï¼ˆè‹¥æœ‰ä¸¦åˆ—åæ¬¡ï¼Œæœƒè‡ªå‹•åŒ…å«ï¼‰
  </div>

  <h3>è€å¸«çš„è©±</h3>
  <textarea id="teacherComment" placeholder="è«‹è¼¸å…¥è€å¸«çš„è©±ï¼Œæœƒå‡ºç¾åœ¨æˆç¸¾å–®ä¸Š"></textarea>
  <div id="wordCount" class="small-text" style="margin-top:4px;">ç›®å‰å­—æ•¸ï¼š0 / å»ºè­°ä¸Šé™ 600</div>

  <div class="btn-row">
    <button onclick="generateReports()">ç”¢ç”Ÿæˆç¸¾å–®</button>
    <button class="btn-secondary" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æ‰€æœ‰æˆç¸¾å–®</button>
    <button class="btn-clear" onclick="clearAll()">æ¸…ç©º</button>
  </div>
</div>

<div id="output"></div>

<script>
/* ====== å·¥å…· & å¹´ç´šç§‘ç›®è¦å‰‡ ====== */
function formatNumber(n){ const f=parseFloat(n); return Number.isNaN(f)?'':(f%1===0?parseInt(f):f.toFixed(2)); }
function num(v){ const x=parseFloat(v); return Number.isNaN(x)?0:x; }
function isLowerGrade(g){ return g==='ä¸€'||g==='äºŒ'; }
function getSubjectConfig(grade){
  return isLowerGrade(grade)
    ? [{key:'c',label:'åœ‹èª'},{key:'m',label:'æ•¸å­¸'}]
    : [{key:'c',label:'åœ‹èª'},{key:'m',label:'æ•¸å­¸'},{key:'s',label:'è‡ªç„¶'},{key:'so',label:'ç¤¾æœƒ'},{key:'e',label:'è‹±æ–‡'}];
}
function buildHeaderMap(headers, grade){
  const map={name:0};
  headers.forEach((t,idx)=>{ const title=(t||'').trim(); if(title.includes('å§“å')||title.toLowerCase()==='name') map.name=idx; });
  getSubjectConfig(grade).forEach(sub=>{
    headers.forEach((t,idx)=>{ const title=(t||'').trim(); if(title.includes(sub.label)) map[sub.key]=idx; });
  });
  return map;
}

/* ====== ç”¢ç”Ÿæˆç¸¾å–® ====== */
function generateReports(){
  const branch=document.getElementById("branch").value;
  const schoolYear=document.getElementById("schoolYear").value;
  const grade=document.getElementById("grade").value;
  const semester=document.getElementById("semester").value;
  const examType=document.getElementById("examType").value;
  const comment=document.getElementById("teacherComment").value;
  const topN=parseInt(document.getElementById("targetIndex").value)||5;

  // ç­å¹³å‡
  const subjects=getSubjectConfig(grade);
  const avgRaw=document.getElementById("avgPaste").value.trim().split("\t");
  const avgVals=subjects.map((_,i)=>num(avgRaw[i]||0));
  const avgTotal=avgVals.reduce((a,b)=>a+b,0);
  const avgAverage=subjects.length?avgTotal/subjects.length:0;

  // åŸå§‹è³‡æ–™
  const raw=document.getElementById("rawInput").value.trim();
  if(!raw){ alert("è«‹å…ˆè²¼ä¸Šå…¨ç­æˆç¸¾è³‡æ–™ï¼ˆå«æ¨™é¡Œåˆ—ï¼‰ã€‚"); return; }
  const lines=raw.split("\n").filter(l=>l.trim().length>0);
  if(lines.length<2){ alert("è³‡æ–™ç­†æ•¸ä¸è¶³ï¼Œè«‹ç¢ºèªè‡³å°‘åŒ…å«æ¨™é¡Œåˆ—èˆ‡ä¸€ä½å­¸ç”Ÿè³‡æ–™ã€‚"); return; }

  const headers=lines[0].split("\t");
  const headerMap=buildHeaderMap(headers,grade);
  const missing=subjects.filter(s=> typeof headerMap[s.key]!=='number').map(s=>s.label);
  if(missing.length){ alert(`æ‰¾ä¸åˆ°å¿…è¦æ¬„ä½ï¼š${missing.join('ã€')}ã€‚\nè«‹ç¢ºèªæ¨™é¡Œåˆ—æ˜¯å¦åŒ…å«é€™äº›æ¬„ä½ã€‚`); return; }

  const students=lines.slice(1).map(l=>l.split("\t"));
  const scoreList=students.map(fields=>{
    const subs=subjects.map(s=>num(fields[headerMap[s.key]]));
    const total=subs.reduce((a,b)=>a+b,0);
    return { name: fields[headerMap.name]||fields[0]||'', raw:fields, scores:subs, total, avg: subjects.length?(total/subjects.length):0 };
  }).sort((a,b)=>b.total-a.total);

  const cutoff=scoreList.length>=topN?scoreList[topN-1].total:0;
  const topStudents=scoreList.filter(stu=>stu.total>=cutoff);

  const output=document.getElementById("output");
  output.innerHTML="";

  scoreList.forEach(student=>{
    // å‰Nåï¼ˆå«ä¸¦åˆ—ï¼‰
    let currentRank=1,lastScore=null,displayRank=1;
    const topRows=topStudents.map(stu=>{
      if(lastScore!==null && stu.total<lastScore){ displayRank=currentRank; }
      lastScore=stu.total; currentRank++;
      const cells=subjects.map((s,idx)=>`<td>${formatNumber(stu.scores[idx])}</td>`).join("");
      return `<tr><td>${displayRank}</td><td>${stu.name}</td>${cells}<td>${formatNumber(stu.total)}</td><td>${formatNumber(stu.avg)}</td></tr>`;
    }).join("");

    const theadCols=['å­¸ç”Ÿ'].concat(subjects.map(s=>s.label)).concat(['ç¸½åˆ†','å¹³å‡']);
    const theadHtml=theadCols.map(t=>`<th>${t}</th>`).join("");
    const personCells=subjects.map((s,idx)=>`<td>${formatNumber(student.scores[idx])}</td>`).join("");
    const avgCells=avgVals.map(v=>`<td>${formatNumber(v)}</td>`).join("");
    const rankHead=['åæ¬¡','å§“å'].concat(subjects.map(s=>s.label)).concat(['ç¸½åˆ†','å¹³å‡']).map(t=>`<th>${t}</th>`).join("");

    const page=`
    <div class="b5">
      <h2 style="text-align:center; margin-bottom:4px; line-height:1.2;">æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘ ${branch}åˆ†æ ¡</h2>
      <p style="text-align:center; margin-top:0; line-height:1.2;">${schoolYear}å­¸å¹´${semester}å­¸æœŸ æœŸ${examType}è€ƒ ${grade}å¹´ç´šå­¸ç”Ÿå€‹äººæˆç¸¾å–®</p>

      <table>
        <tr>${theadHtml}</tr>
        <tr>
          <td>${student.name}</td>
          ${personCells}
          <td>${formatNumber(student.total)}</td>
          <td>${formatNumber(student.avg)}</td>
        </tr>
        <tr>
          <td>ç­å¹³å‡</td>
          ${avgCells}
          <td>${formatNumber(avgTotal)}</td>
          <td>${formatNumber(avgAverage)}</td>
        </tr>
      </table>

      <div class="red-title">æ­£è¯ç­æ’å‰${topN}å</div>
      <table>
        <tr>${rankHead}</tr>
        ${topRows}
      </table>

      <p><strong>è€å¸«çš„è©±ï¼š</strong></p>
      <div class="teacher-box">${comment}</div>

      <table class="signature-table" style="width:100%; font-size:10pt; border-collapse:collapse;">
        <tr>
          <td style="width:33%; text-align:left;">ç­ä¸»ä»»ï¼š</td>
          <td style="width:33%; text-align:left;">å°å¸«ï¼š</td>
          <td style="width:33%; text-align:left;">å®¶é•·ç°½åï¼š</td>
        </tr>
      </table>
    </div>`;
    output.innerHTML += page;
  });
}

/* æ¸…ç©ºéµï¼šé‚„åŸè¼¸å…¥èˆ‡è¼¸å‡º */
function clearAll(){
  document.getElementById("rawInput").value="";
  document.getElementById("avgPaste").value="";
  document.getElementById("teacherComment").value="";
  document.getElementById("wordCount").innerText="ç›®å‰å­—æ•¸ï¼š0 / å»ºè­°ä¸Šé™ 600";
  document.getElementById("targetIndex").value=5;
  document.getElementById("output").innerHTML="";
}

/* é è¨­å­¸å¹´/å­¸æœŸ/è€ƒåˆ¥ */
window.addEventListener("DOMContentLoaded",()=>{
  const now=new Date(), y=now.getFullYear(), m=now.getMonth()+1;
  const semesterYear=(m>=8||m===1)?(y-1911):(y-1912);
  const semester=(m>=8||m===1)?"ä¸Š":"ä¸‹";
  let examType="ä¸­";
  if((m>=1&&m<=2)||(m>=5&&m<=6)) examType="æœ«";
  else if((m>=11&&m<=12)||(m>=4&&m<=5)) examType="ä¸­";
  document.getElementById("schoolYear").value=semesterYear;
  document.getElementById("semester").value=semester;
  document.getElementById("examType").value=examType;

  // å­—æ•¸è¨ˆç®—
  const tc=document.getElementById("teacherComment");
  tc.addEventListener("input",()=>{
    const c=tc.value.length;
    const w=document.getElementById("wordCount");
    w.innerText=`ç›®å‰å­—æ•¸ï¼š${c} / å»ºè­°ä¸Šé™ 600`;
    w.style.color=c>600?'red':'#6b7280';
  });
});
</script>

</body>
</html>
