<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å€‹äººæˆç¸¾å–®ç”¢ç”Ÿå™¨</title>
  <style>
    @page {
      size: B4 landscape;
      margin: 0.5cm;
    }

    @media print {
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .b5 {
        width: 17.6cm !important;
        height: 25cm !important;
        padding: 1.5cm;
        box-sizing: border-box;
        page-break-inside: avoid;
      }
    }

    textarea, input, select {
      font-family: inherit;
      font-size: 14px;
    }

    .b5 {
      width: 50%;
      float: left;
      box-sizing: border-box;
      page-break-inside: avoid;
      page-break-before: avoid;
      break-inside: avoid;
      height: 100%;
      min-height: 100%;
      padding: 1.5cm;
      margin: 0.5cm;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid black;
      text-align: center;
      padding: 5px;
    }

    textarea {
      width: 100%;
      height: 120px;
    }

    #output {
      margin-top: 20px;
    }

    .small-text {
      font-size: 10pt;
    }

    .red-title {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }

    @media print {
      textarea, input, select {
        border: none;
        color: black;
      }
      button, #controls {
        display: none;
      }
    }

    @media screen {
      .b5 {
        width: 17.6cm;
        height: 25cm;
        margin: 0.5cm auto;
        border: 1px solid #ccc;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
        background: white;
      }
    }
  </style>
</head>

<body>

<div id="controls">
  <h2 style="text-align:center">æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘
    <select id="branch">
      <option>æ°¸å¹³</option>
      <option>ç§€æœ—</option>
      <option>æ¸…æ°´</option>
      <option>æ°¸å’Œ</option>
      <option>æ±Ÿç¿ </option>
    </select>åˆ†æ ¡
  </h2>

  <p style="text-align:center">
    <input id="schoolYear" size="4" readonly>å­¸å¹´
    <select id="grade">
      <option>ä¸€</option>
      <option>äºŒ</option>
      <option>ä¸‰</option>
      <option>å››</option>
      <option>äº”</option>
      <option selected>å…­</option>
    </select>å¹´ç´š
    <select id="semester"><option>ä¸Š</option><option>ä¸‹</option></select>å­¸æœŸ
    <select id="examType"><option>ä¸­</option><option>æœ«</option></select>è€ƒ å­¸ç”Ÿæˆç¸¾å–®
  </p>

  <h3>è«‹è²¼ä¸Šå…¨ç­æˆç¸¾è³‡æ–™ï¼ˆå«æ¨™é¡Œåˆ—ï¼‰</h3>
  <textarea id="rawInput" placeholder="å§“å\tåœ‹èª\tæ•¸å­¸\tè‡ªç„¶\tç¤¾æœƒ\tè‹±æ–‡"></textarea>
  <br><br>

  <h3>ç­å¹³å‡æˆç¸¾ï¼ˆè²¼ä¸Šæ ¼å¼ï¼šåœ‹èª\tæ•¸å­¸\tè‡ªç„¶\tç¤¾æœƒ\tè‹±æ–‡ï¼‰</h3>
  <textarea id="avgPaste" placeholder="è«‹è²¼ä¸Šç­å¹³å‡äº”ç§‘æˆç¸¾ï¼ˆä¾‹å¦‚ï¼š91.29\t91.54\t94.37\t92.28\t93.57ï¼‰"></textarea>
  <br><br>

  æ­£è¯ç­æ’å‰ <input id="targetIndex" type="number" value="5" style="width:50px"> åï¼ˆè‹¥æœ‰ä¸¦åˆ—åæ¬¡ï¼Œæœƒè‡ªå‹•åŒ…å«ï¼‰
  <br><br>

  è€å¸«çš„è©±ï¼š<br>
  <textarea id="teacherComment" placeholder="è«‹è¼¸å…¥è€å¸«çš„è©±ï¼Œæœƒå‡ºç¾åœ¨æˆç¸¾å–®ä¸Š"></textarea>
  <div id="wordCount" style="font-size:12px; color:#666; margin-top:4px;">ç›®å‰å­—æ•¸ï¼š0 / å»ºè­°ä¸Šé™ 600</div>
  <br><br>

  <button onclick="generateReports()">ç”¢ç”Ÿæˆç¸¾å–®</button>
  <button onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æ‰€æœ‰æˆç¸¾å–®</button>
</div>

<div id="output"></div>

<script>
function formatNumber(n) {
  const f = parseFloat(n);
  return f % 1 === 0 ? parseInt(f) : f.toFixed(2);
}

function generateReports() {
  const branch = document.getElementById("branch").value;
  const schoolYear = document.getElementById("schoolYear").value;
  const grade = document.getElementById("grade").value;
  const semester = document.getElementById("semester").value;
  const examType = document.getElementById("examType").value;
  const comment = document.getElementById("teacherComment").value;
  const topN = parseInt(document.getElementById("targetIndex").value);

  const avgRaw = document.getElementById("avgPaste").value.trim().split("\t");
  const avgC = Number(avgRaw[0] || 0).toFixed(2);
  const avgM = Number(avgRaw[1] || 0).toFixed(2);
  const avgS = Number(avgRaw[2] || 0).toFixed(2);
  const avgSo = Number(avgRaw[3] || 0).toFixed(2);
  const avgE = Number(avgRaw[4] || 0).toFixed(2);

  const avgTotal = (+avgC + +avgM + +avgS + +avgSo + +avgE).toFixed(2);
  const avgAverage = ((+avgC + +avgM + +avgS + +avgSo + +avgE)/5).toFixed(2);

  const raw = document.getElementById("rawInput").value.trim();
  const lines = raw.split("\n");
  const headers = lines[0].split("\t");
  const headerMap = {};
  headers.forEach((title, index) => {
    if (title.includes('åœ‹èª')) headerMap.c = index;
    if (title.includes('æ•¸å­¸')) headerMap.m = index;
    if (title.includes('è‡ªç„¶')) headerMap.s = index;
    if (title.includes('ç¤¾æœƒ')) headerMap.so = index;
    if (title.includes('è‹±æ–‡')) headerMap.e = index;
  });

  const students = lines.slice(1).map(l => l.split("\t"));
  const scoreList = students.map(fields => {
    const total = [
      +fields[headerMap.c],
      +fields[headerMap.m],
      +fields[headerMap.s],
      +fields[headerMap.so],
      +fields[headerMap.e]
    ].reduce((a, b) => a + b, 0);
    return {
      name: fields[0],
      data: fields,
      total: total,
      avg: (total / 5).toFixed(1)
    };
  }).sort((a, b) => b.total - a.total);

  const cutoffScore = scoreList.length >= topN ? scoreList[topN - 1].total : 0;
  const topStudents = scoreList.filter(stu => stu.total >= cutoffScore);

  const output = document.getElementById("output");
  output.innerHTML = "";

  scoreList.forEach((student) => {
    const s = student.data;
    let currentRank = 1;
    let lastScore = null;
    let displayRank = 1;
    const topRows = topStudents.map((stu) => {
      if (lastScore !== null && stu.total < lastScore) {
        displayRank = currentRank;
      }
      lastScore = stu.total;
      currentRank++;
      return `
        <tr>
          <td>${displayRank}</td>
          <td>${stu.name}</td>
          <td>${formatNumber(stu.data[headerMap.c])}</td>
          <td>${formatNumber(stu.data[headerMap.m])}</td>
          <td>${formatNumber(stu.data[headerMap.s])}</td>
          <td>${formatNumber(stu.data[headerMap.so])}</td>
          <td>${formatNumber(stu.data[headerMap.e])}</td>
          <td>${formatNumber(stu.total)}</td>
          <td>${formatNumber(stu.avg)}</td>
        </tr>`;
    }).join("");

    const page = `
    <div class="b5">
      <h2 style="text-align:center; margin-bottom: 4px; line-height: 1.2;">æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘ ${branch}åˆ†æ ¡</h2>
      <p style="text-align:center; margin-top: 0; line-height: 1.2;">${schoolYear}å­¸å¹´${semester}å­¸æœŸ æœŸ${examType}è€ƒ ${grade}å¹´ç´šå­¸ç”Ÿå€‹äººæˆç¸¾å–®</p>

      <table>
        <tr><th>å­¸ç”Ÿ</th><th>åœ‹èª</th><th>æ•¸å­¸</th><th>è‡ªç„¶</th><th>ç¤¾æœƒ</th><th>è‹±æ–‡</th><th>ç¸½åˆ†</th><th>å¹³å‡</th></tr>
        <tr>
          <td>${s[0]}</td>
          <td>${formatNumber(s[headerMap.c])}</td>
          <td>${formatNumber(s[headerMap.m])}</td>
          <td>${formatNumber(s[headerMap.s])}</td>
          <td>${formatNumber(s[headerMap.so])}</td>
          <td>${formatNumber(s[headerMap.e])}</td>
          <td>${formatNumber(student.total)}</td>
          <td>${formatNumber(student.avg)}</td>
        </tr>
        <tr>
          <td>ç­å¹³å‡</td>
          <td>${formatNumber(avgC)}</td>
          <td>${formatNumber(avgM)}</td>
          <td>${formatNumber(avgS)}</td>
          <td>${formatNumber(avgSo)}</td>
          <td>${formatNumber(avgE)}</td>
          <td>${formatNumber(avgTotal)}</td>
          <td>${formatNumber(avgAverage)}</td>
        </tr>
      </table>

      <div class="red-title">æ­£è¯ç­æ’å‰${topN}å</div>
      <table>
        <tr><th>åæ¬¡</th><th>å§“å</th><th>åœ‹èª</th><th>æ•¸å­¸</th><th>è‡ªç„¶</th><th>ç¤¾æœƒ</th><th>è‹±æ–‡</th><th>ç¸½åˆ†</th><th>å¹³å‡</th></tr>
        ${topRows}
      </table>

      <p><strong>è€å¸«çš„è©±ï¼š</strong></p>
      <div style="border: 1px solid black; padding: 8px; white-space: pre-line;">${comment}</div>

      <table style="width:100%; margin-top:12px; font-size:10pt; border-collapse: collapse;">
        <tr>
          <td style="width:33%; text-align:left; border: 1px solid white;">ç­ä¸»ä»»ï¼š</td>
          <td style="width:33%; text-align:left; border: 1px solid white;">å°å¸«ï¼š</td>
          <td style="width:33%; text-align:left; border: 1px solid white;">å®¶é•·ç°½åï¼š</td>
        </tr>
      </table>
    </div>
    `;
    output.innerHTML += page;
  });
}

window.addEventListener("DOMContentLoaded", () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;

  const semesterYear = (month >= 8 || month === 1)
    ? year - 1911
    : year - 1912;
  const semester = (month >= 8 || month === 1) ? "ä¸Š" : "ä¸‹";

  let examType = "ä¸­";
  if ((month >= 1 && month <= 2) || (month >= 5 && month <= 6)) {
    examType = "æœ«";
  } else if ((month >= 11 && month <= 12) || (month >= 4 && month <= 5)) {
    examType = "ä¸­";
  }

  document.getElementById("schoolYear").value = semesterYear;
  document.getElementById("semester").value = semester;
  document.getElementById("examType").value = examType;

  // å­—æ•¸è¨ˆç®—åŠŸèƒ½å•Ÿå‹•
  const teacherComment = document.getElementById("teacherComment");
  teacherComment.addEventListener("input", () => {
    const count = teacherComment.value.length;
    const wordCountDisplay = document.getElementById("wordCount");
    wordCountDisplay.innerText = `ç›®å‰å­—æ•¸ï¼š${count} / å»ºè­°ä¸Šé™ 600`;
    wordCountDisplay.style.color = count > 600 ? 'red' : '#666';
  });
});
</script>

</body>
</html>
