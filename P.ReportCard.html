<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>個人成績單產生器</title>
  <style>
    @page {
      size: B4 landscape;
      margin: 0.5cm;
    }

    @media print {
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .b5 {
        width: 17.6cm !important;
        height: 25cm !important;
        padding: 1.5cm;
        box-sizing: border-box;
        page-break-inside: avoid;
      }
    }

    textarea, input, select {
      font-family: inherit;
      font-size: 14px;
    }

    .b5 {
      width: 50%;
      float: left;
      box-sizing: border-box;
      page-break-inside: avoid;
      page-break-before: avoid;
      break-inside: avoid;
      height: 100%;
      min-height: 100%;
      padding: 1.5cm;
      margin: 0.5cm;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid black;
      text-align: center;
      padding: 5px;
    }

    textarea {
      width: 100%;
      height: 120px;
    }

    #output {
      margin-top: 20px;
    }

    .small-text {
      font-size: 10pt;
    }

    .red-title {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }

    @media print {
      textarea, input, select {
        border: none;
        color: black;
      }
      button, #controls {
        display: none;
      }
    }

    @media screen {
      .b5 {
        width: 17.6cm;
        height: 25cm;
        margin: 0.5cm auto;
        border: 1px solid #ccc;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
        background: white;
      }
    }
  </style>
</head>

<body>

<div id="controls">
  <h2 style="text-align:center">正華資優教育學苑
    <select id="branch">
      <option>永平</option>
      <option>秀朗</option>
      <option>清水</option>
      <option>永和</option>
      <option>江翠</option>
    </select>分校
  </h2>

  <p style="text-align:center">
    <input id="schoolYear" size="4" readonly>學年
    <select id="grade">
      <option>一</option>
      <option>二</option>
      <option>三</option>
      <option>四</option>
      <option>五</option>
      <option selected>六</option>
    </select>年級
    <select id="semester"><option>上</option><option>下</option></select>學期
    <select id="examType"><option>中</option><option>末</option></select>考 學生成績單
  </p>

  <h3 id="rawTitle">請貼上全班成績資料（含標題列）</h3>
  <textarea id="rawInput" placeholder="姓名\t國語\t數學\t自然\t社會\t英文"></textarea>
  <div id="rawHint" class="small-text" style="margin-top:4px;color:#555;">
    標題列需包含：姓名、國語、數學、自然、社會、英文（年級不同會自動調整必填科目）
  </div>
  <br><br>

  <h3 id="avgTitle">班平均成績（貼上格式：國語\t數學\t自然\t社會\t英文）</h3>
  <textarea id="avgPaste" placeholder="例如：91.29\t91.54\t94.37\t92.28\t93.57"></textarea>
  <div id="avgHint" class="small-text" style="margin-top:4px;color:#555;">
    依年級自動調整科目數：一～二年級（2 科），三～六年級（5 科）
  </div>
  <br><br>

  正華班排前 <input id="targetIndex" type="number" value="5" style="width:50px"> 名（若有並列名次，會自動包含）
  <br><br>

  老師的話：<br>
  <textarea id="teacherComment" placeholder="請輸入老師的話，會出現在成績單上"></textarea>
  <div id="wordCount" style="font-size:12px; color:#666; margin-top:4px;">目前字數：0 / 建議上限 600</div>
  <br><br>

  <button onclick="generateReports()">產生成績單</button>
  <button onclick="window.print()">🖨️ 列印所有成績單</button>
</div>

<div id="output"></div>

<script>
function formatNumber(n) {
  const f = parseFloat(n);
  if (Number.isNaN(f)) return '';
  return f % 1 === 0 ? parseInt(f) : f.toFixed(2);
}
function num(v){ const x = parseFloat(v); return Number.isNaN(x) ? 0 : x; }

function isLowerGrade(grade){ return grade === '一' || grade === '二'; }

function getSubjectConfig(grade){
  if (isLowerGrade(grade)) {
    return [
      { key: 'c', label: '國語' },
      { key: 'm', label: '數學' }
    ];
  }
  return [
    { key: 'c', label: '國語' },
    { key: 'm', label: '數學' },
    { key: 's', label: '自然' },
    { key: 'so', label: '社會' },
    { key: 'e', label: '英文' }
  ];
}

function updatePlaceholders(){
  const grade = document.getElementById("grade").value;
  const subs = getSubjectConfig(grade).map(s=>s.label);
  const rawPH = ["姓名"].concat(subs).join("\\t");
  document.getElementById("rawInput").placeholder = rawPH;

  const avgTitle = document.getElementById("avgTitle");
  const avgPH = subs.join("\\t");
  avgTitle.innerText = `班平均成績（貼上格式：${avgPH}）`;
  document.getElementById("avgPaste").placeholder = `例如：${subs.map(()=> (90 + Math.random()*10).toFixed(2)).join("\\t")}`;

  const rawHint = document.getElementById("rawHint");
  rawHint.innerText = `標題列需包含：姓名、${subs.join('、')}（可任意順序，系統會自動對應）`;
}

function buildHeaderMap(headers, grade){
  const map = { name: 0 }; // 預設第 0 欄是姓名（常見）
  // 嘗試尋找「姓名」欄位
  headers.forEach((t, idx)=>{
    const title = (t || '').trim();
    if (title.includes('姓名') || title.toLowerCase() === 'name') map.name = idx;
  });

  const subjects = getSubjectConfig(grade);
  subjects.forEach(sub=>{
    headers.forEach((t, idx)=>{
      const title = (t || '').trim();
      if (title.includes(sub.label)) map[sub.key] = idx;
    });
  });
  return map;
}

function validateHeaderMap(map, grade){
  const subjects = getSubjectConfig(grade);
  const missing = subjects.filter(s=> typeof map[s.key] !== 'number');
  return { ok: missing.length === 0, missing: missing.map(m=>m.label) };
}

function parseAvgBySubjects(avgRawArr, grade){
  const subjects = getSubjectConfig(grade);
  const vals = subjects.map((_, i)=> num(avgRawArr[i]||0));
  const total = vals.reduce((a,b)=>a+b,0);
  const avg = (vals.length>0) ? (total/vals.length) : 0;
  return { vals, total, avg, subjects };
}

function generateReports() {
  const branch = document.getElementById("branch").value;
  const schoolYear = document.getElementById("schoolYear").value;
  const grade = document.getElementById("grade").value;
  const semester = document.getElementById("semester").value;
  const examType = document.getElementById("examType").value;
  const comment = document.getElementById("teacherComment").value;
  const topN = parseInt(document.getElementById("targetIndex").value);

  // 班平均
  const avgRaw = document.getElementById("avgPaste").value.trim().split("\t");
  const { vals: avgVals, total: avgTotal, avg: avgAverage, subjects } = parseAvgBySubjects(avgRaw, grade);

  // 原始資料
  const raw = document.getElementById("rawInput").value.trim();
  if (!raw) { alert("請先貼上全班成績資料（含標題列）。"); return; }
  const lines = raw.split("\n").filter(l => l.trim().length > 0);
  if (lines.length < 2) { alert("資料筆數不足，請確認至少包含標題列與一位學生資料。"); return; }

  const headers = lines[0].split("\t");
  const headerMap = buildHeaderMap(headers, grade);
  const headerCheck = validateHeaderMap(headerMap, grade);
  if (!headerCheck.ok) {
    alert(`找不到必要欄位：${headerCheck.missing.join('、')}。\n請確認標題列是否包含這些欄位。`);
    return;
  }

  // 解析學生資料
  const students = lines.slice(1).map(l => l.split("\t"));
  const scoreList = students.map(fields => {
    const name = fields[headerMap.name] || fields[0] || '';
    const subsScores = subjects.map(s => num(fields[headerMap[s.key]]));
    const total = subsScores.reduce((a,b)=>a+b,0);
    const avg = subjects.length ? (total / subjects.length) : 0;
    return {
      name,
      raw: fields,
      scores: subsScores,
      total,
      avg
    };
  }).sort((a,b)=> b.total - a.total);

  // 前 N 名（含並列）
  const cutoffScore = scoreList.length >= topN ? scoreList[topN - 1].total : 0;
  const topStudents = scoreList.filter(stu => stu.total >= cutoffScore);

  // 產出
  const output = document.getElementById("output");
  output.innerHTML = "";

  scoreList.forEach((student) => {
    // 前 N 名表格（處理並列名次）
    let currentRank = 1;
    let lastScore = null;
    let displayRank = 1;
    const topRows = topStudents.map((stu) => {
      if (lastScore !== null && stu.total < lastScore) {
        displayRank = currentRank;
      }
      lastScore = stu.total;
      currentRank++;
      const cells = subjects.map((s, idx)=> `<td>${formatNumber(stu.scores[idx])}</td>`).join("");
      return `
        <tr>
          <td>${displayRank}</td>
          <td>${stu.name}</td>
          ${cells}
          <td>${formatNumber(stu.total)}</td>
          <td>${formatNumber(stu.avg)}</td>
        </tr>`;
    }).join("");

    // 個人成績列
    const personCells = subjects.map((s, idx)=>{
      const colIndex = headerMap[s.key];
      return `<td>${formatNumber(student.raw[colIndex])}</td>`;
    }).join("");

    // 班平均列
    const avgCells = avgVals.map(v => `<td>${formatNumber(v.toFixed ? v.toFixed(2) : v)}</td>`).join("");

    // 動態表頭
    const theadCols = ['學生'].concat(subjects.map(s=>s.label)).concat(['總分','平均']);
    const theadHtml = theadCols.map(t=>`<th>${t}</th>`).join("");

    // 前 N 名表頭
    const rankHead = ['名次','姓名'].concat(subjects.map(s=>s.label)).concat(['總分','平均']);
    const rankHeadHtml = rankHead.map(t=>`<th>${t}</th>`).join("");

    const page = `
    <div class="b5">
      <h2 style="text-align:center; margin-bottom: 4px; line-height: 1.2;">正華資優教育學苑 ${branch}分校</h2>
      <p style="text-align:center; margin-top: 0; line-height: 1.2;">${schoolYear}學年${semester}學期 期${examType}考 ${grade}年級學生個人成績單</p>

      <table>
        <tr>${theadHtml}</tr>
        <tr>
          <td>${student.name}</td>
          ${personCells}
          <td>${formatNumber(student.total)}</td>
          <td>${formatNumber(student.avg)}</td>
        </tr>
        <tr>
          <td>班平均</td>
          ${avgCells}
          <td>${formatNumber(avgTotal)}</td>
          <td>${formatNumber(avgAverage)}</td>
        </tr>
      </table>

      <div class="red-title">正華班排前${topN}名</div>
      <table>
        <tr>${rankHeadHtml}</tr>
        ${topRows}
      </table>

      <p><strong>老師的話：</strong></p>
      <div style="border: 1px solid black; padding: 8px; white-space: pre-line;">${comment}</div>

      <table style="width:100%; margin-top:12px; font-size:10pt; border-collapse: collapse;">
        <tr>
          <td style="width:33%; text-align:left; border: 1px solid white;">班主任：</td>
          <td style="width:33%; text-align:left; border: 1px solid white;">導師：</td>
          <td style="width:33%; text-align:left; border: 1px solid white;">家長簽名：</td>
        </tr>
      </table>
    </div>
    `;
    output.innerHTML += page;
  });
}

function initSemesterMeta(){
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;

  const semesterYear = (month >= 8 || month === 1)
    ? year - 1911
    : year - 1912;
  const semester = (month >= 8 || month === 1) ? "上" : "下";

  let examType = "中";
  if ((month >= 1 && month <= 2) || (month >= 5 && month <= 6)) {
    examType = "末";
  } else if ((month >= 11 && month <= 12) || (month >= 4 && month <= 5)) {
    examType = "中";
  }

  document.getElementById("schoolYear").value = semesterYear;
  document.getElementById("semester").value = semester;
  document.getElementById("examType").value = examType;
}

window.addEventListener("DOMContentLoaded", () => {
  initSemesterMeta();
  updatePlaceholders();

  // 字數計算功能啟動
  const teacherComment = document.getElementById("teacherComment");
  teacherComment.addEventListener("input", () => {
    const count = teacherComment.value.length;
    const wordCountDisplay = document.getElementById("wordCount");
    wordCountDisplay.innerText = `目前字數：${count} / 建議上限 600`;
    wordCountDisplay.style.color = count > 600 ? 'red' : '#666';
  });

  // 年級切換 → 動態切換科目數與提示
  document.getElementById("grade").addEventListener("change", updatePlaceholders);
});
</script>

</body>
</html>

