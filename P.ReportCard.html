<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å€‹äººæˆç¸¾å–®ç”¢ç”Ÿå™¨</title>
  <style>
    @page {
      size: B4 landscape;
      margin: 0.5cm;
    }

    @media print {
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .b5 {
        width: 17.6cm !important;
        height: 25cm !important;
        padding: 1.5cm;
        box-sizing: border-box;
        page-break-inside: avoid;
      }
    }

    textarea, input, select {
      font-family: inherit;
      font-size: 14px;
    }

    .b5 {
      width: 50%;
      float: left;
      box-sizing: border-box;
      page-break-inside: avoid;
      page-break-before: avoid;
      break-inside: avoid;
      height: 100%;
      min-height: 100%;
      padding: 1.5cm;
      margin: 0.5cm;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid black;
      text-align: center;
      padding: 5px;
    }

    textarea {
      width: 100%;
      height: 120px;
    }

    #output {
      margin-top: 20px;
    }

    .small-text {
      font-size: 10pt;
    }

    .red-title {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }

    @media print {
      textarea, input, select {
        border: none;
        color: black;
      }
      button, #controls {
        display: none;
      }
    }

    @media screen {
      .b5 {
        width: 17.6cm;
        height: 25cm;
        margin: 0.5cm auto;
        border: 1px solid #ccc;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
        background: white;
      }
    }
  </style>
</head>

<body>

<div id="controls">
  <h2 style="text-align:center">æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘
    <select id="branch">
      <option>æ°¸å¹³</option>
      <option>ç§€æœ—</option>
      <option>æ¸…æ°´</option>
      <option>æ°¸å’Œ</option>
      <option>æ±Ÿç¿ </option>
    </select>åˆ†æ ¡
  </h2>

  <p style="text-align:center">
    <input id="schoolYear" size="4" readonly>å­¸å¹´
    <select id="grade">
      <option>ä¸€</option>
      <option>äºŒ</option>
      <option>ä¸‰</option>
      <option>å››</option>
      <option>äº”</option>
      <option selected>å…­</option>
    </select>å¹´ç´š
    <select id="semester"><option>ä¸Š</option><option>ä¸‹</option></select>å­¸æœŸ
    <select id="examType"><option>ä¸­</option><option>æœ«</option></select>è€ƒ å­¸ç”Ÿæˆç¸¾å–®
  </p>

  <h3 id="rawTitle">è«‹è²¼ä¸Šå…¨ç­æˆç¸¾è³‡æ–™ï¼ˆå«æ¨™é¡Œåˆ—ï¼‰</h3>
  <textarea id="rawInput" placeholder="å§“å\tåœ‹èª\tæ•¸å­¸\tè‡ªç„¶\tç¤¾æœƒ\tè‹±æ–‡"></textarea>
  <div id="rawHint" class="small-text" style="margin-top:4px;color:#555;">
    æ¨™é¡Œåˆ—éœ€åŒ…å«ï¼šå§“åã€åœ‹èªã€æ•¸å­¸ã€è‡ªç„¶ã€ç¤¾æœƒã€è‹±æ–‡ï¼ˆå¹´ç´šä¸åŒæœƒè‡ªå‹•èª¿æ•´å¿…å¡«ç§‘ç›®ï¼‰
  </div>
  <br><br>

  <h3 id="avgTitle">ç­å¹³å‡æˆç¸¾ï¼ˆè²¼ä¸Šæ ¼å¼ï¼šåœ‹èª\tæ•¸å­¸\tè‡ªç„¶\tç¤¾æœƒ\tè‹±æ–‡ï¼‰</h3>
  <textarea id="avgPaste" placeholder="ä¾‹å¦‚ï¼š91.29\t91.54\t94.37\t92.28\t93.57"></textarea>
  <div id="avgHint" class="small-text" style="margin-top:4px;color:#555;">
    ä¾å¹´ç´šè‡ªå‹•èª¿æ•´ç§‘ç›®æ•¸ï¼šä¸€ï½äºŒå¹´ç´šï¼ˆ2 ç§‘ï¼‰ï¼Œä¸‰ï½å…­å¹´ç´šï¼ˆ5 ç§‘ï¼‰
  </div>
  <br><br>

  æ­£è¯ç­æ’å‰ <input id="targetIndex" type="number" value="5" style="width:50px"> åï¼ˆè‹¥æœ‰ä¸¦åˆ—åæ¬¡ï¼Œæœƒè‡ªå‹•åŒ…å«ï¼‰
  <br><br>

  è€å¸«çš„è©±ï¼š<br>
  <textarea id="teacherComment" placeholder="è«‹è¼¸å…¥è€å¸«çš„è©±ï¼Œæœƒå‡ºç¾åœ¨æˆç¸¾å–®ä¸Š"></textarea>
  <div id="wordCount" style="font-size:12px; color:#666; margin-top:4px;">ç›®å‰å­—æ•¸ï¼š0 / å»ºè­°ä¸Šé™ 600</div>
  <br><br>

  <button onclick="generateReports()">ç”¢ç”Ÿæˆç¸¾å–®</button>
  <button onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æ‰€æœ‰æˆç¸¾å–®</button>
</div>

<div id="output"></div>

<script>
function formatNumber(n) {
  const f = parseFloat(n);
  if (Number.isNaN(f)) return '';
  return f % 1 === 0 ? parseInt(f) : f.toFixed(2);
}
function num(v){ const x = parseFloat(v); return Number.isNaN(x) ? 0 : x; }

function isLowerGrade(grade){ return grade === 'ä¸€' || grade === 'äºŒ'; }

function getSubjectConfig(grade){
  if (isLowerGrade(grade)) {
    return [
      { key: 'c', label: 'åœ‹èª' },
      { key: 'm', label: 'æ•¸å­¸' }
    ];
  }
  return [
    { key: 'c', label: 'åœ‹èª' },
    { key: 'm', label: 'æ•¸å­¸' },
    { key: 's', label: 'è‡ªç„¶' },
    { key: 'so', label: 'ç¤¾æœƒ' },
    { key: 'e', label: 'è‹±æ–‡' }
  ];
}

function updatePlaceholders(){
  const grade = document.getElementById("grade").value;
  const subs = getSubjectConfig(grade).map(s=>s.label);
  const rawPH = ["å§“å"].concat(subs).join("\\t");
  document.getElementById("rawInput").placeholder = rawPH;

  const avgTitle = document.getElementById("avgTitle");
  const avgPH = subs.join("\\t");
  avgTitle.innerText = `ç­å¹³å‡æˆç¸¾ï¼ˆè²¼ä¸Šæ ¼å¼ï¼š${avgPH}ï¼‰`;
  document.getElementById("avgPaste").placeholder = `ä¾‹å¦‚ï¼š${subs.map(()=> (90 + Math.random()*10).toFixed(2)).join("\\t")}`;

  const rawHint = document.getElementById("rawHint");
  rawHint.innerText = `æ¨™é¡Œåˆ—éœ€åŒ…å«ï¼šå§“åã€${subs.join('ã€')}ï¼ˆå¯ä»»æ„é †åºï¼Œç³»çµ±æœƒè‡ªå‹•å°æ‡‰ï¼‰`;
}

function buildHeaderMap(headers, grade){
  const map = { name: 0 }; // é è¨­ç¬¬ 0 æ¬„æ˜¯å§“åï¼ˆå¸¸è¦‹ï¼‰
  // å˜—è©¦å°‹æ‰¾ã€Œå§“åã€æ¬„ä½
  headers.forEach((t, idx)=>{
    const title = (t || '').trim();
    if (title.includes('å§“å') || title.toLowerCase() === 'name') map.name = idx;
  });

  const subjects = getSubjectConfig(grade);
  subjects.forEach(sub=>{
    headers.forEach((t, idx)=>{
      const title = (t || '').trim();
      if (title.includes(sub.label)) map[sub.key] = idx;
    });
  });
  return map;
}

function validateHeaderMap(map, grade){
  const subjects = getSubjectConfig(grade);
  const missing = subjects.filter(s=> typeof map[s.key] !== 'number');
  return { ok: missing.length === 0, missing: missing.map(m=>m.label) };
}

function parseAvgBySubjects(avgRawArr, grade){
  const subjects = getSubjectConfig(grade);
  const vals = subjects.map((_, i)=> num(avgRawArr[i]||0));
  const total = vals.reduce((a,b)=>a+b,0);
  const avg = (vals.length>0) ? (total/vals.length) : 0;
  return { vals, total, avg, subjects };
}

function generateReports() {
  const branch = document.getElementById("branch").value;
  const schoolYear = document.getElementById("schoolYear").value;
  const grade = document.getElementById("grade").value;
  const semester = document.getElementById("semester").value;
  const examType = document.getElementById("examType").value;
  const comment = document.getElementById("teacherComment").value;
  const topN = parseInt(document.getElementById("targetIndex").value);

  // ç­å¹³å‡
  const avgRaw = document.getElementById("avgPaste").value.trim().split("\t");
  const { vals: avgVals, total: avgTotal, avg: avgAverage, subjects } = parseAvgBySubjects(avgRaw, grade);

  // åŸå§‹è³‡æ–™
  const raw = document.getElementById("rawInput").value.trim();
  if (!raw) { alert("è«‹å…ˆè²¼ä¸Šå…¨ç­æˆç¸¾è³‡æ–™ï¼ˆå«æ¨™é¡Œåˆ—ï¼‰ã€‚"); return; }
  const lines = raw.split("\n").filter(l => l.trim().length > 0);
  if (lines.length < 2) { alert("è³‡æ–™ç­†æ•¸ä¸è¶³ï¼Œè«‹ç¢ºèªè‡³å°‘åŒ…å«æ¨™é¡Œåˆ—èˆ‡ä¸€ä½å­¸ç”Ÿè³‡æ–™ã€‚"); return; }

  const headers = lines[0].split("\t");
  const headerMap = buildHeaderMap(headers, grade);
  const headerCheck = validateHeaderMap(headerMap, grade);
  if (!headerCheck.ok) {
    alert(`æ‰¾ä¸åˆ°å¿…è¦æ¬„ä½ï¼š${headerCheck.missing.join('ã€')}ã€‚\nè«‹ç¢ºèªæ¨™é¡Œåˆ—æ˜¯å¦åŒ…å«é€™äº›æ¬„ä½ã€‚`);
    return;
  }

  // è§£æå­¸ç”Ÿè³‡æ–™
  const students = lines.slice(1).map(l => l.split("\t"));
  const scoreList = students.map(fields => {
    const name = fields[headerMap.name] || fields[0] || '';
    const subsScores = subjects.map(s => num(fields[headerMap[s.key]]));
    const total = subsScores.reduce((a,b)=>a+b,0);
    const avg = subjects.length ? (total / subjects.length) : 0;
    return {
      name,
      raw: fields,
      scores: subsScores,
      total,
      avg
    };
  }).sort((a,b)=> b.total - a.total);

  // å‰ N åï¼ˆå«ä¸¦åˆ—ï¼‰
  const cutoffScore = scoreList.length >= topN ? scoreList[topN - 1].total : 0;
  const topStudents = scoreList.filter(stu => stu.total >= cutoffScore);

  // ç”¢å‡º
  const output = document.getElementById("output");
  output.innerHTML = "";

  scoreList.forEach((student) => {
    // å‰ N åè¡¨æ ¼ï¼ˆè™•ç†ä¸¦åˆ—åæ¬¡ï¼‰
    let currentRank = 1;
    let lastScore = null;
    let displayRank = 1;
    const topRows = topStudents.map((stu) => {
      if (lastScore !== null && stu.total < lastScore) {
        displayRank = currentRank;
      }
      lastScore = stu.total;
      currentRank++;
      const cells = subjects.map((s, idx)=> `<td>${formatNumber(stu.scores[idx])}</td>`).join("");
      return `
        <tr>
          <td>${displayRank}</td>
          <td>${stu.name}</td>
          ${cells}
          <td>${formatNumber(stu.total)}</td>
          <td>${formatNumber(stu.avg)}</td>
        </tr>`;
    }).join("");

    // å€‹äººæˆç¸¾åˆ—
    const personCells = subjects.map((s, idx)=>{
      const colIndex = headerMap[s.key];
      return `<td>${formatNumber(student.raw[colIndex])}</td>`;
    }).join("");

    // ç­å¹³å‡åˆ—
    const avgCells = avgVals.map(v => `<td>${formatNumber(v.toFixed ? v.toFixed(2) : v)}</td>`).join("");

    // å‹•æ…‹è¡¨é ­
    const theadCols = ['å­¸ç”Ÿ'].concat(subjects.map(s=>s.label)).concat(['ç¸½åˆ†','å¹³å‡']);
    const theadHtml = theadCols.map(t=>`<th>${t}</th>`).join("");

    // å‰ N åè¡¨é ­
    const rankHead = ['åæ¬¡','å§“å'].concat(subjects.map(s=>s.label)).concat(['ç¸½åˆ†','å¹³å‡']);
    const rankHeadHtml = rankHead.map(t=>`<th>${t}</th>`).join("");

    const page = `
    <div class="b5">
      <h2 style="text-align:center; margin-bottom: 4px; line-height: 1.2;">æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘ ${branch}åˆ†æ ¡</h2>
      <p style="text-align:center; margin-top: 0; line-height: 1.2;">${schoolYear}å­¸å¹´${semester}å­¸æœŸ æœŸ${examType}è€ƒ ${grade}å¹´ç´šå­¸ç”Ÿå€‹äººæˆç¸¾å–®</p>

      <table>
        <tr>${theadHtml}</tr>
        <tr>
          <td>${student.name}</td>
          ${personCells}
          <td>${formatNumber(student.total)}</td>
          <td>${formatNumber(student.avg)}</td>
        </tr>
        <tr>
          <td>ç­å¹³å‡</td>
          ${avgCells}
          <td>${formatNumber(avgTotal)}</td>
          <td>${formatNumber(avgAverage)}</td>
        </tr>
      </table>

      <div class="red-title">æ­£è¯ç­æ’å‰${topN}å</div>
      <table>
        <tr>${rankHeadHtml}</tr>
        ${topRows}
      </table>

      <p><strong>è€å¸«çš„è©±ï¼š</strong></p>
      <div style="border: 1px solid black; padding: 8px; white-space: pre-line;">${comment}</div>

      <table style="width:100%; margin-top:12px; font-size:10pt; border-collapse: collapse;">
        <tr>
          <td style="width:33%; text-align:left; border: 1px solid white;">ç­ä¸»ä»»ï¼š</td>
          <td style="width:33%; text-align:left; border: 1px solid white;">å°å¸«ï¼š</td>
          <td style="width:33%; text-align:left; border: 1px solid white;">å®¶é•·ç°½åï¼š</td>
        </tr>
      </table>
    </div>
    `;
    output.innerHTML += page;
  });
}

function initSemesterMeta(){
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;

  const semesterYear = (month >= 8 || month === 1)
    ? year - 1911
    : year - 1912;
  const semester = (month >= 8 || month === 1) ? "ä¸Š" : "ä¸‹";

  let examType = "ä¸­";
  if ((month >= 1 && month <= 2) || (month >= 5 && month <= 6)) {
    examType = "æœ«";
  } else if ((month >= 11 && month <= 12) || (month >= 4 && month <= 5)) {
    examType = "ä¸­";
  }

  document.getElementById("schoolYear").value = semesterYear;
  document.getElementById("semester").value = semester;
  document.getElementById("examType").value = examType;
}

window.addEventListener("DOMContentLoaded", () => {
  initSemesterMeta();
  updatePlaceholders();

  // å­—æ•¸è¨ˆç®—åŠŸèƒ½å•Ÿå‹•
  const teacherComment = document.getElementById("teacherComment");
  teacherComment.addEventListener("input", () => {
    const count = teacherComment.value.length;
    const wordCountDisplay = document.getElementById("wordCount");
    wordCountDisplay.innerText = `ç›®å‰å­—æ•¸ï¼š${count} / å»ºè­°ä¸Šé™ 600`;
    wordCountDisplay.style.color = count > 600 ? 'red' : '#666';
  });

  // å¹´ç´šåˆ‡æ› â†’ å‹•æ…‹åˆ‡æ›ç§‘ç›®æ•¸èˆ‡æç¤º
  document.getElementById("grade").addEventListener("change", updatePlaceholders);
});
</script>

</body>
</html>

