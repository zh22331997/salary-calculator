<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å€‹äººæˆç¸¾å–®ç”¢ç”Ÿå™¨</title>
  <style>
/* ========== Design Tokens ========== */
:root{
  --brand-500:#A1C6EA; --brand-600:#8FB9E2;
  --secondary-500:#BBD1EA; --secondary-600:#A8C5E6;
  --clear-500:#DAE3E5; --clear-600:#CFD9DC;

  --text-strong:#1f2937; --text-normal:#374151; --text-mute:#6b7280;
  --border:#d1d5db; --bg-page:#f0f2f5; --bg-card:#ffffff;

  --font-sans:"Microsoft JhengHei","å¾®è»Ÿæ­£é»‘é«”","Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;

  --radius-lg:12px; --shadow-lg:0 4px 20px rgba(0,0,0,.12);
  --input-height:2.75rem; --btn-height:2.9rem;

  /* ä¸‰å€å­—ç´šé è¨­ï¼ˆå°å‡ºæˆç¸¾å–®é‡é»ç”¨ ptï¼‰ */
  --fs-personal:18pt;  /* å€‹äººæˆç¸¾è¡¨ */
  --fs-rank:18pt;      /* ç­æ’è¡¨ */
  --fs-teacher:16pt;   /* è€å¸«çš„è©±é è¨­å­—ç´š */
  --lh-teacher:1.6;    /* è€å¸«çš„è©±é è¨­è¡Œè· */

  /* é è¦½ç´™å¯¬ï¼ˆçµ¦è¢å¹•è¦–è¦ºç”¨ï¼›åˆ—å°æ™‚ä¸ä½¿ç”¨å®ƒï¼‰ */
  --sheet-width-mm:190mm;
}

/* ========== Base ========== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:var(--font-sans);
  background:var(--bg-page);
  margin:0; padding:0;
  color:var(--text-normal);
  font-size:16px; /* æ“ä½œä»‹é¢ç”¨ pxï¼Œå°å‡ºæˆç¸¾å–®åœ¨ .b5 è£¡å†ç”¨ pt æ§åˆ¶ */
}
#controls{
  background:var(--bg-card);
  padding:2rem; margin:2rem auto 1rem; border-radius:var(--radius-lg);
  box-shadow:var(--shadow-lg); max-width:1100px; width:calc(100% - 2rem);
}
h2{margin:0 0 1rem; color:#0056b3; text-align:center; font-weight:800;}
h3{color:var(--text-strong); border-bottom:2px solid #e0e0e0; padding-bottom:.5rem; margin-top:1.25rem; margin-bottom:.75rem;}
label{font-weight:700; color:#555;}
p{color:#444; font-size:.95rem; line-height:1.6}

textarea, input, select{ font-family:inherit; font-size:16px; }
textarea, input[type="text"], input[type="number"], select{
  width:100%; height:var(--input-height); padding:0 .9rem;
  border-radius:8px; border:1px solid var(--border); background:#fff;
}
textarea{ min-height:160px; height:auto; padding:.75rem; line-height:1.5; font-family:var(--font-mono); }
textarea:focus, input:focus, select:focus{ outline:none; box-shadow:0 0 0 3px rgba(106,154,255,.25); border-color:#6a9aff; }

button{
  display:inline-flex; align-items:center; justify-content:center;
  min-height:var(--btn-height); padding:0 1.1rem; font-size:17px; font-weight:700;
  border:none; border-radius:8px; cursor:pointer; color:#17324A;
  background:var(--brand-500); transition:background .15s ease, transform .12s ease, box-shadow .2s;
}
button:hover{ background:var(--brand-600); transform:translateY(-2px) }
.btn-secondary{ background:var(--secondary-500); }
.btn-secondary:hover{ background:var(--secondary-600); }
.btn-clear{ background:var(--clear-500); }
.btn-clear:hover{ background:var(--clear-600); }
.btn-row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:.75rem; }

.small-text{ font-size:10pt; color:var(--text-mute); }
.red-title{ color:#b91c1c; font-weight:bold; margin-top:10px; }

/* ========== é è¦½ï¼šè®“ç•«é¢åƒä¸€å¼µç´™ï¼ˆåƒ…è¢å¹•ç”¨ï¼‰ ========== */
#output{ display:flex; flex-direction:column; align-items:center; gap:24px; padding:16px 0 48px; }
.b5{
  background:#fff; color:#000;
  width:var(--sheet-width-mm); max-width:calc(100% - 24px);
  margin:0 auto; padding:6mm; /* é è¦½ç•™ç™½ç¸®å°ï¼Œè¦–è¦ºæ›´æ»¿ç‰ˆ */
  border:1px solid #000; box-shadow:0 2px 18px rgba(0,0,0,.08);
  page-break-inside: avoid;
}

/* æˆç¸¾å–®æœ¬æ–‡çµ±ä¸€å­—ç´šï¼ˆptï¼‰ */
.b5 h2,
.b5 p{ font-size:16pt; line-height:1.25; }

/* ========== è¡¨æ ¼ï¼šå…¨é»‘æ¡†ï¼›th/td å­—ç´šç¹¼æ‰¿ï¼Œæ‰åƒå¾—åˆ°å¯èª¿å­—ç´š ========== */
table{ width:100%; border-collapse:collapse; margin-top:10px; background:#fff; border:1px solid #000; }
th, td{ border:1px solid #000; text-align:center; padding:6px; font-size:inherit; color:#000; background:#fff; }

/* ========== ä¸‰å€å­—ç´šæ›è¼‰é» ========== */
.personal-table{ font-size:var(--fs-personal); }
.rank-table{ font-size:var(--fs-rank); }
.teacher-box{
  border:none;          /* ä¸è¦æ–¹æ¡† */
  padding:0;            /* å¦‚è¦ä¿ç•™ç¸®æ’å¯æ”¹æˆ 8px */
  white-space:pre-line;
  line-height:var(--lh-teacher);
  font-size:var(--fs-teacher);
}
.teacher-box::after{ content:"\A"; white-space:pre; }

/* ç°½åå€ï¼ˆæ‹¿æ‰æ ¼ç·šï¼›æ”¹ 12ptï¼‰ */
.signature-table{ border:none!important; box-shadow:none!important; background:transparent!important; margin-top:12px; }
.signature-table td, .signature-table th{
  border:none!important;
  background:transparent!important;
  color:#000;
  font-size:12pt;
}

/* select ç™½åº•é»‘å­— */
h2 select, p select, #controls select{
  appearance:auto !important; background:#fff !important; color:#000 !important; border:1px solid var(--border) !important;
  height:2rem !important; font-size:14px !important; border-radius:6px !important; padding:0 .5rem !important; width:auto !important;
}

/* ========== åˆ—å°ï¼šåªé  @page æ§ç´™å¼µ/é‚Šç•Œï¼›å…§å®¹ä¸å›ºå®šå¯¬ï¼Œç½®ä¸­æ”¾å¤§ ========== */
@page { size: A4 portrait; margin: 6mm; } /* é è¨­ A4ï¼›JS æœƒè¦†è“‹ç‚º A4/B5ï¼›é‚Šç•Œç¸®å°æ›´æ»¿ç‰ˆ */
@media print{
  html, body{
    width:auto; height:auto; margin:0; padding:0; background:#fff; color:#000;
  }
  #controls{ display:none!important; }
  #output{ display:block; }

  .b5{
    width:auto !important; max-width:none !important;
    margin:0 auto !important; padding:0 !important;
    border:none !important; box-shadow:none !important;
    page-break-after:always; break-after:page;
    background:#fff !important; color:#000 !important;
  }

  *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
  </style>
</head>

<body>

<div id="controls">
  <h2>æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘
    <select id="branch">
      <option>æ°¸å¹³</option><option>ç§€æœ—</option><option>æ¸…æ°´</option><option>æ°¸å’Œ</option><option>æ±Ÿç¿ </option>
    </select>åˆ†æ ¡
  </h2>

  <p style="text-align:center">
    <input id="schoolYear" size="4">å­¸å¹´
    <select id="grade"><option>ä¸€</option><option>äºŒ</option><option>ä¸‰</option><option>å››</option><option>äº”</option><option selected>å…­</option></select>å¹´ç´š
    <select id="semester"><option>ä¸Š</option><option>ä¸‹</option></select>å­¸æœŸ
    <select id="examType"><option>ä¸­</option><option>æœ«</option></select>è€ƒ å­¸ç”Ÿæˆç¸¾å–®
  </p>

  <h3>è«‹å¾ EXCEL è²¼ä¸Šå…¨ç­æˆç¸¾è³‡æ–™ï¼ˆå«æ¨™é¡Œåˆ—èˆ‡ã€Œæœ€å¾Œä¸€åˆ—ç­å¹³å‡ã€ï¼Œå°‘ç§‘ç›®ã€æ²’ç­æ’ã€æ²’åæ¬¡...éƒ½æ²’é—œä¿‚ï¼‰</h3>
  <textarea id="rawInput" placeholder="å­¸ç”Ÿ	åœ‹èª	æ•¸å­¸	è‡ªç„¶	ç¤¾æœƒ	è‹±æ–‡	ç¸½åˆ†	å¹³å‡	åœ‹å°ç­æ’	å®‰è¦ªåæ¬¡
è¨±å°æ¯“	100	98	100	100	100	498	99.60  1  1
...
...
...
å¹³å‡	91.29	91.54	94.37	95.13	93.57	463.05	92.61		
"></textarea>

  <div class="small-text" style="margin-top:6px">
    æ­£è¯ç­æ’å‰ <input id="targetIndex" type="number" value="5" style="width:60px; height:2rem"> åï¼ˆè‹¥æœ‰ä¸¦åˆ—ï¼Œæœƒè‡ªå‹•åŒ…å«ï¼‰
  </div>

  <h3>è€å¸«çš„è©±</h3>
  <textarea id="teacherComment" placeholder="è«‹è¼¸å…¥è€å¸«çš„è©±ï¼Œæœƒå‡ºç¾åœ¨æˆç¸¾å–®ä¸Š"></textarea>
  <div id="wordCount" class="small-text" style="margin-top:4px;">ç›®å‰å­—æ•¸ï¼š0 / å»ºè­°ä¸Šé™ 600</div>

  <!-- ä¸‰å€å­—ç´š + ç´™å¼µå°ºå¯¸ + è€å¸«çš„è©±è¡Œè· -->
  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:12px;">
    <label>å€‹äººæˆç¸¾å­—ç´š
      <select id="fsPersonal">
        <option value="12pt">12pt</option>
        <option value="14pt">14pt</option>
        <option value="16pt">16pt</option>
        <option value="18pt" selected>18pt</option>
        <option value="20pt">20pt</option>
      </select>
    </label>
    <label>ç­æ’è¡Œå­—ç´š
      <select id="fsRank">
        <option value="12pt">12pt</option>
        <option value="14pt">14pt</option>
        <option value="16pt">16pt</option>
        <option value="18pt" selected>18pt</option>
        <option value="20pt">20pt</option>
      </select>
    </label>
    <label>è€å¸«çš„è©±å­—ç´š
      <select id="fsTeacher">
        <option value="12pt">12pt</option>
        <option value="14pt">14pt</option>
        <option value="16pt" selected>16pt</option>
        <option value="18pt">18pt</option>
        <option value="20pt">20pt</option>
      </select>
    </label>
    <label>è€å¸«çš„è©±è¡Œè·
      <select id="lhTeacher">
        <option value="1.4">1.4ï¼ˆè¼ƒç·Šï¼‰</option>
        <option value="1.6" selected>1.6ï¼ˆä¸€èˆ¬ï¼‰</option>
        <option value="1.8">1.8ï¼ˆç¨é¬†ï¼‰</option>
        <option value="2">2.0ï¼ˆå¯¬é¬†ï¼‰</option>
      </select>
    </label>
    <label>ç´™å¼µå°ºå¯¸
      <select id="paper">
        <option value="A4" selected>A4 ç›´å¼</option>
        <option value="B5">B5 ç›´å¼</option>
      </select>
    </label>
  </div>

  <div class="btn-row">
    <button onclick="generateReports()">ç”¢ç”Ÿæˆç¸¾å–®</button>
    <button class="btn-secondary" onclick="printAll()">ğŸ–¨ï¸ åˆ—å°æ‰€æœ‰æˆç¸¾å–®</button>
    <button class="btn-clear" onclick="clearAll()">æ¸…ç©º</button>
  </div>
</div>

<div id="output"></div>
<style id="pageStyle"></style>

<script>
/* ====== å·¥å…·å‡½å¼ ====== */
function formatNumber(n){
  const f = parseFloat(n);
  if (Number.isNaN(f)) return '';
  // å›ºå®šå…©ä½å°æ•¸å¾Œï¼ŒæŠŠå°¾ç«¯å¤šé¤˜çš„ 0 èˆ‡å°æ•¸é»ç æ‰
  let s = f.toFixed(2);      // 98 -> "98.00", 98.1 -> "98.10", 98.12 -> "98.12"
  s = s.replace(/\.?0+$/,''); // ç§»é™¤å°¾ç«¯ .0 / .00 / 0
  return s;
}
function num(v){
  const x = parseFloat(v);
  return Number.isNaN(x) ? 0 : x;
}

/* æ ¹æ“šæ¨™é¡Œ + æ•¸å­—æ¯”ä¾‹ï¼Œè‡ªå‹•åµæ¸¬å§“åæ¬„ã€ç§‘ç›®æ¬„ã€ç¸½åˆ†ã€å¹³å‡ */
function detectStructure(headers, dataRows){
  const isNumeric = v => /^\s*-?\d+(\.\d+)?\s*$/.test((v||'').trim());
  let nameIndex = 0;
  let totalIndex = -1;
  let avgIndex = -1;

  // æ‰¾å§“åæ¬„
  headers.forEach((t,idx)=>{
    const title = (t||'').trim();
    const low = title.toLowerCase();
    if(title.includes('å§“å') || title.includes('å­¸ç”Ÿ') || low==='name' || low==='student'){
      nameIndex = idx;
    }
  });

  // å¦‚æœæ²’æœ‰æ˜ç¢ºçš„å§“åæ¨™é¡Œï¼Œå¾ç¬¬ä¸€åˆ—å­¸ç”Ÿè³‡æ–™æ‰¾ã€Œç¬¬ä¸€å€‹éç´”æ•¸å­—ã€æ¬„ä½
  if(dataRows.length){
    const firstRow = dataRows[0];
    let guess = firstRow.findIndex(v=>!isNumeric(v));
    if(guess >= 0) nameIndex = guess;
  }

  // æ‰¾ç¸½åˆ† / å¹³å‡æ¬„
  headers.forEach((t,idx)=>{
    const title = (t||'').trim();
    const low = title.toLowerCase();
    if (title.includes('ç¸½åˆ†') || low === 'total' || low === 'sum'){
      totalIndex = idx;
    }
    if (title.includes('å¹³å‡') || low === 'avg' || low === 'average'){
      avgIndex = idx;
    }
  });

  const excludePattern = /(ç¸½åˆ†|å¹³å‡|åæ¬¡|ç­æ’|æ’å|åº§è™Ÿ|è™Ÿç¢¼|no.|No.|ç·¨è™Ÿ|åºè™Ÿ|å¹´ç´š|ç­ç´š)/;
  const subjects = [];

  headers.forEach((t,idx)=>{
    if(idx === nameIndex) return;
    if(idx === totalIndex) return;
    if(idx === avgIndex) return;

    const title = (t||'').trim();
    if(!title) return;
    if(excludePattern.test(title)) return;

    let numericCount=0, nonEmptyCount=0;
    for(let i=0;i<Math.min(dataRows.length,20);i++){
      const row = dataRows[i] || [];
      const v = row[idx];
      if(v !== undefined && String(v).trim()!==""){
        nonEmptyCount++;
        if(isNumeric(v)) numericCount++;
      }
    }
    // è‡³å°‘æœ‰ 60% éç©ºå€¼æ˜¯æ•¸å­—ï¼Œè¦–ç‚ºæˆç¸¾æ¬„
    if(nonEmptyCount>0 && numericCount/nonEmptyCount>=0.6){
      subjects.push({ label:title, index:idx });
    }
  });

  return { nameIndex, subjects, totalIndex, avgIndex };
}

/* ====== ç”¢ç”Ÿæˆç¸¾å–® ====== */
function generateReports(){
  const branch=document.getElementById("branch").value;
  const schoolYear=document.getElementById("schoolYear").value;
  const grade=document.getElementById("grade").value;
  const semester=document.getElementById("semester").value;
  const examType=document.getElementById("examType").value;
  const comment=document.getElementById("teacherComment").value;
  const topN=parseInt(document.getElementById("targetIndex").value)||5;

  const raw=document.getElementById("rawInput").value.trim();
  if(!raw){
    alert("è«‹å…ˆè²¼ä¸Šå…¨ç­æˆç¸¾è³‡æ–™ï¼ˆå«æ¨™é¡Œåˆ—èˆ‡æœ€å¾Œä¸€åˆ—ç­å¹³å‡ï¼‰ã€‚");
    return;
  }
  const lines=raw.split("\n").filter(l=>l.trim().length>0);
  if(lines.length<3){
    alert("è‡³å°‘éœ€è¦ï¼š1 åˆ—æ¨™é¡Œ + 1 åˆ—å­¸ç”Ÿ + 1 åˆ—ç­å¹³å‡ã€‚");
    return;
  }

  const headers=lines[0].split("\t");
  const dataRows=lines.slice(1).map(l=>l.split("\t"));
  const avgRow = dataRows[dataRows.length-1];       // æœ€å¾Œä¸€åˆ—ï¼šç­å¹³å‡
  const studentRows = dataRows.slice(0,-1);        // å‰é¢çš„åˆ—ï¼šå­¸ç”Ÿè³‡æ–™

  const { nameIndex, subjects, totalIndex, avgIndex } = detectStructure(headers, studentRows);

  if(!subjects.length){
    alert("æ‰¾ä¸åˆ°ä»»ä½•ç§‘ç›®æ¬„ä½ã€‚è«‹ç¢ºèªæ¨™é¡Œåˆ—æœ‰ç§‘ç›®åç¨±ï¼Œä¸”è©²æ¬„ä½å¤šæ•¸å…§å®¹ç‚ºæ•¸å­—ã€‚");
    return;
  }
  if(totalIndex < 0){
    alert("æ‰¾ä¸åˆ°ã€ç¸½åˆ†ã€æ¬„ä½ï¼ˆæ¨™é¡Œéœ€åŒ…å«ã€ç¸½åˆ†ã€æˆ– totalï¼‰ã€‚");
    return;
  }
  if(avgIndex < 0){
    alert("æ‰¾ä¸åˆ°ã€å¹³å‡ã€æ¬„ä½ï¼ˆæ¨™é¡Œéœ€åŒ…å«ã€å¹³å‡ã€æˆ– avgï¼‰ã€‚");
    return;
  }

  const students = studentRows.map(fields=>{
    const name = (fields[nameIndex]||fields[0]||'').trim();
    const scores = subjects.map(sub=>num(fields[sub.index]));
    const total  = num(fields[totalIndex]);
    const avg    = num(fields[avgIndex]);
    return { name, raw:fields, scores, total, avg };
  }).filter(stu=>stu.name); // é¿å…ç©ºåˆ—

  if(!students.length){
    alert("æ²’æœ‰æ‰¾åˆ°å­¸ç”Ÿè³‡æ–™ï¼Œè«‹ç¢ºèªæˆç¸¾è¡¨å…§å®¹ã€‚");
    return;
  }

  // ç­å¹³å‡ï¼šå®Œå…¨ç…§ä½ è²¼çš„æœ€å¾Œä¸€åˆ—
  const avgVals = subjects.map(sub=>num(avgRow[sub.index]));
  const avgTotal = totalIndex>=0 ? num(avgRow[totalIndex]) : '';
  const avgAverage = avgIndex>=0 ? num(avgRow[avgIndex]) : '';

  // ç­æ’è™•ç†ï¼ˆç…§ç¸½åˆ†æ’åºï¼›å®Œå…¨ç”¨ä½ è²¼çš„ç¸½åˆ†ï¼‰
  const scoreList = students.slice().sort((a,b)=>b.total-a.total);
  const cutoff=scoreList.length>=topN?scoreList[topN-1].total:0;
  const topStudents=scoreList.filter(stu=>stu.total>=cutoff);

  const output=document.getElementById("output");
  output.innerHTML="";

  scoreList.forEach(student=>{
    // é‡æ–°è¨ˆç®— top æ’åï¼ˆè™•ç†ä¸¦åˆ—ï¼‰
    let currentRank=1,lastScore=null,displayRank=1;
    const topRows=topStudents.map(stu=>{
      if(lastScore!==null && stu.total<lastScore){ displayRank=currentRank; }
      lastScore=stu.total; currentRank++;
      const cells=subjects.map((s,idx)=>`<td>${formatNumber(stu.scores[idx])}</td>`).join("");
      return `<tr><td>${displayRank}</td><td>${stu.name}</td>${cells}<td>${formatNumber(stu.total)}</td><td>${formatNumber(stu.avg)}</td></tr>`;
    }).join("");

    const theadCols=['å­¸ç”Ÿ'].concat(subjects.map(s=>s.label)).concat(['ç¸½åˆ†','å¹³å‡']);
    const theadHtml=theadCols.map(t=>`<th>${t}</th>`).join("");
    const personCells=subjects.map((s,idx)=>`<td>${formatNumber(student.scores[idx])}</td>`).join("");
    const avgCells=avgVals.map(v=>`<td>${formatNumber(v)}</td>`).join("");
    const rankHead=['åæ¬¡','å§“å'].concat(subjects.map(s=>s.label)).concat(['ç¸½åˆ†','å¹³å‡']).map(t=>`<th>${t}</th>`).join("");

    const page=`
    <div class="b5">
      <h2 style="text-align:center; margin-bottom:4px;">æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘ ${branch}åˆ†æ ¡</h2>
      <p style="text-align:center; margin-top:0;">
        ${schoolYear}å­¸å¹´${semester}å­¸æœŸ æœŸ${examType}è€ƒ ${grade}å¹´ç´šå­¸ç”Ÿå€‹äººæˆç¸¾å–®
      </p>

      <table class="personal-table">
        <tr>${theadHtml}</tr>
        <tr>
          <td>${student.name}</td>
          ${personCells}
          <td>${formatNumber(student.total)}</td>
          <td>${formatNumber(student.avg)}</td>
        </tr>
        <tr>
          <td>ç­å¹³å‡</td>
          ${avgCells}
          <td>${formatNumber(avgTotal)}</td>
          <td>${formatNumber(avgAverage)}</td>
        </tr>
      </table>

      <div class="red-title">æ­£è¯ç­æ’å‰${topN}å</div>
      <table class="rank-table">
        <tr>${rankHead}</tr>
        ${topRows}
      </table>

      <p><strong>è€å¸«çš„è©±ï¼š</strong></p>
      <div class="teacher-box">${comment}</div>

      <table class="signature-table" style="width:100%; border-collapse:collapse;">
        <tr>
          <td style="width:33%; text-align:left;">ç­ä¸»ä»»ï¼š</td>
          <td style="width:33%; text-align:left;">å°å¸«ï¼š</td>
          <td style="width:33%; text-align:left;">å®¶é•·ç°½åï¼š</td>
        </tr>
      </table>
    </div>`;
    output.innerHTML += page;
  });

  applyFontSizes(); // ç”¢ç”Ÿå¾ŒåŒæ­¥å­—ç´šèˆ‡è¡Œè·
}

/* æ¸…ç©º */
function clearAll(){
  document.getElementById("rawInput").value="";
  document.getElementById("teacherComment").value="";
  document.getElementById("wordCount").innerText="ç›®å‰å­—æ•¸ï¼š0 / å»ºè­°ä¸Šé™ 600";
  document.getElementById("targetIndex").value=5;
  document.getElementById("output").innerHTML="";
}

/* å­—ç´š + è¡Œè·æ§åˆ¶ï¼ˆå³æ™‚ï¼‰ */
function applyFontSizes(){
  document.documentElement.style.setProperty('--fs-personal', document.getElementById('fsPersonal').value);
  document.documentElement.style.setProperty('--fs-rank', document.getElementById('fsRank').value);
  document.documentElement.style.setProperty('--fs-teacher', document.getElementById('fsTeacher').value);
  const lhSel = document.getElementById('lhTeacher');
  if(lhSel){
    document.documentElement.style.setProperty('--lh-teacher', lhSel.value);
  }
}

/* ç´™å¼µå°ºå¯¸ï¼ˆA4/B5ï¼‰ï¼šåªå½±éŸ¿ @page èˆ‡ã€Œé è¦½ç´™å¯¬ã€ï¼Œå°åˆ·çœŸæ­£å¯¬åº¦äº¤çµ¦ @page æ§åˆ¶ */
function applyPaper(){
  const paper = document.getElementById('paper')?.value || 'A4';
  const styleEl = document.getElementById('pageStyle');
  const margin = '6mm'; // é‚Šç•Œè®Šå°ï¼Œç‰ˆé¢æ›´æ»¿

  if (paper === 'B5'){
    document.documentElement.style.setProperty('--sheet-width-mm', '165mm'); // é è¦½å¤–è§€
    styleEl.textContent = `@page{ size:B5 portrait; margin:${margin}; }`;
  }else{
    document.documentElement.style.setProperty('--sheet-width-mm', '190mm'); // é è¦½å¤–è§€
    styleEl.textContent = `@page{ size:A4 portrait; margin:${margin}; }`;
  }
}

/* åˆ—å°æé†’ */
function printAll(){
  alert(
    "åˆ—å°å°æé†’ï¼š\n\n" +
    "1) ã€æ›´å¤šè¨­å®šã€ç´™å¼µå°ºå¯¸è¦èˆ‡é¸å–®ç›¸åŒï¼ˆA4 æˆ– B5ï¼‰ã€‚\n" +
    "2) ç¸®æ”¾æ¯”ä¾‹å»ºè­° 100%ï¼ˆæƒ³å¤§å°± 110%ã€120%â€¦ï¼‰ï¼Œæœƒä»¥é é¢ä¸­å¿ƒç½®ä¸­æ”¾å¤§ã€‚\n" +
    "3) é‚Šç•Œå»ºè­° 6mm å·¦å³ï¼Œé é¦–é å°¾é—œé–‰ã€‚\n\n" +
    "è«‹ç¢ºèªé è¦½æ˜¯ä¸€é ä¸€å¼µæˆç¸¾å–®å†åˆ—å°ã€‚"
  );
  window.print();
}

/* é è¨­èˆ‡ç›£è½ */
window.addEventListener("DOMContentLoaded",()=>{
  const now=new Date(), y=now.getFullYear(), m=now.getMonth()+1;
  const semesterYear=(m>=8||m===1)?(y-1911):(y-1912);
  const semester=(m>=8||m===1)?"ä¸Š":"ä¸‹";
  let examType="ä¸­";
  if((m>=1&&m<=2)||(m>=5&&m<=6)) examType="æœ«";
  else if((m>=11&&m<=12)||(m>=4&&m<=5)) examType="ä¸­";
  document.getElementById("schoolYear").value=semesterYear;
  document.getElementById("semester").value=semester;
  document.getElementById("examType").value=examType;

  // å­—æ•¸è¨ˆç®—
  const tc=document.getElementById("teacherComment");
  tc.addEventListener("input",()=>{
    const c=tc.value.length;
    const w=document.getElementById("wordCount");
    w.innerText=`ç›®å‰å­—æ•¸ï¼š${c} / å»ºè­°ä¸Šé™ 600`;
    w.style.color=c>600?'red':'#6b7280';
  });

  // å­—ç´š + è¡Œè·å³æ™‚
  ['fsPersonal','fsRank','fsTeacher','lhTeacher'].forEach(id=>{
    document.getElementById(id).addEventListener('change', applyFontSizes);
  });
  applyFontSizes();

  // ç´™å¼µå°ºå¯¸
  document.getElementById('paper').addEventListener('change', applyPaper);
  applyPaper();
});
</script>

</body>
</html>
