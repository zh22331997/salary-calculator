<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æœŸä¸­æœŸæœ«ç¦®åˆ¸è²¼æ¢ç”¢ç”Ÿå™¨</title>
<style>
/* ç‰ˆé¢ä¸»é¡Œï¼ˆä¸å½±éŸ¿åŠŸèƒ½ï¼‰ */
body{
  font-family:'Noto Sans TC','Microsoft JhengHei',sans-serif;
  background:#f0f2f5;margin:0;padding:0;
  display:flex;justify-content:center;align-items:flex-start;min-height:100vh;
}
.container{
  background:#fff;padding:2rem;margin:2rem 1rem;border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.1);max-width:960px;width:100%;box-sizing:border-box;
}
h1{margin-top:0;color:#0056b3;text-align:center;}
h2,h3{color:#333;border-bottom:2px solid #e0e0e0;padding-bottom:0.5rem;margin-top:1.5rem;margin-bottom:1rem;}
label{font-weight:bold;display:block;color:#555;margin-bottom:0.5rem;}
p{color:#666;font-size:0.95rem;line-height:1.6;}

/* è¼¸å…¥æ¡† */
textarea{
  width:calc(100% - 1rem);
  padding:0.75rem;margin-bottom:1rem;border-radius:8px;border:1px solid #ccc;
  font-size:16px;line-height:1.5;height:220px;min-height:200px;resize:vertical;
  box-sizing:border-box;transition:border-color 0.3s;
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}
textarea:focus{border-color:#6a9aff;outline:none;}

/* æŒ‰éˆ• */
button{
  padding:0.8rem 1.5rem;font-size:17px;border:none;border-radius:8px;cursor:pointer;
  background-color:#4e73df;color:#fff;margin-right:0.8rem;margin-top:1rem;
  transition:background-color 0.3s,transform 0.2s;
}
button:hover{background-color:#2e59d9;transform:translateY(-2px);}
#printButton{background:#28a745;}
#printButton:hover{background:#218838;}

/* ä¸‹æ‹‰é¸å–®ä¸»è‰²ç³» */
select{
  appearance:none;-webkit-appearance:none;-moz-appearance:none;
  padding:0.65rem 2.2rem 0.65rem 1rem;border-radius:8px;border:1px solid #4e73df;
  background-color:#4e73df;color:#fff;font-size:16px;cursor:pointer;margin-right:0.8rem;
  box-sizing:border-box;transition:background-color 0.3s,border-color 0.3s,transform 0.2s;
}
select:hover{background-color:#2e59d9;border-color:#2e59d9;transform:translateY(-2px);}
select:focus{outline:none;border-color:#6a9aff;box-shadow:0 0 0 3px rgba(106,154,255,0.25);}
select{
  background-image:
    linear-gradient(45deg,transparent 50%,#fff 50%),
    linear-gradient(135deg,#fff 50%,transparent 50%);
  background-position:
    calc(100% - 16px) calc(50% - 3px),
    calc(100% - 11px) calc(50% - 3px);
  background-size:6px 6px;background-repeat:no-repeat;
}
select::-ms-expand{display:none;}

/* ä½¿ç”¨èªªæ˜ï¼ˆå¯æ”¶åˆï¼‰ */
.instructions-wrapper{margin:0.8em 0 1.2em;}
.instructions-toggle{
  display:inline-block;background:#4e73df;color:#fff;padding:0.6em 1.2em;
  border-radius:8px;cursor:pointer;font-weight:600;
  transition:background 0.3s,transform 0.2s;
}
.instructions-toggle:hover{background:#2e59d9;transform:translateY(-1px);}
.instructions-content{
  display:none;background:#f8fbff;border:1px solid #e1eefc;border-left:5px solid #4e73df;
  border-radius:8px;padding:1em 1.2em;color:#1b3a57;margin-top:0.8em;
  line-height:1.6;font-size:1em;box-shadow:0 2px 6px rgba(0,0,0,0.05);
}
.instructions-content ul{margin:0.4em 0 0.8em 1.2em;padding:0;}
.instructions-content pre{
  background:#fff;border:1px solid #e6edf7;border-radius:6px;padding:0.6em 0.8em;
  white-space:pre-wrap;margin:0.4em 0;font-size:0.95em;
}

/* çå‹µæ¨™æº–è¨­å®šï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰ */
.settings-container{background:#fff;padding:1.2em 1.5em;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.grade-settings{margin-bottom:1em;line-height:1.2;}
.grade-settings h3{font-size:1.1em;margin:0.5em 0;color:#333;}
.grade-settings label{display:inline-block;width:40px;margin-right:0.2em;margin-bottom:0.2em;font-weight:normal;font-size:0.95em;}
.grade-settings input[type="number"]{
  width:50px;padding:0.2em;border:1px solid #ccc;border-radius:3px;text-align:center;font-size:0.9em;margin-right:0.5em;vertical-align:middle;
}
.hint{display:inline-block;font-size:0.85em;color:#888;margin-left:0.2em;}
.settings-button-group{text-align:right;margin-top:1em;}
.settings-button-group button{background-color:#6c757d;margin-right:0;}
.settings-button-group button:hover{background-color:#5a6268;}

/* è²¼æ¢è¼¸å‡ºï¼ˆä¿ç•™è¨­å®šï¼‰ */
.output-container{margin-top:2em;background:#fff;padding:1em;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.output-grid{display:grid;grid-template-columns:repeat(3,6.5cm);gap:0;justify-content:center;margin:0 auto;}
.slip{width:6.5cm;height:5.6cm;border:1px dashed #999;padding:0.4cm;box-sizing:border-box;page-break-inside:avoid;position:relative;overflow:hidden;}
.slip pre{white-space:pre-wrap;font-size:11pt;line-height:1.2;margin:0;color:#000;}
.student-name{font-size:14pt;font-weight:bold;color:#d9534f;}
.policy-text{font-size:6pt;line-height:1;color:#555;margin-top:0.2cm;}
.logo{position:absolute;top:0.2cm;right:0.2cm;width:1.2cm;height:auto;opacity:0.9;pointer-events:none;}
.total-voucher-info{margin-top:1em;font-weight:bold;text-align:center;padding:0.5em;border-top:1px dashed #ccc;}
.total-voucher-count{color:darkred;font-size:1.2em;}
.no-data-message{text-align:center;color:#777;padding:1em;}

/* åˆ—å° */
@media print{
  @page{size:A4 portrait;margin:0.8cm;}
  body>*:not(.container), .container>*:not(.output-container){display:none!important;}
  .output-container{margin-top:0;padding:0;box-shadow:none;}
  .output-grid{grid-template-columns:repeat(3,6.5cm);gap:0;margin:0 auto;}
  .slip{border:0.5px solid #000;}
  .slip pre{font-size:10.5pt;line-height:1.1;}
  .student-name{font-size:13pt;}
  .total-voucher-info, .no-data-message{display:none!important;}
}
</style>
</head>
<body>
<div class="container">
  <h1>æœŸä¸­æœŸæœ«ç¦®åˆ¸è²¼æ¢ç”¢ç”Ÿå™¨</h1>

  <div class="settings-container">
    <h2>ğŸ† çå‹µæ¨™æº–è¨­å®šï¼ˆè«‹å…ˆç¢ºèªä»¥ä¸‹æ¨™æº–ï¼‰</h2>
    <p style="margin:0.2em 0 0.8em;color:#666;font-size:0.95em;">
      å¹´ç´šåˆ†çµ„è¦å‰‡ï¼šä¸€ã€äºŒå¹´ç´šï¼ä½å¹´ç´šï¼›ä¸‰ã€å››å¹´ç´šï¼ä¸­å¹´ç´šï¼›äº”ã€å…­å¹´ç´šï¼é«˜å¹´ç´šã€‚ä¸‹æ–¹æ•¸å€¼ä»£è¡¨ã€Œå„çç´šçš„æœ€ä½åˆ†æ•¸é–€æª»ã€ã€‚
    </p>

    <div class="grade-settings">
      <h3>ä½å¹´ç´š</h3>
      <label for="lowGrade300">å¹³å‡</label>
      <input type="number" id="lowGrade300" value="100" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸300å…ƒ</span><span class="hint">ï¼ˆä¾‹ï¼š100ï¼‰</span><br>
      <label for="lowGrade100">å¹³å‡</label>
      <input type="number" id="lowGrade100" value="98" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸100å…ƒ</span><span class="hint">ï¼ˆä¾‹ï¼š98ï¼‰</span><br>
    </div>

    <div class="grade-settings">
      <h3>ä¸­å¹´ç´š</h3>
      <label for="midGrade300">å¹³å‡</label>
      <input type="number" id="midGrade300" value="100" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸300å…ƒ</span><span class="hint">ï¼ˆä¾‹ï¼š100ï¼‰</span><br>
      <label for="midGrade200">å¹³å‡</label>
      <input type="number" id="midGrade200" value="97" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸200å…ƒ</span><span class="hint">ï¼ˆä¾‹ï¼š97ï¼‰</span><br>
      <label for="midGrade100">å¹³å‡</label>
      <input type="number" id="midGrade100" value="95" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸100å…ƒ</span><span class="hint">ï¼ˆä¾‹ï¼š95ï¼‰</span><br>
    </div>

    <div class="grade-settings">
      <h3>é«˜å¹´ç´š</h3>
      <label for="highGrade300">å¹³å‡</label>
      <input type="number" id="highGrade300" value="98" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸300å…ƒ</span><span class="hint">ï¼ˆä¾‹ï¼š98ï¼‰</span><br>
      <label for="highGrade200">å¹³å‡</label>
      <input type="number" id="highGrade200" value="95" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸200å…ƒ</span><span class="hint">ï¼ˆä¾‹ï¼š95ï¼‰</span><br>
      <label for="highGrade100">å¹³å‡</label>
      <input type="number" id="highGrade100" value="93" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸100å…ƒ</span><span class="hint">ï¼ˆä¾‹ï¼š93ï¼‰</span><br>
    </div>

    <div class="settings-button-group">
      <button onclick="saveRewardSettings()">å„²å­˜çå‹µæ¨™æº–</button>
      <button onclick="resetRewardSettings()">é‡ç½®ç‚ºé è¨­å€¼</button>
    </div>
  </div>

  <h2>è¼¸å…¥è³‡æ–™</h2>
  <label for="input">è«‹ç›´æ¥æŠŠ Excel/Google è©¦ç®—è¡¨ä¸­<strong>æ•´ä»½æˆç¸¾è¡¨ï¼ˆå«æ¨™é¡Œåˆ—ï¼‰</strong>è¤‡è£½è²¼ä¸Šï¼š</label>

  <!-- æ”¶åˆå¼ä½¿ç”¨èªªæ˜ -->
  <div class="instructions-wrapper">
    <div class="instructions-toggle" onclick="toggleInstructions()">ğŸ“˜ é¡¯ç¤ºä½¿ç”¨èªªæ˜</div>
    <div class="instructions-content" id="instructionsContent">
      <div><strong>âœ¨ ä½¿ç”¨èªªæ˜ï¼š</strong></div>
      <div>
        1) æ¨™é¡Œåˆ—è«‹è‡³å°‘åŒ…å«é€™ä¸‰æ¬„ï¼š<strong>å¹´ç´šï¼ˆæˆ–ç­ç´šï¼‰</strong>ã€<strong>å§“åï¼ˆæˆ–å­¸ç”Ÿï¼‰</strong>ã€<strong>å¹³å‡</strong>ã€‚<br>
        2) å¹´ç´šå¯ç”¨ <strong>1~6</strong> æˆ– <strong>ä¸€ï½å…­</strong>ï¼Œä¹Ÿæ”¯æ´ã€Œå…­å¹´1ç­ã€601ã€1å¹´2ç­ã€ç­‰æ ¼å¼ã€‚<br>
        3) å…¶ä»–æ¬„ï¼ˆåœ‹èªã€æ•¸å­¸ã€è‡ªç„¶â€¦ï¼‰å¯æœ‰å¯ç„¡ï¼Œä¸å½±éŸ¿ã€‚<br>
        4) æœªé”é–€æª»è€…ä¸æœƒç”¢ç”Ÿè²¼æ¢ï¼›æ ¼å¼ä¸ç¬¦æœƒå‡ºç¾æç¤ºã€‚<br>
      </div>
      <div style="margin-top:0.4em;color:#5b6b7a;">
        ä¾‹ï¼š<br>
        <pre>å¹´ç´š å­¸ç”Ÿ åœ‹èª æ•¸å­¸ ç¸½åˆ† å¹³å‡
å…­  ç‹å°æ¨º 98 95 484 96.8
6   æ—å°æ˜€ 95 94 483 96.6</pre>
      </div>
    </div>
  </div>

  <textarea id="input" placeholder="è²¼ä¸Šæ•´ä»½æˆç¸¾è¡¨ï¼ˆå«æ¨™é¡Œï¼‰åˆ°é€™è£¡ã€‚ä¾‹å¦‚ï¼š
å¹´ç´š å­¸ç”Ÿ åœ‹èª æ•¸å­¸ è‡ªç„¶ ç¤¾æœƒ è‹±æ–‡ ç¸½åˆ† å¹³å‡
6 æ—å°æ˜€ 98 95 100 95 96 484 96.8
å…­ ç‹å°æ¨º 95 94  96 98 100 483 96.6"></textarea>

  <label>é¸æ“‡å­¸æœŸèˆ‡è€ƒåˆ¥ï¼š</label><br />
  <select id="semester">
    <option value="ä¸Šå­¸æœŸ">ä¸Šå­¸æœŸ</option>
    <option value="ä¸‹å­¸æœŸ" selected>ä¸‹å­¸æœŸ</option>
  </select>
  <select id="examType">
    <option value="æœŸä¸­è€ƒ">æœŸä¸­è€ƒ</option>
    <option value="æœŸæœ«è€ƒ" selected>æœŸæœ«è€ƒ</option>
  </select>

  <div>
    <button onclick="generateSlips()">ç”¢ç”Ÿç¦®åˆ¸è²¼æ¢</button>
    <button onclick="clearAll()">æ¸…ç©ºè³‡æ–™</button>
    <button id="printButton" onclick="printSlips()" style="display:none;">ğŸ–¨ï¸ åˆ—å°è²¼æ¢</button>
  </div>

  <div class="output-container">
    <div id="result" class="output-grid"></div>
    <p id="totalVoucherSummary" class="total-voucher-info" style="display:none;"></p>
    <p id="noDataMessage" class="no-data-message" style="display:block;">è«‹è¼¸å…¥è³‡æ–™ä¸¦é»æ“Šã€Œç”¢ç”Ÿç¦®åˆ¸è²¼æ¢ã€ã€‚</p>
  </div>
</div>

<script>
/* ====== ä½¿ç”¨èªªæ˜æ”¶åˆ ====== */
function toggleInstructions(){
  const box=document.getElementById('instructionsContent');
  const toggle=document.querySelector('.instructions-toggle');
  if(box.style.display==='block'){
    box.style.display='none';
    toggle.innerHTML='ğŸ“˜ é¡¯ç¤ºä½¿ç”¨èªªæ˜';
  }else{
    box.style.display='block';
    toggle.innerHTML='ğŸ“– æ”¶èµ·ä½¿ç”¨èªªæ˜';
  }
}

/* ====== çå‹µæ¨™æº–è¨­å®šï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰ ====== */
const defaultRewardSettings = {
  lowGrade: { '300': 100, '100': 98 },
  midGrade: { '300': 100, '200': 97, '100': 95 },
  highGrade:{ '300': 98,  '200': 95,  '100': 93 }
};
let currentRewardSettings = {};

function loadRewardSettings() {
  const saved = localStorage.getItem('rewardSettings');
  currentRewardSettings = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultRewardSettings));
  applyRewardSettingsToInputs();
}
function applyRewardSettingsToInputs(){
  document.getElementById('lowGrade300').value = currentRewardSettings.lowGrade['300'];
  document.getElementById('lowGrade100').value = currentRewardSettings.lowGrade['100'];
  document.getElementById('midGrade300').value = currentRewardSettings.midGrade['300'];
  document.getElementById('midGrade200').value = currentRewardSettings.midGrade['200'];
  document.getElementById('midGrade100').value = currentRewardSettings.midGrade['100'];
  document.getElementById('highGrade300').value = currentRewardSettings.highGrade['300'];
  document.getElementById('highGrade200').value = currentRewardSettings.highGrade['200'];
  document.getElementById('highGrade100').value = currentRewardSettings.highGrade['100'];
}
function saveRewardSettings(){
  currentRewardSettings.lowGrade['300'] = parseInt(document.getElementById('lowGrade300').value);
  currentRewardSettings.lowGrade['100'] = parseInt(document.getElementById('lowGrade100').value);
  currentRewardSettings.midGrade['300'] = parseInt(document.getElementById('midGrade300').value);
  currentRewardSettings.midGrade['200'] = parseInt(document.getElementById('midGrade200').value);
  currentRewardSettings.midGrade['100'] = parseInt(document.getElementById('midGrade100').value);
  currentRewardSettings.highGrade['300'] = parseInt(document.getElementById('highGrade300').value);
  currentRewardSettings.highGrade['200'] = parseInt(document.getElementById('highGrade200').value);
  currentRewardSettings.highGrade['100'] = parseInt(document.getElementById('highGrade100').value);
  const all=[ currentRewardSettings.lowGrade['300'], currentRewardSettings.lowGrade['100'],
              currentRewardSettings.midGrade['300'], currentRewardSettings.midGrade['200'], currentRewardSettings.midGrade['100'],
              currentRewardSettings.highGrade['300'], currentRewardSettings.highGrade['200'], currentRewardSettings.highGrade['100'] ];
  const ok = all.every(s=>!isNaN(s)&&s>=0&&s<=100) &&
             currentRewardSettings.lowGrade['300']>=currentRewardSettings.lowGrade['100'] &&
             currentRewardSettings.midGrade['300']>=currentRewardSettings.midGrade['200'] &&
             currentRewardSettings.midGrade['200']>=currentRewardSettings.midGrade['100'] &&
             currentRewardSettings.highGrade['300']>=currentRewardSettings.highGrade['200'] &&
             currentRewardSettings.highGrade['200']>=currentRewardSettings.highGrade['100'];
  if(!ok){ alert('è«‹ç¢ºèªåˆ†æ•¸ç‚º 0â€“100 çš„æœ‰æ•ˆæ•¸å­—ï¼Œä¸”é«˜é‡‘é¡å°æ‡‰é–€æª» â‰¥ ä½é‡‘é¡é–€æª»ã€‚'); loadRewardSettings(); return; }
  localStorage.setItem('rewardSettings', JSON.stringify(currentRewardSettings));
  alert('çå‹µæ¨™æº–å·²å„²å­˜ï¼');
}
function resetRewardSettings(){
  currentRewardSettings = JSON.parse(JSON.stringify(defaultRewardSettings));
  localStorage.setItem('rewardSettings', JSON.stringify(currentRewardSettings));
  applyRewardSettingsToInputs();
  alert('çå‹µæ¨™æº–å·²é‡ç½®ç‚ºé è¨­å€¼ï¼');
}
window.onload = loadRewardSettings;

/* ====== å¹´ç´š/ç­ç´šè§£æèˆ‡åˆ†çµ„ ====== */
// å°‡å¹´ç´šæˆ–ç­ç´šå­—ä¸²è½‰æˆ 1~6
function parseGradeNumber(raw) {
  const str = (raw ?? '').toString().trim();
  const m = str.match(/[1-6]/);  // å…ˆæŠ“é˜¿æ‹‰ä¼¯æ•¸å­—ï¼ˆæ”¯æ´ 601ã€1å¹´2ç­â€¦ï¼‰
  if (m) return parseInt(m[0],10);
  const map = { 'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6 }; // å†æŠ“ä¸­æ–‡æ•¸å­—
  for (const ch in map) if (str.includes(ch)) return map[ch];
  return NaN;
}
// å‚³å…¥ä¸€æ•´è¡Œè³‡æ–™ç‰©ä»¶ï¼ˆå¯å« å¹´ç´š æˆ– ç­ç´š ä»»ä¸€æ¬„ï¼‰
function classifyGradeByRow(row) {
  const gradeRaw = row['å¹´ç´š'] ?? row['ç­ç´š'] ?? '';
  const n = parseGradeNumber(gradeRaw);
  if (n===1||n===2) return 'ä½å¹´ç´š';
  if (n===3||n===4) return 'ä¸­å¹´ç´š';
  if (n===5||n===6) return 'é«˜å¹´ç´š';
  return 'é«˜å¹´ç´š';
}

/* ====== çå‹µåˆ¤å®šèˆ‡èªªæ˜ ====== */
function getRewardByGroup(group, avg){
  const s=currentRewardSettings;
  if(group==='ä½å¹´ç´š'){
    if(avg>=s.lowGrade['300']) return 300;
    if(avg>=s.lowGrade['100']) return 100;
  }else if(group==='ä¸­å¹´ç´š'){
    if(avg>=s.midGrade['300']) return 300;
    if(avg>=s.midGrade['200']) return 200;
    if(avg>=s.midGrade['100']) return 100;
  }else{
    if(avg>=s.highGrade['300']) return 300;
    if(avg>=s.highGrade['200']) return 200;
    if(avg>=s.highGrade['100']) return 100;
  }
  return 0;
}
function getPolicyTextByGroup(group){
  const s=currentRewardSettings;
  const rd=(min,max)=> min===max ? `${min}åˆ†` : `${Math.max(0,min)}åˆ†~${Math.min(100,max)}åˆ†`;
  const len=t=>Array.from(t).reduce((a,ch)=>a+(ch.charCodeAt(0)>255?2:1),0);
  const pad=(t,w)=> t + ' '.repeat(Math.max(0, w - len(t)));
  let d300,d200,d100,w=0;
  if(group==='ä½å¹´ç´š'){
    d300=rd(s.lowGrade['300'],100);
    d100=rd(s.lowGrade['100'],s.lowGrade['300']-1);
    w=Math.max(len('å¹³å‡'+d300),len('å¹³å‡'+d100));
    return `æœŸä¸­ã€æœŸæœ«è€ƒ æˆç¸¾å„ªç•°çå‹µè¾¦æ³•
ä½å¹´ç´š
${pad('å¹³å‡'+d300,w)}çå‹µç¦®åˆ¸300å…ƒ
${pad('å¹³å‡'+d100,w)}çå‹µç¦®åˆ¸100å…ƒ`;
  }else if(group==='ä¸­å¹´ç´š'){
    d300=rd(s.midGrade['300'],100);
    d200=rd(s.midGrade['200'],s.midGrade['300']-1);
    d100=rd(s.midGrade['100'],s.midGrade['200']-1);
    w=Math.max(len('å¹³å‡'+d300),len('å¹³å‡'+d200),len('å¹³å‡'+d100));
    return `æœŸä¸­ã€æœŸæœ«è€ƒ æˆç¸¾å„ªç•°çå‹µè¾¦æ³•
ä¸­å¹´ç´š
${pad('å¹³å‡'+d300,w)}çå‹µç¦®åˆ¸300å…ƒ
${pad('å¹³å‡'+d200,w)}çå‹µç¦®åˆ¸200å…ƒ
${pad('å¹³å‡'+d100,w)}çå‹µç¦®åˆ¸100å…ƒ`;
  }else{
    d300=rd(s.highGrade['300'],100);
    d200=rd(s.highGrade['200'],s.highGrade['300']-1);
    d100=rd(s.highGrade['100'],s.highGrade['200']-1);
    w=Math.max(len('å¹³å‡'+d300),len('å¹³å‡'+d200),len('å¹³å‡'+d100));
    return `æœŸä¸­ã€æœŸæœ«è€ƒ æˆç¸¾å„ªç•°çå‹µè¾¦æ³•
é«˜å¹´ç´š
${pad('å¹³å‡'+d300,w)}çå‹µç¦®åˆ¸300å…ƒ
${pad('å¹³å‡'+d200,w)}çå‹µç¦®åˆ¸200å…ƒ
${pad('å¹³å‡'+d100,w)}çå‹µç¦®åˆ¸100å…ƒ`;
  }
}

/* ====== ä¸»æµç¨‹ï¼šç”¢ç”Ÿè²¼æ¢ ====== */
function generateSlips(){
  const text = document.getElementById('input').value.trim();
  const semester = document.getElementById('semester').value;
  const examType = document.getElementById('examType').value;
  const resultDiv = document.getElementById('result');
  const printButton = document.getElementById('printButton');
  const totalVoucherSummary = document.getElementById('totalVoucherSummary');
  const noDataMessage = document.getElementById('noDataMessage');

  resultDiv.innerHTML = '';
  totalVoucherSummary.style.display = 'none';
  printButton.style.display = 'none';
  noDataMessage.style.display = 'none';

  if(!text){
    noDataMessage.textContent='è«‹è²¼ä¸Šæˆç¸¾è³‡æ–™ã€‚';
    noDataMessage.style.display='block';
    return;
  }
  const lines = text.split('\n');
  if(lines.length<2){
    noDataMessage.textContent='è³‡æ–™ä¸è¶³ï¼Œè«‹ç¢ºèªè²¼ä¸Šçš„è³‡æ–™åŒ…å«æ¨™é¡Œåˆ—å’Œè‡³å°‘ä¸€è¡Œå­¸ç”Ÿè³‡æ–™ã€‚';
    noDataMessage.style.display='block';
    return;
  }

  // è§£æè¡¨é ­
  const headers = lines[0].trim().split(/\s+/).map(h=>h.trim());
  const cleaned = headers.map(h=>h.replace(/\s/g,''));
  const idx = {
    grade: cleaned.findIndex(h=> h.includes('å¹´ç´š') || h.includes('ç­ç´š') || h.includes('ç­')),
    name:  cleaned.findIndex(h=> h.includes('å§“å') || h.includes('å­¸ç”Ÿ')),
    avg:   cleaned.findIndex(h=> h.includes('å¹³å‡'))
  };
  if(idx.grade===-1 && cleaned.findIndex(h=>h.includes('ç­ç´š'))===-1){
    // å…è¨±åªæœ‰ç­ç´šæˆ–å¹´ç´šå…¶ä¸­ä¹‹ä¸€ï¼Œä½†å…©è€…éƒ½æ‰¾ä¸åˆ°å°±å ±éŒ¯
    alert('æ‰¾ä¸åˆ° å¹´ç´šï¼ç­ç´š æ¬„ä½ï¼Œè«‹ç¢ºèªæ¨™é¡Œåˆ—åŒ…å«ã€Œå¹´ç´šã€æˆ–ã€Œç­ç´šã€ã€‚');
    noDataMessage.textContent='æ‰¾ä¸åˆ° å¹´ç´šï¼ç­ç´š æ¬„ä½ï¼Œè«‹ç¢ºèªæ¨™é¡Œåˆ—åŒ…å«ã€Œå¹´ç´šã€æˆ–ã€Œç­ç´šã€ã€‚';
    noDataMessage.style.display='block';
    return;
  }
  if(idx.name===-1 || idx.avg===-1){
    alert('æ‰¾ä¸åˆ° å§“åï¼ˆæˆ–å­¸ç”Ÿï¼‰ï¼å¹³å‡ æ¬„ä½ï¼Œè«‹ç¢ºèªæ¨™é¡Œåˆ—æ ¼å¼æ­£ç¢ºã€‚');
    noDataMessage.textContent='æ‰¾ä¸åˆ° å§“åï¼ˆæˆ–å­¸ç”Ÿï¼‰ï¼å¹³å‡ æ¬„ä½ï¼Œè«‹ç¢ºèªæ¨™é¡Œåˆ—æ ¼å¼æ­£ç¢ºã€‚';
    noDataMessage.style.display='block';
    return;
  }

  let slipsHTML = [];
  let totalVoucherCount = 0;

  for(let i=1;i<lines.length;i++){
    const line = lines[i].trim();
    if(!line) continue;
    const parts = line.split(/\s+/);
    // å»ºä¸€å€‹ row ç‰©ä»¶ï¼Œå¥½è®“åˆ†æµå‡½å¼åŒæ™‚æ”¯æ´ å¹´ç´š/ç­ç´š
    const row = {};
    cleaned.forEach((h,ix)=>{ row[h] = parts[ix]; });

    const gradeRaw = (idx.grade!==-1 ? parts[idx.grade] : (row['ç­ç´š']||'')); // ç›¡é‡æŠ“å¹´ç´šï¼Œå¦å‰‡ç­ç´š
    const name = parts[idx.name];
    const avg = parseFloat(parts[idx.avg]);
    if(!name || isNaN(avg)) continue;

    // ä»¥ row æ±ºå®šå­¸é½¡çµ„
    const group = classifyGradeByRow({ 'å¹´ç´š': gradeRaw, 'ç­ç´š': row['ç­ç´š'] });
    const reward = getRewardByGroup(group, avg);
    if(reward<=0) continue;

    totalVoucherCount += reward/100;

    // é¡¯ç¤ºå¹´ç´šï¼šçµ±ä¸€é¡¯ç¤ºã€ŒNå¹´ç´šã€
    const n = parseGradeNumber(gradeRaw);
    const gradeForShow = isNaN(n) ? `${gradeRaw}å¹´ç´š` : `${n}å¹´ç´š`;

    let formattedSemester = semester.replace('ä¸Š','<strong>ä¸Š</strong>').replace('ä¸‹','<strong>ä¸‹</strong>');
    let formattedExamType = examType.replace('ä¸­','<strong>ä¸­</strong>').replace('æœ«','<strong>æœ«</strong>');
    const term = `${gradeForShow}${formattedSemester}${formattedExamType}`;

    const policy = getPolicyTextByGroup(group);

    const slipText = `å­¸ç”Ÿ <span class='student-name'>${name}</span>
å› ${term}
å„ç§‘å¹³å‡é”${avg}åˆ†ï¼Œ
ç‰¹é ’ç¦®åˆ¸ ${reward} å…ƒä»¥èŒ²é¼“å‹µã€‚
--------------------------`;

    slipsHTML.push(`
      <div class="slip">
        <img src="https://github.com/zh22331997/salary-calculator/blob/main/2019%20zh%20logo.png?raw=true" class="logo" alt="å­¸æ ¡Logo" />
        <pre>${slipText}</pre>
        <pre class="policy-text">${policy}</pre>
      </div>`);
  }

  if(slipsHTML.length>0){
    resultDiv.innerHTML = slipsHTML.join('');
    totalVoucherSummary.innerHTML = `ğŸ å…±éœ€ <span class="total-voucher-count">${totalVoucherCount}</span> å¼µ 100å…ƒç¦®åˆ¸ï¼Œè«‹ç¢ºèªåº«å­˜ã€‚`;
    totalVoucherSummary.style.display='block';
    printButton.style.display='inline-block';
  }else{
    noDataMessage.textContent='âš ï¸ æ²’æœ‰å­¸ç”Ÿç¬¦åˆçå‹µæ¢ä»¶ï¼Œæˆ–è³‡æ–™æ¬„ä½å°ä¸åˆ°ã€‚';
    noDataMessage.style.display='block';
  }
}
/* ====== æ¸…ç©ºè³‡æ–™ ====== */
function clearAll(){
  if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¼¸å…¥èˆ‡çµæœå—ï¼Ÿ')) return;
  document.getElementById('input').value = '';
  document.getElementById('result').innerHTML = '';
  document.getElementById('printButton').style.display = 'none';
  document.getElementById('totalVoucherSummary').style.display = 'none';
  const msg = document.getElementById('noDataMessage');
  msg.textContent = 'è«‹è¼¸å…¥è³‡æ–™ä¸¦é»æ“Šã€Œç”¢ç”Ÿç¦®åˆ¸è²¼æ¢ã€ã€‚';
  msg.style.display = 'block';
}

/* åˆ—å° */
function printSlips(){ window.print(); }
</script>
</body>
</html>
