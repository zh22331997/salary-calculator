<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœŸä¸­æœŸæœ«ç¦®åˆ¸è²¼æ¢ç”¢ç”Ÿå™¨</title>
  <style>
    /* å…¨åŸŸè¨­å®šèˆ‡åŸºæœ¬æ’ç‰ˆ */
    @page {
      margin: 0.6cm; /* æ¨™æº– A4 é‚Šè·ï¼Œä¸Šä¸‹å·¦å³å„ 0.6cm */
    }
    body {
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      background-color: #f4f4f4;
      padding: 2em;
      line-height: 1.6;
      color: #333;
    }

    /* è¼¸å…¥å€å¡Šæ¨£å¼ */
    h1 {
      color: #0056b3;
      text-align: center;
      margin-bottom: 1em;
    }
    label {
      display: block;
      margin-bottom: 0.5em;
      font-weight: bold;
    }
    textarea {
      width: 100%;
      height: 200px;
      font-size: 1em;
      font-family: monospace;
      padding: 0.8em;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; /* ç¢ºä¿å…§é‚Šè·å’Œé‚Šæ¡†åŒ…å«åœ¨å¯¬åº¦å…§ */
      margin-bottom: 1em;
    }
    select, button {
      padding: 0.6em 1.2em;
      margin-right: 0.5em;
      border: 1px solid #007bff;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    button:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    #printButton {
      background-color: #28a745;
      border-color: #28a745;
      display: none; /* é è¨­éš±è— */
    }
    #printButton:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }

    /* çå‹µæ¨™æº–è¨­å®šå€å¡Šæ¨£å¼ - èª¿æ•´ç‚ºæ›´ç·Šæ¹Šçš„ä½ˆå±€ */
    .settings-container {
      background: #fff;
      padding: 1.2em 1.5em; /* ç¸®å°ä¸Šä¸‹å…§é‚Šè· */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 2em;
    }
    .settings-container h2 {
      color: #007bff;
      margin-top: 0;
      margin-bottom: 0.8em; /* ç¸®å°æ¨™é¡Œä¸‹æ–¹é–“è· */
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5em;
      font-size: 1.4em; /* ç¨å¾®ç¸®å°æ¨™é¡Œå­—é«” */
    }
    .grade-settings {
      margin-bottom: 1em; /* ç¸®å°ä¸åŒå¹´ç´šè¨­å®šä¹‹é–“çš„é–“è· */
      line-height: 1.2; /* ç¸®å°è¡Œè· */
    }
    .grade-settings h3 {
        font-size: 1.1em; /* ç¸®å°å¹´ç´šæ¨™é¡Œå­—é«” */
        margin-top: 0.5em;
        margin-bottom: 0.5em; /* ç¸®å°æ¨™é¡Œèˆ‡è¼¸å…¥æ¡†çš„é–“è· */
        color: #333;
    }
    .grade-settings label {
      display: inline-block;
      width: 40px; /* çµ±ä¸€æ¨™ç±¤å¯¬åº¦ */
      margin-right: 0.2em; /* ç¸®å°æ¨™ç±¤èˆ‡è¼¸å…¥æ¡†é–“è· */
      margin-bottom: 0.2em; /* ç¸®å°è¡Œå…§å…ƒç´ é–“è· */
      font-weight: normal;
      font-size: 0.95em; /* ç¨å¾®ç¸®å°å­—é«” */
    }
    .grade-settings input[type="number"] {
      width: 50px; /* ç¸®å°è¼¸å…¥æ¡†å¯¬åº¦ */
      padding: 0.2em; /* ç¸®å°å…§é‚Šè· */
      border: 1px solid #ccc;
      border-radius: 3px;
      text-align: center;
      font-size: 0.9em; /* ç¸®å°å­—é«” */
      margin-right: 0.5em;
      vertical-align: middle; /* å°é½Šæ–‡å­— */
    }
    .grade-settings span { /* ç¦®åˆ¸é‡‘é¡æ–‡å­— */
        font-size: 0.95em;
    }
    .settings-button-group {
      text-align: right;
      margin-top: 1em; /* ç¸®å°æŒ‰éˆ•çµ„ä¸Šæ–¹é–“è· */
    }
    .settings-button-group button {
      background-color: #6c757d;
      border-color: #6c757d;
      padding: 0.5em 1em; /* ç¸®å°æŒ‰éˆ•å…§é‚Šè· */
      font-size: 0.9em; /* ç¸®å°æŒ‰éˆ•å­—é«” */
    }
    .settings-button-group button:hover {
      background-color: #5a6268;
      border-color: #545b62;
    }

    /* è¼¸å‡ºå€å¡Šæ¨£å¼ (ç”¨æ–¼ç¶²é é¡¯ç¤ºå’Œåˆ—å°) */
    .output-container {
      margin-top: 2em;
      background: #fff;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .output-grid {
      display: grid;
      grid-template-columns: repeat(3, 6.5cm); /* 3 åˆ—ï¼Œæ¯åˆ—å¯¬åº¦ 6.5cm */
      gap: 0; /* ç¢ºä¿è²¼æ¢ä¹‹é–“æ²’æœ‰é–“éš” */
      background: #fff;
      padding: 0;
      justify-content: center; /* è®“ç¶²æ ¼å…§å®¹åœ¨å®¹å™¨ä¸­æ°´å¹³å±…ä¸­ */
      /* æ–°å¢ï¼šç¢ºä¿ç¶²é é¡¯ç¤ºæ™‚çš„å·¦å³ç½®ä¸­ */
      margin: 0 auto;
    }
    .slip {
      width: 6.5cm;
      height: 5.6cm; /* é«˜åº¦èª¿æ•´ç‚º 5.6cm (5.8cm - 2mm) */
      border: 1px dashed #999; /* è£åˆ‡è¼”åŠ©ç·šï¼šé è¨­è™›ç·š */
      padding: 0.4cm;
      box-sizing: border-box;
      page-break-inside: avoid; /* é˜²æ­¢è²¼æ¢å…§å®¹è¢«æ‹†æ•£åˆ°ä¸åŒé  */
      position: relative;
      overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
    }
    .slip pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 11pt;
      line-height: 1.2;
      margin: 0;
      color: #000; /* ç¢ºä¿åˆ—å°æ™‚æ–‡å­—é¡è‰²ç‚ºé»‘è‰² */
    }
    .student-name {
      font-size: 14pt;
      font-weight: bold;
      color: #d9534f; /* çµ¦å­¸ç”Ÿå§“åä¸€å€‹æ›´é†’ç›®çš„é¡è‰² */
    }
    .policy-text {
      font-size: 6pt; /* ä¿æŒ 6pt å­—é«”å¤§å° */
      line-height: 1.0;
      color: #555;
      margin-top: 0.2cm; /* èˆ‡ä¸Šæ–¹å…§å®¹éš”é–‹ */
    }
    .logo {
      position: absolute;
      top: 0.2cm;
      right: 0.2cm;
      width: 1.2cm;
      height: auto;
      opacity: 0.9;
      pointer-events: none; /* è®“åœ–ç‰‡ä¸å½±éŸ¿é»æ“Šäº‹ä»¶ */
    }
    .total-voucher-info {
      margin-top: 1em;
      font-weight: bold;
      text-align: center; /* è®“æç¤ºæ–‡å­—ç½®ä¸­ */
      padding: 0.5em;
      border-top: 1px dashed #ccc; /* å¢åŠ åˆ†éš”ç·š */
    }
    .total-voucher-count {
      color: darkred;
      font-size: 1.2em;
    }
    .no-data-message {
        text-align: center;
        color: #777;
        padding: 1em;
    }

    /* åˆ—å°å°ˆç”¨æ¨£å¼ */
    @media print {
      body {
        background-color: #fff; /* åˆ—å°æ™‚èƒŒæ™¯è¨­ç‚ºç™½è‰² */
        padding: 0; /* åˆ—å°æ™‚ç§»é™¤é é¢é‚Šè· */
      }
      /* éš±è—æ‰€æœ‰éåˆ—å°å…§å®¹ */
      body > *:not(.output-container) {
        display: none !important;
      }
      .output-container {
        margin-top: 0;
        padding: 0;
        box-shadow: none;
      }
      .output-grid {
        display: grid;
        grid-template-columns: repeat(3, 6.5cm); /* åˆ—å°æ™‚ä¹Ÿä½¿ç”¨ 3 åˆ—ä½ˆå±€ */
        gap: 0;
        width: auto; /* è®“ç¶²æ ¼æ ¹æ“šå…§å®¹æ±ºå®šå¯¬åº¦ */
        margin: 0 auto; /* ä¸Šä¸‹é‚Šè·0ï¼Œå·¦å³è‡ªå‹•ï¼Œä½¿å…¶æ°´å¹³ç½®ä¸­ */
      }
      .slip {
        width: 6.5cm;
        height: 5.6cm; /* åˆ—å°æ™‚ä¹Ÿä½¿ç”¨ 5.6cm é«˜åº¦ */
        border: 0.5px solid #000; /* ä½¿ç”¨ç´°å¯¦ç·šä½œç‚ºè£åˆ‡ç·šï¼Œæ›´æ¸…æ™° */
        box-sizing: border-box;
        page-break-inside: avoid;
        position: relative;
        overflow: hidden;
      }
      /* èª¿æ•´åˆ—å°æ™‚çš„å­—é«”å¤§å°å’Œè¡Œé«˜ (æ ¹æ“šä¸Šæ¬¡çš„è¨è«–ï¼Œä¿ç•™é€™å€‹èª¿æ•´) */
      .slip pre {
        font-size: 10.5pt; /* ç•¥å¾®ç¸®å°å­—é«” */
        line-height: 1.1; /* èª¿æ•´è¡Œé«˜ï¼Œä½¿å…¶æ›´ç·Šæ¹Š */
      }
      .student-name {
        font-size: 13pt; /* ç•¥å¾®ç¸®å°å­¸ç”Ÿå§“å */
      }
      /* éš±è—ç¦®åˆ¸çµ±è¨ˆè³‡è¨Šï¼Œå› ç‚ºé€™åªç”¨æ–¼ç¶²é é¡¯ç¤º */
      .total-voucher-info, .no-data-message {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <h1>æœŸä¸­æœŸæœ«ç¦®åˆ¸è²¼æ¢ç”¢ç”Ÿå™¨</h1>

  <div class="settings-container">
    <h2>ğŸ† çå‹µæ¨™æº–è¨­å®š (è«‹å…ˆç¢ºèªä»¥ä¸‹æ¨™æº–)</h2>
    <div class="grade-settings">
      <h3>ä½å¹´ç´š</h3>
      <label for="lowGrade300">å¹³å‡</label>
      <input type="number" id="lowGrade300" value="100" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸300å…ƒ</span><br>
      <label for="lowGrade100">å¹³å‡</label>
      <input type="number" id="lowGrade100" value="98" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸100å…ƒ</span><br>
    </div>
    <div class="grade-settings">
      <h3>ä¸­å¹´ç´š</h3>
      <label for="midGrade300">å¹³å‡</label>
      <input type="number" id="midGrade300" value="100" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸300å…ƒ</span><br>
      <label for="midGrade200">å¹³å‡</label>
      <input type="number" id="midGrade200" value="97" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸200å…ƒ</span><br>
      <label for="midGrade100">å¹³å‡</label>
      <input type="number" id="midGrade100" value="95" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸100å…ƒ</span><br>
    </div>
    <div class="grade-settings">
      <h3>é«˜å¹´ç´š</h3>
      <label for="highGrade300">å¹³å‡</label>
      <input type="number" id="highGrade300" value="98" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸300å…ƒ</span><br>
      <label for="highGrade200">å¹³å‡</label>
      <input type="number" id="highGrade200" value="95" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸200å…ƒ</span><br>
      <label for="highGrade100">å¹³å‡</label>
      <input type="number" id="highGrade100" value="93" min="0" max="100">åˆ†ï¼Œ<span>çå‹µç¦®åˆ¸100å…ƒ</span><br>
    </div>
    <div class="settings-button-group">
      <button onclick="saveRewardSettings()">å„²å­˜çå‹µæ¨™æº–</button>
      <button onclick="resetRewardSettings()">é‡ç½®ç‚ºé è¨­å€¼</button>
    </div>
  </div>

  <hr> <label for="input">è«‹è²¼ä¸Šæˆç¸¾è¡¨ï¼ˆå¯å¾EXCELè²¼ä¸Šï¼Œæˆ–ç›´æ¥è¼¸å…¥ï¼Œè¦æœ‰æ¨™é¡Œï¼Œä¸”æ¨™é¡Œè‡³å°‘æœ‰ å¹´ç´šã€å§“åã€å¹³å‡ ä¸‰ç¨®è³‡æ–™ï¼‰ï¼š</label><br> 
  <textarea id="input" placeholder="å¹´ç´š å§“å å¹³å‡
ä¸€ å°ç´…è±† 99
äºŒ å°æ˜ 95
ä¸‰ å°è¯ 100
å›› å°ç¾ 97
äº” å°å¼· 93
å…­ å°è‰ 98"></textarea><br>
  <label>é¸æ“‡å­¸æœŸèˆ‡è€ƒåˆ¥ï¼š</label><br>
  <select id="semester">
    <option value="ä¸Šå­¸æœŸ">ä¸Šå­¸æœŸ</option>
    <option value="ä¸‹å­¸æœŸ" selected>ä¸‹å­¸æœŸ</option>
  </select>
  <select id="examType">
    <option value="æœŸä¸­è€ƒ">æœŸä¸­è€ƒ</option>
    <option value="æœŸæœ«è€ƒ" selected>æœŸæœ«è€ƒ</option>
  </select><br><br>
  <button onclick="generateSlips()">ç”¢ç”Ÿç¦®åˆ¸è²¼æ¢</button>
  <button id="printButton" onclick="printSlips()">ğŸ–¨ï¸ åˆ—å°è²¼æ¢</button>

  <hr> <div class="output-container">
    <div id="result" class="output-grid">
      </div>
    <p id="totalVoucherSummary" class="total-voucher-info" style="display:none;"></p>
    <p id="noDataMessage" class="no-data-message" style="display:block;">è«‹è¼¸å…¥è³‡æ–™ä¸¦é»æ“Šã€Œç”¢ç”Ÿç¦®åˆ¸è²¼æ¢ã€ã€‚</p>
  </div>

  <script>
    // é è¨­çå‹µæ¨™æº–
    const defaultRewardSettings = {
      lowGrade: {
        '300': 100, // å¹³å‡100åˆ† 300å…ƒ
        '100': 98   // å¹³å‡98åˆ† 100å…ƒ
      },
      midGrade: {
        '300': 100, // å¹³å‡100åˆ† 300å…ƒ
        '200': 97,  // å¹³å‡97åˆ† 200å…ƒ
        '100': 95   // å¹³å‡95åˆ† 100å…ƒ
      },
      highGrade: {
        '300': 98,  // å¹³å‡98åˆ† 300å…ƒ
        '200': 95,  // å¹³å‡95åˆ† 200å…ƒ
        '100': 93   // å¹³å‡93åˆ† 100å…ƒ
      }
    };

    // ç•¶å‰ä½¿ç”¨çš„çå‹µæ¨™æº–ï¼Œæœƒå¾ localStorage è¼‰å…¥æˆ–ä½¿ç”¨é è¨­å€¼
    let currentRewardSettings = {};

    /**
     * å¾ localStorage è¼‰å…¥çå‹µæ¨™æº–ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­å€¼ã€‚
     */
    function loadRewardSettings() {
      const savedSettings = localStorage.getItem('rewardSettings');
      if (savedSettings) {
        currentRewardSettings = JSON.parse(savedSettings);
      } else {
        currentRewardSettings = JSON.parse(JSON.stringify(defaultRewardSettings)); // æ·±åº¦è¤‡è£½é è¨­å€¼
      }
      applyRewardSettingsToInputs(); // å°‡è¼‰å…¥çš„æ¨™æº–é¡¯ç¤ºåˆ°è¼¸å…¥æ¡†
    }

    /**
     * å°‡ currentRewardSettings çš„å€¼æ‡‰ç”¨åˆ°ç¶²é ä¸Šçš„è¼¸å…¥æ¡†ã€‚
     */
    function applyRewardSettingsToInputs() {
      document.getElementById('lowGrade300').value = currentRewardSettings.lowGrade['300'];
      document.getElementById('lowGrade100').value = currentRewardSettings.lowGrade['100'];

      document.getElementById('midGrade300').value = currentRewardSettings.midGrade['300'];
      document.getElementById('midGrade200').value = currentRewardSettings.midGrade['200'];
      document.getElementById('midGrade100').value = currentRewardSettings.midGrade['100'];

      document.getElementById('highGrade300').value = currentRewardSettings.highGrade['300'];
      document.getElementById('highGrade200').value = currentRewardSettings.highGrade['200'];
      document.getElementById('highGrade100').value = currentRewardSettings.highGrade['100'];
    }

    /**
     * å°‡ä½¿ç”¨è€…åœ¨è¼¸å…¥æ¡†ä¸­è¨­å®šçš„çå‹µæ¨™æº–å„²å­˜åˆ° localStorageã€‚
     */
    function saveRewardSettings() {
      currentRewardSettings.lowGrade['300'] = parseInt(document.getElementById('lowGrade300').value);
      currentRewardSettings.lowGrade['100'] = parseInt(document.getElementById('lowGrade100').value);

      currentRewardSettings.midGrade['300'] = parseInt(document.getElementById('midGrade300').value);
      currentRewardSettings.midGrade['200'] = parseInt(document.getElementById('midGrade200').value);
      currentRewardSettings.midGrade['100'] = parseInt(document.getElementById('midGrade100').value);

      currentRewardSettings.highGrade['300'] = parseInt(document.getElementById('highGrade300').value);
      currentRewardSettings.highGrade['200'] = parseInt(document.getElementById('highGrade200').value);
      currentRewardSettings.highGrade['100'] = parseInt(document.getElementById('highGrade100').value);

      // æª¢æŸ¥è¼¸å…¥æ˜¯å¦æœ‰æ•ˆ
      // æª¢æŸ¥æ‰€æœ‰çå‹µç­‰ç´šçš„åˆ†æ•¸æ˜¯å¦éƒ½æ˜¯æœ‰æ•ˆæ•¸å­—ä¸”åœ¨0-100ä¹‹é–“
      const allScores = [
          currentRewardSettings.lowGrade['300'], currentRewardSettings.lowGrade['100'],
          currentRewardSettings.midGrade['300'], currentRewardSettings.midGrade['200'], currentRewardSettings.midGrade['100'],
          currentRewardSettings.highGrade['300'], currentRewardSettings.highGrade['200'], currentRewardSettings.highGrade['100']
      ];
      
      const isValid = allScores.every(score => !isNaN(score) && score >= 0 && score <= 100);

      // æª¢æŸ¥åˆ†æ•¸æ˜¯å¦ç¬¦åˆé‚è¼¯éæ¸› (é«˜é‡‘é¡å°æ‡‰é«˜åˆ†æ•¸)
      const isLowGradeOrderValid = currentRewardSettings.lowGrade['300'] >= currentRewardSettings.lowGrade['100'];
      const isMidGradeOrderValid = currentRewardSettings.midGrade['300'] >= currentRewardSettings.midGrade['200'] &&
                                   currentRewardSettings.midGrade['200'] >= currentRewardSettings.midGrade['100'];
      const isHighGradeOrderValid = currentRewardSettings.highGrade['300'] >= currentRewardSettings.highGrade['200'] &&
                                    currentRewardSettings.highGrade['200'] >= currentRewardSettings.highGrade['100'];

      if (!isValid || !isLowGradeOrderValid || !isMidGradeOrderValid || !isHighGradeOrderValid) {
          let errorMessage = 'è«‹ç¢ºèªï¼š\n1. æ‰€æœ‰çå‹µåˆ†æ•¸éƒ½è¼¸å…¥äº†æœ‰æ•ˆæ•¸å­— (0-100)ã€‚\n2. é«˜é‡‘é¡çå‹µå°æ‡‰çš„åˆ†æ•¸ä¸ä½æ–¼ä½é‡‘é¡çå‹µå°æ‡‰çš„åˆ†æ•¸ã€‚';
          alert(errorMessage);
          loadRewardSettings(); // è¼‰å…¥ä¹‹å‰å„²å­˜çš„æˆ–é è¨­å€¼
          return;
      }
      
      localStorage.setItem('rewardSettings', JSON.stringify(currentRewardSettings));
      alert('çå‹µæ¨™æº–å·²å„²å­˜ï¼');
    }

    /**
     * å°‡çå‹µæ¨™æº–é‡ç½®ç‚ºé è¨­å€¼ä¸¦å„²å­˜åˆ° localStorageã€‚
     */
    function resetRewardSettings() {
      currentRewardSettings = JSON.parse(JSON.stringify(defaultRewardSettings)); // æ·±åº¦è¤‡è£½é è¨­å€¼
      localStorage.setItem('rewardSettings', JSON.stringify(currentRewardSettings));
      applyRewardSettingsToInputs(); // æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤º
      alert('çå‹µæ¨™æº–å·²é‡ç½®ç‚ºé è¨­å€¼ï¼');
    }

    // é é¢è¼‰å…¥æ™‚è¼‰å…¥çå‹µè¨­å®š
    window.onload = loadRewardSettings;


    /**
     * æ ¹æ“šå¹´ç´šåˆ¤æ–·æ‰€å±¬çš„å­¸é½¡çµ„ã€‚
     * @param {string} grade - å¹´ç´šçš„æ–‡å­—è¡¨ç¤ºï¼Œä¾‹å¦‚ã€Œä¸€ã€ã€ã€ŒäºŒã€ã€‚
     * @returns {string} - ã€Œä½å¹´ç´šã€ã€ã€Œä¸­å¹´ç´šã€æˆ–ã€Œé«˜å¹´ç´šã€ã€‚
     */
    function classifyGrade(grade) {
      if (grade === 'ä¸€' || grade === 'äºŒ') return 'ä½å¹´ç´š';
      if (grade === 'ä¸‰' || grade === 'å››') return 'ä¸­å¹´ç´š';
      return 'é«˜å¹´ç´š';
    }

    /**
     * æ ¹æ“šå¹´ç´šå’Œå¹³å‡åˆ†æ•¸è¨ˆç®—çå‹µé‡‘é¡ã€‚
     * @param {string} grade - å¹´ç´šçš„æ–‡å­—è¡¨ç¤ºã€‚
     * @param {number} avg - å¹³å‡åˆ†æ•¸ã€‚
     * @returns {number} - çå‹µç¦®åˆ¸é‡‘é¡ã€‚
     */
    function getReward(grade, avg) {
      const group = classifyGrade(grade);
      const settings = currentRewardSettings; // ä½¿ç”¨ç•¶å‰è¨­å®šçš„çå‹µæ¨™æº–

      if (group === 'ä½å¹´ç´š') {
        if (avg === settings.lowGrade['300']) return 300;
        if (avg >= settings.lowGrade['100']) return 100;
      } else if (group === 'ä¸­å¹´ç´š') {
        if (avg === settings.midGrade['300']) return 300;
        if (avg >= settings.midGrade['200']) return 200;
        if (avg >= settings.midGrade['100']) return 100;
      } else { // é«˜å¹´ç´š
        if (avg >= settings.highGrade['300']) return 300;
        if (avg >= settings.highGrade['200']) return 200;
        if (avg >= settings.highGrade['100']) return 100;
      }
      return 0; // æ²’æœ‰é”åˆ°çå‹µæ¨™æº–
    }

    /**
     * æ ¹æ“šå¹´ç´šç²å–ç›¸æ‡‰çš„çå‹µè¾¦æ³•æ–‡å­—ã€‚
     * @param {string} grade - å¹´ç´šçš„æ–‡å­—è¡¨ç¤ºã€‚
     * @returns {string} - çå‹µè¾¦æ³•èªªæ˜æ–‡å­—ã€‚
     */
    function getPolicyText(grade) {
      const group = classifyGrade(grade);
      const settings = currentRewardSettings; // ä½¿ç”¨ç•¶å‰è¨­å®šçš„çå‹µæ¨™æº–
      
      // å‹•æ…‹ç”Ÿæˆçå‹µå€é–“æ–‡å­—çš„è¼”åŠ©å‡½æ•¸
      const getRangeDisplay = (minScore, maxScore) => {
        if (minScore === maxScore) {
          return `${minScore}åˆ†`;
        }
        // ç¢ºä¿ç¯„åœä¸Šé™ä¸è¶…é100åˆ†
        const actualMax = Math.min(maxScore, 100); 
        // ç¢ºä¿ç¯„åœä¸‹é™ä¸ä½æ–¼0åˆ†
        const actualMin = Math.max(0, minScore);
        // å¦‚æœå¯¦éš›çš„ç¯„åœä¸Šé™å°æ–¼ä¸‹é™ï¼Œèªªæ˜é€™å€‹å€é–“ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ä¸²æˆ–ç‰¹å®šæ–‡å­—
        if (actualMax < actualMin) {
            return ''; // æˆ– "ç„¡æ­¤å€é–“"
        }
        return `${actualMin}åˆ†~${actualMax}åˆ†`;
      };

      // ç”¨æ–¼å°é½Šçš„è¼”åŠ©å‡½æ•¸
      // è¨ˆç®—ä¸­æ–‡å­—ç¬¦æ•¸ï¼ˆä¸€å€‹ä¸­æ–‡å­—ç¬¦ç®—å…©å€‹è‹±æ–‡å­—ç¬¦å¯¬åº¦ï¼‰
      const getDisplayLength = (text) => {
          let length = 0;
          for (let i = 0; i < text.length; i++) {
              if (text.charCodeAt(i) > 255) { // å¤§æ–¼255é€šå¸¸æ˜¯ä¸­æ–‡å­—ç¬¦
                  length += 2;
              } else {
                  length += 1;
              }
          }
          return length;
      };

      const padRight = (text, totalLength) => {
          const currentLength = getDisplayLength(text);
          const paddingNeeded = Math.max(0, totalLength - currentLength);
          return text + ' '.repeat(paddingNeeded);
      };

      // å‹•æ…‹è¨ˆç®—åŸºæº–é•·åº¦ï¼Œæ‰¾å‡ºè©²å¹´ç´šæ‰€æœ‰åˆ†æ•¸å€é–“ä¸­é¡¯ç¤ºé•·åº¦æœ€é•·çš„ä¸€å€‹
      let maxLength = 0;

      if (group === 'ä½å¹´ç´š') {
        const d300 = getRangeDisplay(settings.lowGrade['300'], 100);
        const d100 = getRangeDisplay(settings.lowGrade['100'], settings.lowGrade['300'] - 1);
        maxLength = Math.max(getDisplayLength('å¹³å‡' + d300), getDisplayLength('å¹³å‡' + d100));
        
        return `æœŸä¸­ã€æœŸæœ«è€ƒ æˆç¸¾å„ªç•°çå‹µè¾¦æ³•
ä½å¹´ç´š
${padRight('å¹³å‡' + d300, maxLength)}çå‹µç¦®åˆ¸300å…ƒ
${padRight('å¹³å‡' + d100, maxLength)}çå‹µç¦®åˆ¸100å…ƒ`;

      } else if (group === 'ä¸­å¹´ç´š') {
        const d300 = getRangeDisplay(settings.midGrade['300'], 100);
        const d200 = getRangeDisplay(settings.midGrade['200'], settings.midGrade['300'] - 1);
        const d100 = getRangeDisplay(settings.midGrade['100'], settings.midGrade['200'] - 1);
        maxLength = Math.max(getDisplayLength('å¹³å‡' + d300), getDisplayLength('å¹³å‡' + d200), getDisplayLength('å¹³å‡' + d100));

        return `æœŸä¸­ã€æœŸæœ«è€ƒ æˆç¸¾å„ªç•°çå‹µè¾¦æ³•
ä¸­å¹´ç´š
${padRight('å¹³å‡' + d300, maxLength)}çå‹µç¦®åˆ¸300å…ƒ
${padRight('å¹³å‡' + d200, maxLength)}çå‹µç¦®åˆ¸200å…ƒ
${padRight('å¹³å‡' + d100, maxLength)}çå‹µç¦®åˆ¸100å…ƒ`;

      } else { // é«˜å¹´ç´š
        const d300 = getRangeDisplay(settings.highGrade['300'], 100);
        const d200 = getRangeDisplay(settings.highGrade['200'], settings.highGrade['300'] - 1);
        const d100 = getRangeDisplay(settings.highGrade['100'], settings.highGrade['200'] - 1);
        // å‹•æ…‹æ‰¾å‡ºé«˜å¹´ç´šæœ€é•·çš„ä¸€è¡Œä¾†æ±ºå®šå°é½ŠåŸºæº–
        maxLength = Math.max(getDisplayLength('å¹³å‡' + d300), getDisplayLength('å¹³å‡' + d200), getDisplayLength('å¹³å‡' + d100));
        
        return `æœŸä¸­ã€æœŸæœ«è€ƒ æˆç¸¾å„ªç•°çå‹µè¾¦æ³•
é«˜å¹´ç´š
${padRight('å¹³å‡' + d300, maxLength)}çå‹µç¦®åˆ¸300å…ƒ
${padRight('å¹³å‡' + d200, maxLength)}çå‹µç¦®åˆ¸200å…ƒ
${padRight('å¹³å‡' + d100, maxLength)}çå‹µç¦®åˆ¸100å…ƒ`;
      }
    }

    /**
     * ç”Ÿæˆç¦®åˆ¸è²¼æ¢ã€‚
     */
    function generateSlips() {
      const text = document.getElementById('input').value.trim();
      const semester = document.getElementById('semester').value;
      const examType = document.getElementById('examType').value;
      const resultDiv = document.getElementById('result');
      const printButton = document.getElementById('printButton');
      const totalVoucherSummary = document.getElementById('totalVoucherSummary');
      const noDataMessage = document.getElementById('noDataMessage');

      resultDiv.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„çµæœ
      totalVoucherSummary.style.display = 'none'; // éš±è—ç¸½çµè³‡è¨Š
      printButton.style.display = 'none'; // éš±è—åˆ—å°æŒ‰éˆ•
      noDataMessage.style.display = 'none'; // éš±è—ç„¡è³‡æ–™è¨Šæ¯

      if (!text) {
        noDataMessage.textContent = 'è«‹è²¼ä¸Šæˆç¸¾è³‡æ–™ã€‚';
        noDataMessage.style.display = 'block';
        return;
      }

      const lines = text.split('\n');
      if (lines.length < 2) {
        noDataMessage.textContent = 'è³‡æ–™ä¸è¶³ï¼Œè«‹ç¢ºèªè²¼ä¸Šçš„è³‡æ–™åŒ…å«æ¨™é¡Œåˆ—å’Œè‡³å°‘ä¸€è¡Œå­¸ç”Ÿè³‡æ–™ã€‚';
        noDataMessage.style.display = 'block';
        return;
      }

      const headers = lines[0].trim().split(/\s+/);
      // æ¸…ç†è¡¨é ­ï¼Œå»é™¤ä»»ä½•ç©ºç™½å­—å…ƒï¼ˆåŒ…æ‹¬å…¨å½¢å’ŒåŠå½¢ï¼‰
      const cleanedHeaders = headers.map(h => h.trim().replace(/\s/g, ''));

      const gradeIndex = cleanedHeaders.findIndex(h => h.includes('å¹´ç´š') || h.includes('ç­ç´š') || h.includes('ç­'));
      const nameIndex = cleanedHeaders.findIndex(h => h.includes('å§“å'));
      const avgIndex = cleanedHeaders.findIndex(h => h.includes('å¹³å‡'));

      if (gradeIndex === -1 || nameIndex === -1 || avgIndex === -1) {
        alert('æ‰¾ä¸åˆ° å¹´ç´šï¼å§“åï¼å¹³å‡ æ¬„ä½ï¼Œè«‹ç¢ºèªè²¼ä¸Šçš„æ¨™é¡Œåˆ—æ ¼å¼æ­£ç¢ºã€‚');
        noDataMessage.textContent = 'æ‰¾ä¸åˆ° å¹´ç´šï¼å§“åï¼å¹³å‡ æ¬„ä½ï¼Œè«‹ç¢ºèªè²¼ä¸Šçš„æ¨™é¡Œåˆ—æ ¼å¼æ­£ç¢ºã€‚';
        noDataMessage.style.display = 'block';
        return;
      }

      let slipsHTML = [];
      let totalVoucherCount = 0;

      // å¾ç¬¬äºŒè¡Œé–‹å§‹è™•ç†è³‡æ–™
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue; // è·³éç©ºè¡Œ
        
        // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼åˆ†å‰²ï¼Œè™•ç†å¤šå€‹é€£çºŒç©ºç™½
        const parts = line.split(/\s+/);

        // ç¢ºä¿é™£åˆ—é•·åº¦è¶³å¤ ï¼Œé¿å…ç´¢å¼•è¶…å‡ºç¯„åœ
        if (parts.length <= Math.max(gradeIndex, nameIndex, avgIndex)) {
            console.warn(`è·³éç„¡æ•ˆè¡Œ: ${line}`);
            continue;
        }

        const gradeRaw = parts[gradeIndex];
        const name = parts[nameIndex];
        const avg = parseFloat(parts[avgIndex]);

        // æª¢æŸ¥ avg æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—
        if (isNaN(avg)) {
            console.warn(`è·³éå­¸ç”Ÿ ${name} çš„ç„¡æ•ˆå¹³å‡åˆ†æ•¸: ${parts[avgIndex]}`);
            continue;
        }
        
        const reward = getReward(gradeRaw, avg);

        if (reward > 0) { // åªç”Ÿæˆæœ‰çå‹µçš„è²¼æ¢
          totalVoucherCount += reward / 100;

          // ä½¿ç”¨ strong æ¨™ç±¤çªé¡¯æœŸåˆ¥å’Œå­¸æœŸ
          let formattedSemester = semester.replace('ä¸Š', '<strong>ä¸Š</strong>').replace('ä¸‹', '<strong>ä¸‹</strong>');
          let formattedExamType = examType.replace('ä¸­', '<strong>ä¸­</strong>').replace('æœ«', '<strong>æœ«</strong>');
          const term = `${gradeRaw}å¹´ç´š${formattedSemester}${formattedExamType}`;

          const policy = getPolicyText(gradeRaw);

          const slipText = `å­¸ç”Ÿ <span class='student-name'>${name}</span>
å› ${term}
å„ç§‘å¹³å‡é”${avg}åˆ†ï¼Œ
ç‰¹é ’ç¦®åˆ¸ ${reward} å…ƒä»¥èŒ²é¼“å‹µã€‚
--------------------------`;

          slipsHTML.push(`
            <div class="slip">
              <img src="https://github.com/zh22331997/salary-calculator/blob/main/2019%20zh%20logo.png?raw=true" class="logo" alt="å­¸æ ¡Logo" />
              <pre>${slipText}</pre>
              <pre class="policy-text">${policy}</pre>
            </div>`);
        }
      }

      if (slipsHTML.length > 0) {
        resultDiv.innerHTML = slipsHTML.join(''); // å°‡æ‰€æœ‰è²¼æ¢ç›´æ¥åŠ å…¥çµæœå€å¡Š
        totalVoucherSummary.innerHTML = `ğŸ å…±éœ€ <span class="total-voucher-count">${totalVoucherCount}</span> å¼µ 100å…ƒç¦®åˆ¸ï¼Œè«‹ç¢ºèªåº«å­˜ã€‚`;
        totalVoucherSummary.style.display = 'block';
        printButton.style.display = 'inline-block'; // é¡¯ç¤ºåˆ—å°æŒ‰éˆ•
      } else {
        noDataMessage.textContent = 'âš ï¸ æ²’æœ‰å­¸ç”Ÿç¬¦åˆçå‹µæ¢ä»¶ã€‚';
        noDataMessage.style.display = 'block';
      }
    }

    /**
     * è§¸ç™¼åˆ—å°åŠŸèƒ½ã€‚
     */
    function printSlips() {
      // ç”±æ–¼CSSä¸­çš„@media printå·²ç¶“è™•ç†äº†åˆ—å°æ™‚çš„é¡¯ç¤º/éš±è—ï¼Œ
      // é€™è£¡åªéœ€è¦ç›´æ¥å‘¼å« window.print() å³å¯ã€‚
      window.print();
    }
  </script>
</body>
</html>
