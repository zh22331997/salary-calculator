<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>打卡紀錄分析（合併 PT 工時計算）</title>
<style>
*,*::before,*::after{box-sizing:border-box}
:root{
  --bg:#f7f7fb; --card:#fff; --ink:#1f2937; --muted:#6b7280; --border:#e5e7eb;
  --fs:14px; --lh:1.4;
  --s1:6px; --s2:8px; --s3:10px; --s4:12px;
  --r-sm:8px; --r-md:12px;

  /* 主表 / PT工時 共用欄寬 */
  --w-ym: 90px;
  --w-branch: 120px;
  --w-name: 120px;
  --w-type: 160px;
  --w-subtotal: 120px;

  /* 不支薪表專用欄寬 */
  --w-nopay-name:   100px;
  --w-nopay-salary: 100px;
  --w-nopay-att:    110px;
  --w-nopay-info:   360px;
  --w-nopay-detail: 520px;

  /* 特休折現欄寬 */
  --w-cash-day:    90px;
  --w-cash-hour:   90px;
  --w-cash-detail: 360px;
}

html,body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,"Noto Sans TC","Segoe UI",Roboto,Arial,"PingFang TC","Microsoft JhengHei","Helvetica Neue",sans-serif;
  font-size:var(--fs);line-height:var(--lh)
}
.wrap{max-width:min(96vw,1800px);margin:24px auto;padding:0 var(--s3)}
.title{display:flex;align-items:center;justify-content:space-between;gap:var(--s3);flex-wrap:wrap}
.title h1{margin:0;font-size:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r-md);box-shadow:0 1px 3px rgba(0,0,0,.04);padding:var(--s4)}
.row{display:flex;gap:var(--s3);align-items:center;flex-wrap:wrap}
label{font-size:12px;color:#334155;margin-bottom:var(--s1);display:block}
input[type=text],textarea{width:100%;border:1px solid var(--border);border-radius:var(--r-md);padding:8px 10px;font-size:var(--fs)}
textarea{height:220px;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;resize:vertical}
button{appearance:none;border:0;border-radius:var(--r-sm);background:#e3f2fd;color:#1565c0;padding:8px 12px;font-weight:600;cursor:pointer;display:inline-flex;gap:8px}
button:hover{background:#cde5fd}
button.secondary{background:#f1f5f9;color:#334155}
button.secondary:hover{background:#e2e8f0}
button.pill{padding:4px 10px;border-radius:999px;font-size:12px}
.muted{color:var(--muted);font-size:12px;margin-top:6px}
.breakdown{white-space:pre-wrap}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:var(--fs);line-height:1.35}
th,td{border:1px solid var(--border);padding:6px 8px;vertical-align:middle}
th{background:#f3f4f6;text-align:left}
.hint{font-size:12px;color:var(--muted)}
.danger{color:#dc2626;font-weight:700}
td.num, th.num{ text-align:right }
#out table td:last-child,#out table th:last-child{overflow-wrap:anywhere;word-break:break-word}
#out table{ table-layout: fixed }
.editable{background:#fffdf5}
.editable:focus{outline:2px solid #fde68a}

/* toast */
.toast-wrap{position:fixed;right:16px;bottom:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.12);max-width:520px;font-size:13px}
.toast b{color:#fca5a5}

/* 不支薪表右上角控制列 */
.pay-tools{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pay-tools .label{color:var(--muted);font-size:12px}

/* PT 每日明細：單日工時>10 顯示紅字 */
.pt-over10{color:#dc2626;font-weight:700}

/* 條列文字彙整樣式（統一字體大小） */
#summaryText{
  font-size:16px;
  font-family:"Segoe UI","微軟正黑體",sans-serif;
  line-height:1.6;
  white-space:pre-wrap;
  margin:0;
}
.summary-box{
  border:1px solid var(--border);
  border-radius:var(--r-md);
  background:#fff;
  padding:12px;
}
.summary-tools{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  flex-wrap:wrap;
}
</style>
</head>
<body>
<div class="wrap">
  <div class="title"><h1>貼上打卡之星匯出的「打卡紀錄」</h1></div>
  <div class="muted">貼上打卡資料後，會依「員工編號」自動判斷 PT 並完成分析。一天工時固定 <b>8 小時</b>（僅供請假/加班換算用）。</div>

  <div class="card" style="margin-top:12px">
    <div class="row">
      <div style="flex:1;min-width:280px">
        <label for="names">PT 姓名（可留空，在員工編號加上 PT，就會被判斷為 PT）</label>
        <input id="names" type="text" placeholder="此欄目前可留空" />
      </div>
    </div>
    <div style="margin-top:12px">
      <label for="raw">打卡紀錄（打卡之星匯出報表，第二個分頁全選複製貼過來）</label>
      <textarea id="raw" placeholder="在這裡貼上原始資料"></textarea>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="run">整理＋計算</button>
      <button id="clear" class="secondary">清空</button>
    </div>
  </div>

  <div id="out" class="card" style="margin-top:12px">
    <div class="hint">尚未輸出。</div>
  </div>
</div>

<div id="toast" class="toast-wrap" aria-live="polite"></div>

<script>
/* ===== 全域錯誤攔截 ===== */
window.addEventListener('error', e => {
  try { toast(`程式錯誤：<b>${e.message}</b>，詳見 Console。`, 8000); } catch(_) { alert(e.message); }
});
window.addEventListener('unhandledrejection', e => {
  try { toast(`非預期錯誤：<b>${(e.reason && e.reason.message) || e.reason}</b>`, 8000); } catch(_) {}
});

(function(){
  const $ = s=>document.querySelector(s);

  /* ===== 參數 ===== */
  const DAY_HRS = 8;
  const PAY_DIV_DAYS = 30;
  const FREE_LATE_COUNT = 3;
  const FREE_LATE_MIN   = 5;
  const COUNT_TYPES = new Set(["漏打卡","非出勤日打卡","其他異常"]);

  // 到/離職判斷（僅用「最早/最晚有出勤」推論，避免誤判：設定門檻才顯示）
  const EMP_HINT_MIN_GAP_DAYS = 7;
  const RESIGN_HINT_MIN_GAP_DAYS = 7;
  const FULL_MONTH_NO_DUTY_MIN_DAYS = 26;

  const HEADERS_DEFAULT = [
    "員工編號","姓名","部門","打卡日期","日期類別","班別","表定上班時間","表定下班時間",
    "休息時間","表定工時","打卡工時","計薪基準工時","上班打卡時間","遲到","下班打卡時間","早退",
    "出勤異常","提早上班原因","上班打卡方式","上班打卡地點","上班地點異常，不在範圍內的原因",
    "延後下班原因","下班打卡方式","下班打卡地點","下班地點異常，不在範圍內的原因",
    "請假時間","請假時數","假別","加班時間","加班時數"
  ];

  /* ===== 綁定按鈕 ===== */
  const btnRun = $("#run");
  if (btnRun) btnRun.addEventListener("click", () => { try { run(); } catch (err){ console.error(err); toast(`執行失敗：<b>${err.message}</b>`, 8000);} });
  else toast('找不到 id="run" 的按鈕', 6000);

  $("#clear").addEventListener("click", ()=>{
    $("#names").value=""; $("#raw").value=""; $("#out").innerHTML='<div class="hint">尚未輸出。</div>';
  });
  $("#names").addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); run(); } });

  /* ===== 主程序 ===== */
  function run(){
    const wantedNames = ($("#names").value||"").trim().split(/[,\s、，]+/).map(s=>s.trim()).filter(Boolean);

    const text = ($("#raw").value||"").trim();
    const out = $("#out");
    if(!text){ out.innerHTML = '<div class="hint">（請先貼上打卡資料）</div>'; return; }

    const {headers, rows, err} = tsvParse(text);
    if(err){ out.innerHTML = `<div style="color:#dc2626">解析失敗：${err}</div>`; return; }

    // 欄位映射
    const H_CODE  = pickHeader(headers,/員工編號|員工代號|員工代碼/,"員工編號");
    const H_DATE  = pickHeader(headers,/打卡日期/,"打卡日期");
    const H_NAME  = pickHeader(headers,/姓名/,"姓名");
    const H_BRANCH= pickHeader(headers,/分校|部門/,"部門");
    const H_LEAVE_H    = pickHeader(headers,/請假時數/,"請假時數");
    const H_LEAVE_KIND = pickHeader(headers,/假別/,"假別");
    const H_OT_H     = pickHeader(headers,/^(加班時數|加班工時)$/,"加班時數");
    const H_ABN   = pickHeader(headers,/出勤異常/,"出勤異常");
    const H_IN    = pickHeader(headers,/上班打卡時間/,"上班打卡時間");
    const H_OUT   = pickHeader(headers,/下班打卡時間/,"下班打卡時間");
    const H_PAY_BASE = pickHeader(headers,/計薪基準工時|計薪基本工時/,"計薪基準工時");

    const aggMap   = new Map();    // ym|branch|name|type -> rec
    const workAgg  = new Map();    // ym|branch|name -> {hours, detail:[], detailRich:[]}
    const dutyAgg  = new Map();    // ym|name -> {ym,name,days:Map(md->{hours,hasMissing,dow})}
    const sickDateMap = new Map(); // ym|branch|name -> Set(md)
    const missingPairs = [];
    const allCombos = new Set();
    const personTypeMap = new Map(); // branch|name -> {isPT:boolean}
    const activeSpanMap = new Map(); // ym|branch|name -> {first:Date,last:Date}

    // 掃描資料
    rows.forEach(r=>{
      const dateStr = (r[H_DATE]||"").trim();
      const ym = toYM(dateStr);
      const md = toMD(dateStr);
      const dateObj = parseYMD(dateStr);
      const dow = dateObj ? dateObj.getDay() : null;

      const codeRaw = (r[H_CODE]||"").trim();
      const empCode = codeRaw.toUpperCase();
      const name = (r[H_NAME]||"").trim();
      const branch = (r[H_BRANCH]||"").trim();
      const abn = (r[H_ABN]||"").trim();
      const payBaseRaw = (r[H_PAY_BASE] || "").trim();

      // 抓出當天遲到/早退分鐘（從出勤異常欄位解析）
      const rowLateMin  = (() => {
        const ms = String(abn||"").match(/遲到\s*(\d+)\s*分/g) || [];
        return ms.reduce((sum, s) => sum + (Number((s.match(/(\d+)/)||[])[1]) || 0), 0);
      })();
      const rowEarlyMin = (() => {
        const ms = String(abn||"").match(/早退\s*(\d+)\s*分/g) || [];
        return ms.reduce((sum, s) => sum + (Number((s.match(/(\d+)/)||[])[1]) || 0), 0);
      })();

      if(!ym || !name) return;

      const isPT = /PT/i.test(empCode) || wantedNames.includes(name);
      const personKey = `${branch}|${name}`;
      const existing = personTypeMap.get(personKey);
      if (existing) existing.isPT = existing.isPT || isPT;
      else personTypeMap.set(personKey,{isPT});

      allCombos.add(`${ym}|${branch}|${name}`);

      const hasForgetForm = /時間由忘打卡單建立/.test(abn||"");
      const otFromHoursCol = hhmmToHours(r[H_OT_H]);

      const inMin  = parseHM(String(r[H_IN]||""));
      const outMin = parseHM(String(r[H_OUT]||""));

      // === 成對打卡 ===
      if (inMin!=null && outMin!=null){
        const inAdj  = Math.ceil(inMin/30)*30;
        const outAdj = Math.floor(outMin/30)*30;

        let diff = outAdj - inAdj;
        if (diff < 0) diff += 24*60;

        const durMins = Math.max(0, diff);
        const durHrs  = durMins/60;

        let workHrs = 0;
        let workDetail = "";
        let workDetailRich = null;

        if (isPT && payBaseRaw && payBaseRaw !== "19:59:00"){
          const baseHrs = hhmmToHours(payBaseRaw);
          if (baseHrs > 0){
            workHrs = baseHrs;
            workDetail = `${md} ${fmtHours(baseHrs)}`;
            workDetailRich = { md, hours: baseHrs, lateMin: rowLateMin, earlyMin: rowEarlyMin };
          }
        }else if (durHrs > 0){
          workHrs = durHrs;
          workDetail = `${md} ${fmtHours(durHrs)}`;
          workDetailRich = { md, hours: durHrs, lateMin: rowLateMin, earlyMin: rowEarlyMin };
        }

        if (workHrs > 0){
          const k = `${ym}|${branch}|${name}`;
          const rec = workAgg.get(k) || {ym, branch, name, hours:0, detail:[], detailRich:[] };
          rec.hours += workHrs;
          rec.detail.push(workDetail);
          if (workDetailRich) rec.detailRich.push(workDetailRich);
          workAgg.set(k, rec);

          if (dateObj){
            const sp = activeSpanMap.get(k) || {first:null,last:null};
            if (!sp.first || dateObj < sp.first) sp.first = dateObj;
            if (!sp.last  || dateObj > sp.last)  sp.last  = dateObj;
            activeSpanMap.set(k, sp);
          }
        }

        if (durHrs > 0 && (dow===6 || dow===0) && otFromHoursCol===0 && !isPT){
          addDutyDay(dutyAgg, ym, name, md, dow, {hours:durHrs});
        }

      // === 未成對打卡 ===
      }else if ((inMin==null) !== (outMin==null)){
        const which = (inMin==null) ? "缺上班" : "缺下班";
        missingPairs.push({
          ym,branch,name,md,which,
          rawIn:String(r[H_IN]||"—"),
          rawOut:String(r[H_OUT]||"—"),
          hasForm: hasForgetForm
        });

        if ((dow===6 || dow===0) && !isPT){
          addDutyDay(dutyAgg, ym, name, md, dow, {missing:true});
        }

        if (!hasForgetForm){
          if (!/漏打卡|未打卡/.test(abn||"")){
            addAgg(aggMap, ym, branch, name, "漏打卡", {miss:1}, `${md}(未補單)`);
          }
        }
      }

      // ===== 請假 =====
      const leaveKind = (r[H_LEAVE_KIND]||"").replace(/\s/g,"");
      const leaveH = hhmmToHours(r[H_LEAVE_H]);
      if(leaveKind && leaveKind!=="--" && leaveH>0){
        addAgg(aggMap, ym, branch, name, leaveKind, leaveH, `${md} ${fmtHours(leaveH)}`);
      }

      // 病假影響全勤：記錄「日期」
      if ((leaveKind === "病假" || leaveKind === "有薪病假") && leaveH > 0) {
        const key = `${ym}|${branch}|${name}`;
        const set = sickDateMap.get(key) || new Set();
        set.add(md);
        sickDateMap.set(key, set);
      }

      // ===== 加班（只統計加班時數欄位）=====
      if (otFromHoursCol > 0) {
        addAgg(aggMap, ym, branch, name, "加班", otFromHoursCol, `${md} ${fmtHours(otFromHoursCol)}`);
      }

      // ===== 出勤異常 =====
      if (abn && abn!=="--"){
        const parts = String(abn).split(/、/).map(s=>s.trim()).filter(Boolean);
        parts.forEach(p=>{
          let m = p.match(/遲到\s*(\d+)\s*分/);
          if (m){
            const mins=+m[1];
            const typ=/不扣/.test(p)?"遲到(不扣)":"遲到(要扣)";
            addAgg(aggMap, ym, branch, name, typ, {mins,cnt:1}, `${md} ${mins}分鐘`, true);
            return;
          }
          m = p.match(/早退\s*(\d+)\s*分/);
          if (m){ const mins=+m[1]; addAgg(aggMap, ym, branch, name, "早退",{mins,cnt:1}, `${md} ${mins}分鐘`, true); return; }
          m = p.match(/曠職\s*(\d+)\s*分/);
          if (m){ const mins=+m[1]; addAgg(aggMap, ym, branch, name, "曠職",{mins,cnt:1}, `${md} ${mins}分鐘`, true); return; }

          const timesM = p.match(/(\d+)\s*次/);
          let totalTimes = timesM ? Number(timesM[1]) : 0;
          const upMiss   = (p.match(/上班未打卡/gi)||[]).length;
          const downMiss = (p.match(/下班未打卡/gi)||[]).length;
          const plainMiss= (!upMiss && !downMiss) ? (p.match(/漏打卡/gi)||[]).length : 0;
          if (!timesM) totalTimes = upMiss + downMiss + plainMiss;

          if (totalTimes>0){
            for(let i=0;i<upMiss;i++)   addAgg(aggMap, ym, branch, name, "漏打卡",{miss:1}, `${md} 上班`, true);
            for(let i=0;i<downMiss;i++) addAgg(aggMap, ym, branch, name, "漏打卡",{miss:1}, `${md} 下班`, true);
            for(let i=0;i<Math.max(0,totalTimes-upMiss-downMiss);i++)
              addAgg(aggMap, ym, branch, name, "漏打卡",{miss:1}, `${md}`, true);
            return;
          }

          if (/時間由忘打卡單建立/.test(p)){
            const when = /上班/.test(p) ? "上班" : (/下班/.test(p) ? "下班" : "");
            addAgg(aggMap, ym, branch, name, "補打卡單",{cnt:1}, `${md} ${when}`, true);
            return;
          }

          if (p && p!=="--" && !/非出勤日打卡/.test(p)){
            addAgg(aggMap, ym, branch, name, "其他異常",{cnt:1}, `${md} ${p}`, true);
          }
        });
      }
    }); // foreach rows

    // 遲到免扣（<=5 分鐘取最多 3 筆）
    for (const [key, rec] of aggMap.entries()){
      const [ym, branch, name, typ] = key.split("|");
      if (typ==="遲到(要扣)" && Array.isArray(rec._lateEvents) && rec._lateEvents.length){
        const cands = rec._lateEvents.filter(e=>e.mins>0 && e.mins<=FREE_LATE_MIN)
                                     .sort((a,b)=> (b.mins-a.mins) || a.detail.localeCompare(b.detail));
        const waived = cands.slice(0, FREE_LATE_COUNT);
        const set = new Set(waived.map(e=>e.detail));
        let mSum=0,cnt=0;
        waived.forEach(e=>{
          mSum+=e.mins; cnt++;
          addAgg(aggMap, ym, branch, name, "遲到(不扣)", {mins:e.mins,cnt:1}, `${e.detail}（免扣）`, true);
        });
        rec.totalMins=Math.max(0,rec.totalMins-mSum);
        rec.count=Math.max(0,rec.count-cnt);
        rec.detail=rec.detail.filter(d=>!set.has(d));
        aggMap.set(key,rec);
      }
    }

    // 主表輸出
    const rowsOut = [];
    for (const [key, val] of aggMap.entries()){
      const [ym, branch, name, typ] = key.split("|");
      let subtotal="", remark="";

      if (COUNT_TYPES.has(typ)){
        if ((val.count||0)===0) continue;
        subtotal=`${val.count} 次`; remark=val.detail.join("、");
        rowsOut.push([ym,branch,name,typ,subtotal,remark]); continue;
      }

      if (/^(?:遲到|早退|曠職)/.test(typ)){
        if ((val.totalMins||0)===0 && (val.count||0)===0) continue;
        subtotal=`${val.totalMins} 分鐘（${val.count} 次）`;
        remark=val.detail.join("、");
        rowsOut.push([ym,branch,name,typ,subtotal,remark]); continue;
      }

      const hours = Number(val.totalHours||0);
      if (hours===0) continue;
      subtotal = fmtHours(hours);
      remark   = val.detail.join("、");
      rowsOut.push([ym,branch,name,typ,subtotal,remark]);
    }
    rowsOut.sort((a,b)=> a[0].localeCompare(b[0]) || a[1].localeCompare(b[1]) || a[2].localeCompare(b[2]) || a[3].localeCompare(b[3]));

    // 取得本月（最新年月）
    const ymsAll = new Set([...allCombos].map(k=>k.split("|")[0]).filter(Boolean));
    const latestYM = [...ymsAll].sort().pop();

    /* ===== 條列文字彙整 ===== */
    const summaryText = buildPeopleSummaryText({
      allCombos, aggMap, workAgg, personTypeMap, missingPairs,
      COUNT_TYPES, FREE_LATE_COUNT
    });

    /* ===== 畫面輸出 ===== */
    let html = "";

    // 主表（換人換色）
    const headerRow = ["年月","分校","姓名","假別/類型","小計","備註"];
    const thead = `<thead><tr>${
      headerRow.map((h,i)=>`<th${i===4?' class="num"':''}>${h}</th>`).join("")
    }</tr></thead>`;

    let lastPerson = '';
    let alt = false;
    const tbody = `<tbody>${
      rowsOut.map(r=>{
        const name = r[2];
        if (name !== lastPerson) { alt = !alt; lastPerson = name; }
        const bg = alt ? '#fafafa' : '#ffffff';
        const tds = r.map((c,i)=>{
          const isDanger = (i===3 && /^(早退|曠職)$/.test(String(c)));
          const isNum = (i===4);
          const cls = [isDanger?'danger':'', isNum?'num':''].filter(Boolean).join(' ');

          let cellHTML = "";
          if (i === 5 && r[3] === "漏打卡" && c){
            const esc = escapeHtml(c);
            cellHTML = esc.replace(/\(未補單\)/g, '<span style="color:#dc2626;font-weight:700">(未補單)</span>');
          }else{
            cellHTML = escapeHtml(c);
          }
          return `<td${cls?` class="${cls}"`:''}>${cellHTML}</td>`;
        }).join('');
        return `<tr style="background:${bg}">${tds}</tr>`;
      }).join("")
    }</tbody>`;

    const colgroupMain = `<colgroup>
      <col style="width:var(--w-ym)">
      <col style="width:var(--w-branch)">
      <col style="width:var(--w-name)">
      <col style="width:var(--w-type)">
      <col style="width:var(--w-subtotal)">
      <col style="width:auto">
    </colgroup>`;

    html += `<div class="hint" style="margin-bottom:8px">
      共 ${rowsOut.length} 列，
      <button id="copyCandyHTML" class="pill">複製給 CANDY 表格</button>
      可貼回 Google Sheet。
    </div>
    <div style="overflow-x:auto;overflow-y:hidden;max-width:100%">
      <table data-kind="main">${colgroupMain}${thead}${tbody}</table>
    </div>`;

    // ===== PT 工時（自動判斷誰是 PT）=====
    if (latestYM){
      const list = [...workAgg.values()].filter(r=>r.ym===latestYM);
      const baseList = list.filter(r=>{
        const info = personTypeMap.get(`${r.branch}|${r.name}`);
        return info && info.isPT;
      });

      // 缺成對提醒
      const missByPerson = new Map();
      missingPairs.filter(m=>m.ym===latestYM).forEach(m=>{
        const k = `${m.branch}|${m.name}`;
        const arr = missByPerson.get(k)||[];
        arr.push(m.md+" "+m.which);
        missByPerson.set(k,arr);
      });
      baseList.forEach(x=>{
        const key = `${x.branch}|${x.name}`;
        const warns = missByPerson.get(key)||[];
        if (warns.length) x.detail.push(`⚠️ 缺成對 ${warns.length} 筆：${warns.join("、")}`);
      });

      if (baseList.length > 0){
        const ptRows = [...baseList].sort((a,b)=> a.branch.localeCompare(b.branch)||a.name.localeCompare(b.name));

        const headerPT = ["年月","分校","姓名","本月工時","每日明細"];
        const theadPT = `<thead><tr>${
          headerPT.map((h,i)=>`<th${i===3?' class="num"':''}>${h}</th>`).join("")
        }</tr></thead>`;

        const formatPtDetailHTML = (rec)=>{
          const rich = Array.isArray(rec.detailRich) ? rec.detailRich : [];
          if (!rich.length) return escapeHtml(rec.detail.join("、"));

          const parts = rich.map(d=>{
            const baseTxt = `${d.md} ${fmtHoursNum(d.hours)} 小時`;
            const late = Number(d.lateMin || 0);
            const early = Number(d.earlyMin || 0);

            let tail = "";
            if (late > 0 || early > 0){
              const tags = [];
              if (late > 0) tags.push(`遲到${late}分鐘`);
              if (early > 0) tags.push(`早退${early}分鐘`);
              tail = `（${tags.join("、")}）`;
            }

            const txt = baseTxt + tail;
            if (Number(d.hours) > 10){
              return `<span class="pt-over10">${escapeHtml(txt)}</span>`;
            }
            return escapeHtml(txt);
          });

          const extras = (rec.detail || []).filter(s => /^⚠️/.test(String(s)));
          if (extras.length){
            return parts.join("、") + "、" + extras.map(escapeHtml).join("、");
          }
          return parts.join("、");
        };

        const tbodyPT = `<tbody>${
          ptRows.map(r=>`<tr>
            <td>${escapeHtml(r.ym)}</td>
            <td>${escapeHtml(r.branch)}</td>
            <td>${escapeHtml(r.name)}</td>
            <td class="num">${escapeHtml(fmtHoursNum(r.hours))}</td>
            <td>${formatPtDetailHTML(r)}</td>
          </tr>`).join("")
        }</tbody>`;

        const colgroupPT = `<colgroup>
          <col style="width:var(--w-ym)">
          <col style="width:var(--w-branch)">
          <col style="width:var(--w-name)">
          <col style="width:var(--w-subtotal)">
          <col style="width:auto">
        </colgroup>`;

        html += `<div class="hint" style="margin:16px 0 8px">
          本月（${escapeHtml(latestYM||"—")}）PT 工時彙總，共 ${ptRows.length} 筆
          <button id="copyPTOnlyHTML" class="pill" style="margin-left:8px">複製 PT 工時彙總</button>
        </div>
        <div style="overflow-x:auto;overflow-y:hidden;max-width:100%">
          <table data-kind="pt">${colgroupPT}${theadPT}${tbodyPT}</table>
        </div>`;
      }
    }

    /* ===== 不支薪明細表（PT 不出現；移除「全勤?」欄） ===== */
    if (latestYM){
      const getHours = (ym, branch, name, typ) => {
        const rec = aggMap.get(`${ym}|${branch}|${name}|${typ}`);
        return rec ? Number(rec.totalHours||0) : 0;
      };
      const getLateMins = (ym, branch, name) => {
        const rec = aggMap.get(`${ym}|${branch}|${name}|遲到(要扣)`);
        return rec ? Number(rec.totalMins || 0) : 0;
      };
      const getMissCount = (ym, branch, name) => {
        const rec = aggMap.get(`${ym}|${branch}|${name}|漏打卡`);
        return rec ? Number(rec.count || 0) : 0;
      };

      const everyoneThisMonth = [...new Set(
        [...allCombos].map(k=>k.split("|"))
          .filter(([ym])=>ym===latestYM)
          .map(([ym,branch,name])=>`${branch}|${name}`)
      )];

      const ymObj = parseYM(latestYM);
      const monthStart = ymObj ? new Date(ymObj.y, ymObj.m-1, 1) : null;
      const monthEnd = ymObj ? new Date(ymObj.y, ymObj.m, 0) : null;
      const monthDays = (monthStart && monthEnd) ? (Math.round((monthEnd - monthStart)/(24*3600*1000)) + 1) : 30;

      const rowsPay = [];
      for (const key of everyoneThisMonth) {
        const [branch, name] = key.split("|");
        const typeInfo = personTypeMap.get(`${branch}|${name}`) || {};
        const isPTPerson = !!typeInfo.isPT;
        if (isPTPerson) continue;

        const hLeave      = getHours(latestYM,branch,name,"事假");
        const hCare       = getHours(latestYM,branch,name,"家庭照顧假");
        const hSick       = getHours(latestYM,branch,name,"病假");
        const hPaidSick   = getHours(latestYM,branch,name,"有薪病假");
        const sickDays    = (sickDateMap.get(`${latestYM}|${branch}|${name}`)?.size || 0);
        const hMenstrual  = getHours(latestYM,branch,name,"生理假");
        const lateMin     = getLateMins(latestYM,branch,name);
        const missCount   = getMissCount(latestYM,branch,name);

        const parts = [];
        if (hLeave)     parts.push(`事假 ${fmtHoursNum(hLeave)}小時`);
        if (hCare)      parts.push(`家庭照顧假 ${fmtHoursNum(hCare)}小時`);
        if (hSick)      parts.push(`病假 ${fmtHoursNum(hSick)}小時（半薪，影響全勤 ${sickDays} 天）`);
        if (hPaidSick)  parts.push(`有薪病假 ${fmtHoursNum(hPaidSick)}小時（半薪）`);
        if (hMenstrual) parts.push(`生理假 ${fmtHoursNum(hMenstrual)}小時（半薪）`);
        if (lateMin)    parts.push(`遲到 ${lateMin}分`);
        if (missCount)  parts.push(`漏打卡 ${missCount}次`);

        const spanKey = `${latestYM}|${branch}|${name}`;
        const sp = activeSpanMap.get(spanKey) || {first:null,last:null};
        let statusTag = "";

        if (monthStart && monthEnd){
          if (!sp.first && !sp.last){
            if (monthDays >= FULL_MONTH_NO_DUTY_MIN_DAYS){
              statusTag = "本月未出勤";
            }
          }else{
            const gapFromStart = sp.first ? diffDays(sp.first, monthStart) : 0;
            if (sp.first && gapFromStart >= EMP_HINT_MIN_GAP_DAYS){
              statusTag = `${fmtMD(sp.first)}前沒出勤`;
            }
            const gapToEnd = sp.last ? diffDays(monthEnd, sp.last) : 0;
            if (sp.last && gapToEnd >= RESIGN_HINT_MIN_GAP_DAYS){
              const tag2 = `${fmtMD(sp.last)}後沒出勤`;
              statusTag = statusTag ? `${statusTag}；${tag2}` : tag2;
            }
          }
        }

        const infoText = (parts.join("、") || "—") + (statusTag ? `｜${statusTag}` : "");

        rowsPay.push({
          name,
          info: infoText,
          hLeave,hCare,hSick,hPaidSick,hMenstrual,lateMin,
          sickDays,
          missCount,
          isPT: isPTPerson
        });
      }

      if (rowsPay.length){
        const headerPay = [
          "姓名","本薪","全勤金額","各種不支薪假別天數/時數(含遲到要扣)",
          "不支薪明細 不支薪總額","特休折現（天）","特休折現（時）","特休折現明細 折現總額"
        ];

        const colPay = `<colgroup>
          <col style="width:var(--w-nopay-name)">
          <col style="width:var(--w-nopay-salary)">
          <col style="width:var(--w-nopay-att)">
          <col style="width:var(--w-nopay-info)">
          <col style="width:var(--w-nopay-detail)">
          <col style="width:var(--w-cash-day)">
          <col style="width:var(--w-cash-hour)">
          <col style="width:var(--w-cash-detail)">
        </colgroup>`;

        const theadPay = `<thead><tr>${headerPay.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
        const tbodyPay = `<tbody>${
          rowsPay.map(r=>`<tr
              data-hleave="${r.hLeave||0}"
              data-hcare="${r.hCare||0}"
              data-hsick="${r.hSick||0}"
              data-hpaidsick="${r.hPaidSick||0}"
              data-hmenstrual="${r.hMenstrual||0}"
              data-late="${r.lateMin||0}"
              data-sickdays="${r.sickDays||0}"
              data-miss="${r.missCount||0}"
              data-ispt="0">
            <td>${escapeHtml(r.name)}</td>
            <td contenteditable="plaintext-only" class="editable" data-col="salary" title="輸入月薪"></td>
            <td contenteditable="plaintext-only" class="editable" data-col="attendanceBonus" title="輸入全勤金額（例如 1000 或 2000）"></td>
            <td>${escapeHtml(r.info)}</td>
            <td class="breakdown" data-col="nopayDetail" contenteditable="false"></td>
            <td contenteditable="plaintext-only" class="editable" data-col="cashDay" title="輸入折現天數（可小數，例如 1.5）"></td>
            <td contenteditable="plaintext-only" class="editable" data-col="cashHour" title="輸入折現小時（可小數，例如 3.5）"></td>
            <td class="breakdown" data-col="cashDetail" contenteditable="false"></td>
          </tr>`).join("")
        }</tbody>`;

        html += `
          <div class="hint" style="margin:16px 0 8px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
            <div>
              不支薪明細表（${escapeHtml(latestYM)}）
              <button id="copyPTNoPayHTML" class="pill" style="margin-left:8px">複製 PT 時數彙總＋不支薪表格</button>
            </div>
            <div class="pay-tools">
              <span class="label">全勤金額一鍵填入：</span>
              <button id="fillAtt1000" class="pill">1000</button>
              <button id="fillAtt2000" class="pill">2000</button>
            </div>
          </div>
          <div style="overflow-x:auto;overflow-y:hidden;max-width:100%">
            <table id="noPayTable">${colPay}${theadPay}${tbodyPay}</table>
          </div>`;
      }
    }

    /* ===== 主管用：值班檢查表 ===== */
    if (latestYM){
      const dutyList = [...dutyAgg.values()].filter(r=>r.ym===latestYM);
      if (dutyList.length){
        const headerD = ["姓名","值班次數","值班日期與時數"];
        const theadD = `<thead><tr>${headerD.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;

        const colgroupD = `<colgroup>
          <col style="width:var(--w-name)">
          <col style="width:80px">
          <col style="width:auto">
        </colgroup>`;

        const tbodyD = `<tbody>${
          dutyList
            .sort((a,b)=> a.name.localeCompare(b.name))
            .map(r=>{
              const entries = [...r.days.entries()];
              entries.sort((a,b)=>{
                const pa = parseMDKey(a[0]);
                const pb = parseMDKey(b[0]);
                return pa.m - pb.m || pa.d - pb.d;
              });
              const parts = entries.map(([md,info])=>{
                let txt = md + weekdayLabel(info.dow);
                if (info.hours>0) txt += ` ${fmtHoursNum(info.hours)}小時`;
                if (info.hasMissing && info.hours===0) txt += "未成對";
                else if (info.hasMissing && info.hours>0) txt += "（部分未成對）";
                return txt;
              });
              const dutyCount = entries.length;

              return `<tr>
                <td>${escapeHtml(r.name)}</td>
                <td class="num">${escapeHtml(String(dutyCount))}</td>
                <td>${escapeHtml(parts.join("  "))}</td>
              </tr>`;
            }).join("")
        }</tbody>`;

        html += `
          <div class="hint" style="margin:16px 0 8px">
            值班檢查表（${escapeHtml(latestYM)}，統計週六與週日，含未成對視為有值班；PT 不列入）
            <button id="copyDutyHTML" class="pill" style="margin-left:8px">複製值班檢查表</button>
          </div>
          <div style="overflow-x:auto;overflow-y:hidden;max-width:100%">
            <table data-kind="duty">${colgroupD}${theadD}${tbodyD}</table>
          </div>
        `;
      }
    }

    /* ===== 條列文字彙整區塊 ===== */
    html += `
      <div class="hint" style="margin:16px 0 8px">條列文字彙整（依月份分段、每人一段）</div>
      <div class="summary-tools" style="margin-bottom:8px">
        <div class="hint">可直接複製貼到 LINE / Email / 總表備註欄。</div>
        <button id="copySummaryText" class="pill">複製條列文字</button>
      </div>
      <div class="summary-box">
        <pre id="summaryText"></pre>
      </div>
    `;

    out.innerHTML = html;

    // 填入文字
    const pre = document.getElementById("summaryText");
    if (pre) pre.textContent = summaryText || "無異常紀錄";

    /* ===== 綁定：複製 ===== */
    document.querySelector("#out #copyCandyHTML")?.addEventListener("click", ()=>{
      const tableEl = document.querySelector('#out table[data-kind="main"]');
      if (!tableEl) return toast("找不到給Candy的表", 3000);
      selectAndCopyNode(tableEl, '✅ 已複製給Candy的表（相容模式）！');
    });

    document.querySelector("#out #copyPTNoPayHTML")?.addEventListener("click", ()=>{
      const ptTable = document.querySelector('#out table[data-kind="pt"]');
      const npTable = document.querySelector('#noPayTable');
      if (!ptTable && !npTable) return toast("找不到 PT 或 不支薪 表格", 3000);

      const tmp = document.createElement('div');
      tmp.style.cssText = 'position:fixed; left:-9999px; top:0; pointer-events:none;';
      const wrap = document.createElement('div');

      if (ptTable) {
        const title = document.createElement('div');
        title.style.margin = '6px 0';
        title.style.fontWeight = '700';
        title.textContent = '【PT 工時彙總】';
        wrap.appendChild(title);
        wrap.appendChild(ptTable.cloneNode(true));
      }

      if (npTable) {
        const spacer = document.createElement('div');
        spacer.style.height = '12px';
        wrap.appendChild(spacer);

        const title = document.createElement('div');
        title.style.margin = '12px 0 6px';
        title.style.fontWeight = '700';
        title.textContent = '【不支薪明細表】';
        wrap.appendChild(title);
        wrap.appendChild(npTable.cloneNode(true));
      }

      tmp.appendChild(wrap);
      document.body.appendChild(tmp);
      selectAndCopyNode(wrap, '✅ 已複製 PT 時數彙總＋不支薪表格（相容模式）！');
      document.body.removeChild(tmp);
    });

    document.querySelector("#out #copyPTOnlyHTML")?.addEventListener("click", ()=>{
      const ptTable = document.querySelector('#out table[data-kind="pt"]');
      if (!ptTable) return toast("找不到 PT 工時彙總表", 3000);
      selectAndCopyNode(ptTable, '✅ 已複製 PT 工時彙總表！');
    });

    document.querySelector("#out #copyDutyHTML")?.addEventListener("click", ()=>{
      const tableEl = document.querySelector('#out table[data-kind="duty"]');
      if (!tableEl) return toast("找不到值班檢查表", 3000);
      selectAndCopyNode(tableEl, '✅ 已複製值班檢查表！');
    });

    document.querySelector("#out #copySummaryText")?.addEventListener("click", async ()=>{
      const txt = document.getElementById("summaryText")?.textContent || "";
      if (!txt.trim()) return toast("沒有可複製的文字", 2500);

      try{
        if (navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(txt);
          toast("✅ 已複製條列文字！", 2500);
          return;
        }
      }catch(_){}

      const ta = document.createElement("textarea");
      ta.value = txt;
      ta.style.cssText = "position:fixed;left:-9999px;top:0;opacity:0;";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      let ok=false;
      try{ ok=document.execCommand("copy"); }catch(_){}
      document.body.removeChild(ta);
      toast(ok ? "✅ 已複製條列文字！" : "❌ 複製失敗，請手動選取文字再複製。", 3000);
    });

    /* ===== 一鍵填入全勤金額 ===== */
    document.querySelector("#fillAtt1000")?.addEventListener("click", ()=> fillAttendanceAll(1000));
    document.querySelector("#fillAtt2000")?.addEventListener("click", ()=> fillAttendanceAll(2000));

    function fillAttendanceAll(val){
      const table = document.querySelector("#noPayTable");
      if (!table) return;

      let filled = 0;
      table.querySelectorAll('tr').forEach(tr=>{
        const td = tr.querySelector('[data-col="attendanceBonus"]');
        if (!td) return;
        td.innerText = String(val);
        td.dispatchEvent(new Event('input', {bubbles:true}));
        filled++;
      });

      toast(`✅ 已一鍵填入全勤金額 ${val}（套用 ${filled} 筆）`, 3000);
    }

    /* ===== 不支薪：計算 & 折現：計算 ===== */
    const table = document.querySelector("#noPayTable");
    if (table){
      const hourly   = salary => salary / (PAY_DIV_DAYS * DAY_HRS);
      const perMin   = salary => hourly(salary) / 60;

      table.addEventListener("input", (e)=>{
        const td = e.target.closest('[data-col]');
        if (!td) return;

        const tr = td.parentElement;

        const salary = parseMoney(tr.querySelector('[data-col="salary"]')?.innerText || "");
        const attendanceBonus = parseMoney(tr.querySelector('[data-col="attendanceBonus"]')?.innerText || "");
        const cashDay = toNumber(tr.querySelector('[data-col="cashDay"]')?.innerText || "");
        const cashHour= toNumber(tr.querySelector('[data-col="cashHour"]')?.innerText || "");

        const hLeave     = Number(tr.dataset.hleave||0);
        const hCare      = Number(tr.dataset.hcare||0);
        const hSick      = Number(tr.dataset.hsick||0);
        const hPaidSick  = Number(tr.dataset.hpaidsick||0);
        const hMenstrual = Number(tr.dataset.hmenstrual||0);
        const late       = Number(tr.dataset.late||0);
        const sickDays   = Number(tr.dataset.sickdays || 0);
        const missCount  = Number(tr.dataset.miss || 0);
        const isPT       = Number(tr.dataset.ispt || 0) === 1;

        const cellNP   = tr.querySelector('[data-col="nopayDetail"]');
        const cellCash = tr.querySelector('[data-col="cashDetail"]');
        if (!cellNP || !cellCash) return;

        const hardReasons = [];
        if (!isPT){
          if (hLeave > 0) hardReasons.push("事假");
          if (late > 0) hardReasons.push("遲到要扣");
          if (missCount > 3) hardReasons.push("漏打卡>3次");
        }

        const hardLoss = (!isPT && hardReasons.length > 0);
        const sickLoss = (!isPT && !hardLoss && sickDays > 0);

        let rawAttendance = 0;
        let attendanceLine = "";
        let attendanceWarn = "";

        if (!isPT && hardLoss){
          if (attendanceBonus > 0){
            rawAttendance = attendanceBonus;
            attendanceLine = `➖全勤 ${formatMoney(attendanceBonus)}元（原因：${hardReasons.join("、")}）`;
          }else{
            attendanceWarn = `⚠️ 全勤會全扣（請填全勤金額）`;
          }
        }else if (!isPT && sickLoss){
          if (attendanceBonus > 0){
            rawAttendance = (attendanceBonus / PAY_DIV_DAYS) * sickDays;
            attendanceLine = `➖全勤（病假） ${sickDays}天 × ${formatMoney(attendanceBonus)}/30 = ${formatMoney(Math.round(rawAttendance))}元`;
          }else{
            attendanceWarn = `⚠️ 全勤會扣（病假影響 ${sickDays}天，請填全勤金額）`;
          }
        }

        const needSalaryParts = (hLeave>0 || hCare>0 || hSick>0 || hPaidSick>0 || hMenstrual>0 || late>0);
        const hasSalary = (salary > 0);

        let rawLeave=0, rawCare=0, rawSick=0, rawPaidSick=0, rawMens=0, rawLate=0;
        let hr=0, pm=0;

        if (hasSalary){
          hr = hourly(salary);
          pm = perMin(salary);

          rawLeave    = hr * hLeave;
          rawCare     = hr * hCare;
          rawSick     = hr * 0.5 * hSick;
          rawPaidSick = hr * 0.5 * hPaidSick;
          rawMens     = hr * 0.5 * hMenstrual;
          rawLate     = pm * late;
        }

        const totalNoPay = Math.floor(
          rawAttendance +
          (hasSalary ? (rawLeave + rawCare + rawSick + rawPaidSick + rawMens + rawLate) : 0)
        );

        const linesNP = [];
        const roundShow = (n)=> formatMoney(Math.round(n));

        if (attendanceLine) linesNP.push(attendanceLine);
        if (attendanceWarn) linesNP.push(attendanceWarn);

        if (hasSalary){
          if (hLeave)     linesNP.push(`➖事假 ${hLeave}時 × ${salary}/30/8 = ${roundShow(rawLeave)}元`);
          if (hCare)      linesNP.push(`➖家庭照顧假 ${hCare}時 × ${salary}/30/8 = ${roundShow(rawCare)}元`);
          if (hSick)      linesNP.push(`➖病假 ${hSick}時 × ${salary}/30/8/2 = ${roundShow(rawSick)}元`);
          if (hPaidSick)  linesNP.push(`➖有薪病假 ${hPaidSick}時 × ${salary}/30/8/2 = ${roundShow(rawPaidSick)}元`);
          if (hMenstrual) linesNP.push(`➖生理假 ${hMenstrual}時 × ${salary}/30/8/2 = ${roundShow(rawMens)}元`);
          if (late)       linesNP.push(`➖遲到 ${late}分 × ${salary}/30/8/60 = ${roundShow(rawLate)}元`);
        }else{
          if (!isPT && needSalaryParts){
            linesNP.push(`⚠️ 尚未填本薪，其餘扣款待計算`);
          }
        }

        linesNP.push(`不支薪金額：${formatMoney(totalNoPay)} 元`);
        cellNP.textContent = linesNP.join("\n");
        cellNP.setAttribute("data-total", String(totalNoPay));

        if (hasSalary){
          const cashFromDays  = (cashDay||0)  * DAY_HRS * hr;
          const cashFromHours = (cashHour||0) * hr;
          const totalCash = Math.ceil(cashFromDays + cashFromHours);

          const linesCash = [];
          if (cashDay)  linesCash.push(`＋折現 ${cashDay}天 × 8時 × ${salary}/30/8 = ${roundShow(cashFromDays)}元`);
          if (cashHour) linesCash.push(`＋折現 ${cashHour}時 × ${salary}/30/8 = ${roundShow(cashFromHours)}元`);
          linesCash.push(`特休折現金額：${formatMoney(totalCash)} 元`);
          cellCash.textContent = linesCash.join("\n");
          cellCash.setAttribute("data-total", String(totalCash));
        }else{
          cellCash.textContent = "";
          cellCash.removeAttribute("data-total");
        }
      });

      table.querySelectorAll('tr').forEach(tr=>{
        tr.querySelector('[data-col="attendanceBonus"]')?.dispatchEvent(new Event('input', {bubbles:true}));
        const salTd = tr.querySelector('[data-col="salary"]');
        if (salTd && salTd.innerText.trim()) salTd.dispatchEvent(new Event('input', {bubbles:true}));
      });
    }

    /* ===== 條列文字彙整：主函式（依你示意順序）===== */
    function buildPeopleSummaryText({allCombos, aggMap, workAgg, personTypeMap, missingPairs, FREE_LATE_COUNT}){
      const DAY_HRS = 8;

      // 多月份分段（通常只有一個月也 OK）
      const yms = [...new Set([...allCombos].map(k => String(k).split("|")[0]).filter(Boolean))].sort();
      if (!yms.length) return "";

      // 縮短明細用字（分鐘→分；小時→時；去掉多餘空格）
      const shortify = (s) => String(s || "")
        .replace(/\s+/g, " ")
        .replace(/分鐘/g, "分")
        .replace(/小時/g, "時")
        .replace(/\s*分/g, "分")
        .replace(/\s*時/g, "時")
        .trim();

      // 8 小時換算「天/小時」
      const toDaysHoursText = (hours) => {
        const h = Number(hours || 0);
        if (!h) return "";
        const hh = Math.round(h * 2) / 2;
        const days = Math.floor(hh / DAY_HRS);
        const rem  = Math.round((hh - days * DAY_HRS) * 2) / 2;
        if (days > 0 && rem > 0) return `${days}天 ${rem}小時`;
        if (days > 0) return `${days}天`;
        return `${rem}小時`;
      };

      const appendBlock = (label, mainText, detailsText, extraWarn="") => {
        if (!mainText && !detailsText && !extraWarn) return "";
        let line = `• ${label}：`;
        if (mainText) line += `${shortify(mainText)}`;
        if (detailsText) line += `${mainText ? " " : ""}${shortify(detailsText)}`;
        if (extraWarn) line += ` ${shortify(extraWarn)}`;
        return line + "\n";
      };

      // 漏打卡明細固定格式（不要括號、不顯示未補單）
      const missFixedFormat = (items) => {
        const out = [];
        for (const raw of (items || [])) {
          const s = String(raw || "").trim();
          if (!s) continue;
          const md = (s.match(/(\d{1,2}\/\d{1,2})/) || [])[1] || "";
          let side = "";
          if (/缺上班/.test(s) || /上班/.test(s)) side = "上班";
          if (/缺下班/.test(s) || /下班/.test(s)) side = "下班";
          if (md && side) out.push(`${md} ${side}`);
          else if (md)    out.push(`${md}`);
          else            out.push(`${s}`);
        }
        return out.join("、");
      };

      // PT 索引：ym|branch|name -> rec
      const ptMap = new Map();
      [...workAgg.values()].forEach(r => ptMap.set(`${r.ym}|${r.branch}|${r.name}`, r));

      // 未成對索引：ym|branch|name -> ["1/31 上班"...]
      const missPairMap = new Map();
      (missingPairs || []).forEach(m => {
        const k = `${m.ym}|${m.branch}|${m.name}`;
        const arr = missPairMap.get(k) || [];
        const side = (m.which === "缺上班") ? "上班" : (m.which === "缺下班" ? "下班" : m.which);
        arr.push(`${m.md} ${side}`);
        missPairMap.set(k, arr);
      });

      // aggMap 快速取用
      const getRec = (ym, branch, name, typ) => aggMap.get(`${ym}|${branch}|${name}|${typ}`);
      const getHours = (ym, branch, name, typ) => Number((getRec(ym,branch,name,typ)?.totalHours)||0);
      const getMins  = (ym, branch, name, typ) => Number((getRec(ym,branch,name,typ)?.totalMins)||0);
      const getCnt   = (ym, branch, name, typ) => Number((getRec(ym,branch,name,typ)?.count)||0);
      const getDetail= (ym, branch, name, typ) => (getRec(ym,branch,name,typ)?.detail)||[];

      // 你指定順序
      const leaveOrder = ["事假","病假","生理假","家庭照顧假","喪假","有薪病假"];

      const lines = [];

      for (const ym of yms){
        lines.push(`【${ym}】`);

        const people = [...new Set(
          [...allCombos].map(k => k.split("|"))
            .filter(([kym]) => kym === ym)
            .map(([kym, branch, name]) => `${branch}|${name}`)
        )].sort((a,b)=>{
          const [ba,na]=a.split("|"), [bb,nb]=b.split("|");
          return ba.localeCompare(bb) || na.localeCompare(nb);
        });

        for (const key of people){
          const [branch, name] = key.split("|");
          const isPT = !!(personTypeMap.get(`${branch}|${name}`)?.isPT);

          // 只顯示姓名（不要分校、不要[PT]）
          lines.push(`${name}`);

          let block = "";

          // 特休/補休
          const vacHours = getHours(ym, branch, name, "特休") + getHours(ym, branch, name, "補休");
          const vacDetails = []
            .concat(getDetail(ym, branch, name, "特休"))
            .concat(getDetail(ym, branch, name, "補休"))
            .filter(Boolean)
            .join("、");
          block += appendBlock("特休/補休", toDaysHoursText(vacHours), vacDetails);

          // 超時（加班）
          const otHours = getHours(ym, branch, name, "加班");
          const otDetails = getDetail(ym, branch, name, "加班").join("、");
          block += appendBlock("超時", otHours ? `${fmtHoursNum(otHours)}小時` : "", otDetails);

          // 全勤緩衝（遲到不扣 + 漏打卡）
          const noDeductMins = getMins(ym, branch, name, "遲到(不扣)");
          const noDeductDetails = getDetail(ym, branch, name, "遲到(不扣)")
            .map(s => String(s || "").replace(/（免扣）/g, ""))
            .join("、");

          // 漏打卡：全部合併，次數 = 明細筆數（你說不用去重）
          const missAggDetails = getDetail(ym, branch, name, "漏打卡");
          const missPairs      = missPairMap.get(`${ym}|${branch}|${name}`) || [];
          const missAllItems   = [].concat(missAggDetails, missPairs);
          const missTimesShown = missAllItems.length;
          const missFixed      = missFixedFormat(missAllItems);

          const bufferParts = [];
          if (noDeductMins > 0) bufferParts.push(`遲到不扣 ${noDeductMins} 分${noDeductDetails ? " " + noDeductDetails : ""}`);
          if (missTimesShown > 0) bufferParts.push(`漏打卡 ${missTimesShown} 次${missFixed ? " " + missFixed : ""}`);

          if (bufferParts.length){
            const bufferEvents = (getDetail(ym, branch, name, "遲到(不扣)").length) + missTimesShown;
            const warn = bufferEvents > 3 ? " ⚠️ 超過 3 次，全勤取消" : "";
            block += `• 全勤緩衝：${shortify(bufferParts.join("，"))}${shortify(warn)}\n`;
          }

          // 遲到（要扣）
          const lateMins = getMins(ym, branch, name, "遲到(要扣)");
          const lateCnt  = getCnt(ym, branch, name, "遲到(要扣)");
          const lateDetails = getDetail(ym, branch, name, "遲到(要扣)").join("、");
          block += appendBlock("遲到", (lateMins || lateCnt) ? `${lateMins}分（${lateCnt}次）` : "", lateDetails);

          // 各假別
          for (const t of leaveOrder){
            const h = getHours(ym, branch, name, t);
            if (!h) continue;
            const det = getDetail(ym, branch, name, t).join("、");
            let warn = "";
            if (t === "生理假" && h > 8) warn = "⚠️ 生理假超過限額！";
            block += appendBlock(t, toDaysHoursText(h), det, warn);
          }

          // 早退 / 曠職
          const earlyMins = getMins(ym, branch, name, "早退");
          const earlyCnt  = getCnt(ym, branch, name, "早退");
          const earlyDet  = getDetail(ym, branch, name, "早退").join("、");
          block += appendBlock("早退", (earlyMins || earlyCnt) ? `${earlyMins}分（${earlyCnt}次）` : "", earlyDet);

          const absMins = getMins(ym, branch, name, "曠職");
          const absCnt  = getCnt(ym, branch, name, "曠職");
          const absDet  = getDetail(ym, branch, name, "曠職").join("、");
          block += appendBlock("曠職", (absMins || absCnt) ? `${absMins}分（${absCnt}次）` : "", absDet);

          // 其他異常（次數）
          const offCnt = getCnt(ym, branch, name, "非出勤日打卡");
          const offDet = getDetail(ym, branch, name, "非出勤日打卡").join("、");
          block += appendBlock("非出勤日打卡", offCnt ? `${offCnt}次` : "", offDet);

          const otherCnt = getCnt(ym, branch, name, "其他異常");
          const otherDet = getDetail(ym, branch, name, "其他異常").join("、");
          block += appendBlock("其他異常", otherCnt ? `${otherCnt}次` : "", otherDet);

          // PT 內容：不在姓名標示 [PT]，但保留內容避免資訊消失
          if (isPT){
            const pt = ptMap.get(`${ym}|${branch}|${name}`);
            if (pt && Number(pt.hours||0) > 0){
              const rich = Array.isArray(pt.detailRich) ? pt.detailRich : [];
              const detailTxt = rich.map(d=>{
                const late = Number(d.lateMin||0);
                const early = Number(d.earlyMin||0);
                const tags = [];
                if (late>0) tags.push(`遲到${late}分`);
                if (early>0) tags.push(`早退${early}分`);
                const tail = tags.length ? `（${tags.join("、")}）` : "";
                return `${d.md} ${fmtHoursNum(d.hours)}小時${tail}`;
              }).join("、");
              block += appendBlock("PT工時", `${fmtHoursNum(pt.hours)}小時`, detailTxt);
            }
          }

          lines.push(block.trim() ? block.trimEnd() : "無異常紀錄");
          lines.push("");
        }

        lines.push("");
      }

      while(lines.length && lines[lines.length-1]==="") lines.pop();
      return lines.join("\n");
    }
  } // end run

  /* ===== 小工具 ===== */
  function pickHeader(headers, pattern, fallback){ return headers.find(h=>pattern.test(h)) || fallback; }

  function tsvParse(text){
    const lines = text.split(/\r?\n/).filter(x => x.trim().length > 0);
    if (!lines.length) return {headers:[], rows:[], err:"空白內容"};
    const hasTab = /\t/.test(lines[0]);
    const splitter = hasTab ? /\t/ : /\s{2,}/;
    const firstCols = lines[0].split(splitter);
    const headerLike = firstCols.some(c => /員工編號|姓名|打卡日期|請假時數|假別|加班時數|出勤異常/.test(c));
    const headers = headerLike ? firstCols.map(h => h.trim()) : HEADERS_DEFAULT.slice();
    const dataLines = headerLike ? lines.slice(1) : lines;
    const rows = dataLines.map(l => {
      const cols = l.split(splitter);
      const o = {}; headers.forEach((h,i) => o[h] = (cols[i] ?? "").trim());
      return o;
    });
    return {headers, rows, err:null};
  }

  function toNumber(v){ const s=String(v??""); if (/[~:]/.test(s)) return 0; const m=s.match(/-?\d+(?:\.\d+)?/); return m?Number(m[0]):0; }
  function hhmmToHours(v){
    const s=String(v||"").trim();
    const m=s.match(/^(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?$/);
    if(!m) return toNumber(s);
    const h=+m[1]||0, min=+m[2]||0, sec=+m[3]||0;
    return h + min/60 + sec/3600;
  }
  function toYM(s){
    const m=String(s).match(/(\d{4})[\/\-](\d{1,2})/);
    return m?`${m[1]}-${String(m[2]).padStart(2,'0')}`:(s||"");
  }
  function parseYM(ym){
    const m = String(ym||"").match(/^(\d{4})-(\d{2})$/);
    if (!m) return null;
    return {y:Number(m[1]), m:Number(m[2])};
  }
  function toMD(s){ const m=String(s).match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/); return m?Number(m[2])+"/"+Number(m[3]):(s||""); }
  function parseHM(s){
    const m=String(s||"").match(/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/);
    if(!m) return null;
    const hh=Math.min(23,Math.max(0,+m[1]||0));
    const mm=Math.min(59,Math.max(0,+m[2]||0));
    return hh*60+mm;
  }
  function parseYMD(s){
    const m = String(s||"").match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
    if (!m) return null;
    const y = +m[1], mo = +m[2]-1, d = +m[3];
    return new Date(y, mo, d);
  }
  function parseMDKey(md){
    const m = String(md||"").match(/(\d{1,2})\/(\d{1,2})/);
    if (!m) return {m:0,d:0};
    return {m:Number(m[1]),d:Number(m[2])};
  }
  function weekdayLabel(dow){
    const map = ["(日)","(一)","(二)","(三)","(四)","(五)","(六)"];
    return (dow!=null && dow>=0 && dow<map.length) ? map[dow] : "";
  }
  function fmtHoursNum(h){ const n=Number(h||0); return (Math.round(n*10)/10).toString(); }
  function fmtHours(h){ return `${fmtHoursNum(h)} 小時`; }
  function fmtMD(d){
    if (!(d instanceof Date)) return "";
    return `${d.getMonth()+1}/${d.getDate()}`;
  }
  function diffDays(a,b){
    const A = new Date(a.getFullYear(), a.getMonth(), a.getDate()).getTime();
    const B = new Date(b.getFullYear(), b.getMonth(), b.getDate()).getTime();
    return Math.round((A - B) / (24*3600*1000));
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
  function formatMoney(n){ return String(Math.floor(Number(n)||0)).replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
  function parseMoney(s){ return Number(String(s).replace(/[,\s]/g,""))||0; }

  // ✅ 這裡是關鍵修正：允許第 7 個參數（舊呼叫模式），但不影響任何功能
  function addAgg(map, ym, branch, name, typ, val, detailStr, _flagIgnored){
    const normalizedTyp = (typ==="補打卡單") ? "漏打卡" : typ;
    const key = `${ym}|${branch}|${name}|${normalizedTyp}`;
    const rec = map.get(key) || { totalHours:0, totalMins:0, count:0, detail:[], _detailSet:new Set(), _lateEvents:[] };
    const isObj = val && typeof val==="object";
    const dkey = (detailStr||"").trim();
    if (dkey && rec._detailSet.has(dkey)){ map.set(key,rec); return; }

    if (typeof val==="number"){
      rec.totalHours += val;
      rec.detail.push(detailStr);
    }else if (isObj){
      if ("mins" in val){
        rec.totalMins += (val.mins||0);
        rec.count += (val.cnt||1);
        rec.detail.push(detailStr);
        if (/^遲到/.test(normalizedTyp)) rec._lateEvents.push({mins:Number(val.mins||0), detail:detailStr});
      }
      if ("miss" in val){ rec.count += (val.miss||1); rec.detail.push(detailStr); }
      if ("cnt" in val && !("mins" in val) && !("miss" in val)){ rec.count += (val.cnt||1); rec.detail.push(detailStr); }
    }
    if (dkey) rec._detailSet.add(dkey);
    map.set(key,rec);
  }

  function addDutyDay(dutyAgg, ym, name, md, dow, opt){
    const key = `${ym}|${name}`;
    const rec = dutyAgg.get(key) || {ym, name, days:new Map()};
    const dayInfo = rec.days.get(md) || {hours:0, hasMissing:false, dow};
    if (opt && opt.hours) dayInfo.hours += opt.hours;
    if (opt && opt.missing) dayInfo.hasMissing = true;
    if (dow != null) dayInfo.dow = dow;
    rec.days.set(md, dayInfo);
    dutyAgg.set(key, rec);
  }

})(); // IIFE

// ==== 相容式複製工具 ====
function selectAndCopyNode(node, okMsg='✅ 已複製！', errMsg='❌ 複製失敗，請手動選取表格再複製。'){
  const range = document.createRange();
  range.selectNode(node);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
  let ok = false;
  try { ok = document.execCommand('copy'); } catch(_) {}
  sel.removeAllRanges();
  toast(ok ? okMsg : errMsg);
}

/* ===== Toast ===== */
function toast(msg, ms=3000){
  const wrap=document.getElementById("toast"); if(!wrap) return;
  const el=document.createElement("div"); el.className="toast"; el.innerHTML=msg;
  el.addEventListener("click",()=>{ el.parentNode && el.parentNode.removeChild(el); });
  wrap.appendChild(el);
  el.style.opacity="0";
  setTimeout(()=>{ el.style.transition="opacity .3s"; el.style.opacity="1"; }, 50);
  const delay=Math.max(300,ms)-300;
  setTimeout(()=>{ if(el.parentNode) el.style.opacity="0"; }, delay);
  setTimeout(()=>{ el.parentNode && el.parentNode.removeChild(el); }, Math.max(300,ms));
}
</script>
</body>
</html>
