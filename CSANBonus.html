<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è¨ˆç®—èª²è¼”å¸¶ç­æ´¥è²¼ æ¸…æ°´ã€æ±Ÿç¿ </title>
  <style>
    /* é€šç”¨æ¨£å¼ */
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      padding: 2em;
      background: #fafafa;
    }
    h1, h2 {
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: center;
      vertical-align: middle;
    }
    th {
      padding: 4px;
    }

    /* è¼¸å…¥æ¡†æ¨£å¼ */
    input[type="number"],
    input[type="text"] {
      width: 3em; /* é è¨­å¯¬åº¦ */
      padding: 0.2em;
      font-size: 1em;
      text-align: center;
      border: 1px solid #bbb;
      border-radius: 3px;
    }
    input[type="number"].rate {
      width: 3.5em;
    }
    input.note {
      width: 8em;
      text-align: left;
    }
    /* ç‰¹å®šè¼¸å…¥æ¡†å¯¬åº¦ */
    .teacher input { width: 6em; }
    .crossSchool input { width: 5em; }
    .persons input { width: 5em; }
    .partialDays input { width: 5em; }
    .rate input { width: 3.5em; }
    .subDays input { width: 3.5em; }
    .subHours input { width: 3.55em; }
    .attend input,
    .camp1 input,
    .camp2 input { width: 5em; }
    /* ç‰¹æ®Šå‚™è¨»æ¬„ä½ä¸­çš„è¼¸å…¥æ¡† */
    td label input { width: 3em; }
    td label input.repeatBonus { width: 4em; }


    /* æŒ‰éˆ•æ¨£å¼ */
    button {
      margin-right: 0.5em;
      margin-top: 0.8em;
      padding: 0.5em 1em;
      font-size: 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #3498db;
      color: white;
    }
    button:hover {
      background-color: #2980b9;
    }

    /* è¡¨æ ¼å€å¡Šæ¨™é¡Œæ¨£å¼ */
    .section-title td {
      background-color: #d6e9ff;
      font-weight: bold;
      text-align: left;
      font-size: 1em;
      padding-left: 0.5em;
    }

    /* è¡¨é ­åˆ†çµ„èƒŒæ™¯è‰² */
    .thead-group-monthly { background-color: white; }
    .thead-group-semester { background-color: #e0f7fa; }
    .thead-group-sub { background-color: #fff3e0; }
    .thead-group-summer { background-color: #f3e5f5; }

    /* è¡¨æ ¼å…§å®¹åˆ—çš„åˆ†çµ„èƒŒæ™¯è‰² (è¼•å¾®è®Šè‰²) */
    #rows tr td.thead-group-semester { background-color: #f1fcfd; }
    #rows tr td.thead-group-sub { background-color: #fff8ee; }
    #rows tr td.thead-group-summer { background-color: #faf3fb; }
    #rows tr td.thead-group-monthly { background-color: #ffffff; }

    /* ç‰¹å®šæ¬„ä½å¯¬åº¦ */
    th.teacher, td .teacher { width: 6em; }
    th.crossSchool, td .crossSchool { width: 5em; }
    th.persons, td .persons { width: 5em; }
    th.fullBonus, td.fullBonus { width: 6em; }
    th.partialDays, td .partialDays { width: 5em; }
    th.partialBonus, td.partialBonus { width: 6em; }
    th.rate, td .rate { width: 3.5em; }
    th.semTotal, td.semTotal { width: 7em; }
    th.subDays, td .subDays { width: 3.5em; }
    th.subHours, td .subHours { width: 3.55em; }
    th.subTotal, td.subTotal { width: 6em; }
    th.attend, td .attend { width: 5em; }
    th.camp1, td .camp1 { width: 5em; }
    th.camp2, td .camp2 { width: 5em; }
    th.vacBonus, td.vacBonus { width: 7em; }
    td.finalBonus {
      min-width: 15em;
      width: 15em;
    }

    /* ç®—å¼èˆ‡å‚™è¨»æ¨£å¼ */
    .finalBonusFormula {
      font-size: 0.8em;
      color: #555;
      text-align: left;
      word-break: break-word;
    }
    .formula-note {
      font-size: 0.8em;
    }
    td.thead-group-monthly label {
      font-size: 0.85em;
    }
  </style>
</head>
<body>
  <h1>è¨ˆç®—èª²è¼”å¸¶ç­æ´¥è²¼ æ¸…æ°´ã€æ±Ÿç¿ </h1>

  <h2>éå¿…å¡«çš„è¨­å®š</h2>
  <label>æœ¬æœˆå·¥ä½œå¤©æ•¸ï¼š
    <input type="number" id="workdays" value="0" min="0" oninput="recalcAll()" />
  </label>
  <label style="margin-left:1em;">å¯’æš‘è²¬ä»»é¡å¤©æ•¸ï¼š
    <input type="number" id="requiredDays" value="0" min="0" oninput="recalcAll()" />
  (æš‘å‡ç”¨17å¤©)
  </label>
  <br />
  <h2>æ‰¹æ¬¡æ–°å¢ç­ç´š/å°å¸«</h2>
<textarea id="batchInput" rows="3" style="width: 100%;" placeholder="è«‹è²¼ä¸Šç©ºæ ¼åˆ†éš”çš„ç­ç´šæˆ–å°å¸«åå­—ï¼Œä¾‹å¦‚ï¼š1A 1B APPLEè€å¸«"></textarea>
<br />
<button onclick="batchAddTeachers()">ğŸ‘¥æ‰¹æ¬¡æ–°å¢ç­ç´š/å°å¸«</button>
<button onclick="addRow()">â•æ–°å¢ç­ç´š/è€å¸«</button>
<button onclick="removeEmptyRows()">ğŸ—‘ï¸åˆªé™¤ç©ºç™½åˆ—</button>
<button onclick="copyNameAndFormula()">ğŸ“è¤‡è£½å°å¸«èˆ‡æ´¥è²¼ç®—å¼</button>
  <button onclick="copyTable()">ğŸ“‹è¤‡è£½æ•´å¼µè¡¨æ ¼</button>
  <button onclick="exportCSV()">ğŸ’¾åŒ¯å‡ºCSVæª”æ¡ˆ</button>

  <table id="dataTable" role="grid" aria-label="æ•™å¸«æ´¥è²¼è¨ˆç®—è¡¨">
    <thead>
      <tr>
        <th class="thead-group-monthly">å°å¸«</th>
        <th class="thead-group-semester">æ˜¯å¦è·¨æ ¡</th>
        <th class="thead-group-semester">å…¨æœˆäººæ•¸</th>
        <th class="thead-group-semester">å…¨æœˆæ´¥è²¼</th>
        <th class="thead-group-semester">éå…¨æœˆç”Ÿ<br>å…±å¹¾å¤©</th>
        <th class="thead-group-semester">éå…¨æœˆæ´¥è²¼</th>
        <th class="thead-group-semester">å­¸æœŸå¤©<br>æ¯”ä¾‹</th>
        <th class="thead-group-semester">å­¸æœŸæ´¥è²¼</th>

        <th class="thead-group-sub">å­¸æœŸä»£èª²(å¤©)</th>
        <th class="thead-group-sub">å­¸æœŸä»£èª²(æ™‚)</th>
        <th class="thead-group-sub">å­¸æœŸä»£èª²æ‰£</th>

        <th class="thead-group-summer">é»åè¡¨é»æ•¸</th>
        <th class="thead-group-summer">ä¸€æ—¥ç‡Ÿ(1)é»æ•¸</th>
        <th class="thead-group-summer">ä¸€æ—¥ç‡Ÿ(2)é»æ•¸</th>
        <th class="thead-group-summer">å¯’æš‘æ´¥è²¼</th>

        <th class="thead-group-monthly">æœ¬æœˆæ´¥è²¼<br>ç®—å¼</th>
        <th class="thead-group-monthly">å‚™è¨»</th>
        

      </tr>
    </thead>
    <tbody id="rows">
      </tbody>
  </table>

<script>
// --- æ–°å¢çš„è¼”åŠ©å‡½å¼ ---

/**
 * ç”Ÿæˆå­¸æœŸæ´¥è²¼çš„ç®—å¼æ–‡å­—ã€‚
 * @param {number} grade - æ¯äººæ´¥è²¼ç­‰ç´šã€‚
 * @param {number} persons - å…¨æœˆäººæ•¸ã€‚
 * @param {number} partialDays - éå…¨æœˆå¤©æ•¸ã€‚
 * @param {number} workdays - æœ¬æœˆå·¥ä½œå¤©æ•¸ã€‚
 * @param {number} semRate - å­¸æœŸå¤©æ¯”ä¾‹ã€‚
 * @returns {string} å­¸æœŸæ´¥è²¼çš„ç®—å¼æ–‡å­—ã€‚
 */
function generateSemesterBonusFormula(grade, persons, partialDays, workdays, semRate) {
  let components = [];
  if (persons > 15) {
    components.push(`$${grade} * (${persons} - 15)`);
  }
  if (partialDays > 0 && workdays > 0) {
    components.push(`$${grade} * ${partialDays} / ${workdays}`);
  }

  if (components.length === 0) {
    return '';
  }

  let formula = components.join(' + ');
  if (semRate !== 1) {
    const semRateText = semRate % 1 === 0 ? semRate.toFixed(0) : semRate.toString();
    formula = `[${formula}] * ${semRateText}`;
  }
  return formula;
}

/**
 * ç”Ÿæˆä»£èª²æ‰£é™¤çš„ç®—å¼æ–‡å­—ã€‚
 * @param {number} subDays - ä»£èª²å¤©æ•¸ã€‚
 * @param {number} subHours - ä»£èª²æ™‚æ•¸ã€‚
 * @param {number} subTotal - ä»£èª²æ‰£é™¤ç¸½é‡‘é¡ã€‚
 * @returns {string} ä»£èª²æ‰£é™¤çš„ç®—å¼æ–‡å­—ã€‚
 */
function generateSubstitutionDeductionFormula(subDays, subHours, subTotal) {
  if (subDays === 0 && subHours === 0) {
    if (subTotal > 0.01) { // è€ƒæ…®æµ®é»æ•¸èª¤å·®
        return ` - ä»£èª²æ‰£é™¤$${subTotal.toFixed(0)}`;
    }
    return '';
  }

  let text = ' - è«‹ä»£èª²';
  if (subDays > 0) {
    text += `${subDays}å¤©`;
  }
  if (subHours > 0) {
    text += `${subHours}å°æ™‚`;
  }
  text += `$${subTotal.toFixed(0)}`;
  return text;
}

/**
 * ç”Ÿæˆå¯’æš‘æ´¥è²¼çš„ç®—å¼æ–‡å­—ã€‚
 * @param {number} attendPts - é»åè¡¨é»æ•¸ã€‚
 * @param {number} camp1Pts - ä¸€æ—¥ç‡Ÿ(1)é»æ•¸ã€‚
 * @param {number} camp2Pts - ä¸€æ—¥ç‡Ÿ(2)é»æ•¸ã€‚
 * @param {number} requiredDays - å¯’æš‘è²¬ä»»é¡å¤©æ•¸ã€‚
 * @param {number} vacBonus - å¯’æš‘æ´¥è²¼é‡‘é¡ã€‚
 * @param {number} userTotal - ä½¿ç”¨è€…é»æ•¸ç¸½å’Œ (attendPts + camp1Pts + camp2Pts)ã€‚
 * @param {number} requiredTotal - è²¬ä»»é¡ç¸½é»æ•¸ (15 * requiredDays)ã€‚
 * @returns {string} å¯’æš‘æ´¥è²¼çš„ç®—å¼æ–‡å­—ã€‚
 */
function generateVacationBonusFormula(attendPts, camp1Pts, camp2Pts, requiredDays, vacBonus, userTotal, requiredTotal) {
  let components = [];
  if (attendPts > 0) components.push(`${attendPts}`);
  if (camp1Pts > 0) components.push(`${camp1Pts}`);
  if (camp2Pts > 0) components.push(`${camp2Pts}`);

  // å¦‚æœé»æ•¸ç¸½å’Œæœªé”æˆ–ç­‰æ–¼è²¬ä»»é¡
  if (userTotal <= requiredTotal) {
    // åªæœ‰ç•¶æœ‰è¼¸å…¥é»æ•¸æˆ–è¨­å®šè²¬ä»»é¡æ™‚æ‰é¡¯ç¤ºæç¤º
    if (userTotal > 0 || requiredTotal > 0) {
      return ` (é»æ•¸${components.join('+')}æœªè¶…éè²¬ä»»é¡ ${requiredTotal}é»)`;
    }
    return ''; // é»æ•¸å’Œè²¬ä»»é¡éƒ½ç‚º0æ™‚ä¸é¡¯ç¤º
  }

  // å¦‚æœé»æ•¸ç¸½å’Œè¶…éè²¬ä»»é¡ï¼Œä¸”æœ‰æ´¥è²¼ç”¢ç”Ÿ
  if (vacBonus > 0) {
    let expr = components.join('+');
    if (requiredDays > 0) {
      expr += `-15*${requiredDays}`;
    }
    let bonusText = ` + $36*(${expr})`;
    return bonusText;
  }
  return '';
}

// --- ä»¥ä¸‹ç‚ºåŸæœ‰çš„å‡½å¼ï¼Œä¿®æ”¹äº† calcRow çš„ç®—å¼ç”Ÿæˆéƒ¨åˆ† ---

function batchAddTeachers() {
  const input = document.getElementById('batchInput').value.trim();
  if (!input) {
    alert('è«‹å…ˆè¼¸å…¥ç­ç´š/å°å¸«ï¼');
    return;
  }
  const names = input.split(/\s+/);
  names.forEach(name => {
    if(name) {
      addRow();
      const tbody = document.getElementById('rows');
      const lastRow = tbody.lastElementChild;
      const teacherInput = lastRow.querySelector('input.teacher');
      if(teacherInput) teacherInput.value = name;
    }
  });
  recalcAll();
  document.getElementById('batchInput').value = '';
}

function calcGrade(persons, isCrossSchool) {
  let baseGrade26 = 650;
  let baseGrade21 = 600;
  let baseGrade15 = 550;

  if (isCrossSchool) {
    baseGrade26 += 50;
    baseGrade21 += 50;
    baseGrade15 += 50;
  }

  if (persons >= 26) return baseGrade26;
  if (persons >= 21) return baseGrade21;
  if (persons >= 15) return baseGrade15;
  return 0;
}

function calcRow(row) {
  const workdays = parseFloat(document.getElementById('workdays').value) || 0;
  const requiredDays = parseFloat(document.getElementById('requiredDays').value) || 0;

  const getNum = (cls) => {
    const el = row.querySelector(`.${cls}`);
    if (!el) return 0;
    if (el.tagName === 'INPUT' && el.type === 'checkbox') return el.checked ? 1 : 0;
    if (el.tagName === 'INPUT') return parseFloat(el.value) || 0;
    return parseFloat(el.textContent) || 0;
  };

  const persons = getNum('persons');
  const isCrossSchool = row.querySelector('.crossSchool').checked;
  const grade = calcGrade(persons, isCrossSchool);

  const partialDays = getNum('partialDays');
  const partialBonus = (workdays > 0 && partialDays > 0)
    ? grade * partialDays / workdays
    : 0;

  let semRate = getNum('rate');
  if (isNaN(semRate)) semRate = 1;

  const subDays = getNum('subDays');
  if (subDays > workdays) {
    alert(`âš ï¸ ä»£èª²å¤©æ•¸ï¼ˆ${subDays}ï¼‰ä¸å¯å¤§æ–¼æœ¬æœˆå·¥ä½œå¤©æ•¸ï¼ˆ${workdays}ï¼‰`);
    row.querySelector('.subDays').value = workdays;
  }
  const subHours = getNum('subHours');
  const attendPts = getNum('attend');
  const camp1Pts = getNum('camp1');
  const camp2Pts = getNum('camp2');

  const fullBonus = (persons > 15) ? (persons - 15) * grade : 0;
  const semTotal = Math.ceil((fullBonus + partialBonus) * semRate);

  const subTotal = (workdays > 0)
    ? Math.floor((semTotal / workdays) * subDays + (semTotal / workdays / 8) * subHours)
    : 0;

  // è¨ˆç®—ä½¿ç”¨è€…è¼¸å…¥çš„ç¸½é»æ•¸
  const userTotalPoints = attendPts + camp1Pts + camp2Pts;
  // è¨ˆç®—è²¬ä»»é¡é»æ•¸ (15é»/å¤© * è²¬ä»»é¡å¤©æ•¸)
  const requiredTotalPoints = 15 * requiredDays;

  let vacBonus = 0;
  // åªæœ‰ç•¶ä½¿ç”¨è€…ç¸½é»æ•¸å¤§æ–¼è²¬ä»»é¡é»æ•¸æ™‚ï¼Œæ‰è¨ˆç®—å¯’æš‘æ´¥è²¼
  if (userTotalPoints > requiredTotalPoints) {
    vacBonus = (userTotalPoints - requiredTotalPoints) * 36;
  }

  const finalBonus = semTotal - subTotal + vacBonus;

  row.querySelector('.fullBonus').textContent = fullBonus.toFixed(0);
  row.querySelector('.partialBonus').textContent = partialBonus.toFixed(0);
  row.querySelector('.semTotal').textContent = semTotal.toFixed(0);
  row.querySelector('.subTotal').textContent = subTotal.toFixed(0);

  // **** é—œéµä¿®æ”¹ï¼šå¯’æš‘æ´¥è²¼çš„é¡¯ç¤ºé‚è¼¯ ****
  if (userTotalPoints <= requiredTotalPoints) {
    // å¦‚æœç¸½é»æ•¸å°æ–¼æˆ–ç­‰æ–¼è²¬ä»»é¡é»æ•¸ï¼Œé¡¯ç¤ºã€Œæœªè¶…éè²¬ä»»é¡ã€
    row.querySelector('.vacBonus').innerHTML = '<span style="font-size:0.85em;">æœªè¶…éè²¬ä»»é¡</span>';
  } else {
    // å¦å‰‡ï¼Œé¡¯ç¤ºè¨ˆç®—å‡ºçš„æ´¥è²¼é‡‘é¡
    row.querySelector('.vacBonus').textContent = vacBonus.toFixed(0);
  }
  // **********************************

  row.querySelector('.finalBonusValue').textContent = finalBonus.toFixed(0);

  // --- ç”¢ç”Ÿç®—å¼æ–‡å­—çš„é‚è¼¯ä¿®æ”¹ï¼šå‘¼å«è¼”åŠ©å‡½å¼ ---
  let formulaParts = [];

  const semesterFormula = generateSemesterBonusFormula(grade, persons, partialDays, workdays, semRate);
  if (semesterFormula) {
    formulaParts.push(semesterFormula);
  }

  const substitutionFormula = generateSubstitutionDeductionFormula(subDays, subHours, subTotal);
  if (substitutionFormula) {
    formulaParts.push(substitutionFormula);
  }

  const vacationFormula = generateVacationBonusFormula(attendPts, camp1Pts, camp2Pts, requiredDays, vacBonus, userTotalPoints, requiredTotalPoints);
  if (vacationFormula) {
    formulaParts.push(vacationFormula);
  }

  let baseFormulaText = formulaParts.join('');
  if (baseFormulaText === '') {
    baseFormulaText = 'ç„¡æ´¥è²¼ç”¢ç”Ÿ';
  }

  // ç‰¹è‰²èª²åŠ è¨»
  const specialCourseCount = parseInt(row.querySelector('.specialCourse')?.value || '0', 10);
  const specialCourseBonus = specialCourseCount * 180;
  let specialCourseNote = '';
  if (specialCourseCount > 0) {
    specialCourseNote = `<span class="formula-note">ï¼ˆç‰¹è‰²èª²Ã—${specialCourseCount}=$${specialCourseBonus}ï¼‰</span>`;
  }

  // ç°½ç´„é‡‘åŠ è¨»
  const signBonusCount = parseInt(row.querySelector('.signBonus')?.value || '0', 10);
  const signBonusAmount = signBonusCount * 1000;
  let signBonusNote = '';
  if (signBonusCount > 0) {
    signBonusNote = `<span class="formula-note">ï¼ˆç°½ç´„é‡‘$${signBonusAmount}ï¼‰</span>`;
  }

  // é«˜å¹´ç´šåŠ çµ¦
  const seniorBonusCount = parseInt(row.querySelector('.seniorBonus')?.value || '0', 10);
  const seniorBonusAmount = seniorBonusCount * 1000;
  let seniorBonusNote = '';
  if (seniorBonusCount > 0) {
    seniorBonusNote = `<span class="formula-note">ï¼ˆé«˜å¹´ç´šåŠ çµ¦$${seniorBonusAmount}ï¼‰</span>`;
  }

  // ç•™ç­çé‡‘
  const repeatBonus = parseInt(row.querySelector('.repeatBonus')?.value || '0', 10);
  let repeatBonusNote = '';
  if (repeatBonus > 0) {
    repeatBonusNote = `<span class="formula-note">ï¼ˆç•™ç­çé‡‘$${repeatBonus}ï¼‰</span>`;
  }

  // åŠ ç¸½æ‰€æœ‰é¡å¤–åŠ çµ¦é‡‘é¡ï¼ˆæœ€çµ‚åŠ ç¸½ï¼‰
  const bonusExtras = signBonusAmount + specialCourseBonus + seniorBonusAmount + repeatBonus;
  const finalBonusTotal = finalBonus + bonusExtras;

  // å°‡æœ€çµ‚çµæœèˆ‡ç®—å¼çµ„åˆ (æ­¤è™•é¡¯ç¤ºæœ€çµ‚åŠ ç¸½ï¼Œè€Œéç´”ç®—å¼çµæœ)
  row.querySelector('.finalBonusFormula').textContent = `${finalBonusTotal.toFixed(0)}=${baseFormulaText}` +
    (specialCourseCount > 0 ? `ï¼ˆç‰¹è‰²èª²Ã—${specialCourseCount}=$${specialCourseBonus}ï¼‰` : '') +
    (signBonusCount > 0 ? `ï¼ˆç°½ç´„é‡‘$${signBonusAmount}ï¼‰` : '') +
    (seniorBonusCount > 0 ? `ï¼ˆé«˜å¹´ç´šåŠ çµ¦$${seniorBonusAmount}ï¼‰` : '') +
    (repeatBonus > 0 ? `ï¼ˆç•™ç­çé‡‘$${repeatBonus}ï¼‰` : '');
  // --- ç®—å¼æ–‡å­—ç”ŸæˆçµæŸ ---
}

function recalcAll() {
  const rows = document.querySelectorAll('#rows tr');
  rows.forEach(calcRow);
}

function addRow() {
  const tbody = document.getElementById('rows');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="thead-group-monthly"><input type="text" class="teacher" placeholder="å°å¸«" /></td>
    <td class="thead-group-semester"><input type="checkbox" class="crossSchool" onchange="recalcAll()" /></td>
    <td class="thead-group-semester"><input type="number" class="persons" min="0" value="15" oninput="recalcAll()" /></td>
    <td class="thead-group-semester fullBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="partialDays" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-semester partialBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="rate" step="0.001" min="0" max="1" value="1" oninput="recalcAll()" /></td>
    <td class="thead-group-semester semTotal">0</td>

    <td class="thead-group-sub"><input type="number" class="subDays" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-sub"><input type="number" class="subHours" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-sub subTotal">0</td>

    <td class="thead-group-summer"><input type="number" class="attend" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-summer"><input type="number" class="camp1" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-summer"><input type="number" class="camp2" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-summer vacBonus">æœªè¶…éè²¬ä»»é¡</td>

    <td class="thead-group-monthly finalBonus">
      <span class="finalBonusValue" style="display:none;">0</span><br>
      <span class="finalBonusFormula"></span>
    </td>
    <td class="thead-group-monthly">
      <label>é«˜å¹´ç´šåŠ çµ¦ <input type="number" class="seniorBonus" min="0" value="0" oninput="recalcAll()" /></label><br>
      <label>ç‰¹è‰²èª² <input type="number" class="specialCourse" min="0" value="0" oninput="recalcAll()" /></label><br>
      <label>ç°½ç´„é‡‘ <input type="number" class="signBonus" min="0" value="0" oninput="recalcAll()" /></label><br>
      <label>ç•™ç­çé‡‘ <input type="number" class="repeatBonus" min="0" value="0" oninput="recalcAll()" /></label><br>
      <input type="text" class="note" placeholder="å‚™è¨»" />
    </td>
  `;
  tbody.appendChild(tr);
  recalcAll();
}

function copyNameAndFormula() {
  const rows = document.querySelectorAll('#rows tr');
  let text = 'å°å¸«\tæœ¬æœˆæ´¥è²¼ç®—å¼\n';

  rows.forEach(row => {
    const name = row.querySelector('.teacher')?.value.trim() || '';
    const formula = row.querySelector('.finalBonusFormula')?.textContent.trim() || '';
    if (name || formula) {
      text += `${name}\t${formula}\n`;
    }
  });

  navigator.clipboard.writeText(text).then(() => {
    alert('å°å¸«èˆ‡æ´¥è²¼ç®—å¼å·²è¤‡è£½ï¼Œå¯è²¼ä¸Šè‡³ Excel æˆ– Google Sheets');
  });
}

function copyTable() {
  const table = document.getElementById('dataTable');
  let text = '';

  // è¡¨é ­ï¼ˆèˆ‡è³‡æ–™é †åºå®Œå…¨ä¸€è‡´ï¼‰
  const headers = [
    'å°å¸«', 'æ˜¯å¦è·¨æ ¡', 'å…¨æœˆäººæ•¸', 'å…¨æœˆæ´¥è²¼',
    'éå…¨æœˆå¤©æ•¸', 'éå…¨æœˆæ´¥è²¼', 'å­¸æœŸå¤©æ¯”ä¾‹', 'å­¸æœŸæ´¥è²¼',
    'ä»£èª²å¤©', 'ä»£èª²æ™‚', 'ä»£èª²æ‰£é™¤',
    'é»åè¡¨é»æ•¸', 'ä¸€æ—¥ç‡Ÿ1é»æ•¸', 'ä¸€æ—¥ç‡Ÿ2é»æ•¸', 'å¯’æš‘æ´¥è²¼',
    'æœ¬æœˆæ´¥è²¼ç®—å¼', 'å‚™è¨»'
  ];
  text += headers.join('\t') + '\n';

  // è³‡æ–™åˆ—
  const rows = document.querySelectorAll('#rows tr');
  rows.forEach(row => {
    const getInputValue = cls => {
      const el = row.querySelector(`.${cls}`);
      if (!el) return '';
      if (el.type === 'checkbox') return el.checked ? 'æ˜¯' : 'å¦';
      return el.value || '';
    };

    const getTextContent = cls => {
      const el = row.querySelector(`.${cls}`);
      return el ? el.textContent.trim() : '';
    };

    const line = [
      getInputValue('teacher'),
      getInputValue('crossSchool'),
      getInputValue('persons'),
      getTextContent('fullBonus'),
      getInputValue('partialDays'),
      getTextContent('partialBonus'),
      getInputValue('rate'),
      getTextContent('semTotal'),
      getInputValue('subDays'),
      getInputValue('subHours'),
      getTextContent('subTotal'),
      getInputValue('attend'),
      getInputValue('camp1'),
      getInputValue('camp2'),
      getTextContent('vacBonus'),
      getTextContent('finalBonusFormula'),
      getInputValue('note')
    ];

    text += line.map(item => `"${item}"`).join('\t') + '\n';
  });

  navigator.clipboard.writeText(text).then(() => {
    alert('è¡¨æ ¼å·²è¤‡è£½ï¼Œå¯è²¼ä¸Šè‡³ Excel æˆ– Google Sheets');
  });
}

function exportCSV() {
  const rows = document.querySelectorAll('#rows tr');
  const csvHeader = [
    "å°å¸«", "æ˜¯å¦è·¨æ ¡", "å…¨æœˆäººæ•¸", "å…¨æœˆæ´¥è²¼", "éå…¨æœˆå¤©æ•¸", "éå…¨æœˆæ´¥è²¼",
    "å­¸æœŸå¤©æ¯”ä¾‹", "å­¸æœŸæ´¥è²¼", "ä»£èª²å¤©", "ä»£èª²æ™‚", "ä»£èª²æ‰£é™¤",
    "é»åè¡¨é»æ•¸", "ä¸€æ—¥ç‡Ÿ1é»æ•¸", "ä¸€æ—¥ç‡Ÿ2é»æ•¸", "å¯’æš‘æ´¥è²¼", "æœ¬æœˆæ´¥è²¼è¨ˆç®—å¼", "å‚™è¨»"
  ];

  let csv = '\uFEFF' + csvHeader.join(',') + '\n';

  rows.forEach(row => {
    const getText = cls => {
      const el = row.querySelector(`.${cls}`);
      if (!el) return '';
      if (el.tagName === 'INPUT' && el.type === 'checkbox') return el.checked ? 'æ˜¯' : 'å¦';
      if (el.tagName === 'INPUT' || el.tagName === 'SELECT') return el.value;
      return el.textContent;
    };

    const finalBonusFormula = row.querySelector('.finalBonusFormula')?.textContent || '';

    const line = [
      getText('teacher'),
      getText('crossSchool'),
      getText('persons'),
      getText('fullBonus'),
      getText('partialDays'),
      getText('partialBonus'),
      getText('rate'),
      getText('semTotal'),
      getText('subDays'),
      getText('subHours'),
      getText('subTotal'),
      getText('attend'),
      getText('camp1'),
      getText('camp2'),
      getText('vacBonus'),
      finalBonusFormula,
      getText('note')
    ];

    csv += line.map(item => `"${item}"`).join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().slice(0, 10);
  a.href = url;
  a.download = `${date}_èª²è¼”å¸¶ç­æ´¥è²¼.csv`;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
<script>
function removeEmptyRows() {
  const tbody = document.getElementById('rows');
  const rows = tbody.querySelectorAll('tr');

  rows.forEach(row => {
    const teacher = row.querySelector('.teacher')?.value.trim();
    const persons = parseFloat(row.querySelector('.persons')?.value || 0);
    const attend = parseFloat(row.querySelector('.attend')?.value || 0);
    const camp1 = parseFloat(row.querySelector('.camp1')?.value || 0);
    const camp2 = parseFloat(row.querySelector('.camp2')?.value || 0);

    const isEmpty =
    !teacher &&
    (persons === 15 || persons === 0 || isNaN(persons)) &&
    attend === 0 &&
    camp1 === 0 &&
    camp2 === 0;

    if (isEmpty) {
      row.remove();
    }
  });

  recalcAll();
}
</script>
<script>
    // é˜²å‘†æç¤ºåŠŸèƒ½è¦æ”¾æœ€å¾Œ
    document.addEventListener('input', function(e) {
      const workdays = parseFloat(document.getElementById('workdays').value) || 0;
      const requiredDays = parseFloat(document.getElementById('requiredDays').value) || 0;

      const warn = (condition, message) => {
        if (condition) alert(message);
      };

      if (e.target.classList.contains('partialDays') ||
          e.target.classList.contains('subDays') ||
          e.target.classList.contains('subHours')) {
        warn(workdays === 0, 'è«‹å…ˆå¡«å¯«ã€Œæœ¬æœˆå·¥ä½œå¤©æ•¸ã€å†è¼¸å…¥ç›¸é—œæ¬„ä½');
      }

      if (e.target.classList.contains('attend')) {
        warn(requiredDays === 0, 'è«‹å…ˆå¡«å¯«ã€Œè²¬ä»»é¡å¤©æ•¸ã€å†è¼¸å…¥é»åè¡¨é»æ•¸');
      }
    });
</script>
</body>
</html>
