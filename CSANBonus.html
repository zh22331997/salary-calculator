<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>è¨ˆç®—èª²è¼”å¸¶ç­æ´¥è²¼ æ¸…æ°´ã€æ±Ÿç¿ </title>
<style>
/* ========= 0) ä¸»é¡Œè®Šæ•¸ï¼ˆè«è˜­è¿ªè‰²ç³»ï¼‰ ========= */
:root{
  /* è¡¨é ­èƒŒæ™¯ï¼ˆå°æ‡‰ä¸‰ç¾¤ï¼‰ */
  --th-bg-month:#ffffff;
  --th-bg-sem:  #e6f3f6;  /* æ¸…æ°´è—-æ·¡ */
  --th-bg-sub:  #f7eadf;  /* æç²‰-æ·¡  */
  --th-bg-sum:  #f2e7f6;  /* æ·¡ç´«-æ·¡  */

  /* å…§å®¹åˆ—åº•è‰²ï¼ˆæ›´æ·¡ï¼‰ */
  --td-bg-sem:  #f3fbfd;
  --td-bg-sub:  #fff7ef;
  --td-bg-sum:  #faf3fb;

  /* é‚Šç·šèˆ‡æ–‡å­— */
  --bd:#d4d7dd;
  --ink:#293241;

  /* ä¸»è¦æ“ä½œéµï¼ˆæ‰¹æ¬¡/æ–°å¢/åˆªé™¤ï¼‰è«è˜­è¿ªè—ç° */
  --btn-main:#a7c1d1;
  --btn-main-hover:#94b3c6;

  /* æ‘ºç–Šéµè‰²ï¼ˆå°æ‡‰åˆ†ç¾¤ï¼Œç¨æ·±ä¸€éšï¼‰ */
  --btn-sem:#b8dce3;
  --btn-sem-hover:#a9cfda;

  --btn-sub:#f2d8c9;
  --btn-sub-hover:#eecab5;

  --btn-sum:#e1caea;
  --btn-sum-hover:#d8bde4;

  /* å…¶ä»–å·¥å…·éµï¼ˆæ¬¡è¦ï¼‰ */
  --btn-muted:#cfd6df;
  --btn-muted-hover:#c2cbd6;
}

/* ========= 1) å…¨ç«™åŸºç¤ ========= */
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  font-family:"Microsoft JhengHei",sans-serif;
  padding:24px;
  background:#f7f7f8;
  color:var(--ink);
}
h1{
  margin:0 0 16px;
  padding-left:12px;
  border-left:6px solid #3c82f6;
}
button{
  appearance:none; border:0; cursor:pointer;
  padding:.6em 1em; border-radius:12px; font-size:16px;
  line-height:1; transition:.15s;
  display:inline-flex; align-items:center; gap:.5em;
  color:#102a43;
}

/* ========= 2) è¡¨æ ¼å¤–æ¡† + å›ºå®šç‰ˆé¢é…ç½® ========= */
.table-wrap{
  max-height:70vh; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; background:#fff;
}
table{
  width:100%; border-collapse:collapse; background:#fff;
  table-layout:fixed;
}
th,td{
  border:1px solid var(--bd);
  text-align:center; vertical-align:middle;
  padding:10px;
}

/* thead sticky + åˆ†è‰² */
#dataTable thead th{
  position:sticky; top:0; z-index:6;
  background:var(--th-bg,#fff);
  box-shadow:0 2px 0 rgba(0,0,0,.04);
  white-space:normal; overflow:visible; text-overflow:clip;
  font-size:.95em; line-height:1.15; padding:8px 6px;
}
#dataTable thead th.thead-group-monthly{ --th-bg: var(--th-bg-month); }
#dataTable thead th.thead-group-semester{ --th-bg: var(--th-bg-sem); }
#dataTable thead th.thead-group-sub{ --th-bg: var(--th-bg-sub); }
#dataTable thead th.thead-group-summer{ --th-bg: var(--th-bg-sum); }

/* ç¬¬ä¸€æ¬„ stickyï¼ˆtbodyï¼‰ */
#rows td:first-child{
  position:sticky; left:0; z-index:4; background:#fff;
}

/* ========= 3) å…§å®¹åˆ—åˆ†è‰² ========= */
#rows td.thead-group-semester{ background:var(--td-bg-sem); }
#rows td.thead-group-sub{ background:var(--td-bg-sub); }
#rows td.thead-group-summer{ background:var(--td-bg-sum); }
#rows td.thead-group-monthly{ background:#ffffff; }

/* ========= 4) æ¬„å¯¬ ========= */
th.teacher, td .teacher{ width:6em; }
th.crossSchoolCol, td.crossSchoolCol{ width:3.2em; }
th.persons, td .persons{ width:5em; }
th.fullBonus, td.fullBonus{ width:6em; }
th.partialDays, td .partialDays{ width:5em; }
th.partialBonus, td.partialBonus{ width:6em; }
th.rate, td .rate{ width:3.5em; }
th.semTotal, td.semTotal{ width:7em; }
th.subDays, td .subDays{ width:3.5em; }
th.subHours, td .subHours{ width:3.55em; }
th.subTotal, td.subTotal{ width:6em; }
th.attend, td .attend{ width:5em; }
th.camp1, td .camp1{ width:5em; }
th.camp2, td .camp2{ width:5em; }
th.vacBonus, td.vacBonus{ width:7em; }
td.finalBonus{ min-width:15em; width:15em; }
th.noteCol, td.noteCol{ width:22em; min-width:22em; }

/* ========= 5) å„²å­˜æ ¼é¡¯ç¤ºè¦å‰‡ ========= */
/* å°æ¬„ä½ç¶­æŒå–®è¡Œçœç•¥ */
#dataTable tbody td{
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
/* éœ€è¦å®Œæ•´é¡¯ç¤ºçš„æ¬„ä½ */
#dataTable tbody td.vacBonus,
#dataTable tbody td.finalBonus,
#dataTable tbody td.noteCol{
  white-space:normal; overflow:visible; text-overflow:clip;
}
/* å…§éƒ¨è¼¸å…¥çµ±ä¸€ */
#dataTable tbody td input[type="number"],
#dataTable tbody td input[type="text"]{
  width:100%; max-width:100%; padding:6px 8px; text-align:center;
  border:1px solid #cbd5e1; border-radius:8px; font-size:1em;
}
/* checkbox ä¸è¦è¢«æ’æ»¿ */
#dataTable td.crossSchoolCol input.crossSchool{
  width:auto; display:inline-block; margin:0 auto;
}

/* ========= 6) å‚™è¨»æ¬„æ’ç‰ˆ ========= */
td.noteCol{ padding:6px; }
td.noteCol .note-wrap{
  display:flex; flex-wrap:wrap; align-items:center; gap:6px 10px;
}
td.noteCol label{
  display:inline-flex; align-items:center; gap:4px; margin:0; white-space:nowrap;
}
td.noteCol input[type="number"]{ width:4.2em; }
td.noteCol input.note{ width:12em; text-align:left; }

/* ========= 7) å…¬å¼æ–‡å­— ========= */
.finalBonusFormula{ font-size:.85em; color:#4b5563; text-align:left; word-break:break-word; }

/* ========= 8) æ‘ºç–Šç¾¤çµ„ ========= */
.collapse-semester th.thead-group-semester,
.collapse-semester td.thead-group-semester{ display:none; }
.collapse-sub th.thead-group-sub,
.collapse-sub td.thead-group-sub{ display:none; }
.collapse-summer th.thead-group-summer,
.collapse-summer td.thead-group-summer{ display:none; }

/* ========= 9) ä¸Šæ–¹è¨­å®šå€ ========= */
/* ç”¨ flex è®“æ¬„ä½ä¸æœƒè¢«æ¨ä½ */
.settings-row{
  display:flex; flex-wrap:wrap; align-items:center;
  gap:16px 22px; padding:12px; margin:10px 0 14px;
  background:#fff; border:1px solid #e5e7eb; border-radius:12px;
}
.settings-row .field{ display:inline-flex; align-items:center; gap:8px; }
.settings-row label{ color:#374151; }
.settings-row input[type="number"]{
  width:120px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; font-size:1rem;
}
.settings-row .note{ color:#6b7280; font-size:.9rem; }
.input-group{ display:inline-flex; align-items:center; gap:6px; }
.prefix{
  padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px;
  background:#f9fafb; color:#374151;
}
.settings-row input:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.15); }

/* ========= 10) æ‰¹æ¬¡æ–°å¢ï¼šå…©æ¬„ï¼ˆæ¨™é¡Œï¼‹è¼¸å…¥ï¼‰ ========= */
.batch-merge{
  display:grid; grid-template-columns:max-content 1fr; gap:12px;
  align-items:flex-start; padding:12px; margin:10px 0 12px;
  background:#fff; border:1px solid #e5e7eb; border-radius:12px;
}
.batch-merge .title{ font-weight:600; color:#111827; white-space:nowrap; padding-top:6px; }
.batch-merge #batchInput{
  width:100%; min-height:44px; max-height:160px; resize:vertical;
  padding:8px 10px; border:none; background:#fff; font-size:1rem; line-height:1.4; outline:none;
}
.batch-merge:focus-within{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.15); transition:.15s; }
@media (max-width:720px){
  .batch-merge{ grid-template-columns:1fr; gap:6px; }
  .batch-merge .title{ padding-top:0; }
}

/* ========= 11) å·¥å…·åˆ—æŒ‰éˆ•ï¼ˆè«è˜­è¿ªï¼‰ ========= */
.toolbar{ display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 14px; }

/* åŸºåº• */
.btn{ background:var(--btn-muted); }
.btn:hover{ background:var(--btn-muted-hover); }

/* ä¸»è¦ä¸‰éµï¼šæ‰¹æ¬¡/æ–°å¢/åˆªç©ºç™½ */
.btn-main{ background:var(--btn-main); }
.btn-main:hover{ background:var(--btn-main-hover); }

/* æ‘ºç–Šéµå°æ‡‰åˆ†ç¾¤ */
.btn-sem{ background:var(--btn-sem); }
.btn-sem:hover{ background:var(--btn-sem-hover); }
.btn-sub{ background:var(--btn-sub); }
.btn-sub:hover{ background:var(--btn-sub-hover); }
.btn-sum{ background:var(--btn-sum); }
.btn-sum:hover{ background:var(--btn-sum-hover); }
</style>
</head>

<body>
<h1>è¨ˆç®—èª²è¼”å¸¶ç­æ´¥è²¼ æ¸…æ°´ã€æ±Ÿç¿ </h1>

<!-- éå¿…å¡«çš„è¨­å®šï¼ˆ$ èˆ‡è¼¸å…¥åŒçµ„ã€ä¸æœƒè·‘ä½ï¼‰ -->
<div class="settings-row" role="group" aria-label="éå¿…å¡«çš„è¨­å®š">
  <strong>éå¿…å¡«çš„è¨­å®šï¼š</strong>

  <div class="field">
    <label for="workdays">æœ¬æœˆå·¥ä½œå¤©æ•¸</label>
    <input type="number" id="workdays" value="0" min="0" oninput="recalcAll()">
  </div>

  <div class="field">
    <label for="requiredDays">å¯’æš‘è²¬ä»»é¡å¤©æ•¸</label>
    <input type="number" id="requiredDays" value="0" min="0" oninput="recalcAll()">
    <span class="note">ï¼ˆæš‘å‡ç”¨17å¤©ï¼‰</span>
  </div>

  <div class="field">
    <label for="defaultSpecialCoursePrice">ç‰¹è‰²èª²é è¨­å–®åƒ¹</label>
    <span class="input-group">
      <span class="prefix">$</span>
      <input type="number" id="defaultSpecialCoursePrice" value="180" min="0" step="1" oninput="recalcAll()">
    </span>
  </div>
</div>

<!-- æ‰¹æ¬¡æ–°å¢ï¼ˆèªªæ˜ç§»å…¥ placeholderï¼‰ -->
<div class="batch-merge">
  <div class="title">æ‰¹æ¬¡æ–°å¢ç­ç´š/å°å¸«ï¼š</div>
  <textarea id="batchInput" placeholder="è«‹è²¼ä¸Šç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ï¼š1A 1B APPLEè€å¸«"></textarea>
</div>

<!-- æ“ä½œæŒ‰éˆ•åˆ—ï¼ˆè«è˜­è¿ªï¼‰ -->
<div class="toolbar">
  <button class="btn-main" onclick="batchAddTeachers()">ğŸ‘¥ æ‰¹æ¬¡æ–°å¢ç­ç´š/å°å¸«</button>
  <button class="btn-main" onclick="addRow()">â• æ–°å¢ç©ºç™½åˆ—</button>
  <button class="btn-main" onclick="removeEmptyRows()">ğŸ—‘ï¸ åˆªé™¤ç©ºç™½åˆ—</button>

  <button class="btn" onclick="copyNameAndFormula()">ğŸ“ è¤‡è£½å°å¸«èˆ‡æ´¥è²¼ç®—å¼</button>
  <button class="btn" onclick="copyTable()">ğŸ“‹ è¤‡è£½æ•´å¼µè¡¨æ ¼</button>
  <button class="btn" onclick="exportCSV()">ğŸ’¾ åŒ¯å‡º CSV æª”æ¡ˆ</button>
</div>

<!-- æ‘ºç–Šæ§åˆ¶ï¼ˆé¡è‰²å°æ‡‰ä¸‰å€ï¼‰ -->
<div class="toolbar">
  <button type="button" id="toggleSem" class="btn-sem">â†• æ‘ºç–Š/å±•é–‹ï¼šå­¸æœŸæ¬„</button>
  <button type="button" id="toggleSub" class="btn-sub">â†• æ‘ºç–Š/å±•é–‹ï¼šä»£èª²æ¬„</button>
  <button type="button" id="toggleSum" class="btn-sum">â†• æ‘ºç–Š/å±•é–‹ï¼šå¯’æš‘æ¬„</button>
</div>

<div class="table-wrap">
  <table id="dataTable" role="grid" aria-label="æ•™å¸«æ´¥è²¼è¨ˆç®—è¡¨">
    <thead>
      <tr>
        <th class="thead-group-monthly">å°å¸«</th>
        <th class="thead-group-semester crossSchoolCol">æ˜¯å¦è·¨æ ¡</th>
        <th class="thead-group-semester">å…¨æœˆäººæ•¸</th>
        <th class="thead-group-semester">å…¨æœˆæ´¥è²¼</th>
        <th class="thead-group-semester">éå…¨æœˆç”Ÿ<br>å…±å¹¾å¤©</th>
        <th class="thead-group-semester">éå…¨æœˆæ´¥è²¼</th>
        <th class="thead-group-semester">å­¸æœŸå¤©<br>æ¯”ä¾‹</th>
        <th class="thead-group-semester">å­¸æœŸæ´¥è²¼</th>
        <th class="thead-group-sub">å­¸æœŸä»£èª²(å¤©)</th>
        <th class="thead-group-sub">å­¸æœŸä»£èª²(æ™‚)</th>
        <th class="thead-group-sub">å­¸æœŸä»£èª²æ‰£</th>
        <th class="thead-group-summer">é»åè¡¨é»æ•¸(1å¤©1é».åŠå¤©åŠé»)</th>
        <th class="thead-group-summer">ä¸€æ—¥ç‡Ÿ(1)é»æ•¸</th>
        <th class="thead-group-summer">ä¸€æ—¥ç‡Ÿ(2)é»æ•¸</th>
        <th class="thead-group-summer">å¯’æš‘æ´¥è²¼</th>
        <th class="thead-group-monthly">æœ¬æœˆæ´¥è²¼<br>ç®—å¼</th>
        <th class="thead-group-monthly noteCol">å‚™è¨»</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
/* ========= è¨ˆç®—è¼”åŠ©ï¼šç®—å¼æ–‡å­— ========= */
function generateSemesterBonusFormula(grade, persons, partialDays, workdays, semRate){
  const parts=[];
  if(persons>15) parts.push(`$${grade} * (${persons} - 15)`);
  if(partialDays>0 && workdays>0) parts.push(`$${grade} * ${partialDays} / ${workdays}`);
  if(!parts.length) return '';
  let f = parts.join(' + ');
  if(semRate!==1){
    const r = semRate % 1 === 0 ? semRate.toFixed(0) : semRate.toString();
    f = `[${f}] * ${r}`;
  }
  return f;
}
function generateSubstitutionDeductionFormula(subDays, subHours, subTotal){
  if(subDays===0 && subHours===0){
    return (subTotal>0.01) ? ` - ä»£èª²æ‰£é™¤$${subTotal.toFixed(0)}` : '';
  }
  let t=' - è«‹ä»£èª²';
  if(subDays>0) t+=`${subDays}å¤©`;
  if(subHours>0) t+=`${subHours}å°æ™‚`;
  t+=`$${subTotal.toFixed(0)}`;
  return t;
}
function generateVacationBonusFormula(attendPts, camp1Pts, camp2Pts, requiredDays, vacBonus, userTotal, requiredTotal){
  const parts=[];
  if(attendPts>0) parts.push(`${attendPts}`);
  if(camp1Pts>0) parts.push(`${camp1Pts}`);
  if(camp2Pts>0) parts.push(`${camp2Pts}`);
  if(userTotal<=requiredTotal){
    if(userTotal>0 || requiredTotal>0) return ` (é»æ•¸${parts.join('+')}æœªè¶…éè²¬ä»»é¡ ${requiredTotal}é»)`;
    return '';
  }
  if(vacBonus>0){
    let expr = parts.join('+');
    if(requiredDays>0) expr += `-15*${requiredDays}`;
    return ` + $36*(${expr})`;
  }
  return '';
}

/* ========= äº’å‹•ï¼šæ–°å¢/æ‰¹æ¬¡/åˆªç©ºç™½ ========= */
function batchAddTeachers(){
  const input = document.getElementById('batchInput').value.trim();
  if(!input){ alert('è«‹å…ˆè¼¸å…¥ç­ç´š/å°å¸«ï¼'); return; }
  input.split(/\s+/).forEach(name=>{
    if(!name) return;
    addRow();
    const lastRow = document.getElementById('rows').lastElementChild;
    lastRow.querySelector('input.teacher').value = name;
  });
  recalcAll();
  document.getElementById('batchInput').value='';
}
function addRow(){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td class="thead-group-monthly"><input type="text" class="teacher" placeholder="å°å¸«"/></td>
    <td class="thead-group-semester crossSchoolCol"><input type="checkbox" class="crossSchool" onchange="recalcAll()"/></td>
    <td class="thead-group-semester"><input type="number" class="persons" min="0" value="15" oninput="recalcAll()"/></td>
    <td class="thead-group-semester fullBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="partialDays" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-semester partialBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="rate" step="0.001" min="0" max="1" value="1" oninput="recalcAll()"/></td>
    <td class="thead-group-semester semTotal">0</td>
    <td class="thead-group-sub"><input type="number" class="subDays" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-sub"><input type="number" class="subHours" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-sub subTotal">0</td>
    <td class="thead-group-summer"><input type="number" class="attend" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-summer"><input type="number" class="camp1" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-summer"><input type="number" class="camp2" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-summer vacBonus"></td>
    <td class="thead-group-monthly finalBonus">
      <span class="finalBonusValue" style="display:none;">0</span><br>
      <span class="finalBonusFormula"></span>
    </td>
    <td class="thead-group-monthly noteCol">
      <div class="note-wrap">
        <label>é«˜å¹´ç´šåŠ çµ¦ <input type="number" class="seniorBonus" min="0" value="0" oninput="recalcAll()"/></label>
        <label>ç‰¹è‰²èª² <input type="number" class="specialCourse" min="0" value="0" oninput="recalcAll()"/> Ã— $<input type="number" class="specialCoursePrice" min="0" step="1" placeholder="é è¨­" oninput="recalcAll()"/></label>
        <label>ç°½ç´„é‡‘ <input type="number" class="signBonus" min="0" value="0" oninput="recalcAll()"/></label>
        <label>ç•™ç­çé‡‘ <input type="number" class="repeatBonus" min="0" value="0" oninput="recalcAll()"/></label>
        <input type="text" class="note" placeholder="å‚™è¨»"/>
      </div>
    </td>`;
  document.getElementById('rows').appendChild(tr);
  recalcAll();
}
function removeEmptyRows(){
  document.querySelectorAll('#rows tr').forEach(row=>{
    const teacher = row.querySelector('.teacher')?.value.trim();
    const persons = parseFloat(row.querySelector('.persons')?.value || 0);
    const attend  = parseFloat(row.querySelector('.attend')?.value || 0);
    const camp1   = parseFloat(row.querySelector('.camp1')?.value || 0);
    const camp2   = parseFloat(row.querySelector('.camp2')?.value || 0);
    const isEmpty = !teacher && (persons===15 || persons===0 || isNaN(persons)) && attend===0 && camp1===0 && camp2===0;
    if(isEmpty) row.remove();
  });
  recalcAll();
}

/* ========= è¨ˆç®—ä¸»æµç¨‹ ========= */
function calcGrade(persons, isCrossSchool){
  let g26=650, g21=600, g15=550;
  if(isCrossSchool){ g26+=50; g21+=50; g15+=50; }
  if(persons>=26) return g26;
  if(persons>=21) return g21;
  if(persons>=15) return g15;
  return 0;
}
function calcRow(row){
  const workdays = parseFloat(document.getElementById('workdays').value) || 0;
  const requiredDays = parseFloat(document.getElementById('requiredDays').value) || 0;

  const getNum = cls=>{
    const el=row.querySelector(`.${cls}`);
    if(!el) return 0;
    if(el.tagName==='INPUT' && el.type==='checkbox') return el.checked?1:0;
    if(el.tagName==='INPUT') return parseFloat(el.value)||0;
    return parseFloat(el.textContent)||0;
  };

  const persons=getNum('persons');
  const isCrossSchool=row.querySelector('.crossSchool').checked;
  const grade=calcGrade(persons, isCrossSchool);

  const partialDays=getNum('partialDays');
  const partialBonus=(workdays>0 && partialDays>0)? grade*partialDays/workdays : 0;

  let semRate=getNum('rate'); if(isNaN(semRate)) semRate=1;

  const subDays=getNum('subDays');
  if(subDays>workdays){
    alert(`âš ï¸ ä»£èª²å¤©æ•¸ï¼ˆ${subDays}ï¼‰ä¸å¯å¤§æ–¼æœ¬æœˆå·¥ä½œå¤©æ•¸ï¼ˆ${workdays}ï¼‰`);
    row.querySelector('.subDays').value=workdays;
  }
  const subHours=getNum('subHours');
  const attendPts=getNum('attend');
  const camp1Pts=getNum('camp1');
  const camp2Pts=getNum('camp2');

  const fullBonus=(persons>15)? (persons-15)*grade : 0;
  const semTotal=Math.ceil((fullBonus+partialBonus)*semRate);

  const subTotal=(workdays>0)
    ? Math.floor((semTotal/workdays)*subDays + (semTotal/workdays/8)*subHours)
    : 0;

  const userTotal=attendPts+camp1Pts+camp2Pts;
  const requiredTotal=15*requiredDays;
  const vacBonus = userTotal>requiredTotal ? (userTotal-requiredTotal)*36 : 0;

  const finalBonus=semTotal - subTotal + vacBonus;

  row.querySelector('.fullBonus').textContent=fullBonus.toFixed(0);
  row.querySelector('.partialBonus').textContent=partialBonus.toFixed(0);
  row.querySelector('.semTotal').textContent=semTotal.toFixed(0);
  row.querySelector('.subTotal').textContent=subTotal.toFixed(0);

  // å¯’æš‘æ´¥è²¼é¡¯ç¤ºé‚è¼¯ï¼šæœªå¡«ä»»ä½•é»æ•¸ä¸”æœªè¨­è²¬ä»»é¡ â†’ ä¸é¡¯ç¤º
  const vacCell = row.querySelector('.vacBonus');
  if (userTotal === 0 && requiredTotal === 0) {
    vacCell.textContent = '';
  } else if (userTotal <= requiredTotal) {
    vacCell.innerHTML = '<span style="font-size:0.85em;">æœªè¶…éè²¬ä»»é¡</span>';
  } else {
    vacCell.textContent = vacBonus.toFixed(0);
  }

  row.querySelector('.finalBonusValue').textContent=finalBonus.toFixed(0);

  const semF = generateSemesterBonusFormula(grade, persons, partialDays, workdays, semRate);
  const subF = generateSubstitutionDeductionFormula(subDays, subHours, subTotal);
  const vacF = generateVacationBonusFormula(attendPts, camp1Pts, camp2Pts, requiredDays, vacBonus, userTotal, requiredTotal);

  let base = [semF, subF, vacF].filter(Boolean).join('');
  if(!base) base='ç„¡æ´¥è²¼ç”¢ç”Ÿ';

  const scCount = parseInt(row.querySelector('.specialCourse')?.value || '0',10);
  const defaultPrice = Math.max(0, parseFloat(document.getElementById('defaultSpecialCoursePrice')?.value || '180'));
  const scpRaw = row.querySelector('.specialCoursePrice')?.value ?? '';
  const scPrice = (scpRaw==='' || isNaN(parseFloat(scpRaw))) ? defaultPrice : Math.max(0, parseFloat(scpRaw));
  const scBonus = scCount*scPrice;

  const signCount = parseInt(row.querySelector('.signBonus')?.value || '0',10);
  const signBonus = signCount*1000;

  const seniorCount = parseInt(row.querySelector('.seniorBonus')?.value || '0',10);
  const seniorBonus = seniorCount*1000;

  const repeatBonus = parseInt(row.querySelector('.repeatBonus')?.value || '0',10);

  const extras = signBonus + scBonus + seniorBonus + repeatBonus;
  const finalTotal = finalBonus + extras;

  row.querySelector('.finalBonusFormula').textContent =
    `${finalTotal.toFixed(0)}=${base}`
    + (seniorCount>0 ? `ï¼ˆé«˜å¹´ç´šåŠ çµ¦$${seniorBonus}ï¼‰` : '')
    + (scCount>0 ? `ï¼ˆç‰¹è‰²èª²Ã—${scCount}Ã—$${scPrice}=$${scBonus}ï¼‰` : '')
    + (signCount>0 ? `ï¼ˆç°½ç´„é‡‘$${signBonus}ï¼‰` : '')
    + (repeatBonus>0 ? `ï¼ˆç•™ç­çé‡‘$${repeatBonus}ï¼‰` : '');
}

function recalcAll(){ document.querySelectorAll('#rows tr').forEach(calcRow); }

/* ========= åŒ¯å‡º/è¤‡è£½ ========= */
function copyNameAndFormula(){
  let text='å°å¸«\tæœ¬æœˆæ´¥è²¼ç®—å¼\n';
  document.querySelectorAll('#rows tr').forEach(row=>{
    const name = row.querySelector('.teacher')?.value.trim() || '';
    const formula = row.querySelector('.finalBonusFormula')?.textContent.trim() || '';
    if(name || formula) text += `${name}\t${formula}\n`;
  });
  navigator.clipboard.writeText(text).then(()=> alert('å°å¸«èˆ‡æ´¥è²¼ç®—å¼å·²è¤‡è£½ï¼Œå¯è²¼ä¸Šè‡³ Excel æˆ– Google Sheets'));
}
function copyTable(){
  const headers=[
    'å°å¸«','æ˜¯å¦è·¨æ ¡','å…¨æœˆäººæ•¸','å…¨æœˆæ´¥è²¼','éå…¨æœˆå¤©æ•¸','éå…¨æœˆæ´¥è²¼','å­¸æœŸå¤©æ¯”ä¾‹','å­¸æœŸæ´¥è²¼',
    'ä»£èª²å¤©','ä»£èª²æ™‚','ä»£èª²æ‰£é™¤','é»åè¡¨é»æ•¸','ä¸€æ—¥ç‡Ÿ1é»æ•¸','ä¸€æ—¥ç‡Ÿ2é»æ•¸','å¯’æš‘æ´¥è²¼',
    'æœ¬æœˆæ´¥è²¼ç®—å¼','å‚™è¨»'
  ];
  let text=headers.join('\t')+'\n';
  document.querySelectorAll('#rows tr').forEach(row=>{
    const getInput=cls=>{ const el=row.querySelector(`.${cls}`); if(!el) return ''; return el.type==='checkbox' ? (el.checked?'æ˜¯':'å¦') : (el.value||''); };
    const getText =cls=>{ const el=row.querySelector(`.${cls}`); return el ? el.textContent.trim():''; };
    const line=[
      getInput('teacher'), getInput('crossSchool'), getInput('persons'), getText('fullBonus'),
      getInput('partialDays'), getText('partialBonus'), getInput('rate'), getText('semTotal'),
      getInput('subDays'), getInput('subHours'), getText('subTotal'), getInput('attend'),
      getInput('camp1'), getInput('camp2'), getText('vacBonus'), getText('finalBonusFormula'),
      getInput('note')
    ];
    text+= line.map(x=>`"${x}"`).join('\t')+'\n';
  });
  navigator.clipboard.writeText(text).then(()=> alert('è¡¨æ ¼å·²è¤‡è£½ï¼Œå¯è²¼ä¸Šè‡³ Excel æˆ– Google Sheets'));
}
function exportCSV(){
  const headers=[
    "å°å¸«","æ˜¯å¦è·¨æ ¡","å…¨æœˆäººæ•¸","å…¨æœˆæ´¥è²¼","éå…¨æœˆå¤©æ•¸","éå…¨æœˆæ´¥è²¼",
    "å­¸æœŸå¤©æ¯”ä¾‹","å­¸æœŸæ´¥è²¼","ä»£èª²å¤©","ä»£èª²æ™‚","ä»£èª²æ‰£é™¤",
    "é»åè¡¨é»æ•¸","ä¸€æ—¥ç‡Ÿ1é»æ•¸","ä¸€æ—¥ç‡Ÿ2é»æ•¸","å¯’æš‘æ´¥è²¼","æœ¬æœˆæ´¥è²¼è¨ˆç®—å¼","å‚™è¨»"
  ];
  let csv='\uFEFF'+headers.join(',')+'\n';
  document.querySelectorAll('#rows tr').forEach(row=>{
    const get =cls=>{
      const el=row.querySelector(`.${cls}`);
      if(!el) return '';
      if(el.tagName==='INPUT' && el.type==='checkbox') return el.checked?'æ˜¯':'å¦';
      if(el.tagName==='INPUT' || el.tagName==='SELECT') return el.value;
      return el.textContent;
    };
    const formula=row.querySelector('.finalBonusFormula')?.textContent || '';
    const line=[
      get('teacher'), get('crossSchool'), get('persons'), get('fullBonus'),
      get('partialDays'), get('partialBonus'), get('rate'), get('semTotal'),
      get('subDays'), get('subHours'), get('subTotal'), get('attend'),
      get('camp1'), get('camp2'), get('vacBonus'), formula, get('note')
    ];
    csv+= line.map(x=>`"${x}"`).join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url;
  a.download=`${new Date().toISOString().slice(0,10)}_èª²è¼”å¸¶ç­æ´¥è²¼.csv`;
  a.click(); URL.revokeObjectURL(url);
}

/* ========= æ‘ºç–Šåˆ‡æ› ========= */
(function setupCollapseToggles(){
  const table = document.getElementById('dataTable');
  document.getElementById('toggleSem')?.addEventListener('click', ()=>{
    table.classList.toggle('collapse-semester');
  });
  document.getElementById('toggleSub')?.addEventListener('click', ()=>{
    table.classList.toggle('collapse-sub');
  });
  document.getElementById('toggleSum')?.addEventListener('click', ()=>{
    table.classList.toggle('collapse-summer');
  });
})();

// ===== é˜²å‘†æé†’ï¼ˆå°ˆæ³¨æ–¼ã€Œé–‹å§‹è¼¸å…¥å‰ã€çš„æé†’ï¼‰=====
(function setupGuards(){
  const workdaysEl      = document.getElementById('workdays');
  const requiredDaysEl  = document.getElementById('requiredDays');

  // ç”¨ focusinï¼ˆäº‹ä»¶æœƒå†’æ³¡åˆ° documentï¼‰ï¼Œæ¯” key å…¥æ‰æé†’æ›´ç›´è¦º
  document.addEventListener('focusin', (e)=>{
    const t = e.target;

    // A. éœ€è¦å…ˆå¡«ã€Œæœ¬æœˆå·¥ä½œå¤©æ•¸ã€çš„æ¬„ä½
    if (t.classList && (t.classList.contains('partialDays') ||
                        t.classList.contains('subDays')     ||
                        t.classList.contains('subHours'))) {
      const workdays = parseFloat(workdaysEl.value) || 0;
      if (workdays === 0) {
        alert('è«‹å…ˆå¡«å¯«ã€Œæœ¬æœˆå·¥ä½œå¤©æ•¸ã€ï¼Œå†è¼¸å…¥ éå…¨æœˆ/ä»£èª² æ¬„ä½ã€‚');
        t.blur();                 // è‹¥åªæƒ³æé†’ï¼Œä¸æƒ³ç¦æ­¢ï¼Œåˆªæ‰é€™è¡Œ
      }
    }

    // B. éœ€è¦å…ˆå¡«ã€Œå¯’æš‘è²¬ä»»é¡å¤©æ•¸ã€çš„æ¬„ä½
    if (t.classList && (t.classList.contains('attend') ||
                        t.classList.contains('camp1')  ||
                        t.classList.contains('camp2'))) {
      const reqDays = parseFloat(requiredDaysEl.value) || 0;
      if (reqDays === 0) {
        alert('è«‹å…ˆå¡«å¯«ã€Œå¯’æš‘è²¬ä»»é¡å¤©æ•¸ã€ï¼Œå†è¼¸å…¥ é»æ•¸ æ¬„ä½ã€‚');
        t.blur();                 // è‹¥åªæƒ³æé†’ï¼Œä¸æƒ³ç¦æ­¢ï¼Œåˆªæ‰é€™è¡Œ
      }
    }
  });

  // å‚™è¨»ï¼šè‹¥ä½¿ç”¨è€…ä¹‹å¾ŒæŠŠæ•¸å€¼æ¸…æˆ 0ï¼Œå†é»å…¥æ¬„ä½ä»æœƒæé†’ï¼Œç¬¦åˆä½ çš„éœ€æ±‚ã€‚
})();
</script>
</body>
</html>
