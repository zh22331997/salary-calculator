<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>æ­£è¯æˆ¶å¤–æˆé•·ç‡Ÿoræ´»å‹•åç‰Œç”¢ç”Ÿå™¨ v0713</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
<style>
body{font-family:'Noto Sans TC',"Microsoft JhengHei",sans-serif;background:#f0f2f5;margin:0;padding:0;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;}
.container{background:#fff;padding:2rem;margin:2rem 1rem;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);max-width:960px;width:100%;box-sizing:border-box;}
h1{margin-top:0;}
h2,h3{color:#333;border-bottom:2px solid #e0e0e0;padding-bottom:0.5rem;margin-top:1.5rem;margin-bottom:1rem;}
input,textarea{width:calc(100% - 1rem);padding:0.75rem;margin-bottom:1rem;border-radius:8px;border:1px solid #ccc;font-size:16px;box-sizing:border-box;transition:border-color 0.3s;}
input:focus,textarea:focus{border-color:#6a9aff;outline:none;}
label{font-weight:bold;display:block;color:#555;margin-bottom:0.5rem;}
.row{display:flex;gap:1.5rem;flex-wrap:wrap;}
.col{flex:1;min-width:280px;}
button{padding:0.8rem 1.5rem;font-size:17px;border:none;border-radius:8px;cursor:pointer;background-color:#4e73df;color:white;margin-right:0.8rem;margin-top:1rem;transition:background-color 0.3s,transform 0.2s;}
button:hover{background-color:#2e59d9;transform:translateY(-2px);}
p{color:#666;font-size:0.95rem;line-height:1.5;}
code{background-color:#f0f0f0;padding:2px 5px;border-radius:4px;font-family:monospace;}
.card-container{display:flex;flex-wrap:wrap;gap:0;justify-content:flex-start;margin-top:0;}
.name-card{width:8.5cm;height:5.5cm;box-sizing:border-box;background:white;border:1px solid #aaa;padding:0.25cm;overflow:hidden;page-break-inside:avoid;flex:none;margin-bottom:0;display:flex;flex-direction:column;justify-content:space-between;align-items:center;text-align:center;position:relative;}
.card-header-top{width:100%;display:flex;justify-content:center;font-size:11.5pt;font-weight:700;color:#333;}
.card-event{font-size:13pt;font-weight:900;color:#000;margin-bottom:0.2cm;}
.card-name{font-size:24pt;font-weight:900;color:#333;line-height:1.1;}
.card-group{font-size:14pt;font-weight:700;color:#555;}
.card-footer{font-size:11pt;color:#444;line-height:1.3;text-align:center;}
.name-card::before{
  content:"";
  position:absolute;
  inset:10%;
  background:url('https://github.com/zh22331997/salary-calculator/blob/main/2019%20zh%20logo.png?raw=true') center/contain no-repeat;
  opacity:0.12;
  z-index:0;
  pointer-events:none;
}
@media print{
  @page{size:A4 portrait;margin:0.8cm;}
  body>*:not(.container),.container>*:not(.card-container){display:none!important;}
  .card-container{flex-wrap:wrap;justify-content:center;}
  .name-card:nth-child(10n+10){page-break-after:always!important;}
  .name-card::before{opacity:0.25!important;}
}
.error-line{background-color:#fff8e6;border-left:4px solid #f0ad4e;padding:4px 8px;margin-bottom:4px;color:#8a6d3b;}
.success-summary{color:#007700;font-weight:bold;margin-top:8px;}
.controls-inline{display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap}
.controls-inline label{display:inline-flex;align-items:center;gap:0.4rem;white-space:nowrap}
@media (max-width:600px){.controls-inline label{white-space:normal;line-height:1.6}}
details summary{cursor:pointer;font-weight:bold;background:#eef2ff;padding:0.5rem 0.8rem;border-radius:6px;}
details p{margin-top:0.5rem;}
</style>
</head>
<body>
<div class="container">
  <h1>æ­£è¯æˆ¶å¤–æ´»å‹•åç‰Œç”¢ç”Ÿå™¨</h1>

  <h2>ğŸ“‹ æ´»å‹•è¨­å®š</h2>
  <div class="row">
    <div class="col">
      <label>åˆ†æ ¡åç¨±</label>
      <input type="text" id="schoolName" value="æ°¸å¹³åˆ†æ ¡">
    </div>
    <div class="col">
      <label>æ´»å‹•åç¨±</label>
      <input type="text" id="eventName" value="æˆ¶å¤–ä¸€æ—¥ç‡Ÿ">
    </div>
  </div>

  <label>å¸¶éšŠä¸»ä»»ï¼ˆå¯å¤šä½ï¼Œè«‹æ›è¡Œè¼¸å…¥ï¼‰</label>
  <textarea id="director" rows="2">OOä¸»ä»»0900-123-456</textarea>

  <h3>ğŸ“š å­¸ç”Ÿè³‡æ–™</h3>

  <details id="infoBox">
    <summary>ğŸ“– é»æˆ‘å±•é–‹ï¼æ”¶åˆèªªæ˜</summary>
    <p>
      âœ… è²¼è³‡æ–™æœ‰å…©ç¨®æ–¹å¼ï¼š<br>
      â‘  å¾ Excelï¼ˆå«æ¨™é¡Œåˆ—ï¼‰è¤‡è£½è²¼ä¸Šï¼Œç³»çµ±æœƒè‡ªå‹•è¾¨è­˜ä»¥ä¸‹è³‡è¨Š <code>åƒåŠ ?ã€å§“åã€è»Šæ¬¡ã€æ¡Œæ¬¡ã€å¸¶éšŠè€å¸«</code>ã€‚<br>
      â‘¡ åªè²¼éœ€è¦çš„æ¬„ä½ï¼ˆå«æ¨™é¡Œåˆ—ï¼‰ï¼š<code>å§“å è»Šæ¬¡ æ¡Œæ¬¡ è€å¸«èˆ‡é›»è©±</code><br><br>
      ğŸ§­ è¦å‰‡ï¼š<br>
      â€¢ <code>ä¸€å®š</code>è¦å¾ Excel è¤‡è£½è²¼ä¸Šã€‚<br>
      â€¢ è‹¥åµæ¸¬åˆ°ã€ŒåƒåŠ ?ã€æ¬„ï¼šç³»çµ±åªæœƒè¼¸å‡ºå‹¾é¸çš„åå–®ã€‚<br>
      â€¢ è‹¥ç„¡åˆ†æ¡Œå¯ä¸è¼¸å…¥ã€Œæ¡Œæ¬¡ã€ã€‚<br>
      â€¢ æ‰‹æ©Ÿè‡ªå‹•è½‰ç‚º <code>09xx-xxx-xxx</code> æ ¼å¼ã€‚<br>
      â€¢ åˆ—å°æ™‚è«‹å‹¾ã€ŒèƒŒæ™¯åœ–å½¢ã€ï¼Œæ‰æœƒæœ‰ LOGOï¼<br>
      â€¢ ä¸»ä»»ï¼‹è€å¸«é›»è©±å…±å¯å››è¡Œï¼›ä¸»ä»»æ˜¯å…±ç”¨æ¬„ï¼Œè€å¸«æ˜¯å€‹åˆ¥æ¬„ã€‚
    </p>
  </details>

  <textarea id="inputArea" rows="8" placeholder="å§“å è»Šæ¬¡ æ¡Œæ¬¡ è€å¸«èˆ‡é›»è©±
ç‹å°æ˜ ç¬¬1è»Š ç¬¬1æ¡Œ Tinaè€å¸« 0900-111-222"></textarea>

  <button onclick="generateCards()">ç”Ÿæˆåç‰Œ</button>
  <button onclick="window.print()">åˆ—å°åç‰Œ</button>
  <button style="background-color:#999" onclick="clearAll()">ğŸ§¹ æ¸…ç©ºå…§å®¹</button>

  <div class="controls-inline" style="margin-top:1rem;">
    <label>
      <input type="checkbox" id="hideTitles"> éš±è—ã€Œå¸¶éšŠè€å¸«ã€èˆ‡ã€Œå¸¶éšŠä¸»ä»»ã€å­—æ¨£
    </label>
  </div>

  <div id="errorMsg" style="margin-top:1rem;"></div>
  <div class="card-container" id="cardContainer"></div>
</div>

<script>
// === å·¥å…·å‡½å¼ ===
function normalizeSpaces(s){return(s||'').toString().replace(/[\u3000\u00A0]/g,' ').trim();}
function extractPhone(t){const m=(t||'').match(/09\d{2}-?\d{3}-?\d{3}/);return m?m[0]:'';}
function stripPhone(t){return normalizeSpaces((t||'').replace(/09\d{2}-?\d{3}-?\d{3}/g,''));}
// æ‰‹æ©Ÿè™Ÿç¢¼çµ±ä¸€ç‚º 09xx-xxx-xxx
function formatPhone(p){
  if(!p) return '';
  const d = p.replace(/[^\d]/g,'');
  if(/^09\d{8}$/.test(d)) return d.replace(/(\d{4})(\d{3})(\d{3})/,'$1-$2-$3');
  return p;
}

// è§£æã€Œå¤šä½è€å¸«ã€æ¬„ä½ï¼šä¾‹å¦‚ã€Œç¥0912-234-456 å¦‚0978-877-878ã€
function parseTeacherField(raw){
  const s = normalizeSpaces(raw || '');
  // æŠ“å¤šçµ„ï¼šå¯å«ç©ºç™½ã€é “è™Ÿã€é€—è™Ÿç­‰ï¼Œåƒ…åŒ¹é…09é–‹é ­
  const re = /([^\d\sã€ï¼Œ]*)\s*(09\d{2}[- ]?\d{3}[- ]?\d{3})/g;
  let m, items = [];
  while((m = re.exec(s)) !== null){
    const name  = (m[1] || '').trim();
    const phone = formatPhone(m[2]);
    items.push([name, phone].filter(Boolean).join(' '));
  }
  // è‹¥æœ‰å¤šä½è€å¸«ï¼Œç”¨é “è™Ÿä¸²æ¥é¡¯ç¤ºï¼ˆè‹¥æƒ³ä¸€è¡Œä¸€ä½å¯æ”¹æˆ <br>ï¼‰
  if(items.length) return items.join('ã€');

  // è‹¥æ•´æ¬„åªåŒ…å«ä¸€ä½æˆ–æ²’åµæ¸¬æˆåŠŸï¼Œé€€å›èˆŠè™•ç†
  const phone = extractPhone(s);
  const name  = stripPhone(s);
  return [name, phone].filter(Boolean).join(' ');
}

function normalizeCar(r){if(!r)return'';let s=r.replace(/\s+/g,'');let m=s.match(/(\d{1,3})/);return m?`ç¬¬${m[1]}è»Š`:s;}
function normalizeTable(r){if(!r)return'';let s=r.replace(/\s+/g,'');let m=s.match(/(\d{1,3})/);return m&&!/æ¡Œ/.test(s)?`ç¬¬${m[1]}æ¡Œ`:s;}
function parseDirectors(raw){return(raw||'').split(/[\n,ï¼Œã€ï¼›;\/]+/g).map(s=>s.trim()).filter(Boolean).map(p=>{
  const ph=(p.match(/09\d{2}-?\d{3}-?\d{3}/)||[])[0];
  return ph?p.replace(ph,ph.replace(/(\d{4})(\d{3})(\d{3})/,'$1-$2-$3')):p;
});}
function isTeacherRow(cells){return cells.some(c=>/è€å¸«|ä¸»ä»»/.test(c||''));}

// === æ¨™é¡Œåˆ¥å ===
const ALIAS={name:['å§“å'],car:['è»Šæ¬¡','è»Š'],table:['æ¡Œæ¬¡','æ¡Œ'],teacher:['å¸¶éšŠè€å¸«','è€å¸«'],participate:['åƒåŠ ?','å‡ºå¸­']};
function buildHeaderIndex(header){
  const h=header.split(/\t+/).map(x=>normalizeSpaces(x));
  const f=a=>h.findIndex(x=>a.some(v=>x.includes(v)));
  return{name:f(ALIAS.name),car:f(ALIAS.car),table:f(ALIAS.table),teacher:f(ALIAS.teacher),participate:f(ALIAS.participate)};
}

// === ä¸»åŠŸèƒ½ ===
function generateCards(){
  const school=document.getElementById('schoolName').value.trim();
  const event=document.getElementById('eventName').value.trim();
  const directorHTML=parseDirectors(document.getElementById('director').value).join('<br>');
  const input=document.getElementById('inputArea').value.trim();
  const box=document.getElementById('cardContainer');
  const msg=document.getElementById('errorMsg');
  box.innerHTML='';msg.innerHTML='';
  if(!input)return;

  const lines=input.split(/\r?\n/).filter(l=>l.trim()!=='');
  let success=0;let onlyTrue=false;
  const idx=buildHeaderIndex(lines[0]);

  if(idx.name!==-1){
    if(idx.participate!==-1){
      onlyTrue=true;
      msg.innerHTML='<div class="success-summary">å·²åµæ¸¬ã€ŒåƒåŠ ?ã€ï¼šåªè¼¸å‡º TRUEã€‚</div>';
    }else{
      msg.innerHTML='<div class="error-line">æœªåµæ¸¬ã€ŒåƒåŠ ?ã€ï¼šè¼¸å‡ºå…¨éƒ¨è³‡æ–™ã€‚</div>';
    }
    for(let i=1;i<lines.length;i++){
      const c=lines[i].split(/\t+/);
      if(isTeacherRow(c))continue;
      if(onlyTrue&&idx.participate>=0){
        const v=c[idx.participate]||'';if(!/^(TRUE|æ˜¯|Y|YES|1)$/i.test(v))continue;
      }
      const name=c[idx.name]||'';if(!name)continue;
      const car=normalizeCar(c[idx.car]||'');
      const table=normalizeTable(c[idx.table]||'');
      const leader = parseTeacherField(c[idx.teacher]||'');
      box.innerHTML+=cardHTML(school,event,name,`${car} ${table}`.trim(),leader,directorHTML);
      success++;
    }
  }else{
    for(const l of lines){
      const m=l.split(/\t+/);
      if(isTeacherRow(m))continue;
      const name=m[0]||'';if(!name)continue;
      const car=normalizeCar(m[1]||'');
      const table=normalizeTable(m[2]||'');
      const leader = parseTeacherField(m[3]||'');
      box.innerHTML+=cardHTML(school,event,name,`${car} ${table}`.trim(),leader,directorHTML);
      success++;
    }
    msg.innerHTML='<div class="error-line">æœªåµæ¸¬æ¨™é¡Œåˆ—ï¼šä½¿ç”¨ç›¸å®¹æ¨¡å¼ã€‚</div>';
  }

  msg.innerHTML+=`<div class="success-summary">âœ… å…±ç”¢ç”Ÿ ${success} å¼µåç‰Œã€‚</div>`;
}

// === å¡ç‰‡æ¨¡æ¿ ===
function cardHTML(school,event,name,group,leader,directorHTML){
  const hideTitles=document.getElementById('hideTitles')?.checked;
  const leaderText=leader?(hideTitles?`${leader}`:`å¸¶éšŠè€å¸«ï¼š${leader}`):'';
  const directorText=directorHTML?(hideTitles?`${directorHTML}`:`å¸¶éšŠä¸»ä»»ï¼š${directorHTML}`):'';
  const footerHTML=[leaderText,directorText].filter(Boolean).map(t=>`<div>${t}</div>`).join('')||'<div>â€”</div>';
  return `<div class="name-card">
    <div class="card-header-top"><span>æ­£è¯å­¸è‹‘</span><span>${school}</span></div>
    <div class="card-event">${event}</div>
    <div class="card-name">${name}</div>
    <div class="card-group">${group||''}</div>
    <div class="card-footer">${footerHTML}</div>
  </div>`;
}

function clearAll(){
  document.getElementById('inputArea').value='';
  document.getElementById('cardContainer').innerHTML='';
  document.getElementById('errorMsg').innerHTML='';
}

// === å‹¾é¸èˆ‡èªªæ˜è¨˜æ†¶ ===
document.addEventListener('DOMContentLoaded',()=>{
  const hide=document.getElementById('hideTitles');
  const info=document.getElementById('infoBox');
  if(hide){
    const saved=localStorage.getItem('hideTitles');
    if(saved!==null)hide.checked=saved==='1';
    hide.addEventListener('change',()=>{
      localStorage.setItem('hideTitles',hide.checked?'1':'0');
      const box=document.getElementById('cardContainer');
      if(!box||box.children.length===0)return;
      const y=window.scrollY;generateCards();window.scrollTo(0,y);
    });
  }
  if(info){
    const openSaved=localStorage.getItem('infoBoxOpen');
    if(openSaved==='1')info.setAttribute('open','');
    info.addEventListener('toggle',()=>{localStorage.setItem('infoBoxOpen',info.open?'1':'0');});
  }
});
</script>
</body>
</html>
