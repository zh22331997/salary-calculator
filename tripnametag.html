<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>正華戶外成長營or活動名牌產生器 v0713</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
<style>
body{font-family:'Noto Sans TC',"Microsoft JhengHei",sans-serif;background:#f0f2f5;margin:0;padding:0;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;}
.container{background:#fff;padding:2rem;margin:2rem 1rem;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);max-width:960px;width:100%;box-sizing:border-box;}
h1{margin-top:0;}
h2,h3{color:#333;border-bottom:2px solid #e0e0e0;padding-bottom:0.5rem;margin-top:1.5rem;margin-bottom:1rem;}
input,textarea{width:calc(100% - 1rem);padding:0.75rem;margin-bottom:1rem;border-radius:8px;border:1px solid #ccc;font-size:16px;box-sizing:border-box;transition:border-color 0.3s;}
input:focus,textarea:focus{border-color:#6a9aff;outline:none;}
label{font-weight:bold;display:block;color:#555;margin-bottom:0.5rem;}
.row{display:flex;gap:1.5rem;flex-wrap:wrap;}
.col{flex:1;min-width:280px;}
button{padding:0.8rem 1.5rem;font-size:17px;border:none;border-radius:8px;cursor:pointer;background-color:#4e73df;color:white;margin-right:0.8rem;margin-top:1rem;transition:background-color 0.3s,transform 0.2s;}
button:hover{background-color:#2e59d9;transform:translateY(-2px);}
p{color:#666;font-size:0.95rem;line-height:1.5;}
code{background-color:#f0f0f0;padding:2px 5px;border-radius:4px;font-family:monospace;}
.card-container{display:flex;flex-wrap:wrap;gap:0;justify-content:flex-start;margin-top:0;}
.name-card{width:8.5cm;height:5.5cm;box-sizing:border-box;background:white;border:1px solid #aaa;padding:0.25cm;overflow:hidden;page-break-inside:avoid;flex:none;margin-bottom:0;display:flex;flex-direction:column;justify-content:space-between;align-items:center;text-align:center;position:relative;}
.card-header-top{width:100%;display:flex;justify-content:center;font-size:11.5pt;font-weight:700;color:#333;}
.card-event{font-size:13pt;font-weight:900;color:#000;margin-bottom:0.2cm;}
.card-name{font-size:24pt;font-weight:900;color:#333;line-height:1.1;}
.card-group{font-size:14pt;font-weight:700;color:#555;}
.card-footer{font-size:11pt;color:#444;line-height:1.3;text-align:center;}
.name-card::before{
  content:"";
  position:absolute;
  inset:10%;
  background:url('https://github.com/zh22331997/salary-calculator/blob/main/2019%20zh%20logo.png?raw=true') center/contain no-repeat;
  opacity:0.12;
  z-index:0;
  pointer-events:none;
}
@media print{
  @page{size:A4 portrait;margin:0.8cm;}
  body>*:not(.container),.container>*:not(.card-container){display:none!important;}
  .card-container{flex-wrap:wrap;justify-content:center;}
  .name-card:nth-child(10n+10){page-break-after:always!important;}
  .name-card::before{opacity:0.25!important;}
}
.error-line{background-color:#fff8e6;border-left:4px solid #f0ad4e;padding:4px 8px;margin-bottom:4px;color:#8a6d3b;}
.success-summary{color:#007700;font-weight:bold;margin-top:8px;}
.controls-inline{display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap}
.controls-inline label{display:inline-flex;align-items:center;gap:0.4rem;white-space:nowrap}
@media (max-width:600px){.controls-inline label{white-space:normal;line-height:1.6}}
details summary{cursor:pointer;font-weight:bold;background:#eef2ff;padding:0.5rem 0.8rem;border-radius:6px;}
details p{margin-top:0.5rem;}
</style>
</head>
<body>
<div class="container">
  <h1>正華戶外活動名牌產生器</h1>

  <h2>📋 活動設定</h2>
  <div class="row">
    <div class="col">
      <label>分校名稱</label>
      <input type="text" id="schoolName" value="永平分校">
    </div>
    <div class="col">
      <label>活動名稱</label>
      <input type="text" id="eventName" value="戶外一日營">
    </div>
  </div>

  <label>帶隊主任（可多位，請換行輸入）</label>
  <textarea id="director" rows="2">OO主任0900-123-456</textarea>

  <h3>📚 學生資料</h3>

  <details id="infoBox">
    <summary>📖 點我展開／收合說明</summary>
    <p>
      ✅ 貼資料有兩種方式：<br>
      ① 從 Excel（含標題列）複製貼上，系統會自動辨識以下資訊 <code>參加?、姓名、車次、桌次、帶隊老師</code>。<br>
      ② 只貼需要的欄位（含標題列）：<code>姓名 車次 桌次 老師與電話</code><br><br>
      🧭 規則：<br>
      • <code>一定</code>要從 Excel 複製貼上。<br>
      • 若偵測到「參加?」欄：系統只會輸出勾選的名單。<br>
      • 若無分桌可不輸入「桌次」。<br>
      • 手機自動轉為 <code>09xx-xxx-xxx</code> 格式。<br>
      • 列印時請勾「背景圖形」，才會有 LOGO！<br>
      • 主任＋老師電話共可四行；主任是共用欄，老師是個別欄。
    </p>
  </details>

  <textarea id="inputArea" rows="8" placeholder="姓名 車次 桌次 老師與電話
王小明 第1車 第1桌 Tina老師 0900-111-222"></textarea>

  <button onclick="generateCards()">生成名牌</button>
  <button onclick="window.print()">列印名牌</button>
  <button style="background-color:#999" onclick="clearAll()">🧹 清空內容</button>

  <div class="controls-inline" style="margin-top:1rem;">
    <label>
      <input type="checkbox" id="hideTitles"> 隱藏「帶隊老師」與「帶隊主任」字樣
    </label>
  </div>

  <div id="errorMsg" style="margin-top:1rem;"></div>
  <div class="card-container" id="cardContainer"></div>
</div>

<script>
// === 工具函式 ===
function normalizeSpaces(s){return(s||'').toString().replace(/[\u3000\u00A0]/g,' ').trim();}
function extractPhone(t){const m=(t||'').match(/09\d{2}-?\d{3}-?\d{3}/);return m?m[0]:'';}
function stripPhone(t){return normalizeSpaces((t||'').replace(/09\d{2}-?\d{3}-?\d{3}/g,''));}
// 手機號碼統一為 09xx-xxx-xxx
function formatPhone(p){
  if(!p) return '';
  const d = p.replace(/[^\d]/g,'');
  if(/^09\d{8}$/.test(d)) return d.replace(/(\d{4})(\d{3})(\d{3})/,'$1-$2-$3');
  return p;
}

// 解析「多位老師」欄位：例如「玥0912-234-456 如0978-877-878」
function parseTeacherField(raw){
  const s = normalizeSpaces(raw || '');
  // 抓多組：可含空白、頓號、逗號等，僅匹配09開頭
  const re = /([^\d\s、，]*)\s*(09\d{2}[- ]?\d{3}[- ]?\d{3})/g;
  let m, items = [];
  while((m = re.exec(s)) !== null){
    const name  = (m[1] || '').trim();
    const phone = formatPhone(m[2]);
    items.push([name, phone].filter(Boolean).join(' '));
  }
  // 若有多位老師，用頓號串接顯示（若想一行一位可改成 <br>）
  if(items.length) return items.join('、');

  // 若整欄只包含一位或沒偵測成功，退回舊處理
  const phone = extractPhone(s);
  const name  = stripPhone(s);
  return [name, phone].filter(Boolean).join(' ');
}

function normalizeCar(r){if(!r)return'';let s=r.replace(/\s+/g,'');let m=s.match(/(\d{1,3})/);return m?`第${m[1]}車`:s;}
function normalizeTable(r){if(!r)return'';let s=r.replace(/\s+/g,'');let m=s.match(/(\d{1,3})/);return m&&!/桌/.test(s)?`第${m[1]}桌`:s;}
function parseDirectors(raw){return(raw||'').split(/[\n,，、；;\/]+/g).map(s=>s.trim()).filter(Boolean).map(p=>{
  const ph=(p.match(/09\d{2}-?\d{3}-?\d{3}/)||[])[0];
  return ph?p.replace(ph,ph.replace(/(\d{4})(\d{3})(\d{3})/,'$1-$2-$3')):p;
});}
function isTeacherRow(cells){return cells.some(c=>/老師|主任/.test(c||''));}

// === 標題別名 ===
const ALIAS={name:['姓名'],car:['車次','車'],table:['桌次','桌'],teacher:['帶隊老師','老師'],participate:['參加?','出席']};
function buildHeaderIndex(header){
  const h=header.split(/\t+/).map(x=>normalizeSpaces(x));
  const f=a=>h.findIndex(x=>a.some(v=>x.includes(v)));
  return{name:f(ALIAS.name),car:f(ALIAS.car),table:f(ALIAS.table),teacher:f(ALIAS.teacher),participate:f(ALIAS.participate)};
}

// === 主功能 ===
function generateCards(){
  const school=document.getElementById('schoolName').value.trim();
  const event=document.getElementById('eventName').value.trim();
  const directorHTML=parseDirectors(document.getElementById('director').value).join('<br>');
  const input=document.getElementById('inputArea').value.trim();
  const box=document.getElementById('cardContainer');
  const msg=document.getElementById('errorMsg');
  box.innerHTML='';msg.innerHTML='';
  if(!input)return;

  const lines=input.split(/\r?\n/).filter(l=>l.trim()!=='');
  let success=0;let onlyTrue=false;
  const idx=buildHeaderIndex(lines[0]);

  if(idx.name!==-1){
    if(idx.participate!==-1){
      onlyTrue=true;
      msg.innerHTML='<div class="success-summary">已偵測「參加?」：只輸出 TRUE。</div>';
    }else{
      msg.innerHTML='<div class="error-line">未偵測「參加?」：輸出全部資料。</div>';
    }
    for(let i=1;i<lines.length;i++){
      const c=lines[i].split(/\t+/);
      if(isTeacherRow(c))continue;
      if(onlyTrue&&idx.participate>=0){
        const v=c[idx.participate]||'';if(!/^(TRUE|是|Y|YES|1)$/i.test(v))continue;
      }
      const name=c[idx.name]||'';if(!name)continue;
      const car=normalizeCar(c[idx.car]||'');
      const table=normalizeTable(c[idx.table]||'');
      const leader = parseTeacherField(c[idx.teacher]||'');
      box.innerHTML+=cardHTML(school,event,name,`${car} ${table}`.trim(),leader,directorHTML);
      success++;
    }
  }else{
    for(const l of lines){
      const m=l.split(/\t+/);
      if(isTeacherRow(m))continue;
      const name=m[0]||'';if(!name)continue;
      const car=normalizeCar(m[1]||'');
      const table=normalizeTable(m[2]||'');
      const leader = parseTeacherField(m[3]||'');
      box.innerHTML+=cardHTML(school,event,name,`${car} ${table}`.trim(),leader,directorHTML);
      success++;
    }
    msg.innerHTML='<div class="error-line">未偵測標題列：使用相容模式。</div>';
  }

  msg.innerHTML+=`<div class="success-summary">✅ 共產生 ${success} 張名牌。</div>`;
}

// === 卡片模板 ===
function cardHTML(school,event,name,group,leader,directorHTML){
  const hideTitles=document.getElementById('hideTitles')?.checked;
  const leaderText=leader?(hideTitles?`${leader}`:`帶隊老師：${leader}`):'';
  const directorText=directorHTML?(hideTitles?`${directorHTML}`:`帶隊主任：${directorHTML}`):'';
  const footerHTML=[leaderText,directorText].filter(Boolean).map(t=>`<div>${t}</div>`).join('')||'<div>—</div>';
  return `<div class="name-card">
    <div class="card-header-top"><span>正華學苑</span><span>${school}</span></div>
    <div class="card-event">${event}</div>
    <div class="card-name">${name}</div>
    <div class="card-group">${group||''}</div>
    <div class="card-footer">${footerHTML}</div>
  </div>`;
}

function clearAll(){
  document.getElementById('inputArea').value='';
  document.getElementById('cardContainer').innerHTML='';
  document.getElementById('errorMsg').innerHTML='';
}

// === 勾選與說明記憶 ===
document.addEventListener('DOMContentLoaded',()=>{
  const hide=document.getElementById('hideTitles');
  const info=document.getElementById('infoBox');
  if(hide){
    const saved=localStorage.getItem('hideTitles');
    if(saved!==null)hide.checked=saved==='1';
    hide.addEventListener('change',()=>{
      localStorage.setItem('hideTitles',hide.checked?'1':'0');
      const box=document.getElementById('cardContainer');
      if(!box||box.children.length===0)return;
      const y=window.scrollY;generateCards();window.scrollTo(0,y);
    });
  }
  if(info){
    const openSaved=localStorage.getItem('infoBoxOpen');
    if(openSaved==='1')info.setAttribute('open','');
    info.addEventListener('toggle',()=>{localStorage.setItem('infoBoxOpen',info.open?'1':'0');});
  }
});
</script>
</body>
</html>
