<!DOCTYPE html>  
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å€‹äººæˆç¸¾å–®ç”¢ç”Ÿå™¨</title>
  <style>
/* ========== Design Tokens ========== */
:root{
  --brand-500:#A1C6EA; --brand-600:#8FB9E2;
  --secondary-500:#BBD1EA; --secondary-600:#A8C5E6;
  --clear-500:#DAE3E5; --clear-600:#CFD9DC;

  --text-strong:#1f2937; --text-normal:#374151; --text-mute:#6b7280;
  --border:#d1d5db; --bg-page:#f0f2f5; --bg-card:#ffffff;

  --font-sans:"Microsoft JhengHei","å¾®è»Ÿæ­£é»‘é«”","Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;

  --radius-lg:12px; --shadow-lg:0 4px 20px rgba(0,0,0,.12);
  --input-height:2.75rem; --btn-height:2.9rem;

  /* ä¸‰å€å­—ç´šï¼ˆå¯ç”±ä¸‹æ‹‰å³æ™‚æ”¹ï¼‰ */
  --fs-personal:14px;
  --fs-rank:14px;
  --fs-teacher:14px;

  /* é è¦½ç´™å¯¬ï¼ˆçµ¦è¢å¹•è¦–è¦ºç”¨ï¼›åˆ—å°æ™‚ä¸ä½¿ç”¨å®ƒï¼‰ */
  --sheet-width-mm:160mm;
}

/* ========== Base ========== */
*{box-sizing:border-box}
html,body{height:100%}
body{font-family:var(--font-sans); background:var(--bg-page); margin:0; padding:0; color:var(--text-normal);}
#controls{
  background:var(--bg-card);
  padding:2rem; margin:2rem auto 1rem; border-radius:var(--radius-lg);
  box-shadow:var(--shadow-lg); max-width:1100px; width:calc(100% - 2rem);
}
h2{margin:0 0 1rem; color:#0056b3; text-align:center; font-weight:800;}
h3{color:var(--text-strong); border-bottom:2px solid #e0e0e0; padding-bottom:.5rem; margin-top:1.25rem; margin-bottom:.75rem;}
label{font-weight:700; color:#555;}
p{color:#444; font-size:.95rem; line-height:1.6}

textarea, input, select{ font-family:inherit; font-size:16px; }
textarea, input[type="text"], input[type="number"], select{
  width:100%; height:var(--input-height); padding:0 .9rem;
  border-radius:8px; border:1px solid var(--border); background:#fff;
}
textarea{ min-height:160px; height:auto; padding:.75rem; line-height:1.5; font-family:var(--font-mono); }
textarea:focus, input:focus, select:focus{ outline:none; box-shadow:0 0 0 3px rgba(106,154,255,.25); border-color:#6a9aff; }

button{
  display:inline-flex; align-items:center; justify-content:center;
  min-height:var(--btn-height); padding:0 1.1rem; font-size:17px; font-weight:700;
  border:none; border-radius:8px; cursor:pointer; color:#17324A;
  background:var(--brand-500); transition:background .15s ease, transform .12s ease, box-shadow .2s;
}
button:hover{ background:var(--brand-600); transform:translateY(-2px) }
.btn-secondary{ background:var(--secondary-500); }
.btn-secondary:hover{ background:var(--secondary-600); }
.btn-clear{ background:var(--clear-500); }
.btn-clear:hover{ background:var(--clear-600); }
.btn-row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:.75rem; }

.small-text{ font-size:10pt; color:var(--text-mute); }
.red-title{ color:#b91c1c; font-weight:bold; margin-top:10px; }

/* ========== é è¦½ï¼šè®“ç•«é¢åƒä¸€å¼µç´™ï¼ˆåƒ…è¢å¹•ç”¨ï¼‰ ========== */
#output{ display:flex; flex-direction:column; align-items:center; gap:24px; padding:16px 0 48px; }
.b5{
  background:#fff; color:#000;
  width:var(--sheet-width-mm); max-width:calc(100% - 32px);
  margin:0 auto; padding:12mm;
  border:1px solid #000; box-shadow:0 2px 18px rgba(0,0,0,.08);
  page-break-inside: avoid;
}

/* ========== è¡¨æ ¼ï¼šå…¨é»‘æ¡†ï¼›th/td å­—ç´šç¹¼æ‰¿ï¼Œæ‰åƒå¾—åˆ°å¯èª¿å­—ç´š ========== */
table{ width:100%; border-collapse:collapse; margin-top:10px; background:#fff; border:1px solid #000; }
th, td{ border:1px solid #000; text-align:center; padding:6px; font-size:inherit; color:#000; background:#fff; }

/* ========== ä¸‰å€å­—ç´šæ›è¼‰é» ========== */
.personal-table{ font-size:var(--fs-personal); }
.rank-table{ font-size:var(--fs-rank); }
.teacher-box{
  border:1px solid #000; padding:8px; white-space:pre-line; line-height:1.6; font-size:var(--fs-teacher);
}
.teacher-box::after{ content:"\A"; white-space:pre; }

/* ç°½åå€ï¼ˆæ‹¿æ‰æ ¼ç·šï¼‰ */
.signature-table{ border:none!important; box-shadow:none!important; background:transparent!important; margin-top:12px; }
.signature-table td, .signature-table th{ border:none!important; background:transparent!important; color:#000; }

/* select ç™½åº•é»‘å­— */
h2 select, p select, #controls select{
  appearance:auto !important; background:#fff !important; color:#000 !important; border:1px solid var(--border) !important;
  height:2rem !important; font-size:14px !important; border-radius:6px !important; padding:0 .5rem !important; width:auto !important;
}

/* ========== åˆ—å°ï¼šåªé  @page æ§ç´™å¼µ/é‚Šç•Œï¼›å…§å®¹ä¸å›ºå®šå¯¬ï¼Œç½®ä¸­æ”¾å¤§ ========== */
@page { size: A4 portrait; margin: 10mm; } /* é è¨­ A4ï¼›JS æœƒè¦†è“‹ç‚º A4/B5 */
@media print{
  html, body{
    width:auto; height:auto; margin:0; padding:0; background:#fff; color:#000;
  }
  #controls{ display:none!important; }
  #output{ display:block; }

  .b5{
    width:auto !important; max-width:none !important;
    margin:0 auto !important; padding:0 !important;
    border:none !important; box-shadow:none !important;
    page-break-after:always; break-after:page;
    background:#fff !important; color:#000 !important;
  }

  *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
  </style>
</head>

<body>

<div id="controls">
  <h2>æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘
    <select id="branch">
      <option>æ°¸å¹³</option><option>ç§€æœ—</option><option>æ¸…æ°´</option><option>æ°¸å’Œ</option><option>æ±Ÿç¿ </option>
    </select>åˆ†æ ¡
  </h2>

  <p style="text-align:center">
    <input id="schoolYear" size="4" readonly>å­¸å¹´
    <select id="grade"><option>ä¸€</option><option selected>äºŒ</option><option>ä¸‰</option><option>å››</option><option>äº”</option><option>å…­</option></select>å¹´ç´š
    <select id="semester"><option>ä¸Š</option><option>ä¸‹</option></select>å­¸æœŸ
    <select id="examType"><option>ä¸­</option><option>æœ«</option></select>è€ƒ å­¸ç”Ÿæˆç¸¾å–®
  </p>

  <h3>è«‹å¾ EXCEL è²¼ä¸Šå…¨ç­æˆç¸¾è³‡æ–™ï¼ˆå«æ¨™é¡Œåˆ—ï¼‰</h3>
  <!-- ä½å¹´ç´šï¼šåœ‹èªã€æ•¸å­¸ç‚ºå¿…å¡«ï¼›ã€ç”Ÿæ´»ã€å¯æœ‰å¯ç„¡ã€‚é«˜å¹´ç´šç¶­æŒäº”ç§‘ -->
  <textarea id="rawInput" placeholder="å§“å[TAB]åœ‹èª[TAB]æ•¸å­¸[ï¼ˆå¯é¸ï¼‰ç”Ÿæ´»][TAB]è‡ªç„¶[TAB]ç¤¾æœƒ[TAB]è‹±æ–‡"></textarea>

  <h3>è«‹å¾ EXCEL è²¼ä¸Šç­å¹³å‡ï¼ˆä¾å¹´ç´šè‡ªå‹•ï¼‰</h3>
  <!-- è‹¥æœ‰ã€ç”Ÿæ´»ã€æ¬„å°±æœƒè®€å–ï¼›æ²’æœ‰å°±ç•¥é -->
  <textarea id="avgPaste" placeholder="ä¸€äºŒå¹´ç´šï¼šåœ‹èª[TAB]æ•¸å­¸[ï¼ˆå¯é¸ï¼‰ç”Ÿæ´»]ï¼›ä¸‰ï½å…­å¹´ç´šï¼šåœ‹èª[TAB]æ•¸å­¸[TAB]è‡ªç„¶[TAB]ç¤¾æœƒ[TAB]è‹±æ–‡"></textarea>

  <div class="small-text" style="margin-top:6px">
    æ­£è¯ç­æ’å‰ <input id="targetIndex" type="number" value="5" style="width:60px; height:2rem"> åï¼ˆè‹¥æœ‰ä¸¦åˆ—ï¼Œæœƒè‡ªå‹•åŒ…å«ï¼‰
  </div>

  <h3>è€å¸«çš„è©±</h3>
  <textarea id="teacherComment" placeholder="è«‹è¼¸å…¥è€å¸«çš„è©±ï¼Œæœƒå‡ºç¾åœ¨æˆç¸¾å–®ä¸Š"></textarea>
  <div id="wordCount" class="small-text" style="margin-top:4px;">ç›®å‰å­—æ•¸ï¼š0 / å»ºè­°ä¸Šé™ 600</div>

  <!-- ä¸‰å€å­—ç´š + ç´™å¼µå°ºå¯¸ -->
  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:12px;">
    <label>å€‹äººæˆç¸¾å­—ç´š
      <select id="fsPersonal">
        <option value="13px">å°</option>
        <option value="14px" selected>ä¸­</option>
        <option value="15px">ä¸­åå¤§</option>
        <option value="16px">å¤§</option>
        <option value="18px">ç‰¹å¤§</option>
      </select>
    </label>
    <label>ç­æ’è¡Œå­—ç´š
      <select id="fsRank">
        <option value="13px">å°</option>
        <option value="14px" selected>ä¸­</option>
        <option value="15px">ä¸­åå¤§</option>
        <option value="16px">å¤§</option>
        <option value="18px">ç‰¹å¤§</option>
      </select>
    </label>
    <label>è€å¸«çš„è©±å­—ç´š
      <select id="fsTeacher">
        <option value="13px">å°</option>
        <option value="14px" selected>ä¸­</option>
        <option value="15px">ä¸­åå¤§</option>
        <option value="16px">å¤§</option>
        <option value="18px">ç‰¹å¤§</option>
      </select>
    </label>
    <label>ç´™å¼µå°ºå¯¸
      <select id="paper">
        <option value="A4" selected>A4 ç›´å¼</option>
        <option value="B5">B5 ç›´å¼</option>
      </select>
    </label>
  </div>

  <div class="btn-row">
    <button onclick="generateReports()">ç”¢ç”Ÿæˆç¸¾å–®</button>
    <button class="btn-secondary" onclick="printAll()">ğŸ–¨ï¸ åˆ—å°æ‰€æœ‰æˆç¸¾å–®</button>
    <button class="btn-clear" onclick="clearAll()">æ¸…ç©º</button>
  </div>
</div>

<div id="output"></div>
<style id="pageStyle"></style>

<script>
/* ====== å·¥å…· & å¹´ç´šç§‘ç›®è¦å‰‡ ====== */
function formatNumber(n){ const f=parseFloat(n); return Number.isNaN(f)?'':(f%1===0?parseInt(f):f.toFixed(2)); }
function num(v){ const x=parseFloat(v); return Number.isNaN(x)?NaN:x; }
function isLowerGrade(g){ return g==='ä¸€'||g==='äºŒ'; }

/* ä½å¹´ç´šï¼šåœ‹èªã€æ•¸å­¸ç‚ºå¿…å¡«ï¼›ç”Ÿæ´»ç‚ºã€Œå¯é¸ã€ */
function getSubjectConfig(grade){
  return isLowerGrade(grade)
    ? [
        {key:'c',label:'åœ‹èª',required:true},
        {key:'m',label:'æ•¸å­¸',required:true},
        {key:'l',label:'ç”Ÿæ´»',required:false} // å¯æœ‰å¯ç„¡
      ]
    : [
        {key:'c',label:'åœ‹èª',required:true},
        {key:'m',label:'æ•¸å­¸',required:true},
        {key:'s',label:'è‡ªç„¶',required:true},
        {key:'so',label:'ç¤¾æœƒ',required:true},
        {key:'e',label:'è‹±æ–‡',required:true}
      ];
}

/* è§£æä¸€æ ¼åˆ†æ•¸ï¼š'æœªè€ƒ' æˆ–ç©ºç™½ â†’ absentï¼›æ•¸å­— â†’ value */
function parseCell(raw){
  const t = (raw??'').toString().trim();
  if (!t || t==='æœªè€ƒ') return { absent:true, value:NaN };
  const v = parseFloat(t);
  if (Number.isNaN(v)) return { absent:true, value:NaN };
  return { absent:false, value:v };
}
function displayScoreCell(raw){
  const {absent, value} = parseCell(raw);
  return absent ? 'æœ¬æ¬¡æœªè€ƒ' : formatNumber(value);
}

/* æ”¯æ´ã€Œå§“åï¼å­¸ç”Ÿï¼nameï¼studentã€ï¼›å„ç§‘æ¨™é¡Œå°æ‡‰ï¼ˆå«ã€ç”Ÿæ´»ã€ï¼‰ */
function buildHeaderMap(headers, grade, dataFirstRow){
  const map = { name: 0 };
  headers.forEach((t,idx)=>{
    const title=(t||'').trim(); const low=title.toLowerCase();
    if (title.includes('å§“å') || title.includes('å­¸ç”Ÿ') || low==='name' || low==='student') map.name=idx;
  });
  getSubjectConfig(grade).forEach(sub=>{
    headers.forEach((t,idx)=>{ const title=(t||'').trim(); if(title.includes(sub.label)) map[sub.key]=idx; });
  });
  const isNumeric = s => /^\s*\d+(\.\d+)?\s*$/.test(s||'');
  const hasNameHeader = headers.some(h=>{ const s=String(h||''); const low=s.toLowerCase(); return s.includes('å§“å')||s.includes('å­¸ç”Ÿ')||low==='name'||low==='student'; });
  if (!hasNameHeader && Array.isArray(dataFirstRow) && dataFirstRow.length){
    let guess = dataFirstRow.findIndex(v=>!isNumeric(v));
    if (guess === -1 && dataFirstRow.length>1) guess = 1;
    if (guess >= 0) map.name = guess;
  }
  return map;
}

/* æª¢æŸ¥æŸç§‘æ˜¯å¦ã€Œæ•´æ¬„æœªè€ƒã€ */
function subjectColumnAllAbsent(students, colIdx){
  if (typeof colIdx!=='number') return false;
  return students.every(row => parseCell(row[colIdx]).absent);
}

/* ====== ç”¢ç”Ÿæˆç¸¾å–® ====== */
function generateReports(){
  const branch=document.getElementById("branch").value;
  const schoolYear=document.getElementById("schoolYear").value;
  const grade=document.getElementById("grade").value;
  const semester=document.getElementById("semester").value;
  const examType=document.getElementById("examType").value;
  const comment=document.getElementById("teacherComment").value;
  const topN=parseInt(document.getElementById("targetIndex").value)||5;

  const subjectsBase=getSubjectConfig(grade);

  /* è®€åŸå§‹è³‡æ–™ */
  const raw=document.getElementById("rawInput").value.trim();
  if(!raw){ alert("è«‹å…ˆè²¼ä¸Šå…¨ç­æˆç¸¾è³‡æ–™ï¼ˆå«æ¨™é¡Œåˆ—ï¼‰ã€‚"); return; }
  const lines=raw.split("\n").filter(l=>l.trim().length>0);
  if(lines.length<2){ alert("è³‡æ–™ç­†æ•¸ä¸è¶³ï¼Œè«‹ç¢ºèªè‡³å°‘åŒ…å«æ¨™é¡Œåˆ—èˆ‡ä¸€ä½å­¸ç”Ÿè³‡æ–™ã€‚"); return; }

  const headers=lines[0].split("\t");
  const students=lines.slice(1).map(l=>l.split("\t"));
  const firstData=students[0]||[];
  const headerMap=buildHeaderMap(headers,grade,firstData);

  /* å¿…å¡«æ¬„ä½æª¢æŸ¥ï¼ˆä½å¹´ç´šåªæª¢æŸ¥åœ‹èª/æ•¸å­¸ï¼›ç”Ÿæ´»ç‚ºé¸å¡«ï¼‰ */
  const withIndex = subjectsBase.map(s => ({...s, idx: headerMap[s.key]}));
  const missingRequired = withIndex
    .filter(s => s.required && typeof s.idx!=='number')
    .map(s=>s.label);
  if(missingRequired.length){
    alert(`æ‰¾ä¸åˆ°å¿…è¦æ¬„ä½ï¼š${missingRequired.join('ã€')}ã€‚\nè«‹ç¢ºèªæ¨™é¡Œåˆ—æ˜¯å¦åŒ…å«é€™äº›æ¬„ä½ã€‚`);
    return;
  }

  /* å‹•æ…‹å•Ÿç”¨ç§‘ç›®ï¼šéœ€ã€Œæœ‰æ¬„ä½ã€ä¸”éæ•´æ¬„æœªè€ƒï¼›é¸å¡«çš„ã€ç”Ÿæ´»ã€è‹¥æ²’è²¼æˆ–æ•´æ¬„æœªè€ƒï¼Œå°±è‡ªå‹•ç•¥é */
  const activeSubjects = withIndex.filter(s => typeof s.idx==='number' && !subjectColumnAllAbsent(students, s.idx));
  if (activeSubjects.length===0){
    alert("åµæ¸¬åˆ°æ‰€æœ‰ç§‘ç›®æ•´æ¬„çš†ç‚ºã€æœªè€ƒã€ã€‚è«‹è‡³å°‘æœ‰ä¸€ç§‘æœ‰æˆç¸¾ï¼Œæˆ–ç§»é™¤ä¸å¿…è¦çš„æ¬„ä½ã€‚");
    return;
  }

  /* è§£æç­å¹³å‡ï¼ˆåªå° activeSubjectsï¼›è‹¥æœªè²¼æˆ–æœªè€ƒå‰‡ç•¥éï¼‰ */
  const avgRaw=document.getElementById("avgPaste").value.trim().split("\t");
  const avgVals = activeSubjects.map((sub, i)=>{
    const rawVal = avgRaw[sub.idx] ?? avgRaw[i]; // å˜—è©¦ä»¥æ¬„ä½ç´¢å¼•ï¼›ä¸è¡Œå°±ä»¥é †åºå®¹éŒ¯
    const {absent, value} = parseCell(rawVal);
    return absent ? NaN : value;
  });
  const avgIncluded = avgVals.filter(v=>!Number.isNaN(v));
  const avgTotal = avgIncluded.reduce((a,b)=>a+b,0);
  const avgAverage = avgIncluded.length ? avgTotal/avgIncluded.length : 0;

  /* é€ç”Ÿè¨ˆç®—ï¼ˆåƒ…å° activeSubjectsï¼›å€‹åˆ¥æ ¼è‹¥æœªè€ƒå‰‡ç•¥éï¼‰ */
  const scoreList=students.map(row=>{
    const subsRaw = activeSubjects.map(sub => row[sub.idx]);
    const parsed = subsRaw.map(parseCell);
    const includedValues = parsed.filter(x=>!x.absent).map(x=>x.value);
    const total = includedValues.reduce((a,b)=>a+b,0);
    const avg = includedValues.length ? total / includedValues.length : 0;
    const name = row[headerMap.name] || row[0] || '';
    return { name, row, subsRaw, parsed, total, avg };
  }).sort((a,b)=>b.total-a.total);

  /* å‰ N åï¼ˆå«ä¸¦åˆ—ï¼‰ */
  const cutoff=scoreList.length>=topN?scoreList[topN-1].total:0;
  const topStudents=scoreList.filter(stu=>stu.total>=cutoff);

  /* ====== è¼¸å‡º ====== */
  const output=document.getElementById("output");
  output.innerHTML="";

  scoreList.forEach(student=>{
    let currentRank=1,lastScore=null,displayRank=1;
    const topRows=topStudents.map(stu=>{
      if(lastScore!==null && stu.total<lastScore){ displayRank=currentRank; }
      lastScore=stu.total; currentRank++;
      const cells=activeSubjects.map((s,idx)=>`<td>${displayScoreCell(stu.subsRaw[idx])}</td>`).join("");
      return `<tr><td>${displayRank}</td><td>${stu.name}</td>${cells}<td>${formatNumber(stu.total)}</td><td>${formatNumber(stu.avg)}</td></tr>`;
    }).join("");

    const theadCols=['å­¸ç”Ÿ'].concat(activeSubjects.map(s=>s.label)).concat(['ç¸½åˆ†','å¹³å‡']);
    const theadHtml=theadCols.map(t=>`<th>${t}</th>`).join("");
    const personCells=activeSubjects.map((s,idx)=>`<td>${displayScoreCell(student.subsRaw[idx])}</td>`).join("");
    const avgCells=activeSubjects.map((s,idx)=> isNaN(avgVals[idx]) ? `<td>æœ¬æ¬¡æœªè€ƒ</td>` : `<td>${formatNumber(avgVals[idx])}</td>`).join("");
    const rankHead=['åæ¬¡','å§“å'].concat(activeSubjects.map(s=>s.label)).concat(['ç¸½åˆ†','å¹³å‡']).map(t=>`<th>${t}</th>`).join("");

    const page=`
    <div class="b5">
      <h2 style="text-align:center; margin-bottom:4px; line-height:1.2;">æ­£è¯è³‡å„ªæ•™è‚²å­¸è‹‘ ${branch}åˆ†æ ¡</h2>
      <p style="text-align:center; margin-top:0; line-height:1.2;">${schoolYear}å­¸å¹´${semester}å­¸æœŸ æœŸ${examType}è€ƒ ${grade}å¹´ç´šå­¸ç”Ÿå€‹äººæˆç¸¾å–®</p>

      <table class="personal-table">
        <tr>${theadHtml}</tr>
        <tr>
          <td>${student.name}</td>
          ${personCells}
          <td>${formatNumber(student.total)}</td>
          <td>${formatNumber(student.avg)}</td>
        </tr>
        <tr>
          <td>ç­å¹³å‡</td>
          ${avgCells}
          <td>${formatNumber(avgTotal)}</td>
          <td>${formatNumber(avgAverage)}</td>
        </tr>
      </table>

      <div class="red-title">æ­£è¯ç­æ’å‰${topN}å</div>
      <table class="rank-table">
        <tr>${rankHead}</tr>
        ${topRows}
      </table>

      <p><strong>è€å¸«çš„è©±ï¼š</strong></p>
      <div class="teacher-box">${comment}</div>

      <table class="signature-table" style="width:100%; font-size:10pt; border-collapse:collapse;">
        <tr>
          <td style="width:33%; text-align:left;">ç­ä¸»ä»»ï¼š</td>
          <td style="width:33%; text-align:left;">å°å¸«ï¼š</td>
          <td style="width:33%; text-align:left;">å®¶é•·ç°½åï¼š</td>
        </tr>
      </table>
    </div>`;
    output.innerHTML += page;
  });

  applyFontSizes(); // ç”¢ç”Ÿå¾ŒåŒæ­¥å­—ç´š
}

/* æ¸…ç©º */
function clearAll(){
  document.getElementById("rawInput").value="";
  document.getElementById("avgPaste").value="";
  document.getElementById("teacherComment").value="";
  document.getElementById("wordCount").innerText="ç›®å‰å­—æ•¸ï¼š0 / å»ºè­°ä¸Šé™ 600";
  document.getElementById("targetIndex").value=5;
  document.getElementById("output").innerHTML="";
}

/* å­—ç´šæ§åˆ¶ï¼ˆå³æ™‚ï¼‰ */
function applyFontSizes(){
  document.documentElement.style.setProperty('--fs-personal', document.getElementById('fsPersonal').value);
  document.documentElement.style.setProperty('--fs-rank', document.getElementById('fsRank').value);
  document.documentElement.style.setProperty('--fs-teacher', document.getElementById('fsTeacher').value);
}

/* ç´™å¼µå°ºå¯¸ï¼ˆA4/B5ï¼‰ï¼šåªå½±éŸ¿ @page èˆ‡ã€Œé è¦½ç´™å¯¬ã€ï¼Œå°åˆ·çœŸæ­£å¯¬åº¦äº¤çµ¦ @page æ§åˆ¶ */
function applyPaper(){
  const paper = document.getElementById('paper')?.value || 'A4';
  const styleEl = document.getElementById('pageStyle');
  const margin = '10mm';

  if (paper === 'B5'){
    document.documentElement.style.setProperty('--sheet-width-mm', '156mm'); // é è¦½å¤–è§€
    styleEl.textContent = `@page{ size:B5 portrait; margin:${margin}; }`;
  }else{
    document.documentElement.style.setProperty('--sheet-width-mm', '190mm'); // é è¦½å¤–è§€
    styleEl.textContent = `@page{ size:A4 portrait; margin:${margin}; }`;
  }
}

/* åˆ—å°æé†’ */
function printAll(){
  alert(
    "åˆ—å°å°æé†’ï¼š\n\n" +
    "1) ã€æ›´å¤šè¨­å®šã€ç´™å¼µå°ºå¯¸è¦èˆ‡é¸å–®ç›¸åŒï¼ˆA4 æˆ– B5ï¼‰ã€‚\n" +
    "2) ç¸®æ”¾æ¯”ä¾‹å»ºè­° 100%ï¼ˆæƒ³å¤§å°± 110%ã€120%â€¦ï¼‰ï¼Œæœƒä»¥é é¢ä¸­å¿ƒç½®ä¸­æ”¾å¤§ã€‚\n" +
    "3) é‚Šç•Œç”¨ 10mmï¼ˆæˆ‘å€‘ç”¨ @page æ§åˆ¶ï¼‰ï¼Œé é¦–é å°¾é—œé–‰ã€‚\n\n" +
    "è«‹ç¢ºèªé è¦½æ˜¯ä¸€é ä¸€å¼µæˆç¸¾å–®å†åˆ—å°ã€‚"
  );
  window.print();
}

/* é è¨­èˆ‡ç›£è½ */
window.addEventListener("DOMContentLoaded",()=>{
  const now=new Date(), y=now.getFullYear(), m=now.getMonth()+1;
  const semesterYear=(m>=8||m===1)?(y-1911):(y-1912);
  const semester=(m>=8||m===1)?"ä¸Š":"ä¸‹";
  let examType="ä¸­";
  if((m>=1&&m<=2)||(m>=5&&m<=6)) examType="æœ«";
  else if((m>=11&&m<=12)||(m>=4&&m<=5)) examType="ä¸­";
  document.getElementById("schoolYear").value=semesterYear;
  document.getElementById("semester").value=semester;
  document.getElementById("examType").value=examType;

  // å­—æ•¸è¨ˆç®—
  const tc=document.getElementById("teacherComment");
  tc.addEventListener("input",()=>{
    const c=tc.value.length;
    const w=document.getElementById("wordCount");
    w.innerText=`ç›®å‰å­—æ•¸ï¼š${c} / å»ºè­°ä¸Šé™ 600`;
    w.style.color=c>600?'red':'#6b7280';
  });

  // å­—ç´šå³æ™‚
  ['fsPersonal','fsRank','fsTeacher'].forEach(id=>{
    document.getElementById(id).addEventListener('change', applyFontSizes);
  });
  applyFontSizes();

  // ç´™å¼µå°ºå¯¸
  document.getElementById('paper').addEventListener('change', applyPaper);
  applyPaper();
});
</script>

</body>
</html>
