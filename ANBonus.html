<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è¨ˆç®—èª²è¼”å¸¶ç­æ´¥è²¼</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      padding: 2em;
      background: #fafafa;
    }
    h1, h2 {
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: center;
      vertical-align: middle;
    }
    th {
      padding: 4px;
    }
    input[type="number"], input[type="text"] {
      width: 6em;
      padding: 0.2em;
      font-size: 1em;
      text-align: center;
      border: 1px solid #bbb;
      border-radius: 3px;
    }
    input[type="number"].rate {
      width: 5em;
    }
    button {
      margin-right: 0.5em;
      margin-top: 0.8em;
      padding: 0.5em 1em;
      font-size: 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #3498db;
      color: white;
    }
    button:hover {
      background-color: #2980b9;
    }
    .section-title td {
      background-color: #d6e9ff;
      font-weight: bold;
      text-align: left;
      font-size: 1.1em;
      padding-left: 0.5em;
    }
    .thead-group-semester {
      background-color: #e0f7fa;
    }
    .thead-group-sub {
      background-color: #fff3e0;
    }
    .thead-group-summer {
      background-color: #f3e5f5;
    }
    #rows tr td.thead-group-semester {
    background-color: #f1fcfd; /* æ·ºä¸€é»çš„è—ç¶ è‰² */
    }
    #rows tr td.thead-group-sub {
    background-color: #fff8ee; /* æ·ºä¸€é»çš„ç±³é»ƒè‰² */
    }
    #rows tr td.thead-group-summer {
    background-color: #faf3fb; /* æ·ºä¸€é»çš„ç²‰ç´«è‰² */
    }
    #rows tr td.thead-group-monthly {
    background-color: #ffffff; /* æˆ–è€…çµ±ä¸€ç™½åº• */
    }
    
    th.teacher, td .teacher input { width: 9em; }
    th.crossSchool, td .crossSchool input { width: 5em; }
    th.persons, td .persons input { width: 5em; }
    th.fullBonus, td.fullBonus { width: 6em; }
    th.partialDays, td .partialDays input { width: 5em; }
    th.partialBonus, td.partialBonus { width: 6em; }
    th.rate, td .rate input { width: 5em; }
    th.semTotal, td.semTotal { width: 7em; }
    th.subDays, td .subDays input { width: 5em; }
    th.subHours, td .subHours input { width: 5em; }
    th.subTotal, td.subTotal { width: 6em; }
    th.attend, td .attend input { width: 5em; }
    th.camp1, td .camp1 input { width: 5em; }
    th.camp2, td .camp2 input { width: 5em; }
    th.vacBonus, td.vacBonus { width: 7em; }
    th.finalBonus, td.finalBonus { width: 7em; }
    /* æ–°å¢ä¸€å€‹ CSS é¡åˆ¥ä¾†é¡¯ç¤ºç®—å¼ */
    .finalBonusFormula {
        font-size: 0.8em; /* è®“ç®—å¼æ–‡å­—å°ä¸€é» */
        color: #555;
        text-align: left; /* ç®—å¼é å·¦å°é½Š */
        word-break: break-all; /* é˜²æ­¢æ–‡å­—æº¢å‡º */
    }
  </style>
</head>
<body>
  <h1>è¨ˆç®—èª²è¼”å¸¶ç­æ´¥è²¼</h1>

  <h2>éå¿…å¡«çš„è¨­å®š</h2>
  <label>æœ¬æœˆå·¥ä½œå¤©æ•¸ï¼š
    <input type="number" id="workdays" value="0" min="0" oninput="recalcAll()" />
  </label>
  <label style="margin-left:1em;">å¯’æš‘è²¬ä»»é¡å¤©æ•¸ï¼š
    <input type="number" id="requiredDays" value="0" min="0" oninput="recalcAll()" />
  (æš‘å‡ç”¨17å¤©)
  </label>
  <br />
  <h2>æ‰¹æ¬¡æ–°å¢ç­ç´š/å°å¸«</h2>
<textarea id="batchInput" rows="3" style="width: 100%;" placeholder="è«‹è²¼ä¸Šç©ºæ ¼åˆ†éš”çš„ç­ç´šæˆ–å°å¸«åå­—ï¼Œä¾‹å¦‚ï¼š1A 1B APPLEè€å¸«"></textarea>
<br />
<button onclick="batchAddTeachers()">æ‰¹æ¬¡æ–°å¢ç­ç´š/å°å¸«åˆ—</button>
<button onclick="addRow()">â• æ–°å¢ç­ç´š/è€å¸«</button>
<button onclick="removeEmptyRows()">ğŸ—‘ï¸ åˆªé™¤ç©ºç™½åˆ—</button>

  <button onclick="copyTable()">ğŸ“‹ è¤‡è£½è¡¨æ ¼</button>
  <button onclick="exportCSV()">ğŸ’¾ åŒ¯å‡º CSV</button>

  <table id="dataTable" role="grid" aria-label="æ•™å¸«æ´¥è²¼è¨ˆç®—è¡¨">
    <thead>
      <tr>
        <th class="thead-group-monthly" style="background-color: white;">å°å¸«</th>
        <th class="thead-group-semester">æ˜¯å¦è·¨æ ¡</th>
        <th class="thead-group-semester">å…¨æœˆäººæ•¸</th>
        <th class="thead-group-semester">å…¨æœˆæ´¥è²¼</th>
        <th class="thead-group-semester">éå…¨æœˆå­¸ç”Ÿ<br>ç¸½å…±å¹¾å¤©</th>
        <th class="thead-group-semester">éå…¨æœˆæ´¥è²¼</th>
        <th class="thead-group-semester">å­¸æœŸå¤©æ¯”ä¾‹</th>
        <th class="thead-group-semester">å­¸æœŸæ´¥è²¼</th>

        <th class="thead-group-sub">å­¸æœŸé–“ä»£èª²å¤©</th>
        <th class="thead-group-sub">å­¸æœŸé–“ä»£èª²æ™‚</th>
        <th class="thead-group-sub">å­¸æœŸé–“ä»£èª²æ‰£é™¤</th>

        <th class="thead-group-summer">é»åè¡¨é»æ•¸</th>
        <th class="thead-group-summer">ä¸€æ—¥ç‡Ÿ(1)é»æ•¸</th>
        <th class="thead-group-summer">ä¸€æ—¥ç‡Ÿ(2)é»æ•¸</th>
        <th class="thead-group-summer">å¯’æš‘æ´¥è²¼</th>

        <th class="thead-group-monthly" style="background-color: white;">æœ¬æœˆæ´¥è²¼<br>è¨ˆç®—å¼</th>
      </tr>
    </thead>
    <tbody id="rows">
      </tbody>
  </table>

<script>
function batchAddTeachers() {
  const input = document.getElementById('batchInput').value.trim();
  if (!input) {
    alert('è«‹å…ˆè¼¸å…¥ç­ç´š/å°å¸«ï¼');
    return;
  }
  const names = input.split(/\s+/);
  names.forEach(name => {
    if(name) {
      addRow();
      const tbody = document.getElementById('rows');
      const lastRow = tbody.lastElementChild;
      const teacherInput = lastRow.querySelector('input.teacher');
      if(teacherInput) teacherInput.value = name;
    }
  });
  recalcAll();
  document.getElementById('batchInput').value = '';
}

function calcGrade(persons, isCrossSchool) {
  let baseGrade26 = 650;
  let baseGrade21 = 600;
  let baseGrade15 = 550;

  if (isCrossSchool) {
    baseGrade26 += 50;
    baseGrade21 += 50;
    baseGrade15 += 50;
  }

  if (persons >= 26) return baseGrade26;
  if (persons >= 21) return baseGrade21;
  if (persons >= 15) return baseGrade15;
  return 0;
}

function calcRow(row) {
  const workdays = parseFloat(document.getElementById('workdays').value) || 0;
  const requiredDays = parseFloat(document.getElementById('requiredDays').value) || 0;

  const getNum = (cls) => {
    const el = row.querySelector(`.${cls}`);
    if (!el) return 0;
    if (el.tagName === 'INPUT' && el.type === 'checkbox') return el.checked ? 1 : 0;
    if (el.tagName === 'INPUT') return parseFloat(el.value) || 0;
    return parseFloat(el.textContent) || 0;
  };

  const persons = getNum('persons');
  const isCrossSchool = row.querySelector('.crossSchool').checked;
  const grade = calcGrade(persons, isCrossSchool);

  const partialDays = getNum('partialDays');
  const partialBonus = (workdays > 0 && partialDays > 0)
  ? grade * partialDays / workdays
  : 0;


  let semRate = getNum('rate');
if (isNaN(semRate)) semRate = 1; // åªåœ¨æ²’å¡«æ™‚ç”¨ 1


  const subDays = getNum('subDays');
  if (subDays > workdays) {
  alert(`âš ï¸ ä»£èª²å¤©æ•¸ï¼ˆ${subDays}ï¼‰ä¸å¯å¤§æ–¼æœ¬æœˆå·¥ä½œå¤©æ•¸ï¼ˆ${workdays}ï¼‰`);
  row.querySelector('.subDays').value = workdays;
  }
  const subHours = getNum('subHours');
  const attendPts = getNum('attend');
  const camp1Pts = getNum('camp1');
  const camp2Pts = getNum('camp2');

  const fullBonus = (persons > 15) ? (persons - 15) * grade : 0;
  const semTotal = (fullBonus + partialBonus) * semRate;

  const subTotal = (workdays > 0)
  ? (semTotal / workdays) * subDays + (semTotal / workdays / 8) * subHours
  : 0;


  let campTotalRaw = attendPts + camp1Pts + camp2Pts - 15 * requiredDays;
  let campTotal = Math.max(0, campTotalRaw);
  const vacBonus = campTotal * 36;

  const finalBonus = semTotal - subTotal + vacBonus;

  row.querySelector('.fullBonus').textContent = fullBonus.toFixed(0);
  row.querySelector('.partialBonus').textContent = partialBonus.toFixed(0);
  row.querySelector('.semTotal').textContent = semTotal.toFixed(0);
  row.querySelector('.subTotal').textContent = subTotal.toFixed(0);
  row.querySelector('.vacBonus').textContent = vacBonus > 0 ? vacBonus.toFixed(0) : 'æœªé”è²¬ä»»é¡';
  row.querySelector('.finalBonusValue').textContent = finalBonus.toFixed(0);

  // --- ç”¢ç”Ÿç®—å¼æ–‡å­—çš„é‚è¼¯ä¿®æ”¹ ---
  let formulaParts = [];

  // 1. å­¸æœŸæ´¥è²¼éƒ¨åˆ† (semester bonus)
  let semBonusComponents = [];
  if (persons > 15) {
      semBonusComponents.push(`$${grade} * (${persons} - 15)`);
  }
  if (partialDays > 0) {
      semBonusComponents.push(`$${grade} * ${partialDays} / ${workdays}`);
  }

  if (semBonusComponents.length > 0) {
      let semBonusFormula = semBonusComponents.join(' + ');
      if (semRate !== 1) {
          semBonusFormula = `[${semBonusFormula}] * ${semRate.toFixed(3)}`;
      }
      formulaParts.push(semBonusFormula);
  }


  // 2. ä»£èª²æ‰£é™¤éƒ¨åˆ† (substitution deduction)
  if (subDays > 0 || subHours > 0) {
      let subDeductionText = ' - è«‹ä»£èª²';
      if (subDays > 0) {
          subDeductionText += `${subDays}å¤©`;
      }
      if (subHours > 0) {
          subDeductionText += `${subHours}å°æ™‚`;
      }
      subDeductionText += `$${subTotal.toFixed(0)}`;
      formulaParts.push(subDeductionText);
  } else if (subTotal > 0.01) { // æµ®é»æ•¸èª¤å·®å°è‡´çš„å¾®å°æ‰£é™¤é¡
      formulaParts.push(` - ä»£èª²æ‰£é™¤$${subTotal.toFixed(0)}`);
  }


  // 3. å¯’æš‘æ´¥è²¼éƒ¨åˆ† (vacation bonus)
  let vacBonusPtsComponents = [];
  if (attendPts > 0) {
      vacBonusPtsComponents.push(`${attendPts}`);
  }
  if (camp1Pts > 0) {
      vacBonusPtsComponents.push(`${camp1Pts}`);
  }
  if (camp2Pts > 0) {
      vacBonusPtsComponents.push(`${camp2Pts}`);
  }

  if (campTotalRaw < 0) {
      if (attendPts > 0 || camp1Pts > 0 || camp2Pts > 0) {
          formulaParts.push(` (é»æ•¸${vacBonusPtsComponents.join('+')}æœªé”è²¬ä»»é¡ ${15 * requiredDays}é»)`);
      }
  } else if (vacBonus > 0) {
      let vacBonusExpr = `${vacBonusPtsComponents.join('+')}`;
      if (requiredDays > 0) {
          vacBonusExpr += `-15*${requiredDays}`;
      }
      formulaParts.push(` + $36*(${vacBonusExpr})`);
  }

  let finalFormula = formulaParts.join('');
  if (finalFormula === '') {
      finalFormula = 'ç„¡æ´¥è²¼ç”¢ç”Ÿ';
  }

  // å°‡æœ€çµ‚çµæœèˆ‡ç®—å¼çµ„åˆ
  row.querySelector('.finalBonusFormula').textContent = `${finalBonus.toFixed(0)}=${finalFormula}`;
  // --- ç®—å¼æ–‡å­—ç”ŸæˆçµæŸ ---
}
function recalcAll() {
  const rows = document.querySelectorAll('#rows tr');
  rows.forEach(calcRow);
}

function addRow() {
  const tbody = document.getElementById('rows');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="thead-group-monthly"><input type="text" class="teacher" placeholder="å°å¸«" /></td>
    <td class="thead-group-semester"><input type="checkbox" class="crossSchool" onchange="recalcAll()" /></td>
    <td class="thead-group-semester"><input type="number" class="persons" min="0" value="15" oninput="recalcAll()" /></td>
    <td class="thead-group-semester fullBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="partialDays" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-semester partialBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="rate" step="0.001" min="0" max="1" value="1" oninput="recalcAll()" /></td>
    <td class="thead-group-semester semTotal">0</td>

    <td class="thead-group-sub"><input type="number" class="subDays" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-sub"><input type="number" class="subHours" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-sub subTotal">0</td>

    <td class="thead-group-summer"><input type="number" class="attend" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-summer"><input type="number" class="camp1" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-summer"><input type="number" class="camp2" min="0" value="0" oninput="recalcAll()" /></td>
    <td class="thead-group-summer vacBonus">æœªé”è²¬ä»»é¡</td>

    <td class="thead-group-monthly finalBonus">
      <span class="finalBonusValue" style="display:none;">0</span><br>
      <span class="finalBonusFormula"></span>
    </td>
  `;
  tbody.appendChild(tr);
  recalcAll();
}


function copyTable() {
  const table = document.getElementById('dataTable');
  let text = '';
  const headerCells = [...table.querySelector('thead tr').cells].map(c => c.textContent.trim());
  text += headerCells.join('\t') + '\n';

  const rows = document.querySelectorAll('#rows tr');
  rows.forEach(row => {
    const cells = [];
    row.querySelectorAll('td').forEach(td => {
      const input = td.querySelector('input, select');
      if (input) {
        if (input.type === 'checkbox') {
          cells.push(input.checked ? 'æ˜¯' : 'å¦');
        } else {
          cells.push(input.value);
        }
      } else {
          if (td.classList.contains('finalBonus')) {
              // é€™è£¡åªè¤‡è£½å…¬å¼éƒ¨åˆ†
              const formula = td.querySelector('.finalBonusFormula').textContent;
              cells.push(formula);
          } else {
              cells.push(td.textContent.trim());
          }
      }
    });
    text += cells.join('\t') + '\n';
  });

  navigator.clipboard.writeText(text).then(() => {
    alert('è¡¨æ ¼å·²è¤‡è£½ï¼Œå¯è²¼ä¸Šè‡³ Excel æˆ– Google Sheets');
  });
}

function exportCSV() {
  const rows = document.querySelectorAll('#rows tr');
  const workdays = document.getElementById('workdays').value;
  const requiredDays = document.getElementById('requiredDays').value;
  let csv = `ç­ç´š,å°å¸«,æ˜¯å¦è·¨æ ¡,å…¨æœˆäººæ•¸,å…¨æœˆæ´¥è²¼,éå…¨æœˆå¤©æ•¸,éå…¨æœˆæ´¥è²¼,å­¸æœŸå¤©æ¯”ä¾‹,å­¸æœŸæ´¥è²¼,ä»£èª²å¤©,ä»£èª²æ™‚,ä»£èª²æ‰£é™¤,é»åè¡¨é»æ•¸,ä¸€æ—¥ç‡Ÿ1é»æ•¸,ä¸€æ—¥ç‡Ÿ2é»æ•¸,å¯’æš‘æ´¥è²¼,æœ¬æœˆæ´¥è²¼è¨ˆç®—å¼\n`; // ç§»é™¤ç´”æ•¸å€¼æ¬„ä½

  rows.forEach(row => {
    const getText = cls => {
      const el = row.querySelector(`.${cls}`);
      if (!el) return '';
      if (el.tagName === 'INPUT' && el.type === 'checkbox') return el.checked ? 'æ˜¯' : 'å¦';
      if (el.tagName === 'INPUT' || el.tagName === 'SELECT') return el.value;
      return el.textContent;
    };

    const finalBonusFormula = row.querySelector('.finalBonusFormula').textContent; // åªå–å¾—ç®—å¼

    csv += [
      getText('className'),
      getText('teacher'),
      getText('crossSchool'),
      getText('persons'),
      getText('fullBonus'),
      getText('partialDays'),
      getText('partialBonus'),
      getText('rate'),
      getText('semTotal'),
      getText('subDays'),
      getText('subHours'),
      getText('subTotal'),
      getText('attend'),
      getText('camp1'),
      getText('camp2'),
      getText('vacBonus'),
      finalBonusFormula // åŒ¯å‡ºç®—å¼
    ].map(item => `"${item}"`).join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const date = new Date().toISOString().slice(0, 10);
  a.download = `${date}_æ•™å¸«æ´¥è²¼è³‡æ–™.csv`;
  a.click();
}

</script>
<script>
function removeEmptyRows() {
  const tbody = document.getElementById('rows');
  const rows = tbody.querySelectorAll('tr');

  rows.forEach(row => {
    const teacher = row.querySelector('.teacher')?.value.trim();
    const persons = parseFloat(row.querySelector('.persons')?.value || 0);
    const attend = parseFloat(row.querySelector('.attend')?.value || 0);
    const camp1 = parseFloat(row.querySelector('.camp1')?.value || 0);
    const camp2 = parseFloat(row.querySelector('.camp2')?.value || 0);

    const isEmpty =
      !teacher &&
      persons === 15 &&  // é è¨­å€¼
      attend === 0 &&
      camp1 === 0 &&
      camp2 === 0;

    if (isEmpty) {
      row.remove();
    }
  });

  recalcAll();
}
</script>
<script>
    // é˜²å‘†æç¤ºåŠŸèƒ½è¦æ”¾æœ€å¾Œ
    document.addEventListener('input', function(e) {
      const workdays = parseFloat(document.getElementById('workdays').value) || 0;
      const requiredDays = parseFloat(document.getElementById('requiredDays').value) || 0;

      const warn = (condition, message) => {
        if (condition) alert(message);
      };

      if (e.target.classList.contains('partialDays') ||
          e.target.classList.contains('subDays') ||
          e.target.classList.contains('subHours')) {
        warn(workdays === 0, 'è«‹å…ˆå¡«å¯«ã€Œæœ¬æœˆå·¥ä½œå¤©æ•¸ã€å†è¼¸å…¥ç›¸é—œæ¬„ä½');
      }

      if (e.target.classList.contains('attend')) {
        warn(requiredDays === 0, 'è«‹å…ˆå¡«å¯«ã€Œè²¬ä»»é¡å¤©æ•¸ã€å†è¼¸å…¥é»åè¡¨é»æ•¸');
      }
    });
  </script>
</body>
</html>




