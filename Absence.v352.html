<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>打卡紀錄分析</title>
<style>
*,*::before,*::after{box-sizing:border-box}
:root{--bg:#f7f7fb;--card:#fff;--ink:#1f2937;--muted:#6b7280;--pri:#4f46e5;--border:#e5e7eb}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","Segoe UI",Roboto,Arial,"PingFang TC","Microsoft JhengHei","Helvetica Neue",sans-serif}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px}
.title{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.title h1{margin:0;font-size:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 3px rgba(0,0,0,.04);padding:16px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
label{font-size:12px;color:#334155;margin-bottom:6px;display:block}
input[type=text],textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px}
textarea{height:260px;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;resize:vertical}
button{appearance:none;border:0;border-radius:8px;background:#e3f2fd;color:#1565c0;padding:12px 18px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 2px 6px rgba(21,101,192,0.3);transition:background .2s,box-shadow .2s,transform .04s}
button:hover{background:#cde5fd;box-shadow:0 4px 12px rgba(21,101,192,0.5)}
button:active{transform:translateY(1px)}
button.secondary{background:#f1f5f9;color:#334155;box-shadow:0 1px 3px rgba(2,6,23,0.12)}
button.secondary:hover{background:#e2e8f0;box-shadow:0 3px 8px rgba(2,6,23,0.18)}
.muted{color:var(--muted);font-size:12px;margin-top:6px}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{border:1px solid var(--border);padding:8px 10px;vertical-align:middle}
th{background:#f3f4f6;text-align:left}
.hint{font-size:12px;color:var(--muted)}
.danger{color:#dc2626;font-weight:700}
.toast-wrap{position:fixed;right:16px;bottom:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.12);max-width:520px;font-size:14px;line-height:1.4}
.toast b{color:#fca5a5}
/* 讓最後一欄可換行 */
#out table td:last-child,#out table th:last-child{overflow-wrap:anywhere;word-break:break-word}
</style>
</head>
<body>
<div class="wrap">
  <div class="title"><h1>貼上打卡之星匯出的「打卡紀錄」</h1></div>
  <div class="muted">先輸入 PT 姓名（可多位），再貼上打卡資料，一鍵同時完成分析與 PT 工時計算。一天工時固定 <b>8 小時</b>（僅供請假/加班換算用）。</div>

  <div class="card" style="margin-top:12px">
    <div class="row">
      <div style="flex:1;min-width:280px">
        <label for="names">PT 姓名（逗號、空白或頓號分隔）</label>
        <input id="names" type="text" placeholder="例如：張正華" />
      </div>
    </div>
    <div style="margin-top:12px">
      <label for="raw">打卡紀錄（含或不含表頭；欄位以 Tab 分隔）</label>
      <textarea id="raw" placeholder="在這裡貼上原始資料"></textarea>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="run">整理＋計算</button>
      <button id="clear" class="secondary">清空</button>
    </div>
  </div>

  <div id="out" class="card" style="margin-top:12px">
    <div class="hint">尚未輸出。</div>
  </div>
</div>

<div id="toast" class="toast-wrap" aria-live="polite"></div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const DAY_HRS = 8;              // 給請假/加班內部用，顯示仍改為「小時」
  const FREE_LATE_COUNT = 3;      // 遲到免扣筆數
  const FREE_LATE_MIN   = 5;      // 遲到免扣分鐘
  const COUNT_TYPES = new Set(["漏打卡","非出勤日打卡"]);

  const headersDefault = [
    "員工編號","姓名","部門","打卡日期","日期類別","班別","表定上班時間","表定下班時間",
    "休息時間","表定工時","打卡工時","計薪基準工時","上班打卡時間","遲到","下班打卡時間","早退",
    "出勤異常","提早上班原因","上班打卡方式","上班打卡地點","上班地點異常，不在範圍內的原因",
    "延後下班原因","下班打卡方式","下班打卡地點","下班地點異常，不在範圍內的原因",
    "請假時間","請假時數","假別","加班時間","加班時數"
  ];

  $("#run").addEventListener("click", run);
  $("#clear").addEventListener("click", ()=>{
    $("#names").value="";
    $("#raw").value="";
    $("#out").innerHTML='<div class="hint">尚未輸出。</div>';
  });
  $("#names").addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); run(); } });

  let lastTSV = "";

  function run(){
    const namesInput = ($("#names").value||"").trim();
    const wantedNames = namesInput.split(/[,\s、，]+/).map(s=>s.trim()).filter(Boolean);
    const text = ($("#raw").value||"").trim();
    const out = $("#out");
    if(!text){ out.innerHTML = '<div class="hint">（請先貼上打卡資料）</div>'; return; }

    const {headers, rows, err} = tsvParse(text);
    if(err){ out.innerHTML = `<div style="color:#dc2626">解析失敗：${err}</div>`; return; }

    // 抬頭欄位
    const H_DATE   = pickHeader(headers,/打卡日期/,"打卡日期");
    const H_NAME   = pickHeader(headers,/姓名/,"姓名");
    const H_BRANCH = pickHeader(headers,/分校|部門/,"部門");
    const H_LEAVE_H    = pickHeader(headers,/請假時數/,"請假時數");
    const H_LEAVE_KIND = pickHeader(headers,/假別/,"假別");
    const H_OT_H     = pickHeader(headers,/^(加班時數|加班工時)$/,"加班時數");
    const H_OT_TIME  = pickHeader(headers,/^加班時間$/,"加班時間");
    const H_ABN   = pickHeader(headers,/出勤異常/,"出勤異常");
    const H_EARLY_REASON = pickHeader(headers,/提早上班原因/,"提早上班原因");
    const H_LATE_REASON  = pickHeader(headers,/延後下班原因/,"延後下班原因");
    const H_IN    = pickHeader(headers,/上班打卡時間/,"上班打卡時間");
    const H_OUT   = pickHeader(headers,/下班打卡時間/,"下班打卡時間");

    const map = new Map();              // 主表彙總
    const workAgg = new Map();          // PT 工時計算（半小時規則）
    const missingPairs = [];            // 缺成對打卡
    const allCombos = new Set();        // 本次出現的人
    const someoneHasAnyMap = new Map(); // 是否出現在主表（用於無異常名單）

    rows.forEach(r=>{
      const dateStr = (r[H_DATE]||"").trim();
      const ym = toYM(dateStr);
      const md = toMD(dateStr);
      const name = (r[H_NAME]||"").trim();
      const branch = (r[H_BRANCH]||"").trim();
      const abn = (r[H_ABN]||"").trim();
      if (ym && name) allCombos.add(`${ym}|${branch}|${name}`);

      // 1) PT 工時計算（半小時規則）
      const inMin  = parseHM(String(r[H_IN]||""));
      const outMin = parseHM(String(r[H_OUT]||""));
      if (inMin!=null && outMin!=null){
        const inAdj  = Math.ceil(inMin/30)*30;    // 上班進位
        const outAdj = Math.floor(outMin/30)*30;  // 下班捨去
        const durMins = Math.max(0, outAdj - inAdj);
        const durHrs  = durMins/60;
        if (durHrs>0 && ym && name){
          const k = `${ym}|${branch}|${name}`;
          const rec = workAgg.get(k) || {ym, branch, name, hours:0, detail:[] };
          rec.hours += durHrs;
          rec.detail.push(`${md} ${fmtHours(durHrs)}`);
          workAgg.set(k, rec);
        }
      }else if ((inMin==null) !== (outMin==null)){
        const which = (inMin==null) ? "缺上班" : "缺下班";
        if (ym && name) {
          missingPairs.push({ ym, branch, name, md, which,
            rawIn: String(r[H_IN]||"—"), rawOut: String(r[H_OUT]||"—")});
        }
      }

      // 2) 請假（小時計，以小時顯示）
      const leaveKind = (r[H_LEAVE_KIND]||"").replace(/\s/g,"");
      const leaveH = hhmmToHours(r[H_LEAVE_H]);
      if(leaveKind && leaveKind!=="--" && leaveH>0){
        addAgg(map, ym, branch, name, leaveKind, leaveH, `${md} ${fmtHours(leaveH)}`);
      }

      // 3) 超時（加班）
      const otFromTime = hhmmToHours(r[H_OT_TIME]);
      const otH = H_OT_H && r[H_OT_H] ? toNumber(r[H_OT_H]) : 0;
      const ot = (otFromTime || 0) > 0 ? otFromTime : otH;
      if (ot>0) addAgg(map, ym, branch, name, "超時", ot, `${md} ${fmtHours(ot)}`);

      // 4) 招生(加班)偵測
      const reasonText = String(r[H_EARLY_REASON]||"") + " " + String(r[H_LATE_REASON]||"");
      if (/招生/.test(reasonText)){
        let otRecruit=0;
        const m = reasonText.match(/招生.*?(\d+(?:\.\d+)?)\s*小時/);
        if (m) otRecruit = Number(m[1]);
        if (otRecruit>0) addAgg(map, ym, branch, name, "招生(加班)", otRecruit, `${md} ${fmtHours(otRecruit)}`);
        else addAgg(map, ym, branch, name, "招生(待確認)", {cnt:1}, `${md} 招生？小時`, true);
      }

      // 5) 出勤異常（分鐘/計次）
      if (abn && abn!=="--"){
        const parts = String(abn).split(/、/).map(s=>s.trim()).filter(Boolean);
        parts.forEach(p=>{
          let m = p.match(/遲到\s*(\d+)\s*分/);
          if (m){ const mins=+m[1]; const typ=/不扣/.test(p)?"遲到(不扣)":"遲到⚠️";
            addAgg(map, ym, branch, name, typ, {mins,cnt:1}, `${md} ${mins}分鐘`, true); return;}
          m = p.match(/早退\s*(\d+)\s*分/);
          if (m){ const mins=+m[1]; addAgg(map, ym, branch, name, "早退",{mins,cnt:1}, `${md} ${mins}分鐘`, true); return;}
          m = p.match(/曠職\s*(\d+)\s*分/);
          if (m){ const mins=+m[1]; addAgg(map, ym, branch, name, "曠職",{mins,cnt:1}, `${md} ${mins}分鐘`, true); return;}
          const timesM = p.match(/(\d+)\s*次/);
          let totalTimes = timesM ? Number(timesM[1]) : 0;
          const upMiss   = (p.match(/上班未打卡/gi)||[]).length;
          const downMiss = (p.match(/下班未打卡/gi)||[]).length;
          const plainMiss= (!upMiss && !downMiss) ? (p.match(/漏打卡/gi)||[]).length : 0;
          if (!timesM) totalTimes = upMiss + downMiss + plainMiss;
          if (totalTimes>0){
            for(let i=0;i<upMiss;i++)   addAgg(map, ym, branch, name, "漏打卡",{miss:1}, `${md} 上班`, true);
            for(let i=0;i<downMiss;i++) addAgg(map, ym, branch, name, "漏打卡",{miss:1}, `${md} 下班`, true);
            for(let i=0;i<Math.max(0,totalTimes-upMiss-downMiss);i++)
              addAgg(map, ym, branch, name, "漏打卡",{miss:1}, `${md}`, true);
            return;
          }
          if (/時間由忘打卡單建立/.test(p)){
            const when = /上班/.test(p) ? "上班" : (/下班/.test(p) ? "下班" : "");
            addAgg(map, ym, branch, name, "補打卡單",{cnt:1}, `${md} ${when}`, true); return;
          }
          if (p && p!=="--" && !/非出勤日打卡/.test(p)){
            addAgg(map, ym, branch, name, "其他異常",{cnt:1}, `${md} ${p}`, true);
          }
        });
      }
    }); // end rows.forEach

    // 遲到「免扣」處理
    for (const [key, rec] of map.entries()){
      const [ym, branch, name, typ] = key.split("|");
      if (typ==="遲到⚠️" && Array.isArray(rec._lateEvents) && rec._lateEvents.length){
        const cands = rec._lateEvents.filter(e=>e.mins<=FREE_LATE_MIN).sort((a,b)=> (b.mins-a.mins) || a.detail.localeCompare(b.detail));
        const waived = cands.slice(0, FREE_LATE_COUNT);
        const set = new Set(waived.map(e=>e.detail));
        let mSum=0,cnt=0;
        waived.forEach(e=>{ mSum+=e.mins; cnt++; addAgg(map, ym, branch, name, "遲到(不扣)", {mins:e.mins,cnt:1}, `${e.detail}（不扣）`, true); });
        rec.totalMins=Math.max(0,rec.totalMins-mSum);
        rec.count=Math.max(0,rec.count-cnt);
        rec.detail=rec.detail.filter(d=>!set.has(d));
        map.set(key,rec);
      }
    }

    // 主表輸出
    const rowsOut = [];
    let dangerCount=0;

    for (const [key, val] of map.entries()){
      const [ym, branch, name, typ] = key.split("|");
      let subtotal="", remark="";
      if (typ==="招生(待確認)"){
        subtotal="？小時"; remark=val.detail.join("、");
        rowsOut.push([ym,branch,name,typ,subtotal,remark]); continue;
      }
      if (COUNT_TYPES.has(typ) || typ==="其他異常"){
        subtotal=`${val.count} 次`; remark=val.detail.join("、");
        rowsOut.push([ym,branch,name,typ,subtotal,remark]); continue;
      }
      if (/^(?:遲到|早退|曠職)/.test(typ)){
        if ((val.totalMins||0)===0 && (val.count||0)===0) continue;
        if (typ==="早退" || typ==="曠職") dangerCount++;
        subtotal=`${val.totalMins} 分鐘（${val.count} 次）`;
        remark=val.detail.join("、");
        rowsOut.push([ym,branch,name,typ,subtotal,remark]); continue;
      }
      // 小時計 → 一律顯示「小時」
      const hours = Number(val.totalHours||0);
      if (hours===0) continue;
      subtotal = fmtHours(hours);
      remark   = val.detail.join("、");
      rowsOut.push([ym,branch,name,typ,subtotal,remark]);
    }

    rowsOut.sort((a,b)=> a[0].localeCompare(b[0]) || a[1].localeCompare(b[1]) || a[2].localeCompare(b[2]) || a[3].localeCompare(b[3]));

    // 非全勤名單：遲到⚠️≥1、事/病假>0小時、漏打卡>3次
    const notFullMap = new Map();
    for (const [k,v] of map.entries()){
      const [ym, branch, name, typ] = k.split("|");
      const key2 = `${ym}|${branch}|${name}`;
      const rec = notFullMap.get(key2)||{ym,branch,name,reasons:[]};
      if (typ==="遲到⚠️" && (v.count||0)>0) rec.reasons.push(`遲到⚠️${v.count}次`);
      if ((typ==="事假"||typ==="病假") && (v.totalHours||0)>0) rec.reasons.push(`${typ}${fmtHoursNum(v.totalHours)}小時`);
      if (typ==="漏打卡" && (v.count||0)>3) rec.reasons.push(`漏打卡${v.count}次`);
      notFullMap.set(key2,rec);
    }
    const notFullRows = [...notFullMap.values()].filter(x=>x.reasons.length>0)
      .sort((a,b)=> a.ym.localeCompare(b.ym)||a.branch.localeCompare(b.branch)||a.name.localeCompare(b.name));

    // 無異常名單（出現在資料，但完全沒有被彙總到）
    for (const key of map.keys()){ const [ym,branch,name]=key.split("|"); someoneHasAnyMap.set(`${ym}|${branch}|${name}`, true); }
    const noAbnRows = [...new Set([...workAgg.keys(), ...Array.from(allCombos)])]
      .map(k=>{const [ym,branch,name]=k.split("|"); return {ym,branch,name};})
      .filter(r=>!someoneHasAnyMap.get(`${r.ym}|${r.branch}|${r.name}`))
      .sort((a,b)=> a.ym.localeCompare(b.ym)||a.branch.localeCompare(b.branch)||a.name.localeCompare(b.name));

    // ====== 組畫面 ======
    const col6 = `<colgroup>
      <col style="width:110px"><col style="width:120px"><col style="width:120px">
      <col style="width:160px"><col style="width:120px"><col>
    </colgroup>`;
    const thead = `<thead><tr><th>年月</th><th>分校</th><th>姓名</th><th>假別/類型</th><th>小計</th><th>備註</th></tr></thead>`;
    const tbody = `<tbody>${
      rowsOut.map(r=>`<tr>${
        r.map((c,i)=>`<td${i===3 && /^(早退|曠職)$/.test(String(c))?' class="danger"':''}>${escapeHtml(c)}</td>`).join("")
      }</tr>`).join("")
    }</tbody>`;

    // 缺成對（去重）
    const missKey=new Set(), missDedup=[];
    for(const r of missingPairs){
      const k=`${r.ym}|${r.branch}|${r.name}|${r.md}|${r.which}`;
      if(!missKey.has(k)){ missKey.add(k); missDedup.push(r); }
    }
    const miss = missDedup.sort((a,b)=> a.ym.localeCompare(b.ym)||a.branch.localeCompare(b.branch)||a.name.localeCompare(b.name)||a.md.localeCompare(b.md));

    // PT 工時彙總（顯示 wantedNames；若沒填，顯示全部 PT）
    const yms = new Set([...workAgg.values()].map(r=>r.ym));
    const latestYM = [...yms].sort().pop(); // 本月
    const ptRows = [];
    if (latestYM){
      const list = [...workAgg.values()].filter(r=>r.ym===latestYM);
      const setWanted = new Set(wantedNames);
      const toShow = (setWanted.size>0) ? list.filter(r=>setWanted.has(r.name)) : list;
      const found = new Set(toShow.map(r=>r.name));
      // 未找到但有指定姓名 → 顯示 0 小時
      if (setWanted.size>0){
        wantedNames.forEach(n=>{
          if(!found.has(n)) ptRows.push({ym:latestYM,branch:"—",name:n,hours:0,detail:["（未找到成對上下班打卡）"]});
        });
      }
      ptRows.push(...toShow);
      ptRows.sort((a,b)=> a.branch.localeCompare(b.branch)||a.name.localeCompare(b.name));
    }

    let html = "";
    // 1) 主表給Candy
      html += `<div class="hint" style="margin-bottom:8px">
      共 ${rowsOut.length} 列，
      <button id="copyTSV" class="pill">複製給Candy的表格</button>
      <button id="copyAllTSV" class="pill">複製整頁表格</button>
      可貼回 Google Sheet。
      </div>
      <div style="overflow:auto"><table>${col6}${thead}${tbody}</table></div>`;
      
    // 2) PT 工時彙總
    if (ptRows.length>0){
      const colPT = `<colgroup>
        <col style="width:110px"><col style="width:120px"><col style="width:120px">
        <col style="width:120px"><col>
      </colgroup>`;
      const theadPT = `<thead><tr><th>年月</th><th>分校</th><th>姓名</th><th>本月工時</th><th>每日明細</th></tr></thead>`;
      const tbodyPT = `<tbody>${
        ptRows.map(r=>`<tr>
          <td>${escapeHtml(r.ym)}</td>
          <td>${escapeHtml(r.branch)}</td>
          <td>${escapeHtml(r.name)}</td>
          <td>${escapeHtml(fmtHoursNum(r.hours))}</td>
          <td>${escapeHtml(r.detail.join("、"))}</td>
        </tr>`).join("")
      }</tbody>`;
      html += `<div class="hint" style="margin:16px 0 8px">本月（${escapeHtml(latestYM||"—")}）PT 工時彙總，共 ${ptRows.length} 筆</div>
      <div style="overflow:auto; margin-bottom:16px"><table>${colPT}${theadPT}${tbodyPT}</table></div>`;
    }

    // 3) 缺成對
    if (miss.length>0){
      const colMiss = `<colgroup>
        <col style="width:110px"><col style="width:120px"><col style="width:120px">
        <col style="width:90px"><col style="width:90px"><col>
      </colgroup>`;
      const theadMiss = `<thead><tr><th>年月</th><th>分校</th><th>姓名</th><th>日期</th><th>缺少</th><th>原始上下班打卡</th></tr></thead>`;
      const tbodyMiss = `<tbody>${
        miss.map(r=>`<tr>
          <td>${escapeHtml(r.ym)}</td>
          <td>${escapeHtml(r.branch)}</td>
          <td>${escapeHtml(r.name)}</td>
          <td>${escapeHtml(r.md)}</td>
          <td>${escapeHtml(r.which)}</td>
          <td>${escapeHtml(`上班：${r.rawIn}／下班：${r.rawOut}`)}</td>
        </tr>`).join("")
      }</tbody>`;
      html += `<div class="hint" style="margin:16px 0 8px">缺成對打卡名單 <b>${miss.length}</b> 筆</div>
      <div style="overflow:auto"><table>${colMiss}${theadMiss}${tbodyMiss}</table></div>`;
    }

    // 4) 非全勤名單
    if (notFullRows.length>0){
      const col4 = `<colgroup><col style="width:110px"><col style="width:120px"><col style="width:120px"><col></colgroup>`;
      const thead2 = `<thead><tr><th>年月</th><th>分校</th><th>姓名</th><th>非全勤原因</th></tr></thead>`;
      const tbody2 = `<tbody>${
        notFullRows.map(r=>`<tr>
          <td>${escapeHtml(r.ym)}</td>
          <td>${escapeHtml(r.branch)}</td>
          <td>${escapeHtml(r.name)}</td>
          <td>${escapeHtml(r.reasons.join("、"))}</td>
        </tr>`).join("")
      }</tbody>`;
      html += `<div class="hint" style="margin:16px 0 8px">本月非全勤 <b>${notFullRows.length}</b> 人</div>
      <div style="overflow:auto"><table>${col4}${thead2}${tbody2}</table></div>`;
    }

    // 5) 無異常名單
    if (noAbnRows.length>0){
      const col3 = `<colgroup><col style="width:110px"><col style="width:120px"><col></colgroup>`;
      const thead3 = `<thead><tr><th>年月</th><th>分校</th><th>姓名</th></tr></thead>`;
      const tbody3 = `<tbody>${
        noAbnRows.map(r=>`<tr>
          <td>${escapeHtml(r.ym)}</td>
          <td>${escapeHtml(r.branch)}</td>
          <td>${escapeHtml(r.name)}</td>
        </tr>`).join("")
      }</tbody>`;
      html += `<div class="hint" style="margin:16px 0 8px">本月無異常名單 <b>${noAbnRows.length}</b> 人（有出現在資料，但完全正常）</div>
      <div style="overflow:auto"><table>${col3}${thead3}${tbody3}</table></div>`;
    }

    $("#out").innerHTML = html;

    // 複製主表 TSV
    const headerRow = ["年月","分校","姓名","假別/類型","小計","備註"];
    lastTSV = [headerRow, ...rowsOut].map(cols=>cols.map(v=>String(v??"").replaceAll("\t"," ")).join("\t")).join("\n");
    const copyBtn = document.querySelector("#out #copyTSV");
    copyBtn && copyBtn.addEventListener("click", ()=>navigator.clipboard.writeText(lastTSV).then(()=>alert("已複製，可貼到 Google Sheet！")));
    // ===== 產生「整頁 TSV」：主表 + PT工時 + 缺成對 + 非全勤 + 無異常 =====

function makeTSV(header, rows) {
  return [header, ...rows]
    .map(cols => cols.map(v => String(v ?? "").replaceAll("\t", " ")).join("\t"))
    .join("\n");
}

let allTSVParts = [];

// (A) 主表
const headerMain = ["年月","分校","姓名","假別/類型","小計","備註"];
allTSVParts.push("【主表】");
allTSVParts.push(makeTSV(headerMain, rowsOut));

// (B) PT 工時彙總（若有）
if (ptRows.length > 0) {
  const headerPT = ["年月","分校","姓名","本月工時(小時)","每日明細（半小時規則）"];
  const rowsPT = ptRows.map(r => [r.ym, r.branch, r.name, (Math.round((Number(r.hours||0))*10)/10), r.detail.join("、")]);
  allTSVParts.push("【PT工時彙總】");
  allTSVParts.push(makeTSV(headerPT, rowsPT));
}



// (C) 缺成對
if (miss.length > 0) {
  const headerMiss = ["年月","分校","姓名","日期","缺少","原始上下班打卡"];
  const rowsMiss = miss.map(r => [r.ym, r.branch, r.name, r.md, r.which, `上班：${r.rawIn}／下班：${r.rawOut}`]);
  allTSVParts.push("【缺成對打卡】");
  allTSVParts.push(makeTSV(headerMiss, rowsMiss));
}

// (D) 非全勤
if (notFullRows.length > 0) {
  const headerNotFull = ["年月","分校","姓名","非全勤原因"];
  const rowsNotFull = notFullRows.map(r => [r.ym, r.branch, r.name, r.reasons.join("、")]);
  allTSVParts.push("【本月非全勤名單】");
  allTSVParts.push(makeTSV(headerNotFull, rowsNotFull));
}

// (E) 無異常
if (noAbnRows.length > 0) {
  const headerNoAbn = ["年月","分校","姓名"];
  const rowsNoAbn = noAbnRows.map(r => [r.ym, r.branch, r.name]);
  allTSVParts.push("【本月無異常名單】");
  allTSVParts.push(makeTSV(headerNoAbn, rowsNoAbn));
}

const lastTSVAll = allTSVParts.join("\n\n");

// 綁定「複製整頁」按鈕
const copyAllBtn = document.querySelector("#out #copyAllTSV");
if (copyAllBtn) {
  copyAllBtn.addEventListener("click", () => {
    navigator.clipboard.writeText(lastTSVAll).then(() => {
      alert("已複製全部表格，可直接貼到 Google Sheet！");
    });
  });
}

    // Toast
    if (dangerCount>0) toast(`偵測到 <b>${dangerCount}</b> 筆「早退／曠職」。請確認是否應補假單。`, 12000);
    if (miss.length>0) toast(`本月偵測到 <b>${miss.length}</b> 筆「缺成對打卡」。請協助補單或補打卡。`, 12000);
  }

  // ------- 工具與小函式 -------
  function pickHeader(headers, pattern, fallback){ return headers.find(h=>pattern.test(h)) || fallback; }
  function tsvParse(text){
    const lines = text.split(/\r?\n/).filter(x=>x.trim().length>0);
    if(!lines.length) return {headers:[], rows:[], err:"空白內容"};
    const firstCols = lines[0].split("\t");
    const headerLike = firstCols.some(c=>/員工編號|姓名|打卡日期|請假時數|假別|加班時數|出勤異常/.test(c));
    const headers = headerLike ? firstCols.map(h=>h.trim()) : headersDefault.slice();
    const dataLines = headerLike ? lines.slice(1) : lines;
    const rows = dataLines.map(l=>{
      const cols=l.split("\t"); const o={}; headers.forEach((h,i)=>o[h]=(cols[i]??"").trim()); return o;
    });
    return {headers, rows, err:null};
  }
  function toNumber(v){ const s=String(v??""); if (/[~:]/.test(s)) return 0; const m=s.match(/-?\d+(?:\.\d+)?/); return m?Number(m[0]):0; }
  function hhmmToHours(v){
    const s=String(v||"").trim(); const m=s.match(/^(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?$/);
    if(!m) return toNumber(s); const h=+m[1]||0, min=+m[2]||0, sec=+m[3]||0; return h + min/60 + sec/3600;
  }
  function toYM(s){ const m=String(s).match(/(\d{4})[\/\-](\d{1,2})/); return m?`${m[1]}-${String(m[2]).padStart(2,'0')}`:(s||""); }
  function toMD(s){ const m=String(s).match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/); return m?Number(m[2])+"/"+Number(m[3]):(s||""); }
  function parseHM(s){ const m=String(s||"").match(/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/); if(!m) return null; const hh=Math.min(23,Math.max(0,+m[1]||0)); const mm=Math.min(59,Math.max(0,+m[2]||0)); return hh*60+mm; }
  function fmtHoursNum(h){ const n=Number(h||0); return (Math.round(n*10)/10).toString(); } // 1位小數
  function fmtHours(h){ return `${fmtHoursNum(h)} 小時`; }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

  function addAgg(map, ym, branch, name, typ, val, detailStr, isEvent){
    const normalizedTyp = (typ==="補打卡單") ? "漏打卡" : typ;
    const key = `${ym}|${branch}|${name}|${normalizedTyp}`;
    const rec = map.get(key) || { totalHours:0, totalMins:0, count:0, detail:[], _detailSet:new Set(), _lateEvents:[] };
    const isObj = val && typeof val==="object";
    const dkey = (detailStr||"").trim();
    if (isObj && dkey && rec._detailSet.has(dkey)){ map.set(key,rec); return; }

    if (typeof val==="number"){
      rec.totalHours += val;
      rec.detail.push(detailStr);
    }else if (isObj){
      if ("mins" in val){ rec.totalMins += (val.mins||0); rec.count += (val.cnt||1); rec.detail.push(detailStr);
        if (/^遲到/.test(normalizedTyp)) rec._lateEvents.push({mins:Number(val.mins||0), detail:detailStr});
      }
      if ("miss" in val){ rec.count += (val.miss||1); rec.detail.push(detailStr); }
      if ("cnt" in val && !("mins" in val) && !("miss" in val)){ rec.count += (val.cnt||1); rec.detail.push(detailStr); }
    }
    if (isObj && dkey) rec._detailSet.add(dkey);
    map.set(key,rec);
  }

})(); // IIFE

// Toast
function toast(msg, ms=12000){
  const wrap=document.getElementById("toast"); if(!wrap) return;
  const el=document.createElement("div"); el.className="toast"; el.innerHTML=msg;
  el.addEventListener("click",()=>{ el.parentNode && el.parentNode.removeChild(el); });
  wrap.appendChild(el); el.style.transition="opacity .3s";
  const delay=Math.max(300,ms)-300; setTimeout(()=>{ if(el.parentNode) el.style.opacity="0"; }, delay);
  setTimeout(()=>{ el.parentNode && el.parentNode.removeChild(el); }, Math.max(300,ms));
}
</script>
</body>
</html>
