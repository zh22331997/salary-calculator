<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="utf-8" />
<title>繳費通知產生器</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --brand:#17324A; --muted:#6b7280; --line:#9aa3ab; --border:#d1d5db;
  --bg:#ffffff; --bg-page:#f0f2f5;
  --font-sans:"Microsoft JhengHei","微軟正黑體","Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
  --gap-between:6mm; --gap-col:6mm; /* 預覽用；列印時會覆蓋 */
}
*{box-sizing:border-box}
html,body{height:100%}
body{font-family:var(--font-sans); background:var(--bg-page); margin:0; color:#374151; display:flex; justify-content:center}
.container{ background:#fff; padding:2rem; margin:2rem 1rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.12); max-width:980px; width:100%;}
h1{margin:0 0 1rem 0; color:#0056b3; text-align:center; font-weight:800;}
label{font-weight:700; color:#555; display:block; margin:.25rem 0 .5rem;}
.input-area{ max-width:980px; margin:0 auto 24px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.08);}
.grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
.col-3{ grid-column:span 3; } .col-4{ grid-column:span 4; } .col-6{ grid-column:span 6; } .col-12{ grid-column:span 12; }

textarea,.input-area input[type="text"],.input-area input[type="date"]{
  width:100%; height:2.75rem; padding:0 .9rem; border-radius:8px; border:1px solid var(--border);
  font-size:16px; background:#fff; transition:border-color .2s, box-shadow .2s;
}
textarea{ min-height:200px; height:auto; resize:vertical; padding:.6rem; line-height:1.5; font-family:var(--font-mono); }
textarea:focus,.input-area input[type="text"]:focus,.input-area input[type="date"]:focus{ outline:none; border-color:#6a9aff!important; box-shadow:0 0 0 3px rgba(106,154,255,.25); }

button{
  display:inline-flex; align-items:center; justify-content:center; min-height:2.9rem; padding:0 1.25rem;
  font-size:17px; font-weight:700; border:none; border-radius:8px; cursor:pointer; color:#17324A;
  background:#A1C6EA; transition:background-color .15s ease, transform .12s ease, box-shadow .2s; box-shadow:0 1px 3px rgba(0,0,0,.08);
}
button:hover{background:#8FB9E2; transform:translateY(-2px)}
button:active{transform:translateY(-1px)}
.btn-secondary{ background:#BBD1EA; } .btn-clear{ background:#DAE3E5; }
.btn-row{ display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:.5rem; }
.btn-row > button{ width:200px; }

.print-area{ margin-top:18px; } /* 預覽好看；列印會歸零 */

/* ===== A4 一頁 2×4 共 8 張 ===== */
.page{
  position:relative; background:#fff; border:1px solid var(--border); border-radius:10px;
  padding:6mm; margin:0 auto 12px auto;
  display:grid; grid-template-columns:1fr 1fr; grid-template-rows:repeat(4,1fr);
  column-gap:var(--gap-col); row-gap:var(--gap-between);
  page-break-after:always;
}
.page:last-child{ page-break-after:auto; }

/* 卡片樣式：標題／資訊／項目列／總計／匯款 */
.card{
  border:1.5px solid #b7c1c9; border-radius:10px; padding:8px 10px; background:#fff; display:flex; flex-direction:column; gap:6px;
}
.card header{display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--line); padding-bottom:4px}
.card .title{font-weight:900; color:#17324A; font-size:16px; letter-spacing:.3px;}
.card .hint{font-size:11px; color:#748089}

.info{display:grid; grid-template-columns:1fr 1fr; column-gap:8px; row-gap:2px; font-size:12.5px; color:#333}
.info .label{color:#666; width:72px; display:inline-block}

.items{border-top:1px dashed var(--line); border-bottom:1px dashed var(--line); padding:6px 0; display:flex; flex-direction:column; gap:2px}
.item-row{display:flex; justify-content:space-between; align-items:flex-start; gap:8px; font-size:13px}
.item-left{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.item-right{min-width:max-content; text-align:right}
.money{font-weight:800; color:#c80000}

.total{font-weight:900; font-size:15px; color:#111; display:flex; justify-content:flex-end; gap:10px; margin-top:2px}
.payinfo{margin-top:2px; font-size:11.5px; color:#384350; line-height:1.35}
.payinfo .mono{font-family:var(--font-mono); letter-spacing:.2px}

/* ===== 列印緊湊版（確保放得下 8 張） ===== */
@media print{
  html{ font-size:11.5pt; }
  body{ background:#fff; }
  h1,.input-area,.btn-row{ display:none !important; }
  .container{ box-shadow:none; margin:0 !important; padding:0 !important; max-width:none; }
  .print-area{ margin-top:0 !important; }
  .page:first-child{ margin-top:0 !important; }
  @page{ size:A4 portrait; margin:10mm; }

  :root{
    --gap-between:6mm; --gap-col:6mm;
    --page-w:210mm; --page-h:297mm; --page-m:10mm; --cols:2; --rows:4;
    --card-w: calc((var(--page-w) - 2*var(--page-m) - (var(--cols) - 1)*var(--gap-col)) / var(--cols));
    --card-h: calc((var(--page-h) - 2*var(--page-m) - (var(--rows) - 1)*var(--gap-between)) / var(--rows));
  }
  .page{
    border:0; border-radius:0; padding:0; margin:0;
    grid-template-columns:repeat(2, var(--card-w));
    grid-template-rows:repeat(4, var(--card-h));
  }
  .card{ width:var(--card-w); height:var(--card-h); padding:6px 8px; }
  .card .title{font-size:12.2pt}
  .hint{font-size:9.6pt}
  .info{font-size:10.2pt}
  .item-row{font-size:10.6pt}
  .total{font-size:11.6pt}
  .payinfo{font-size:9.6pt}
}
</style>
</head>
<body>
  <div class="container">
    <h1>繳費通知產生器</h1>

    <div class="input-area">
      <div class="grid">
        <div class="col-12">
          <label>貼上名單（從EXCEL貼上 或逗號分隔）</label>
          <textarea id="pasteArea" placeholder="【範例(羊奶)】
班級	姓名	項目一	金額一	羊奶袋	口味	備註
1A	馬小皓	12月羊奶	700	否	鮮乳	

【範例(餐費)】
班級	姓名	項目一	        金額一	備註一	項目二	金額二	備註二
1A	馬小皓	10/26-11/25餐費	700		預收餐費	1250	"></textarea>
          <div style="font-size:13px;color:#6b7280;margin-top:6px;">
            ● 羊奶格式：<b>班級／姓名／項目一／金額一／羊奶袋／口味／備註</b><br>
            ● 羊奶也可：<b>班級／姓名／代收項目／金額／羊奶袋／口味／備註（特殊輪）</b><br>
            ● 餐費格式：<b>班級／姓名／項目一／金額一／備註一／項目二／金額二／備註二</b><br>
            ● 金額可為負數；第二項與備註二可留空。列印請選 100%（實際大小），關閉頁首/頁尾。
          </div>
        </div>

        <div class="col-3">
          <label>收費區間</label>
          <input type="text" id="feePeriod" placeholder="例：2025年12月" />
        </div>
        <div class="col-3">
          <label>繳費期限</label>
          <input type="date" id="deadline" />
        </div>
        <div class="col-6">
          <label>共用備註（附加在最末，可留空）</label>
          <input type="text" id="globalNote" placeholder="例：請於期限前完成繳款，逾期依規定加收手續費" />
        </div>

        <!-- 匯款 / 轉帳資訊（可改） -->
        <div class="col-4">
          <label>匯款戶名</label>
          <input type="text" id="payName" value="凱勝文理技藝短期補習班" />
        </div>
        <div class="col-4">
          <label>銀行 / 分行</label>
          <input type="text" id="payBank" value="玉山銀行808雙和分行" />
        </div>
        <div class="col-4">
          <label>匯款帳號</label>
          <input type="text" id="payAccount" value="0129940060389" />
        </div>
        <div class="col-12">
          <label>匯款提醒文字</label>
          <input type="text" id="payNote" value="匯款後請提供末五碼、匯款金額、繳費項目" />
        </div>
      </div>

      <div class="btn-row">
        <button id="btnGenerate">生成通知</button>
        <button class="btn-secondary" id="btnPrint">列印 / PDF</button>
        <button class="btn-clear">清空資料</button>
        <span id="previewCount" style="margin-left:8px;"></span>
      </div>

      <div id="warnBox" class="warn" role="alert" style="display:none;"></div>
    </div>

    <div class="print-area" id="printArea" aria-live="polite"></div>
  </div>

  <!-- 卡片模板（單列多項目） -->
  <template id="cardTemplate">
    <div class="card">
      <header>
        <div class="title">繳費通知</div>
        <div class="hint">※ 如對金額或項目有疑問，請於三日內與我們聯繫。</div>
      </header>

      <div class="info">
        <div><span class="label">收費區間</span><span class="val period"></span></div>
        <div><span class="label">繳費期限</span><span class="val deadline"></span></div>
        <div><span class="label">學生姓名</span><span class="val name"></span></div>
        <div><span class="label">班級</span><span class="val klass"></span></div>
      </div>

      <div class="items"></div>

      <div class="total"><span>共計</span><span class="money total-amount"></span></div>

      <div class="payinfo">
        【匯款/轉帳】戶名：<span class="mono pay-name"></span><br/>
        銀行：<span class="mono pay-bank"></span>　帳號：<span class="mono pay-account"></span><br/>
        <span class="pay-note"></span>
      </div>
    </div>
  </template>

<script>
/* ===== 小工具 ===== */
const $  = (s,c=document)=>c.querySelector(s);
const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));
function pad(n){ return String(n).padStart(2,'0'); }
function detectDelimiter(s){ const t=(s.match(/\t/g)||[]).length, c=(s.match(/,/g)||[]).length; return t>=c?'\t':','; }

/* 下月10日（週末順延）＋下月標籤 */
function nextMonth10thBusinessDay(base=new Date()){
  const y=base.getFullYear(), m=base.getMonth();
  const d=new Date(y, m+1, 10);
  if(d.getDay()===6) d.setDate(d.getDate()+2);
  if(d.getDay()===0) d.setDate(d.getDate()+1);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function nextMonthLabel(base=new Date()){
  const y=base.getFullYear(), m=base.getMonth();
  const d=new Date(y, m+1, 1);
  return `${d.getFullYear()}年${d.getMonth()+1}月`;
}

/* 金額處理（允許負數、千分位、$、元） */
function isAmountLike(raw){
  const s=String(raw||'').trim(); if(!s) return false;
  return /^(?:-?\s*)?(?:NT\$?\s*)?\$?\s*\d{1,3}(?:,\d{3})*(?:\.\d+)?(?:\s*元)?$/i.test(s) || /^-?\d+(?:\.\d+)?$/.test(s);
}
function toNumber(raw){ const s=String(raw||'').replace(/[^\d\-.]/g,''); return Number(s||0); }
function fmtMoney(n){ return '$ ' + Math.round(n).toLocaleString('zh-Hant-TW',{maximumFractionDigits:0}); }

/* 解析（彈性吃兩種格式）：
   羊奶：班級/姓名/項目一/金額一/羊奶袋/口味/備註
   餐費：班級/姓名/項目一/金額一/備註一/項目二/金額二/備註二
   也可混合貼，上述欄位之外的剩餘欄會自動忽略。 */
function parseRows(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return [];
  const d=detectDelimiter(lines[0]);
  const head=lines[0].split(d).map(v=>v.trim());
  const hasHeader=/班級|姓名|項目一|金額一|羊奶袋|口味|備註|備註一|備註二|項目二|金額二/.test(head.join(''));
  const body=hasHeader?lines.slice(1):lines;

  return body.map(line=>{
    const p=line.split(d).map(s=>s.trim());
    // 嘗試判斷是羊奶型或餐費型
    const looksMilk = (p[4]||'').match(/^(\u662f|否|Y|N|YES|NO)$/i) || (head.join('').includes('羊奶袋'));
    const row={
      klass:p[0]||'', name:p[1]||'',
      item1:p[2]||'', amt1:p[3]||'',
      // 羊奶型
      bagYes:false, flavor:'', note1:'',
      // 第二項（可空）
      item2:'', amt2:'', note2:''
    };
    if(looksMilk){
      row.bagYes=/^(\u662f|Y|YES)$/i.test(p[4]||'');
      row.flavor=p[5]||'';
      row.note1=p[6]||'';
      row.item2=p[7]||''; row.amt2=p[8]||''; row.note2=p[9]||'';
    }else{
      row.note1=p[4]||'';
      row.item2=p[5]||''; row.amt2=p[6]||''; row.note2=p[7]||'';
    }
    return row;
  });
}

/* 轉成卡片資料：最多兩項；備註與口味/+袋合併，但以空白分隔（不再用頓號） */
function toCards(rows){
  return rows.map(r=>{
    // 組 item1 備註：口味、+袋、note1（以空白分隔）
    const parts1=[];
    if(r.flavor) parts1.push(r.flavor);
    if(r.bagYes) parts1.push('+袋');
    if(r.note1)  parts1.push(r.note1);
    const note1 = parts1.join(' ').trim();

    const items=[];
    let sum=0;

    const push=(label, amt, note)=>{
      if(!label && !amt) return;
      const isNum=isAmountLike(amt);
      const amountNum=isNum?toNumber(amt):0;
      const left = note ? `${label}（${note}）` : label;
      items.push({ left, isNum, amountDisplay: isNum? fmtMoney(amountNum) : (amt||'—') });
      if(isNum) sum+=amountNum;
    };
    push(r.item1, r.amt1, note1);
    push(r.item2, r.amt2, r.note2);

    return { klass:r.klass, name:r.name, items, sum };
  });
}

/* 排序／分頁 */
function sortByClassName(arr){
  const coll=new Intl.Collator('zh-Hant-u-co-stroke',{numeric:true,sensitivity:'base'});
  return arr.sort((a,b)=>{const c=coll.compare(a.klass||'～～～',b.klass||'～～～'); return c!==0?c:coll.compare(a.name||'',b.name||'');});
}
function toPagesOf8(arr){
  const out=[]; for(let i=0;i<arr.length;i+=8) out.push(arr.slice(i,i+8));
  return out.map(pg=>{while(pg.length<8) pg.push({klass:'',name:'',items:[],sum:0,__blank:true}); return pg;});
}

/* DOM 填入 */
function addItemRow(container, left, rightHTML){
  const row=document.createElement('div'); row.className='item-row';
  const l=document.createElement('div'); l.className='item-left'; l.textContent=left||'';
  const r=document.createElement('div'); r.className='item-right'; r.innerHTML=rightHTML||'';
  row.appendChild(l); row.appendChild(r); container.appendChild(row);
}
function fillCard(node,stu,globals,pay){
  $('.period',node).textContent   = globals.feePeriod || '';
  $('.deadline',node).textContent = globals.deadline || '';
  $('.name',node).textContent     = stu.name || (stu.__blank?'':'（未填）');
  $('.klass',node).textContent    = stu.klass || (stu.__blank?'':'—');

  const itemsBox=$('.items',node); itemsBox.innerHTML='';
  if(!stu.__blank){
    stu.items.forEach(it=>{
      const right = it.isNum ? `<span class="money">${it.amountDisplay}</span>` : it.amountDisplay;
      addItemRow(itemsBox, it.left, right);
    });
    $('.total-amount',node).textContent = fmtMoney(stu.sum);
  }else{
    $('.total-amount',node).textContent='';
  }

  // 匯款
  $('.pay-name',node).textContent    = pay.name || '';
  $('.pay-bank',node).textContent    = pay.bank || '';
  $('.pay-account',node).textContent = pay.account || '';
  $('.pay-note',node).textContent    = pay.note || '';
}

/* ===== 主流程 ===== */
const printArea = document.getElementById('printArea');
const template  = document.getElementById('cardTemplate');

function generate(){
  const rows = parseRows(document.getElementById('pasteArea').value);
  printArea.innerHTML='';
  const globals={
    feePeriod: document.getElementById('feePeriod').value.trim(),
    deadline:  document.getElementById('deadline').value,
    globalNote:document.getElementById('globalNote').value.trim()
  };
  const pay={
    name:    document.getElementById('payName').value.trim(),
    bank:    document.getElementById('payBank').value.trim(),
    account: document.getElementById('payAccount').value.trim(),
    note:    document.getElementById('payNote').value.trim()
  };
  if(rows.length===0){ document.getElementById('previewCount').textContent='尚未產生任何通知，請先貼上名單。'; return; }

  const cards   = toCards(rows);
  const sorted  = sortByClassName(cards);
  const pages   = toPagesOf8(sorted);

  pages.forEach(group=>{
    const page=document.createElement('div'); page.className='page';
    group.forEach(stu=>{
      const node=template.content.cloneNode(true);
      fillCard(node,stu,globals,pay);
      page.appendChild(node);
    });
    printArea.appendChild(page);
  });
  document.getElementById('previewCount').textContent=`共 ${sorted.length} 位；每頁固定 8 位，共 ${pages.length} 頁。`;

  // 提醒：有非數字金額
  const nonNum = cards.flatMap(s=>s.items.filter(i=>!i.isNum).map(i=>`${s.klass||'—'} ${s.name||'—'}／${i.left}：${i.amountDisplay}`));
  const warnBox = document.getElementById('warnBox');
  if(nonNum.length){
    alert(`⚠️ 有 ${nonNum.length} 筆「金額非數字」項目，已排版但未納入總計。`);
    warnBox.style.display='block';
    warnBox.textContent = '未納入總計：\n' + nonNum.join('\n');
  }else{
    warnBox.style.display='none';
    warnBox.textContent='';
  }
}

/* 預設帶入下月區間與 10 日（遇週末順延） */
document.addEventListener('DOMContentLoaded', ()=>{
  const today=new Date();
  if(!document.getElementById('feePeriod').value)  document.getElementById('feePeriod').value  = nextMonthLabel(today);
  if(!document.getElementById('deadline').value)   document.getElementById('deadline').value   = nextMonth10thBusinessDay(today);
});

/* 事件 */
document.getElementById('btnGenerate').addEventListener('click', generate);
document.querySelector('.btn-secondary').addEventListener('click', ()=>{ if(!printArea.children.length) generate(); requestAnimationFrame(()=>window.print()); });
document.querySelector('.btn-clear').addEventListener('click', ()=>{
  document.getElementById('pasteArea').value='';
  document.getElementById('previewCount').textContent='';
  const warnBox=document.getElementById('warnBox'); warnBox.style.display='none'; warnBox.textContent='';
  document.getElementById('pasteArea').focus();
});
</script>
</body>
</html>
