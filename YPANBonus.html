<!DOCTYPE html> 
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>計算課輔帶班津貼 永平、秀朗、永和</title>
<style>
/***** =========================================================
 *  0) 主題變數（莫蘭迪色系）＋常用寬度
 *  想換色 / 微調按鈕或欄寬，優先改這裡
 * ======================================================= *****/
:root{
  /* 表頭背景（對應三群） */
  --th-bg-month:#ffffff;
  --th-bg-sem:  #e6f3f6;  /* 清水藍-淡 */
  --th-bg-sub:  #f7eadf;  /* 杏粉-淡  */
  --th-bg-sum:  #f2e7f6;  /* 淡紫-淡  */

  /* 內容列底色（更淡，對應三群） */
  --td-bg-sem:  #f3fbfd;
  --td-bg-sub:  #fff7ef;
  --td-bg-sum:  #faf3fb;

  /* 邊線與文字 */
  --bd:#d4d7dd;
  --ink:#293241;

  /* 主要操作鍵（批次/新增/刪除）莫蘭迪藍灰 */
  --btn-main:#a7c1d1;
  --btn-main-hover:#94b3c6;

  /* 摺疊鍵（對應分群，稍深一階） */
  --btn-sem:#b8dce3;
  --btn-sem-hover:#a9cfda;

  --btn-sub:#f2d8c9;
  --btn-sub-hover:#eecab5;

  --btn-sum:#e1caea;
  --btn-sum-hover:#d8bde4;

  /* 其他工具鍵（次要） */
  --btn-muted:#cfd6df;
  --btn-muted-hover:#c2cbd6;

  /* ====== 欄寬參數（方便集中調整） ====== */
  /* 僅需 3 位數的欄位寬度（人數、天數、比例等） */
  --w-3digit: 2.8em;       /* 約 3 位數剛好 */
  --w-3digit-plus: 3.2em;  /* 3 位數偏寬（較舒適） */

  /* 本月津貼算式欄（加寬顯示） */
  --w-final-formula-min: 26em; /*比下一行少2*/
  --w-final-formula:     28em;

  /* 備註欄（改為約原本的一半寬） */
  --w-note-col:     15em; /*比下一行多1*/
  --w-note-input:   14em;
  --w-note-number:   2.8em;
}

/***** =========================================================
 *  1) 全站基礎
 * ======================================================= *****/
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  font-family:"Microsoft JhengHei",sans-serif;
  padding:24px;
  background:#f7f7f8;
  color:var(--ink);
}
h1{
  margin:0 0 16px;
  padding-left:12px;
  border-left:6px solid #3c82f6; /* 標題裝飾 */
}

/***** =========================================================
 *  2) 表格外框＋固定版面配置（sticky）
 * ======================================================= *****/
.table-wrap{
  max-height:70vh;
  overflow:auto;
  border:1px solid #e5e7eb;
  border-radius:12px;
  background:#fff;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  table-layout:fixed; /* 固定版面，遵守欄寬 */
}
th,td{
  border:1px solid var(--bd);
  text-align:center;
  vertical-align:middle;
  padding:10px;
}

/* thead sticky + 分色 */
#dataTable thead th{
  position:sticky; top:0; z-index:6;
  background:var(--th-bg,#fff);
  box-shadow:0 2px 0 rgba(0,0,0,.04);
  white-space:normal; overflow:visible; text-overflow:clip;
  font-size:.95em; line-height:1.15; padding:8px 6px;
}
#dataTable thead th.thead-group-monthly{ --th-bg: var(--th-bg-month); }
#dataTable thead th.thead-group-semester{ --th-bg: var(--th-bg-sem); }
#dataTable thead th.thead-group-sub{ --th-bg: var(--th-bg-sub); }
#dataTable thead th.thead-group-summer{ --th-bg: var(--th-bg-sum); }

/* 第一欄 sticky（tbody） */
#rows td:first-child{
  position:sticky; left:0; z-index:4; background:#fff;
}

/***** =========================================================
 *  3) 內容列分色（tbody）
 * ======================================================= *****/
#rows td.thead-group-semester{ background:var(--td-bg-sem); }
#rows td.thead-group-sub{      background:var(--td-bg-sub); }
#rows td.thead-group-summer{   background:var(--td-bg-sum); }
#rows td.thead-group-monthly{  background:#ffffff; }

/***** =========================================================
 *  4) 欄寬（以 class 對應你原本的欄位）
 *  ・本月津貼算式加寬
 *  ・備註欄變窄（約原本一半）
 *  ・3 位數欄位微縮（新的需求）
 * ======================================================= *****/
/* 一般欄位（若未在下方覆蓋，沿用原先設定或預設分配） */
th.teacher, td .teacher{ width:6em; }
th.crossSchoolCol, td.crossSchoolCol{ width:3.2em; }
th.fullBonus, td.fullBonus{ width:6em; }
th.partialBonus, td.partialBonus{ width:6em; }
th.semTotal, td.semTotal{ width:7em; }
th.subTotal, td.subTotal{ width:6em; }
th.vacBonus, td.vacBonus{ width:7em; }

/* ====== 只需 3 位數的欄位 → 微縮 ======
   可改用 --w-3digit / --w-3digit-plus 調整緊度 */
th.persons,      td .persons{     width: var(--w-3digit-plus); } /* 全月人數 */
th.partialDays,  td .partialDays{ width: var(--w-3digit-plus); } /* 非全月生天數 */
th.rate,         td .rate{        width: var(--w-3digit); }      /* 比例（0~1） */
th.subDays,      td .subDays{     width: var(--w-3digit); }      /* 代課天 */
th.subHours,     td .subHours{    width: var(--w-3digit); }      /* 代課時 */
th.attend,       td .attend{      width: var(--w-3digit-plus); } /* 點名表點數 */
th.camp1,        td .camp1{       width: var(--w-3digit-plus); } /* 一日營(1) */
th.camp2,        td .camp2{       width: var(--w-3digit-plus); } /* 一日營(2) */

/* 本月津貼算式欄：加寬，便於閱讀長公式 */
td.finalBonus{
  min-width: var(--w-final-formula-min);
  width:     var(--w-final-formula);
}

/* 備註欄：改為較窄 */
th.noteCol, td.noteCol{
  width:     var(--w-note-col);
  min-width: var(--w-note-col);
}

/***** =========================================================
 *  5) 儲存格顯示規則
 *  ・小欄位維持省略
 *  ・需要完整顯示（vacBonus/finalBonus/noteCol）允許換行
 * ======================================================= *****/
#dataTable tbody td{
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
#dataTable tbody td.vacBonus,
#dataTable tbody td.finalBonus,
#dataTable tbody td.noteCol{
  white-space:normal; overflow:visible; text-overflow:clip; text-align:left;
}

/* 內部輸入統一外觀 */
#dataTable tbody td input[type="number"],
#dataTable tbody td input[type="text"]{
  width:100%; max-width:100%;
  padding:6px 8px; text-align:center;
  border:1px solid #cbd5e1; border-radius:8px; font-size:1em;
}

/* checkbox 不被撐滿 */
#dataTable td.crossSchoolCol input.crossSchool{
  width:auto; display:inline-block; margin:0 auto;
}

/***** =========================================================
 *  6) 備註欄排版（縮裡面的輸入寬）
 * ======================================================= *****/
td.noteCol{ padding:6px; }
td.noteCol .note-wrap{
  display:flex; flex-wrap:wrap; align-items:center; gap:6px 10px;
}
td.noteCol label{
  display:inline-flex; align-items:center; gap:4px; margin:0; white-space:nowrap;
  font-size: 0.9rem;   /* ← 新增：備註欄中文字縮小 */
}
/* 跟著「備註欄變窄」微縮內部欄位 */
td.noteCol input.note{ width: var(--w-note-input); text-align:left; }
td.noteCol input[type="number"]{ width: var(--w-note-number); }

/***** =========================================================
 *  7) 算式小字
 * ======================================================= *****/
.finalBonusFormula{
  font-size:.85em; color:#4b5563; word-break:break-word;
}

/***** =========================================================
 *  8) 摺疊群組（按鈕切換時加上 class）
 * ======================================================= *****/
.collapse-semester th.thead-group-semester,
.collapse-semester td.thead-group-semester{ display:none; }
.collapse-sub th.thead-group-sub,
.collapse-sub td.thead-group-sub{ display:none; }
.collapse-summer th.thead-group-summer,
.collapse-summer td.thead-group-summer{ display:none; }

/***** =========================================================
 *  9) 上方設定區（非必填的設定）
 * ======================================================= *****/
.settings-row{
  display:flex; flex-wrap:wrap; align-items:center;
  gap:16px 22px; padding:12px; margin:10px 0 14px;
  background:#fff; border:1px solid #e5e7eb; border-radius:12px;
}
.settings-row .field{ display:inline-flex; align-items:center; gap:8px; }
.settings-row label{ color:#374151; }
.settings-row input[type="number"]{
  width:120px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; font-size:1rem;
}
.settings-row .note{ color:#6b7280; font-size:.9rem; }
.input-group{ display:inline-flex; align-items:center; gap:6px; }
.prefix{
  padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px;
  background:#f9fafb; color:#374151;
}
.settings-row input:focus{
  outline:none; border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.15);
}

/***** =========================================================
 * 10) 批次新增（說明合併在 placeholder）
 * ======================================================= *****/
.batch-merge{
  display:grid; grid-template-columns:max-content 1fr; gap:12px;
  align-items:flex-start; padding:12px; margin:10px 0 12px;
  background:#fff; border:1px solid #e5e7eb; border-radius:12px;
}
.batch-merge .title{
  font-weight:600; color:#111827; white-space:nowrap; padding-top:6px;
}
.batch-merge #batchInput{
  width:100%; min-height:44px; max-height:160px; resize:vertical;
  padding:8px 10px; border:none; background:#fff; font-size:1rem; line-height:1.4; outline:none;
}
.batch-merge:focus-within{
  border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.15); transition:.15s;
}
@media (max-width:720px){
  .batch-merge{ grid-template-columns:1fr; gap:6px; }
  .batch-merge .title{ padding-top:0; }
}

/***** =========================================================
 * 11) 工具列按鈕（莫蘭迪一致風格）
 * 主要三鍵用 .btn-main；摺疊鈕依分群 .btn-sem/.btn-sub/.btn-sum
 * 其他工具用 .btn
 * ======================================================= *****/
.toolbar{ display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 14px; }

button{
  appearance:none; border:0; cursor:pointer;
  padding:.6em 1em; border-radius:12px; font-size:16px;
  line-height:1; transition:.15s;
  display:inline-flex; align-items:center; gap:.5em;
  color:#102a43;
}
/* 次要工具 */
.btn{ background:var(--btn-muted); }
.btn:hover{ background:var(--btn-muted-hover); }
/* 主要三鍵 */
.btn-main{ background:var(--btn-main); }
.btn-main:hover{ background:var(--btn-main-hover); }
/* 摺疊鈕（對應三群色） */
.btn-sem{ background:var(--btn-sem); }
.btn-sem:hover{ background:var(--btn-sem-hover); }
.btn-sub{ background:var(--btn-sub); }
.btn-sub:hover{ background:var(--btn-sub-hover); }
.btn-sum{ background:var(--btn-sum); }
.btn-sum:hover{ background:var(--btn-sum-hover); }



</style>
</head>

<body>
<h1>計算課輔帶班津貼 永平、秀朗、永和</h1>

<!-- 非必填的設定 -->
<div class="settings-row" role="group" aria-label="非必填的設定">
  <strong>非必填的設定：</strong>

  <div class="field">
    <label for="workdays">本月工作天數</label>
    <input type="number" id="workdays" value="0" min="0" oninput="recalcAll()">
  </div>

  <div class="field">
    <label for="requiredDays">寒暑責任額天數</label>
    <input type="number" id="requiredDays" value="0" min="0" oninput="recalcAll()">
    <span class="note">（暑假用17天）</span>
  </div>

  <div class="field">
    <label for="defaultSpecialCoursePrice">特色課預設單價</label>
    <span class="input-group">
      <span class="prefix">$</span>
      <input type="number" id="defaultSpecialCoursePrice" value="180" min="0" step="1" oninput="recalcAll()">
    </span>
  </div>
</div>

<!-- 批次新增 -->
<div class="batch-merge">
  <div class="title">批次新增班級/導師：</div>
  <textarea id="batchInput" placeholder="請貼上空格分隔，例如：1A 1B APPLE老師"></textarea>
</div>

<!-- 操作按鈕列 -->
<div class="toolbar">
  <button class="btn-main" onclick="batchAddTeachers()">👥 批次新增班級/導師</button>
  <button class="btn-main" onclick="addRow()">➕ 新增空白列</button>
  <button class="btn-main" onclick="removeEmptyRows()">🗑️ 刪除空白列</button>

  <button class="btn" onclick="copyNameAndFormula()">📝 複製導師與津貼算式</button>
  <button class="btn" onclick="copyTable()">📋 複製整張表格</button>
  <button class="btn" onclick="exportCSV()">💾 匯出 CSV 檔案</button>
</div>

<!-- 摺疊控制 -->
<div class="toolbar">
  <button type="button" id="toggleSem" class="btn-sem">↕ 摺疊/展開：學期欄</button>
  <button type="button" id="toggleSub" class="btn-sub">↕ 摺疊/展開：代課欄</button>
  <button type="button" id="toggleSum" class="btn-sum">↕ 摺疊/展開：寒暑欄</button>
</div>

<div class="table-wrap">
  <table id="dataTable" role="grid" aria-label="教師津貼計算表">
    <thead>
      <tr>
        <th class="thead-group-monthly">導師</th>
        <th class="thead-group-semester crossSchoolCol">是否跨校</th>
        <th class="thead-group-semester">全月人數</th>
        <th class="thead-group-semester">全月津貼</th>
        <th class="thead-group-semester">非全月生<br>共幾天</th>
        <th class="thead-group-semester">非全月津貼</th>
        <th class="thead-group-semester">學期天<br>比例</th>
        <th class="thead-group-semester">學期津貼</th>
        <th class="thead-group-sub">學期代課(天)</th>
        <th class="thead-group-sub">學期代課(時)</th>
        <th class="thead-group-sub">學期代課扣</th>
        <th class="thead-group-summer">點名表點數(1天1點.半天半點)</th>
        <th class="thead-group-summer">一日營(1)點數</th>
        <th class="thead-group-summer">一日營(2)點數</th>
        <th class="thead-group-summer">寒暑津貼</th>
        <th class="thead-group-monthly">本月津貼<br>算式</th>
        <th class="thead-group-monthly noteCol">備註</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
/* ===== 顯示與最終計算規則 =====
   - 顯示：中間欄位四捨五入
   - 計算：保留原始小數做運算，最後本月津貼(不含額外獎金)無條件進位
*/
const roundDisp = n => Math.round(+n);      // 顯示四捨五入（整數）
const ceilInt   = n => Math.ceil(+n - 1e-12); // 最終無條件進位（避免浮點誤差）

/* ========= 算式文字 ========= */
function generateSemesterBonusFormula(grade, persons, partialDays, workdays, semRate){
  const parts=[];
  if(persons>15) parts.push(`$${grade} * (${persons} - 15)`);
  if(partialDays>0 && workdays>0) parts.push(`$${grade} * ${partialDays} / ${workdays}`);
  if(!parts.length) return '';
  let f = parts.join(' + ');
  if(semRate!==1){
    const r = semRate % 1 === 0 ? semRate.toFixed(0) : semRate.toString();
    f = `[${f}] * ${r}`;
  }
  return f;
}
function generateSubstitutionDeductionFormula(subDays, subHours, subTotalRaw){
  if(subDays===0 && subHours===0){
    return (subTotalRaw>0.01) ? ` - 代課扣除$${roundDisp(subTotalRaw)}` : '';
  }
  let t=' - 請代課';
  if(subDays>0) t+=`${subDays}天`;
  if(subHours>0) t+=`${subHours}小時`;
  t+=`$${roundDisp(subTotalRaw)}`;
  return t;
}
function generateVacationBonusFormula(attendPts, camp1Pts, camp2Pts, requiredDays, vacBonusRaw, userTotal, requiredTotal){
  const parts=[];
  if(attendPts>0) parts.push(`${attendPts}`);
  if(camp1Pts>0) parts.push(`${camp1Pts}`);
  if(camp2Pts>0) parts.push(`${camp2Pts}`);
  if(userTotal<=requiredTotal){
    if(userTotal>0 || requiredTotal>0) return ` (點數${parts.join('+')}未超過責任額 ${requiredTotal}點)`;
    return '';
  }
  if(vacBonusRaw>0){
    let expr = parts.join('+');
    if(requiredDays>0) expr += `-15*${requiredDays}`;
    return ` + $36*(${expr})`;
  }
  return '';
}

/* ========= 互動：新增/批次/刪空白 ========= */
function batchAddTeachers(){
  const input = document.getElementById('batchInput').value.trim();
  if(!input){ alert('請先輸入班級/導師！'); return; }
  input.split(/\s+/).forEach(name=>{
    if(!name) return;
    addRow();
    const lastRow = document.getElementById('rows').lastElementChild;
    lastRow.querySelector('input.teacher').value = name;
  });
  recalcAll();
  document.getElementById('batchInput').value='';
}
function addRow(){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td class="thead-group-monthly"><input type="text" class="teacher" placeholder="導師"/></td>
    <td class="thead-group-semester crossSchoolCol"><input type="checkbox" class="crossSchool" onchange="recalcAll()"/></td>
    <td class="thead-group-semester"><input type="number" class="persons" min="0" value="15" oninput="recalcAll()"/></td>
    <td class="thead-group-semester fullBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="partialDays" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-semester partialBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="rate" step="0.001" min="0" max="1" value="1" oninput="recalcAll()"/></td>
    <td class="thead-group-semester semTotal">0</td>

    <td class="thead-group-sub"><input type="number" class="subDays" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-sub"><input type="number" class="subHours" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-sub subTotal">0</td>

    <td class="thead-group-summer"><input type="number" class="attend" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-summer"><input type="number" class="camp1" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-summer"><input type="number" class="camp2" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-summer vacBonus"></td>

    <td class="thead-group-monthly finalBonus">
      <span class="finalBonusValue" style="display:none;">0</span><br>
      <span class="finalBonusFormula"></span>
    </td>

    <td class="thead-group-monthly noteCol">
  <div class="note-wrap">
    <label>高年級加給 $ <input type="number" class="seniorBonus" min="0" step="1000" value="0" oninput="recalcAll()"/></label>
    <label>特色課 <input type="number" class="specialCourse" min="0" value="0" oninput="recalcAll()"/> × $<input type="number" class="specialCoursePrice" min="0" step="1" placeholder="預設" oninput="recalcAll()"/></label>
    <label>簽約金 $ <input type="number" class="signBonus"   min="0" step="1000" value="0" oninput="recalcAll()"/></label>
    <label>留班獎金 <input type="number" class="repeatBonus" min="0" value="0" oninput="recalcAll()"/></label>
    <input type="text" class="note" placeholder="備註"/>
  </div>
</td>`;
  
  document.getElementById('rows').appendChild(tr);
  recalcAll();
}
function removeEmptyRows(){
  document.querySelectorAll('#rows tr').forEach(row=>{
    const teacher = row.querySelector('.teacher')?.value.trim();
    const persons = parseFloat(row.querySelector('.persons')?.value || 0);
    const attend  = parseFloat(row.querySelector('.attend')?.value || 0);
    const camp1   = parseFloat(row.querySelector('.camp1')?.value || 0);
    const camp2   = parseFloat(row.querySelector('.camp2')?.value || 0);
    const isEmpty = !teacher && (persons===15 || persons===0 || isNaN(persons)) && attend===0 && camp1===0 && camp2===0;
    if(isEmpty) row.remove();
  });
  recalcAll();
}

/* ========= 計算主流程（顯示四捨五入；最終無條件進位） ========= */
function calcGrade(persons, isCrossSchool){
  let g26=800, g21=700, g15=600;
  if(isCrossSchool){ g26+=50; g21+=50; g15+=50; }
  if(persons>=26) return g26;
  if(persons>=21) return g21;
  if(persons>=15) return g15;
  return 0;
}
function calcRow(row){
  const workdays     = parseFloat(document.getElementById('workdays').value) || 0;
  const requiredDays = parseFloat(document.getElementById('requiredDays').value) || 0;

  const getNum = cls=>{
    const el=row.querySelector(`.${cls}`);
    if(!el) return 0;
    if(el.tagName==='INPUT' && el.type==='checkbox') return el.checked?1:0;
    if(el.tagName==='INPUT') return parseFloat(el.value)||0;
    return parseFloat(el.textContent)||0;
  };

  const persons = getNum('persons');
  const isCrossSchool = row.querySelector('.crossSchool').checked;
  const grade  = calcGrade(persons, isCrossSchool);

  const partialDays = getNum('partialDays');
  const semRateRaw  = getNum('rate');
  const semRate = isNaN(semRateRaw) ? 1 : semRateRaw;

  const subDays  = getNum('subDays');
  if(subDays>workdays){
    alert(`⚠️ 代課天數（${subDays}）不可大於本月工作天數（${workdays}）`);
    row.querySelector('.subDays').value = workdays;
  }
  const subHours = getNum('subHours');

  const attendPts = getNum('attend');
  const camp1Pts  = getNum('camp1');
  const camp2Pts  = getNum('camp2');

  /* === 原始小數（用來計算） === */
  const fullBonusRaw    = persons>15 ? (persons-15)*grade : 0;
  const partialBonusRaw = (workdays>0 && partialDays>0)? grade*partialDays/workdays : 0;
  const semTotalRaw     = (fullBonusRaw + partialBonusRaw) * semRate;

  const subTotalRaw     = (workdays>0)
    ? (semTotalRaw/workdays)*subDays + (semTotalRaw/workdays/8)*subHours
    : 0;

  const userTotal      = attendPts + camp1Pts + camp2Pts;
  const requiredTotal  = 15*requiredDays;
  const vacBonusRaw    = userTotal>requiredTotal ? (userTotal-requiredTotal)*36 : 0;

  // 最終本月津貼（不含加給）：無條件進位
  const finalBaseRaw   = semTotalRaw - subTotalRaw + vacBonusRaw;
  const finalBase      = ceilInt(finalBaseRaw);

  /* === 顯示（四捨五入） === */
  row.querySelector('.fullBonus').textContent    = roundDisp(fullBonusRaw);
  row.querySelector('.partialBonus').textContent = roundDisp(partialBonusRaw);
  row.querySelector('.semTotal').textContent     = roundDisp(semTotalRaw);
  row.querySelector('.subTotal').textContent     = roundDisp(subTotalRaw);

  const vacCell = row.querySelector('.vacBonus');
  if (userTotal === 0 && requiredTotal === 0) {
    vacCell.textContent = '';
  } else if (userTotal <= requiredTotal) {
    vacCell.innerHTML = '<span style="font-size:.88em;">未超過責任額</span>';
  } else {
    vacCell.textContent = roundDisp(vacBonusRaw);
  }

  row.querySelector('.finalBonusValue').textContent = finalBase.toString();

  const semF = generateSemesterBonusFormula(grade, persons, partialDays, workdays, semRate);
  const subF = generateSubstitutionDeductionFormula(subDays, subHours, subTotalRaw);
  const vacF = generateVacationBonusFormula(attendPts, camp1Pts, camp2Pts, requiredDays, vacBonusRaw, userTotal, requiredTotal);

  let base = [semF, subF, vacF].filter(Boolean).join('');
  if(!base) base='無人數津貼';

  // 額外加給（皆為整數）
  const scCount = parseInt(row.querySelector('.specialCourse')?.value || '0',10);
  const defaultPrice = Math.max(0, parseFloat(document.getElementById('defaultSpecialCoursePrice')?.value || '180'));
  const scpRaw = row.querySelector('.specialCoursePrice')?.value ?? '';
  const scPrice = (scpRaw==='' || isNaN(parseFloat(scpRaw))) ? defaultPrice : Math.max(0, parseFloat(scpRaw));
  const scBonus = scCount*scPrice;

  const signBonus   = parseFloat(row.querySelector('.signBonus')?.value || '0') || 0;    // 簽約獎金直接金額
  const seniorBonus = parseFloat(row.querySelector('.seniorBonus')?.value || '0') || 0;  // 高年級加給直接金額


  const repeatBonus = parseInt(row.querySelector('.repeatBonus')?.value || '0',10);

  const extras = scBonus + signBonus + seniorBonus + repeatBonus;
  const finalTotal = finalBase + extras;

  row.querySelector('.finalBonusFormula').textContent =
  `${finalTotal}=${base}`
  + (seniorBonus>0 ? `（高年級加給$${seniorBonus}）` : '')
  + (scCount>0 ? `（特色課×${scCount}×$${scPrice}=$${scBonus}）` : '')
  + (signBonus>0 ? `（簽約金$${signBonus}）` : '')
  + (repeatBonus>0 ? `（留班獎金$${repeatBonus}）` : '');

}

function recalcAll(){ document.querySelectorAll('#rows tr').forEach(calcRow); }

/* ========= 匯出/複製 ========= */
function copyNameAndFormula(){
  let text='導師\t本月津貼算式\n';
  document.querySelectorAll('#rows tr').forEach(row=>{
    const name = row.querySelector('.teacher')?.value.trim() || '';
    const formula = row.querySelector('.finalBonusFormula')?.textContent.trim() || '';
    if(name || formula) text += `${name}\t${formula}\n`;
  });
  navigator.clipboard.writeText(text).then(()=> alert('導師與津貼算式已複製，可貼上至 Excel 或 Google Sheets'));
}
function copyTable(){
  const headers=[
    '導師','是否跨校','全月人數','全月津貼','非全月天數','非全月津貼','學期天比例','學期津貼',
    '代課天','代課時','代課扣除','點名表點數','一日營1點數','一日營2點數','寒暑津貼',
    '本月津貼算式','備註'
  ];
  let text=headers.join('\t')+'\n';
  document.querySelectorAll('#rows tr').forEach(row=>{
    const getInput=cls=>{ const el=row.querySelector(`.${cls}`); if(!el) return ''; return el.type==='checkbox' ? (el.checked?'是':'否') : (el.value||''); };
    const getText =cls=>{ const el=row.querySelector(`.${cls}`); return el ? el.textContent.trim():''; };
    const line=[
      getInput('teacher'), getInput('crossSchool'), getInput('persons'), getText('fullBonus'),
      getInput('partialDays'), getText('partialBonus'), getInput('rate'), getText('semTotal'),
      getInput('subDays'), getInput('subHours'), getText('subTotal'), getInput('attend'),
      getInput('camp1'), getInput('camp2'), getText('vacBonus'), getText('finalBonusFormula'),
      getInput('note')
    ];
    text+= line.map(x=>`"${x}"`).join('\t')+'\n';
  });
  navigator.clipboard.writeText(text).then(()=> alert('表格已複製，可貼上至 Excel 或 Google Sheets'));
}
function exportCSV(){
  const headers=[
    "導師","是否跨校","全月人數","全月津貼","非全月天數","非全月津貼",
    "學期天比例","學期津貼","代課天","代課時","代課扣除",
    "點名表點數","一日營1點數","一日營2點數","寒暑津貼","本月津貼計算式","備註"
  ];
  let csv='\uFEFF'+headers.join(',')+'\n';
  document.querySelectorAll('#rows tr').forEach(row=>{
    const get =cls=>{
      const el=row.querySelector(`.${cls}`);
      if(!el) return '';
      if(el.tagName==='INPUT' && el.type==='checkbox') return el.checked?'是':'否';
      if(el.tagName==='INPUT' || el.tagName==='SELECT') return el.value;
      return el.textContent;
    };
    const formula=row.querySelector('.finalBonusFormula')?.textContent || '';
    const line=[
      get('teacher'), get('crossSchool'), get('persons'), get('fullBonus'),
      get('partialDays'), get('partialBonus'), get('rate'), get('semTotal'),
      get('subDays'), get('subHours'), get('subTotal'), get('attend'),
      get('camp1'), get('camp2'), get('vacBonus'), formula, get('note')
    ];
    csv+= line.map(x=>`"${x}"`).join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url;
  a.download=`${new Date().toISOString().slice(0,10)}_課輔帶班津貼.csv`;
  a.click(); URL.revokeObjectURL(url);
}

/* ========= 摺疊切換 ========= */
(function setupCollapseToggles(){
  const table = document.getElementById('dataTable');
  document.getElementById('toggleSem')?.addEventListener('click', ()=> table.classList.toggle('collapse-semester'));
  document.getElementById('toggleSub')?.addEventListener('click', ()=> table.classList.toggle('collapse-sub'));
  document.getElementById('toggleSum')?.addEventListener('click', ()=> table.classList.toggle('collapse-summer'));
})();

/* ========= 防呆提示 ========= */
document.addEventListener('input', e=>{
  const workdays = parseFloat(document.getElementById('workdays').value) || 0;
  const requiredDays = parseFloat(document.getElementById('requiredDays').value) || 0;
  const warn=(cond,msg)=>{ if(cond) alert(msg); };
  if(e.target.classList.contains('partialDays')||
     e.target.classList.contains('subDays')||
     e.target.classList.contains('subHours')){
    warn(workdays===0,'請先填寫「本月工作天數」再輸入相關欄位');
  }
  if(e.target.classList.contains('attend')||
     e.target.classList.contains('camp1')||
     e.target.classList.contains('camp2')){
    warn(requiredDays===0,'請先填寫「寒暑責任額天數」再輸入點數');
  }
});
</script>
</body>
</html>
