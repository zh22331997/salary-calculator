<!DOCTYPE html> 
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>è¨ˆç®—èª²è¼”å¸¶ç­æ´¥è²¼ æ°¸å¹³ã€ç§€æœ—ã€æ°¸å’Œ</title>
<style>
/***** =========================================================
 *  0) ä¸»é¡Œè®Šæ•¸ï¼ˆè«è˜­è¿ªè‰²ç³»ï¼‰ï¼‹å¸¸ç”¨å¯¬åº¦
 *  æƒ³æ›è‰² / å¾®èª¿æŒ‰éˆ•æˆ–æ¬„å¯¬ï¼Œå„ªå…ˆæ”¹é€™è£¡
 * ======================================================= *****/
:root{
  /* è¡¨é ­èƒŒæ™¯ï¼ˆå°æ‡‰ä¸‰ç¾¤ï¼‰ */
  --th-bg-month:#ffffff;
  --th-bg-sem:  #e6f3f6;  /* æ¸…æ°´è—-æ·¡ */
  --th-bg-sub:  #f7eadf;  /* æç²‰-æ·¡  */
  --th-bg-sum:  #f2e7f6;  /* æ·¡ç´«-æ·¡  */

  /* å…§å®¹åˆ—åº•è‰²ï¼ˆæ›´æ·¡ï¼Œå°æ‡‰ä¸‰ç¾¤ï¼‰ */
  --td-bg-sem:  #f3fbfd;
  --td-bg-sub:  #fff7ef;
  --td-bg-sum:  #faf3fb;

  /* é‚Šç·šèˆ‡æ–‡å­— */
  --bd:#d4d7dd;
  --ink:#293241;

  /* ä¸»è¦æ“ä½œéµï¼ˆæ‰¹æ¬¡/æ–°å¢/åˆªé™¤ï¼‰è«è˜­è¿ªè—ç° */
  --btn-main:#a7c1d1;
  --btn-main-hover:#94b3c6;

  /* æ‘ºç–Šéµï¼ˆå°æ‡‰åˆ†ç¾¤ï¼Œç¨æ·±ä¸€éšï¼‰ */
  --btn-sem:#b8dce3;
  --btn-sem-hover:#a9cfda;

  --btn-sub:#f2d8c9;
  --btn-sub-hover:#eecab5;

  --btn-sum:#e1caea;
  --btn-sum-hover:#d8bde4;

  /* å…¶ä»–å·¥å…·éµï¼ˆæ¬¡è¦ï¼‰ */
  --btn-muted:#cfd6df;
  --btn-muted-hover:#c2cbd6;

  /* ====== æ¬„å¯¬åƒæ•¸ï¼ˆæ–¹ä¾¿é›†ä¸­èª¿æ•´ï¼‰ ====== */
  /* åƒ…éœ€ 3 ä½æ•¸çš„æ¬„ä½å¯¬åº¦ï¼ˆäººæ•¸ã€å¤©æ•¸ã€æ¯”ä¾‹ç­‰ï¼‰ */
  --w-3digit: 2.8em;       /* ç´„ 3 ä½æ•¸å‰›å¥½ */
  --w-3digit-plus: 3.2em;  /* 3 ä½æ•¸åå¯¬ï¼ˆè¼ƒèˆ’é©ï¼‰ */

  /* æœ¬æœˆæ´¥è²¼ç®—å¼æ¬„ï¼ˆåŠ å¯¬é¡¯ç¤ºï¼‰ */
  --w-final-formula-min: 26em; /*æ¯”ä¸‹ä¸€è¡Œå°‘2*/
  --w-final-formula:     28em;

  /* å‚™è¨»æ¬„ï¼ˆæ”¹ç‚ºç´„åŸæœ¬çš„ä¸€åŠå¯¬ï¼‰ */
  --w-note-col:     15em; /*æ¯”ä¸‹ä¸€è¡Œå¤š1*/
  --w-note-input:   14em;
  --w-note-number:   2.8em;
}

/***** =========================================================
 *  1) å…¨ç«™åŸºç¤
 * ======================================================= *****/
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  font-family:"Microsoft JhengHei",sans-serif;
  padding:24px;
  background:#f7f7f8;
  color:var(--ink);
}
h1{
  margin:0 0 16px;
  padding-left:12px;
  border-left:6px solid #3c82f6; /* æ¨™é¡Œè£é£¾ */
}

/***** =========================================================
 *  2) è¡¨æ ¼å¤–æ¡†ï¼‹å›ºå®šç‰ˆé¢é…ç½®ï¼ˆstickyï¼‰
 * ======================================================= *****/
.table-wrap{
  max-height:70vh;
  overflow:auto;
  border:1px solid #e5e7eb;
  border-radius:12px;
  background:#fff;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  table-layout:fixed; /* å›ºå®šç‰ˆé¢ï¼Œéµå®ˆæ¬„å¯¬ */
}
th,td{
  border:1px solid var(--bd);
  text-align:center;
  vertical-align:middle;
  padding:10px;
}

/* thead sticky + åˆ†è‰² */
#dataTable thead th{
  position:sticky; top:0; z-index:6;
  background:var(--th-bg,#fff);
  box-shadow:0 2px 0 rgba(0,0,0,.04);
  white-space:normal; overflow:visible; text-overflow:clip;
  font-size:.95em; line-height:1.15; padding:8px 6px;
}
#dataTable thead th.thead-group-monthly{ --th-bg: var(--th-bg-month); }
#dataTable thead th.thead-group-semester{ --th-bg: var(--th-bg-sem); }
#dataTable thead th.thead-group-sub{ --th-bg: var(--th-bg-sub); }
#dataTable thead th.thead-group-summer{ --th-bg: var(--th-bg-sum); }

/* ç¬¬ä¸€æ¬„ stickyï¼ˆtbodyï¼‰ */
#rows td:first-child{
  position:sticky; left:0; z-index:4; background:#fff;
}

/***** =========================================================
 *  3) å…§å®¹åˆ—åˆ†è‰²ï¼ˆtbodyï¼‰
 * ======================================================= *****/
#rows td.thead-group-semester{ background:var(--td-bg-sem); }
#rows td.thead-group-sub{      background:var(--td-bg-sub); }
#rows td.thead-group-summer{   background:var(--td-bg-sum); }
#rows td.thead-group-monthly{  background:#ffffff; }

/***** =========================================================
 *  4) æ¬„å¯¬ï¼ˆä»¥ class å°æ‡‰ä½ åŸæœ¬çš„æ¬„ä½ï¼‰
 *  ãƒ»æœ¬æœˆæ´¥è²¼ç®—å¼åŠ å¯¬
 *  ãƒ»å‚™è¨»æ¬„è®Šçª„ï¼ˆç´„åŸæœ¬ä¸€åŠï¼‰
 *  ãƒ»3 ä½æ•¸æ¬„ä½å¾®ç¸®ï¼ˆæ–°çš„éœ€æ±‚ï¼‰
 * ======================================================= *****/
/* ä¸€èˆ¬æ¬„ä½ï¼ˆè‹¥æœªåœ¨ä¸‹æ–¹è¦†è“‹ï¼Œæ²¿ç”¨åŸå…ˆè¨­å®šæˆ–é è¨­åˆ†é…ï¼‰ */
th.teacher, td .teacher{ width:6em; }
th.crossSchoolCol, td.crossSchoolCol{ width:3.2em; }
th.fullBonus, td.fullBonus{ width:6em; }
th.partialBonus, td.partialBonus{ width:6em; }
th.semTotal, td.semTotal{ width:7em; }
th.subTotal, td.subTotal{ width:6em; }
th.vacBonus, td.vacBonus{ width:7em; }

/* ====== åªéœ€ 3 ä½æ•¸çš„æ¬„ä½ â†’ å¾®ç¸® ======
   å¯æ”¹ç”¨ --w-3digit / --w-3digit-plus èª¿æ•´ç·Šåº¦ */
th.persons,      td .persons{     width: var(--w-3digit-plus); } /* å…¨æœˆäººæ•¸ */
th.partialDays,  td .partialDays{ width: var(--w-3digit-plus); } /* éå…¨æœˆç”Ÿå¤©æ•¸ */
th.rate,         td .rate{        width: var(--w-3digit); }      /* æ¯”ä¾‹ï¼ˆ0~1ï¼‰ */
th.subDays,      td .subDays{     width: var(--w-3digit); }      /* ä»£èª²å¤© */
th.subHours,     td .subHours{    width: var(--w-3digit); }      /* ä»£èª²æ™‚ */
th.attend,       td .attend{      width: var(--w-3digit-plus); } /* é»åè¡¨é»æ•¸ */
th.camp1,        td .camp1{       width: var(--w-3digit-plus); } /* ä¸€æ—¥ç‡Ÿ(1) */
th.camp2,        td .camp2{       width: var(--w-3digit-plus); } /* ä¸€æ—¥ç‡Ÿ(2) */

/* æœ¬æœˆæ´¥è²¼ç®—å¼æ¬„ï¼šåŠ å¯¬ï¼Œä¾¿æ–¼é–±è®€é•·å…¬å¼ */
td.finalBonus{
  min-width: var(--w-final-formula-min);
  width:     var(--w-final-formula);
}

/* å‚™è¨»æ¬„ï¼šæ”¹ç‚ºè¼ƒçª„ */
th.noteCol, td.noteCol{
  width:     var(--w-note-col);
  min-width: var(--w-note-col);
}

/***** =========================================================
 *  5) å„²å­˜æ ¼é¡¯ç¤ºè¦å‰‡
 *  ãƒ»å°æ¬„ä½ç¶­æŒçœç•¥
 *  ãƒ»éœ€è¦å®Œæ•´é¡¯ç¤ºï¼ˆvacBonus/finalBonus/noteColï¼‰å…è¨±æ›è¡Œ
 * ======================================================= *****/
#dataTable tbody td{
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
#dataTable tbody td.vacBonus,
#dataTable tbody td.finalBonus,
#dataTable tbody td.noteCol{
  white-space:normal; overflow:visible; text-overflow:clip; text-align:left;
}

/* å…§éƒ¨è¼¸å…¥çµ±ä¸€å¤–è§€ */
#dataTable tbody td input[type="number"],
#dataTable tbody td input[type="text"]{
  width:100%; max-width:100%;
  padding:6px 8px; text-align:center;
  border:1px solid #cbd5e1; border-radius:8px; font-size:1em;
}

/* checkbox ä¸è¢«æ’æ»¿ */
#dataTable td.crossSchoolCol input.crossSchool{
  width:auto; display:inline-block; margin:0 auto;
}

/***** =========================================================
 *  6) å‚™è¨»æ¬„æ’ç‰ˆï¼ˆç¸®è£¡é¢çš„è¼¸å…¥å¯¬ï¼‰
 * ======================================================= *****/
td.noteCol{ padding:6px; }
td.noteCol .note-wrap{
  display:flex; flex-wrap:wrap; align-items:center; gap:6px 10px;
}
td.noteCol label{
  display:inline-flex; align-items:center; gap:4px; margin:0; white-space:nowrap;
  font-size: 0.9rem;   /* â† æ–°å¢ï¼šå‚™è¨»æ¬„ä¸­æ–‡å­—ç¸®å° */
}
/* è·Ÿè‘—ã€Œå‚™è¨»æ¬„è®Šçª„ã€å¾®ç¸®å…§éƒ¨æ¬„ä½ */
td.noteCol input.note{ width: var(--w-note-input); text-align:left; }
td.noteCol input[type="number"]{ width: var(--w-note-number); }

/***** =========================================================
 *  7) ç®—å¼å°å­—
 * ======================================================= *****/
.finalBonusFormula{
  font-size:.85em; color:#4b5563; word-break:break-word;
}

/***** =========================================================
 *  8) æ‘ºç–Šç¾¤çµ„ï¼ˆæŒ‰éˆ•åˆ‡æ›æ™‚åŠ ä¸Š classï¼‰
 * ======================================================= *****/
.collapse-semester th.thead-group-semester,
.collapse-semester td.thead-group-semester{ display:none; }
.collapse-sub th.thead-group-sub,
.collapse-sub td.thead-group-sub{ display:none; }
.collapse-summer th.thead-group-summer,
.collapse-summer td.thead-group-summer{ display:none; }

/***** =========================================================
 *  9) ä¸Šæ–¹è¨­å®šå€ï¼ˆéå¿…å¡«çš„è¨­å®šï¼‰
 * ======================================================= *****/
.settings-row{
  display:flex; flex-wrap:wrap; align-items:center;
  gap:16px 22px; padding:12px; margin:10px 0 14px;
  background:#fff; border:1px solid #e5e7eb; border-radius:12px;
}
.settings-row .field{ display:inline-flex; align-items:center; gap:8px; }
.settings-row label{ color:#374151; }
.settings-row input[type="number"]{
  width:120px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; font-size:1rem;
}
.settings-row .note{ color:#6b7280; font-size:.9rem; }
.input-group{ display:inline-flex; align-items:center; gap:6px; }
.prefix{
  padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px;
  background:#f9fafb; color:#374151;
}
.settings-row input:focus{
  outline:none; border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.15);
}

/***** =========================================================
 * 10) æ‰¹æ¬¡æ–°å¢ï¼ˆèªªæ˜åˆä½µåœ¨ placeholderï¼‰
 * ======================================================= *****/
.batch-merge{
  display:grid; grid-template-columns:max-content 1fr; gap:12px;
  align-items:flex-start; padding:12px; margin:10px 0 12px;
  background:#fff; border:1px solid #e5e7eb; border-radius:12px;
}
.batch-merge .title{
  font-weight:600; color:#111827; white-space:nowrap; padding-top:6px;
}
.batch-merge #batchInput{
  width:100%; min-height:44px; max-height:160px; resize:vertical;
  padding:8px 10px; border:none; background:#fff; font-size:1rem; line-height:1.4; outline:none;
}
.batch-merge:focus-within{
  border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.15); transition:.15s;
}
@media (max-width:720px){
  .batch-merge{ grid-template-columns:1fr; gap:6px; }
  .batch-merge .title{ padding-top:0; }
}

/***** =========================================================
 * 11) å·¥å…·åˆ—æŒ‰éˆ•ï¼ˆè«è˜­è¿ªä¸€è‡´é¢¨æ ¼ï¼‰
 * ä¸»è¦ä¸‰éµç”¨ .btn-mainï¼›æ‘ºç–Šéˆ•ä¾åˆ†ç¾¤ .btn-sem/.btn-sub/.btn-sum
 * å…¶ä»–å·¥å…·ç”¨ .btn
 * ======================================================= *****/
.toolbar{ display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 14px; }

button{
  appearance:none; border:0; cursor:pointer;
  padding:.6em 1em; border-radius:12px; font-size:16px;
  line-height:1; transition:.15s;
  display:inline-flex; align-items:center; gap:.5em;
  color:#102a43;
}
/* æ¬¡è¦å·¥å…· */
.btn{ background:var(--btn-muted); }
.btn:hover{ background:var(--btn-muted-hover); }
/* ä¸»è¦ä¸‰éµ */
.btn-main{ background:var(--btn-main); }
.btn-main:hover{ background:var(--btn-main-hover); }
/* æ‘ºç–Šéˆ•ï¼ˆå°æ‡‰ä¸‰ç¾¤è‰²ï¼‰ */
.btn-sem{ background:var(--btn-sem); }
.btn-sem:hover{ background:var(--btn-sem-hover); }
.btn-sub{ background:var(--btn-sub); }
.btn-sub:hover{ background:var(--btn-sub-hover); }
.btn-sum{ background:var(--btn-sum); }
.btn-sum:hover{ background:var(--btn-sum-hover); }



</style>
</head>

<body>
<h1>è¨ˆç®—èª²è¼”å¸¶ç­æ´¥è²¼ æ°¸å¹³ã€ç§€æœ—ã€æ°¸å’Œ</h1>

<!-- éå¿…å¡«çš„è¨­å®š -->
<div class="settings-row" role="group" aria-label="éå¿…å¡«çš„è¨­å®š">
  <strong>éå¿…å¡«çš„è¨­å®šï¼š</strong>

  <div class="field">
    <label for="workdays">æœ¬æœˆå·¥ä½œå¤©æ•¸</label>
    <input type="number" id="workdays" value="0" min="0" oninput="recalcAll()">
  </div>

  <div class="field">
    <label for="requiredDays">å¯’æš‘è²¬ä»»é¡å¤©æ•¸</label>
    <input type="number" id="requiredDays" value="0" min="0" oninput="recalcAll()">
    <span class="note">ï¼ˆæš‘å‡ç”¨17å¤©ï¼‰</span>
  </div>

  <div class="field">
    <label for="defaultSpecialCoursePrice">ç‰¹è‰²èª²é è¨­å–®åƒ¹</label>
    <span class="input-group">
      <span class="prefix">$</span>
      <input type="number" id="defaultSpecialCoursePrice" value="180" min="0" step="1" oninput="recalcAll()">
    </span>
  </div>
</div>

<!-- æ‰¹æ¬¡æ–°å¢ -->
<div class="batch-merge">
  <div class="title">æ‰¹æ¬¡æ–°å¢ç­ç´š/å°å¸«ï¼š</div>
  <textarea id="batchInput" placeholder="è«‹è²¼ä¸Šç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ï¼š1A 1B APPLEè€å¸«"></textarea>
</div>

<!-- æ“ä½œæŒ‰éˆ•åˆ— -->
<div class="toolbar">
  <button class="btn-main" onclick="batchAddTeachers()">ğŸ‘¥ æ‰¹æ¬¡æ–°å¢ç­ç´š/å°å¸«</button>
  <button class="btn-main" onclick="addRow()">â• æ–°å¢ç©ºç™½åˆ—</button>
  <button class="btn-main" onclick="removeEmptyRows()">ğŸ—‘ï¸ åˆªé™¤ç©ºç™½åˆ—</button>

  <button class="btn" onclick="copyNameAndFormula()">ğŸ“ è¤‡è£½å°å¸«èˆ‡æ´¥è²¼ç®—å¼</button>
  <button class="btn" onclick="copyTable()">ğŸ“‹ è¤‡è£½æ•´å¼µè¡¨æ ¼</button>
  <button class="btn" onclick="exportCSV()">ğŸ’¾ åŒ¯å‡º CSV æª”æ¡ˆ</button>
</div>

<!-- æ‘ºç–Šæ§åˆ¶ -->
<div class="toolbar">
  <button type="button" id="toggleSem" class="btn-sem">â†• æ‘ºç–Š/å±•é–‹ï¼šå­¸æœŸæ¬„</button>
  <button type="button" id="toggleSub" class="btn-sub">â†• æ‘ºç–Š/å±•é–‹ï¼šä»£èª²æ¬„</button>
  <button type="button" id="toggleSum" class="btn-sum">â†• æ‘ºç–Š/å±•é–‹ï¼šå¯’æš‘æ¬„</button>
</div>

<div class="table-wrap">
  <table id="dataTable" role="grid" aria-label="æ•™å¸«æ´¥è²¼è¨ˆç®—è¡¨">
    <thead>
      <tr>
        <th class="thead-group-monthly">å°å¸«</th>
        <th class="thead-group-semester crossSchoolCol">æ˜¯å¦è·¨æ ¡</th>
        <th class="thead-group-semester">å…¨æœˆäººæ•¸</th>
        <th class="thead-group-semester">å…¨æœˆæ´¥è²¼</th>
        <th class="thead-group-semester">éå…¨æœˆç”Ÿ<br>å…±å¹¾å¤©</th>
        <th class="thead-group-semester">éå…¨æœˆæ´¥è²¼</th>
        <th class="thead-group-semester">å­¸æœŸå¤©<br>æ¯”ä¾‹</th>
        <th class="thead-group-semester">å­¸æœŸæ´¥è²¼</th>
        <th class="thead-group-sub">å­¸æœŸä»£èª²(å¤©)</th>
        <th class="thead-group-sub">å­¸æœŸä»£èª²(æ™‚)</th>
        <th class="thead-group-sub">å­¸æœŸä»£èª²æ‰£</th>
        <th class="thead-group-summer">é»åè¡¨é»æ•¸(1å¤©1é».åŠå¤©åŠé»)</th>
        <th class="thead-group-summer">ä¸€æ—¥ç‡Ÿ(1)é»æ•¸</th>
        <th class="thead-group-summer">ä¸€æ—¥ç‡Ÿ(2)é»æ•¸</th>
        <th class="thead-group-summer">å¯’æš‘æ´¥è²¼</th>
        <th class="thead-group-monthly">æœ¬æœˆæ´¥è²¼<br>ç®—å¼</th>
        <th class="thead-group-monthly noteCol">å‚™è¨»</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
/* ===== é¡¯ç¤ºèˆ‡æœ€çµ‚è¨ˆç®—è¦å‰‡ =====
   - é¡¯ç¤ºï¼šä¸­é–“æ¬„ä½å››æ¨äº”å…¥
   - è¨ˆç®—ï¼šä¿ç•™åŸå§‹å°æ•¸åšé‹ç®—ï¼Œæœ€å¾Œæœ¬æœˆæ´¥è²¼(ä¸å«é¡å¤–çé‡‘)ç„¡æ¢ä»¶é€²ä½
*/
const roundDisp = n => Math.round(+n);      // é¡¯ç¤ºå››æ¨äº”å…¥ï¼ˆæ•´æ•¸ï¼‰
const ceilInt   = n => Math.ceil(+n - 1e-12); // æœ€çµ‚ç„¡æ¢ä»¶é€²ä½ï¼ˆé¿å…æµ®é»èª¤å·®ï¼‰

/* ========= ç®—å¼æ–‡å­— ========= */
function generateSemesterBonusFormula(grade, persons, partialDays, workdays, semRate){
  const parts=[];
  if(persons>15) parts.push(`$${grade} * (${persons} - 15)`);
  if(partialDays>0 && workdays>0) parts.push(`$${grade} * ${partialDays} / ${workdays}`);
  if(!parts.length) return '';
  let f = parts.join(' + ');
  if(semRate!==1){
    const r = semRate % 1 === 0 ? semRate.toFixed(0) : semRate.toString();
    f = `[${f}] * ${r}`;
  }
  return f;
}
function generateSubstitutionDeductionFormula(subDays, subHours, subTotalRaw){
  if(subDays===0 && subHours===0){
    return (subTotalRaw>0.01) ? ` - ä»£èª²æ‰£é™¤$${roundDisp(subTotalRaw)}` : '';
  }
  let t=' - è«‹ä»£èª²';
  if(subDays>0) t+=`${subDays}å¤©`;
  if(subHours>0) t+=`${subHours}å°æ™‚`;
  t+=`$${roundDisp(subTotalRaw)}`;
  return t;
}
function generateVacationBonusFormula(attendPts, camp1Pts, camp2Pts, requiredDays, vacBonusRaw, userTotal, requiredTotal){
  const parts=[];
  if(attendPts>0) parts.push(`${attendPts}`);
  if(camp1Pts>0) parts.push(`${camp1Pts}`);
  if(camp2Pts>0) parts.push(`${camp2Pts}`);
  if(userTotal<=requiredTotal){
    if(userTotal>0 || requiredTotal>0) return ` (é»æ•¸${parts.join('+')}æœªè¶…éè²¬ä»»é¡ ${requiredTotal}é»)`;
    return '';
  }
  if(vacBonusRaw>0){
    let expr = parts.join('+');
    if(requiredDays>0) expr += `-15*${requiredDays}`;
    return ` + $36*(${expr})`;
  }
  return '';
}

/* ========= äº’å‹•ï¼šæ–°å¢/æ‰¹æ¬¡/åˆªç©ºç™½ ========= */
function batchAddTeachers(){
  const input = document.getElementById('batchInput').value.trim();
  if(!input){ alert('è«‹å…ˆè¼¸å…¥ç­ç´š/å°å¸«ï¼'); return; }
  input.split(/\s+/).forEach(name=>{
    if(!name) return;
    addRow();
    const lastRow = document.getElementById('rows').lastElementChild;
    lastRow.querySelector('input.teacher').value = name;
  });
  recalcAll();
  document.getElementById('batchInput').value='';
}
function addRow(){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td class="thead-group-monthly"><input type="text" class="teacher" placeholder="å°å¸«"/></td>
    <td class="thead-group-semester crossSchoolCol"><input type="checkbox" class="crossSchool" onchange="recalcAll()"/></td>
    <td class="thead-group-semester"><input type="number" class="persons" min="0" value="15" oninput="recalcAll()"/></td>
    <td class="thead-group-semester fullBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="partialDays" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-semester partialBonus">0</td>
    <td class="thead-group-semester"><input type="number" class="rate" step="0.001" min="0" max="1" value="1" oninput="recalcAll()"/></td>
    <td class="thead-group-semester semTotal">0</td>

    <td class="thead-group-sub"><input type="number" class="subDays" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-sub"><input type="number" class="subHours" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-sub subTotal">0</td>

    <td class="thead-group-summer"><input type="number" class="attend" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-summer"><input type="number" class="camp1" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-summer"><input type="number" class="camp2" min="0" value="0" oninput="recalcAll()"/></td>
    <td class="thead-group-summer vacBonus"></td>

    <td class="thead-group-monthly finalBonus">
      <span class="finalBonusValue" style="display:none;">0</span><br>
      <span class="finalBonusFormula"></span>
    </td>

    <td class="thead-group-monthly noteCol">
  <div class="note-wrap">
    <label>é«˜å¹´ç´šåŠ çµ¦ $ <input type="number" class="seniorBonus" min="0" step="1000" value="0" oninput="recalcAll()"/></label>
    <label>ç‰¹è‰²èª² <input type="number" class="specialCourse" min="0" value="0" oninput="recalcAll()"/> Ã— $<input type="number" class="specialCoursePrice" min="0" step="1" placeholder="é è¨­" oninput="recalcAll()"/></label>
    <label>ç°½ç´„é‡‘ $ <input type="number" class="signBonus"   min="0" step="1000" value="0" oninput="recalcAll()"/></label>
    <label>ç•™ç­çé‡‘ <input type="number" class="repeatBonus" min="0" value="0" oninput="recalcAll()"/></label>
    <input type="text" class="note" placeholder="å‚™è¨»"/>
  </div>
</td>`;
  
  document.getElementById('rows').appendChild(tr);
  recalcAll();
}
function removeEmptyRows(){
  document.querySelectorAll('#rows tr').forEach(row=>{
    const teacher = row.querySelector('.teacher')?.value.trim();
    const persons = parseFloat(row.querySelector('.persons')?.value || 0);
    const attend  = parseFloat(row.querySelector('.attend')?.value || 0);
    const camp1   = parseFloat(row.querySelector('.camp1')?.value || 0);
    const camp2   = parseFloat(row.querySelector('.camp2')?.value || 0);
    const isEmpty = !teacher && (persons===15 || persons===0 || isNaN(persons)) && attend===0 && camp1===0 && camp2===0;
    if(isEmpty) row.remove();
  });
  recalcAll();
}

/* ========= è¨ˆç®—ä¸»æµç¨‹ï¼ˆé¡¯ç¤ºå››æ¨äº”å…¥ï¼›æœ€çµ‚ç„¡æ¢ä»¶é€²ä½ï¼‰ ========= */
function calcGrade(persons, isCrossSchool){
  let g26=800, g21=700, g15=600;
  if(isCrossSchool){ g26+=50; g21+=50; g15+=50; }
  if(persons>=26) return g26;
  if(persons>=21) return g21;
  if(persons>=15) return g15;
  return 0;
}
function calcRow(row){
  const workdays     = parseFloat(document.getElementById('workdays').value) || 0;
  const requiredDays = parseFloat(document.getElementById('requiredDays').value) || 0;

  const getNum = cls=>{
    const el=row.querySelector(`.${cls}`);
    if(!el) return 0;
    if(el.tagName==='INPUT' && el.type==='checkbox') return el.checked?1:0;
    if(el.tagName==='INPUT') return parseFloat(el.value)||0;
    return parseFloat(el.textContent)||0;
  };

  const persons = getNum('persons');
  const isCrossSchool = row.querySelector('.crossSchool').checked;
  const grade  = calcGrade(persons, isCrossSchool);

  const partialDays = getNum('partialDays');
  const semRateRaw  = getNum('rate');
  const semRate = isNaN(semRateRaw) ? 1 : semRateRaw;

  const subDays  = getNum('subDays');
  if(subDays>workdays){
    alert(`âš ï¸ ä»£èª²å¤©æ•¸ï¼ˆ${subDays}ï¼‰ä¸å¯å¤§æ–¼æœ¬æœˆå·¥ä½œå¤©æ•¸ï¼ˆ${workdays}ï¼‰`);
    row.querySelector('.subDays').value = workdays;
  }
  const subHours = getNum('subHours');

  const attendPts = getNum('attend');
  const camp1Pts  = getNum('camp1');
  const camp2Pts  = getNum('camp2');

  /* === åŸå§‹å°æ•¸ï¼ˆç”¨ä¾†è¨ˆç®—ï¼‰ === */
  const fullBonusRaw    = persons>15 ? (persons-15)*grade : 0;
  const partialBonusRaw = (workdays>0 && partialDays>0)? grade*partialDays/workdays : 0;
  const semTotalRaw     = (fullBonusRaw + partialBonusRaw) * semRate;

  const subTotalRaw     = (workdays>0)
    ? (semTotalRaw/workdays)*subDays + (semTotalRaw/workdays/8)*subHours
    : 0;

  const userTotal      = attendPts + camp1Pts + camp2Pts;
  const requiredTotal  = 15*requiredDays;
  const vacBonusRaw    = userTotal>requiredTotal ? (userTotal-requiredTotal)*36 : 0;

  // æœ€çµ‚æœ¬æœˆæ´¥è²¼ï¼ˆä¸å«åŠ çµ¦ï¼‰ï¼šç„¡æ¢ä»¶é€²ä½
  const finalBaseRaw   = semTotalRaw - subTotalRaw + vacBonusRaw;
  const finalBase      = ceilInt(finalBaseRaw);

  /* === é¡¯ç¤ºï¼ˆå››æ¨äº”å…¥ï¼‰ === */
  row.querySelector('.fullBonus').textContent    = roundDisp(fullBonusRaw);
  row.querySelector('.partialBonus').textContent = roundDisp(partialBonusRaw);
  row.querySelector('.semTotal').textContent     = roundDisp(semTotalRaw);
  row.querySelector('.subTotal').textContent     = roundDisp(subTotalRaw);

  const vacCell = row.querySelector('.vacBonus');
  if (userTotal === 0 && requiredTotal === 0) {
    vacCell.textContent = '';
  } else if (userTotal <= requiredTotal) {
    vacCell.innerHTML = '<span style="font-size:.88em;">æœªè¶…éè²¬ä»»é¡</span>';
  } else {
    vacCell.textContent = roundDisp(vacBonusRaw);
  }

  row.querySelector('.finalBonusValue').textContent = finalBase.toString();

  const semF = generateSemesterBonusFormula(grade, persons, partialDays, workdays, semRate);
  const subF = generateSubstitutionDeductionFormula(subDays, subHours, subTotalRaw);
  const vacF = generateVacationBonusFormula(attendPts, camp1Pts, camp2Pts, requiredDays, vacBonusRaw, userTotal, requiredTotal);

  let base = [semF, subF, vacF].filter(Boolean).join('');
  if(!base) base='ç„¡äººæ•¸æ´¥è²¼';

  // é¡å¤–åŠ çµ¦ï¼ˆçš†ç‚ºæ•´æ•¸ï¼‰
  const scCount = parseInt(row.querySelector('.specialCourse')?.value || '0',10);
  const defaultPrice = Math.max(0, parseFloat(document.getElementById('defaultSpecialCoursePrice')?.value || '180'));
  const scpRaw = row.querySelector('.specialCoursePrice')?.value ?? '';
  const scPrice = (scpRaw==='' || isNaN(parseFloat(scpRaw))) ? defaultPrice : Math.max(0, parseFloat(scpRaw));
  const scBonus = scCount*scPrice;

  const signBonus   = parseFloat(row.querySelector('.signBonus')?.value || '0') || 0;    // ç°½ç´„çé‡‘ç›´æ¥é‡‘é¡
  const seniorBonus = parseFloat(row.querySelector('.seniorBonus')?.value || '0') || 0;  // é«˜å¹´ç´šåŠ çµ¦ç›´æ¥é‡‘é¡


  const repeatBonus = parseInt(row.querySelector('.repeatBonus')?.value || '0',10);

  const extras = scBonus + signBonus + seniorBonus + repeatBonus;
  const finalTotal = finalBase + extras;

  row.querySelector('.finalBonusFormula').textContent =
  `${finalTotal}=${base}`
  + (seniorBonus>0 ? `ï¼ˆé«˜å¹´ç´šåŠ çµ¦$${seniorBonus}ï¼‰` : '')
  + (scCount>0 ? `ï¼ˆç‰¹è‰²èª²Ã—${scCount}Ã—$${scPrice}=$${scBonus}ï¼‰` : '')
  + (signBonus>0 ? `ï¼ˆç°½ç´„é‡‘$${signBonus}ï¼‰` : '')
  + (repeatBonus>0 ? `ï¼ˆç•™ç­çé‡‘$${repeatBonus}ï¼‰` : '');

}

function recalcAll(){ document.querySelectorAll('#rows tr').forEach(calcRow); }

/* ========= åŒ¯å‡º/è¤‡è£½ ========= */
function copyNameAndFormula(){
  let text='å°å¸«\tæœ¬æœˆæ´¥è²¼ç®—å¼\n';
  document.querySelectorAll('#rows tr').forEach(row=>{
    const name = row.querySelector('.teacher')?.value.trim() || '';
    const formula = row.querySelector('.finalBonusFormula')?.textContent.trim() || '';
    if(name || formula) text += `${name}\t${formula}\n`;
  });
  navigator.clipboard.writeText(text).then(()=> alert('å°å¸«èˆ‡æ´¥è²¼ç®—å¼å·²è¤‡è£½ï¼Œå¯è²¼ä¸Šè‡³ Excel æˆ– Google Sheets'));
}
function copyTable(){
  const headers=[
    'å°å¸«','æ˜¯å¦è·¨æ ¡','å…¨æœˆäººæ•¸','å…¨æœˆæ´¥è²¼','éå…¨æœˆå¤©æ•¸','éå…¨æœˆæ´¥è²¼','å­¸æœŸå¤©æ¯”ä¾‹','å­¸æœŸæ´¥è²¼',
    'ä»£èª²å¤©','ä»£èª²æ™‚','ä»£èª²æ‰£é™¤','é»åè¡¨é»æ•¸','ä¸€æ—¥ç‡Ÿ1é»æ•¸','ä¸€æ—¥ç‡Ÿ2é»æ•¸','å¯’æš‘æ´¥è²¼',
    'æœ¬æœˆæ´¥è²¼ç®—å¼','å‚™è¨»'
  ];
  let text=headers.join('\t')+'\n';
  document.querySelectorAll('#rows tr').forEach(row=>{
    const getInput=cls=>{ const el=row.querySelector(`.${cls}`); if(!el) return ''; return el.type==='checkbox' ? (el.checked?'æ˜¯':'å¦') : (el.value||''); };
    const getText =cls=>{ const el=row.querySelector(`.${cls}`); return el ? el.textContent.trim():''; };
    const line=[
      getInput('teacher'), getInput('crossSchool'), getInput('persons'), getText('fullBonus'),
      getInput('partialDays'), getText('partialBonus'), getInput('rate'), getText('semTotal'),
      getInput('subDays'), getInput('subHours'), getText('subTotal'), getInput('attend'),
      getInput('camp1'), getInput('camp2'), getText('vacBonus'), getText('finalBonusFormula'),
      getInput('note')
    ];
    text+= line.map(x=>`"${x}"`).join('\t')+'\n';
  });
  navigator.clipboard.writeText(text).then(()=> alert('è¡¨æ ¼å·²è¤‡è£½ï¼Œå¯è²¼ä¸Šè‡³ Excel æˆ– Google Sheets'));
}
function exportCSV(){
  const headers=[
    "å°å¸«","æ˜¯å¦è·¨æ ¡","å…¨æœˆäººæ•¸","å…¨æœˆæ´¥è²¼","éå…¨æœˆå¤©æ•¸","éå…¨æœˆæ´¥è²¼",
    "å­¸æœŸå¤©æ¯”ä¾‹","å­¸æœŸæ´¥è²¼","ä»£èª²å¤©","ä»£èª²æ™‚","ä»£èª²æ‰£é™¤",
    "é»åè¡¨é»æ•¸","ä¸€æ—¥ç‡Ÿ1é»æ•¸","ä¸€æ—¥ç‡Ÿ2é»æ•¸","å¯’æš‘æ´¥è²¼","æœ¬æœˆæ´¥è²¼è¨ˆç®—å¼","å‚™è¨»"
  ];
  let csv='\uFEFF'+headers.join(',')+'\n';
  document.querySelectorAll('#rows tr').forEach(row=>{
    const get =cls=>{
      const el=row.querySelector(`.${cls}`);
      if(!el) return '';
      if(el.tagName==='INPUT' && el.type==='checkbox') return el.checked?'æ˜¯':'å¦';
      if(el.tagName==='INPUT' || el.tagName==='SELECT') return el.value;
      return el.textContent;
    };
    const formula=row.querySelector('.finalBonusFormula')?.textContent || '';
    const line=[
      get('teacher'), get('crossSchool'), get('persons'), get('fullBonus'),
      get('partialDays'), get('partialBonus'), get('rate'), get('semTotal'),
      get('subDays'), get('subHours'), get('subTotal'), get('attend'),
      get('camp1'), get('camp2'), get('vacBonus'), formula, get('note')
    ];
    csv+= line.map(x=>`"${x}"`).join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url;
  a.download=`${new Date().toISOString().slice(0,10)}_èª²è¼”å¸¶ç­æ´¥è²¼.csv`;
  a.click(); URL.revokeObjectURL(url);
}

/* ========= æ‘ºç–Šåˆ‡æ› ========= */
(function setupCollapseToggles(){
  const table = document.getElementById('dataTable');
  document.getElementById('toggleSem')?.addEventListener('click', ()=> table.classList.toggle('collapse-semester'));
  document.getElementById('toggleSub')?.addEventListener('click', ()=> table.classList.toggle('collapse-sub'));
  document.getElementById('toggleSum')?.addEventListener('click', ()=> table.classList.toggle('collapse-summer'));
})();

/* ========= é˜²å‘†æç¤º ========= */
document.addEventListener('input', e=>{
  const workdays = parseFloat(document.getElementById('workdays').value) || 0;
  const requiredDays = parseFloat(document.getElementById('requiredDays').value) || 0;
  const warn=(cond,msg)=>{ if(cond) alert(msg); };
  if(e.target.classList.contains('partialDays')||
     e.target.classList.contains('subDays')||
     e.target.classList.contains('subHours')){
    warn(workdays===0,'è«‹å…ˆå¡«å¯«ã€Œæœ¬æœˆå·¥ä½œå¤©æ•¸ã€å†è¼¸å…¥ç›¸é—œæ¬„ä½');
  }
  if(e.target.classList.contains('attend')||
     e.target.classList.contains('camp1')||
     e.target.classList.contains('camp2')){
    warn(requiredDays===0,'è«‹å…ˆå¡«å¯«ã€Œå¯’æš‘è²¬ä»»é¡å¤©æ•¸ã€å†è¼¸å…¥é»æ•¸');
  }
});
</script>
</body>
</html>
