<!DOCTYPE html>   
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å‡åˆ¥çµ±è¨ˆå·¥å…·v2</title>
    <style>
        /*ç®—å¡:å¯è¨ˆç®—å¹´å‡*/
        /* å…¨å±€æ¨£å¼ */
        body {
            font-family: "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background-color:#D4DCDB;
            padding: 1.5em;
            color: #333;
        }

        label {
            margin-right: 0.5em;
        }
        h2 {
           color: #333; /* é…åˆå…¨é å­—é«”é¡ */
           border-left: 6px solid #3c82f6; /* æ¨™é¡Œçš„è‰²å¡Šé…åˆå…¨é å­—é«”é¡è‰² */
           padding-left: 12px;
           margin-bottom: 20px;
        }
        :root {
            --w-date: 2em;
            --w-weekday: 2em;
            --w-day: 2em;
            --w-hour: 4em;
            --w-minutes: 4em;
            --w-punch: 8em;
            --w-special: 15em;
        }
        /*çµ±ä¸€å…©ç¨®çµ±è¨ˆçµæœçš„å­—é«”å¤§å°*/
        #resultsLeave,
        #vacationBreakdown {
            font-size: 16px;
            font-family: "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            line-height: 1.6;
        }



        /* çµ±ä¸€æŒ‰éˆ•æ¨£å¼ */
        .btn {
        padding: 0.5em 1.2em;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin: 0.3em;
        }

        /* è—è‰²æŒ‰éˆ• */
        .btn-blue {
            background-color: #3c82f6;
        }
        .btn-blue:hover {
            background-color: #2563eb;
        }

        /* ç¶ è‰²æŒ‰éˆ•ï¼ˆå¦‚ï¼šåŒ¯å…¥ï¼‰ */
        .btn-green {
            background-color: #10b981;
        }
        .btn-green:hover {
            background-color: #0e9f6e;
        }

        /* ç°è‰²æŒ‰éˆ•ï¼ˆå¦‚ï¼šè¤‡è£½ã€æ¬¡è¦æ“ä½œï¼‰ */
        .btn-gray {
            background-color: #6b7280;
        }
        .btn-gray:hover {
            background-color: #4b5563;
        }
        table {
            table-layout: fixed;
            width: 100%;
            max-width: 1200px;
            margin: 1.5em 0;  /* âœ… æ”¹æˆä¸Šä¸‹é–“è· 1.5emï¼Œå·¦å³ä¸ç½®ä¸­ */
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 0.6em;
            text-align: center;
        }
        th {
            background-color: #f0f4f8;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr.sunday {
            background-color: #ffe5e5;
        }
        tr.saturday {
            background-color: #e5f0ff;
        }
        input[type="checkbox"] {
            transform: scale(1.3);
        }
        input[type="text"] {
            width: 6em;
            padding: 0.3em;
            margin-right: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="number"] {
            width: 4em;
            padding: 0.2em;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 1em;
        }

        /* æ¯æ¬„å¯¬åº¦è¨­å®š */
        /* æ¯æ¬„å¯¬åº¦è¨­å®šï¼ˆé›†ä¸­ç®¡ç†ï¼‰ */
        /* æ¯æ¬„å¯¬åº¦è¨­å®šï¼ˆæ–°ç‰ˆï¼šç„¡ã€Œå¤©ã€æ¬„ï¼‰ */
        table th:nth-child(1), table td:nth-child(1) { width: var(--w-date); }     /* æ—¥æœŸ */
        table th:nth-child(2), table td:nth-child(2) { width: var(--w-weekday); }  /* æ˜ŸæœŸ */
        
        table th:nth-child(3), table td:nth-child(3),   /* ç‰¹ä¼‘è£œä¼‘(æ™‚) */
        table th:nth-child(4), table td:nth-child(4),   /* äº‹å‡(æ™‚) */
        table th:nth-child(5), table td:nth-child(5),   /* ç—…å‡(æ™‚) */
        table th:nth-child(9), table td:nth-child(9),   /* ç”Ÿç†å‡(æ™‚) */
        table th:nth-child(10), table td:nth-child(10), /* å–ªå‡(æ™‚) */
        table th:nth-child(11), table td:nth-child(11)  /* è¶…æ™‚(æ™‚) */
        { width: var(--w-hour); }
        table th:nth-child(6), table td:nth-child(6),   /* é²åˆ°æ‰£(åˆ†é˜) */
        table th:nth-child(7), table td:nth-child(7)    /* é²åˆ°ä¸‰æ¬¡äº”åˆ†é˜å…§(åˆ†é˜) */
        { width: var(--w-minutes); }

        table th:nth-child(8), table td:nth-child(8) { width: var(--w-punch); }    /* æ¼æ‰“å¡ */
        table th:nth-child(12), table td:nth-child(12) { width: var(--w-special); }/* å©š/ç”¢/é™ªç”¢/ç”¢æª¢(æ™‚) */


        .totals {
            margin-top: 20px;
            white-space: pre-wrap;
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px dashed #ccc;
            font-size: 1.2em; /* ç‰¹ä¼‘åŠ æ¸›çµ±è¨ˆå€æ–‡å­—å¤§å° */
            font-family: "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", sans-serif; /* é¿å…é è¨­è®Š monospace */
            line-height: 1.6;
        }


        tr.weekend-row:hover {
            background-color: #A29093;
        }
        tr.error-row {
            background-color: #ffe6e6 !important; /* æ·¡ç´…è‰² */
            border: 2px solid #d33; /* å¼·èª¿é‚Šæ¡† */
        }

        .date-input {
            width: 80px;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center; /* æ°´å¹³å°é½Š */
            gap: 4px; /* èª¿æ•´é–“è· */
            flex-wrap: wrap;
            max-width: 150px;    
        }
        .special-leave-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-wrap: nowrap;
        }
        .no-wrap-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            gap: 4px; /* å…ƒä»¶é–“è· */
        }


        
    </style>
</head>
<body>
    <h2>å‡åˆ¥ç™»è¨˜èˆ‡çµ±è¨ˆå·¥å…·</h2>
    <label>è€å¸«å§“åï¼š<input type="text" id="teacherNameLeave" style="width: 100px" placeholder="ä¾‹å¦‚ï¼šå¼µæ­£è¯" oninput="calculateLeave()"></label>
    <label>å¹´ä»½ï¼š<input type="number" id="yearInput" value="" min="2000" max="2100"></label>
    <label>æœˆä»½ï¼ˆ1~12ï¼‰ï¼š<input type="number" id="monthInput" value="" min="1" max="12"></label><br><br>
    <label>æœˆåˆçµé¤˜ï¼šâ›±ï¸ç‰¹ä¼‘è£œä¼‘ï¼ˆå¤©ï¼‰ï¼š</label>
    <input type="number" id="remainVacationDays" style="width: 80px" placeholder="ä¾‹å¦‚ï¼š2" oninput="calculateLeave()">
    <label>â›±ï¸ç‰¹ä¼‘è£œä¼‘ï¼ˆæ™‚ï¼‰ï¼š</label>
    <input type="number" id="remainVacationHours" style="width: 80px" placeholder="ä¾‹å¦‚ï¼š6" oninput="calculateLeave()">
    <div id="formArea"></div>
    <h3>çµ±è¨ˆçµæœï¼ˆå¦‚æœªæ›´æ–°ï¼Œç©ºç™½è™•é»ä¸€ä¸‹ï¼Œå†æŒ‰è¤‡è£½ï¼‰ï¼š</h3>
    <div class="totals" id="resultsLeave" contenteditable="true"></div>
    <button class="btn btn-gray" onclick="copyResultsLeave()">ğŸ“‹ è¤‡è£½çµæœ</button>
    <button class="btn btn-green" onclick="importToAll()">â” åŒ¯å…¥ å‡åˆ¥ç™»è¨˜è¡¨æ ¼ èˆ‡ ä¸æ”¯è–ªè¨ˆç®—</button>
    <button class="btn btn-gray" onclick="toggleBalanceInfo()">ğŸ“Œ é¡¯ç¤º / éš±è—ç‰¹ä¼‘è£œä¼‘è¨ˆç®—èªªæ˜</button>
    <div id="balanceDetails" style="display: none;">
    <pre class="totals" id="vacationBreakdown" contenteditable="true"></pre>
    </div>

    <div style="margin-top: 30px; padding: 15px; background-color: #f7f6f4; border-radius: 16px;">
    <h3 style="margin-bottom: 10px; color: #5a5a5a;">ğŸ“„ ç¼ºå‹¤åˆ†æçµæœ</h3>
    <iframe
    id="absenceFrame"
    src="https://zh22331997.github.io/salary-calculator/ExportAbsence.html"
    width="100%"
    height="600"
    style="border: 4px solid #c2b9b0; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);">
    </iframe>
    </div>

    <div id="toast" style="
     position: fixed;
     bottom: 20px;
     left: 50%;
     transform: translateX(-50%);
     background-color: #323232;
     color: white;
     padding: 10px 20px;
     border-radius: 8px;
     font-size: 0.95em;
     opacity: 0;
     transition: opacity 0.5s ease;
     z-index: 1000;
     pointer-events: none;
     ">æç¤ºè¨Šæ¯</div>
     <hr>

    <h2>äº‹ç—…å‡ æˆ– é²åˆ° ä¸è¨ˆè–ªè¨ˆç®—å™¨</h2>

<label>è€å¸«å§“åï¼ˆå¯ç•™ç©ºï¼‰ï¼š</label>
<input type="text" id="nameSalary" style="width: 100px" placeholder="ä¾‹å¦‚ï¼šå¼µæ­£è¯"><br>

<label>åŸå§‹æœˆè–ªï¼š</label>
<input type="number" id="salary" style="width: 100px;" placeholder="ä¾‹å¦‚ï¼š32000"><br>

<label>äº‹å‡ï¼ˆå°æ™‚ï¼‰ï¼š</label>
<input type="number" id="leaveHoursSalary" style="width: 60px" placeholder="0"><br>

<label>ç—…å‡ï¼ˆå°æ™‚ï¼‰ï¼š</label>
<input type="number" id="sickHoursSalary" style="width: 60px" placeholder="0"><br>

<label>ç”Ÿç†å‡ï¼ˆå°æ™‚ï¼‰ï¼š</label>
<input type="number" id="menstrualHoursSalary" style="width: 60px" placeholder="0"><br>

<label>å®¶åº­ç…§é¡§å‡ï¼ˆå°æ™‚ï¼‰ï¼š</label>
<input type="number" id="familyCareHoursSalary" style="width: 60px" placeholder="0"><br>

<label>è¶…éä¸‰æ¬¡5åˆ†é˜çš„é²åˆ°ï¼ˆåˆ†é˜ï¼‰ï¼š</label>
<input type="number" id="lateMinutesSalary" style="width: 60px" placeholder="0"><br>

<label>ğŸ’°æŠ˜ç¾ï¼ˆå¤©ï¼‰ï¼š</label>
<input type="number" id="cashOutDaysSalary" style="width: 60px" placeholder="0" oninput="calculateLeave()">

<label>ğŸ’°æŠ˜ç¾ï¼ˆå°æ™‚ï¼‰ï¼š</label>
<input type="number" id="cashOutHoursSalary" style="width: 60px" placeholder="0" oninput="calculateLeave()"><br>
<br>
    

    <button class="btn btn-blue" onclick="calculateSalaryDeduction()">è¨ˆç®—ä¸æ”¯è–ª</button>
    <br><br>
    <div id="salaryResult"></div>
    <button class="btn btn-gray" onclick="copyResultsSalary()">ğŸ“‹ è¤‡è£½ç®—å¼</button>


<script>
    // --- å·¥å…·å‡½æ•¸ (Utility Functions) ---
    /**
     * å°‡å€¼è§£æç‚ºæµ®é»æ•¸ï¼Œè‹¥ç„¡æ³•è§£æå‰‡è¿”å› 0ã€‚
     * @param {string|number} value - è¦è§£æçš„å€¼ã€‚
     * @returns {number} è§£æå¾Œçš„æ•¸å­—æˆ– 0ã€‚
     */
    function parseNumber(value) {
        const num = parseFloat(value);
        return isNaN(num) ? 0 : num;
    }

    /**
     * æ ¼å¼åŒ–å‡åˆ¥è¨˜éŒ„çš„é¡¯ç¤ºå­—ä¸²ã€‚
     * @param {object} entry - å‡åˆ¥è¨˜éŒ„ç‰©ä»¶ï¼ŒåŒ…å« date å’Œæ™‚é–“/å¤©æ•¸å–®ä½ã€‚
     * @param {'minutes'|'hours'|'days'} unit - å‡åˆ¥çš„æ™‚é–“å–®ä½ã€‚
     * @returns {string} æ ¼å¼åŒ–å¾Œçš„å­—ä¸²ã€‚
     */
    function formatEntry(entry, unit) {
    const value = entry[unit];
    if (value === undefined || value === null) return '';  // ğŸ‘‰ è‹¥æ²’è³‡æ–™å°±ä¸è¼¸å‡º

    let unitText = '';
    if (unit === 'minutes') unitText = 'åˆ†';
    else if (unit === 'hours') unitText = 'æ™‚';
    else if (unit === 'days') unitText = 'å¤©';

    return `(${entry.date} ${value}${unitText})`;
}


    /**
     * é¡¯ç¤ºçŸ­æš«çš„æç¤ºè¨Šæ¯ã€‚
     * @param {string} message - è¦é¡¯ç¤ºçš„è¨Šæ¯ã€‚
     * @param {number} duration - è¨Šæ¯é¡¯ç¤ºçš„æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰ã€‚
     */
    function showToast(message, duration = 2500) {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = message;
            toast.style.opacity = 1;
            setTimeout(() => {
                toast.style.opacity = 0;
            }, duration);
        } else {
            console.warn("Toast å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¨Šæ¯ï¼š", message);
        }
    }

    /**
     * æ ¹æ“šæ—¥æœŸå­—ä¸²ç²å–æ˜ŸæœŸæ–‡å­—ã€‚
     * @param {string} dateStr - æ—¥æœŸå­—ä¸²ï¼Œæ ¼å¼ç‚º "æœˆ/æ—¥"ã€‚
     * @returns {string} æ˜ŸæœŸæ–‡å­—ï¼ˆå¦‚ "æ—¥", "ä¸€"ï¼‰ã€‚
     */
    function getWeekdayString(dateStr) {
        const [month, day] = dateStr.split("/").map(Number);
        const year = parseInt(document.getElementById("yearInput").value);
        const date = new Date(year, month - 1, day);
        const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        return weekdays[date.getDay()];
    }

    /**
     * é©—è­‰è¼¸å…¥æ¡†çš„å€¼ï¼Œç¢ºä¿æ•¸å­—æ­£ç¢ºä¸”ä¸è¶…éé™åˆ¶ã€‚
     * @param {HTMLInputElement} input - æ•¸å­—è¼¸å…¥æ¡†å…ƒç´ ã€‚
     */
    function validateInput(input) {
        let value = parseFloat(input.value) || 0;

        if (value < 0) {
            showToast("æ•¸å€¼ä¸èƒ½æ˜¯è² æ•¸ï¼");
            input.value = 0;
            return;
        }

        
    }

    /**
     * ç²å–æŒ‡å®š ID å…ƒç´ çš„æ•¸å€¼ï¼Œè‹¥ç„¡å‰‡è¿”å› 0ã€‚
     * @param {string} id - å…ƒç´  IDã€‚
     * @returns {number} å…ƒç´ å€¼ã€‚
     */
    function getValue(id) {
        const element = document.getElementById(id);
        return element ? parseNumber(element.value) : 0;
    }


    // --- å…¨å±€ç‹€æ…‹ (Global State) ---
    // å…¨å±€è®Šæ•¸ç”¨æ–¼å„²å­˜è¨˜éŒ„ï¼Œä»¥ä¾¿åŒ¯å…¥å’Œé¡¯ç¤º
    let leaveRecords = []; // äº‹å‡
    let sickRecords = [];  // ç—…å‡
    let lateRecords = [];  // é²åˆ°ï¼ˆæ‰£è–ªï¼‰
    let lateNoDeductRecords = []; // é²åˆ°ä¸æ‰£ï¼ˆå…¨å‹¤ç·©è¡ï¼‰
    let punchCardMissRecords = []; // æ¼æ‰“å¡
    let menstrualRecords = [];     // ç”Ÿç†å‡
    let vacationRecords = [];      // ç‰¹ä¼‘/è£œä¼‘
    let funeralRecords = [];       // å–ªå‡
    let overtimeRecords = [];      // è¶…æ™‚
    let specialLeaves = {          // å©šï¼ç”¢ï¼é™ªç”¢ï¼ç”¢æª¢ï¼å®¶åº­ç…§é¡§å‡
    'å©šå‡': { records: [], days: 0, hours: 0 },
    'ç”¢å‡': { records: [], days: 0, hours: 0 },
    'é™ªç”¢å‡': { records: [], days: 0, hours: 0 },
    'ç”¢æª¢å‡': { records: [], days: 0, hours: 0 },
    'å®¶åº­ç…§é¡§å‡': { records: [], days: 0, hours: 0 }
};


    // --- äº‹ä»¶è™•ç†èˆ‡é‚è¼¯ (Event Handlers & Logic) ---


function validateRowTotal(row) {
    // å–æ¶ˆæ•´åˆ—ç¸½é‡æª¢æŸ¥ï¼ˆä¸å†é™åˆ¶ä¸€å¤©/8å°æ™‚ï¼Œä¹Ÿä¸åšå¤©æ™‚äº’æ–¥ï¼‰
    row.classList.remove("error-row");
    return true;
}



    /**
     * ç”Ÿæˆæœˆä»½çš„æ—¥æœŸè¡¨æ ¼ã€‚
     */
     function generateTable() {
    const year = parseInt(document.getElementById("yearInput").value);
    const month = parseInt(document.getElementById("monthInput").value);
    const daysInMonth = new Date(year, month, 0).getDate();

    const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    let html = `
        <table>
            <thead>
            <tr>
                <th>æ—¥æœŸ</th><th>æ˜ŸæœŸ</th>
                <th>ç‰¹ä¼‘<br>è£œä¼‘<br>(æ™‚)</th>
                <th>äº‹å‡<br>(æ™‚)</th>
                <th>ç—…å‡<br>(æ™‚)</th>
                <th>é²åˆ°æ‰£<br>(åˆ†é˜)</th>
                <th>é²åˆ°ä¸‰æ¬¡äº”åˆ†é˜å…§<br>(åˆ†é˜)</th>
                <th>æ¼æ‰“å¡</th>
                <th>ç”Ÿç†å‡<br>(æ™‚)</th>
                <th>å–ªå‡<br>(æ™‚)</th>
                <th>è¶…æ™‚<br>(æ™‚)</th>
                <th>å©šï¼ç”¢ï¼é™ªç”¢ï¼ç”¢æª¢ï¼å®¶åº­ç…§é¡§å‡ï¼ˆæ™‚ï¼‰</th>
            </tr>
            </thead>
<tbody>
    `;

    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const displayDate = `${month}/${day}`;
        const dayOfWeek = date.getDay();
        const weekendClass = dayOfWeek === 6 ? "saturday" : dayOfWeek === 0 ? "sunday" : "";

        html += `
            <tr class="weekend-row ${weekendClass}">
                <td>${displayDate}</td>
                <td>(${weekDays[dayOfWeek]})</td>
                ${generateLeaveCells("v", displayDate, true)}
                ${generateLeaveCells("p", displayDate)}
                ${generateLeaveCells("s", displayDate)}
                ${generateLateCells(displayDate)}
                ${generatePunchCardMissCell(displayDate)}
                ${generateHourOnlyCell("m", displayDate)}
                ${generateLeaveCells("f", displayDate)}
                ${generateHourOnlyCell("overtime", displayDate)}
                <td>${generateSpecialLeaveCell(displayDate)}</td>
            </tr>
        `;
    }

    html += '</tbody></table>';
    document.getElementById("formArea").innerHTML = html;
    document.getElementById("resultsLeave").innerText = '';
    calculateLeave();
}
function generateLeaveCells(type, date, withValidateRow = false) {
    // åªç”¢ç”Ÿã€Œ(æ™‚)ã€æ¬„ä½ï¼Œä¸å†æœ‰ã€Œ(å¤©)ã€
    const validate = withValidateRow ? "validateRowTotal(this.closest('tr'));" : "";
    return `
        <td>
            <input type="number" name="leave-${type}" data-type="${type}-hour" onchange="validateInput(this); ${validate} calculateLeave();">
            <input type="hidden" name="leave-${type}-date" value="${date}">
        </td>
    `;
}


function generateLateCells(date) {
    return `
        <td>
            <input type="number" name="late" data-type="late-min" onchange="validateInput(this); calculateLeave();">
            <input type="hidden" name="late-date" value="${date}">
        </td>
        <td>
            <input type="number" name="late-no-deduct" data-type="late-no-deduct-min" onchange="validateInput(this); calculateLeave();">
            <input type="hidden" name="late-no-deduct-date" value="${date}">
        </td>
    `;
}

function generatePunchCardMissCell(date) {
    return `
        <td>
            <div class="checkbox-group">
                <label><input type="checkbox" name="punch-card-miss" data-type="punch-in" data-date="${date}" onchange="calculateLeave()">ä¸Šç­</label>
                <label><input type="checkbox" name="punch-card-miss" data-type="punch-out" data-date="${date}" onchange="calculateLeave()">ä¸‹ç­</label>
            </div>
        </td>
    `;
}

function generateHourOnlyCell(type, date) {
    return `
        <td>
            <input type="number" name="${type}" data-type="${type}-hour" onchange="validateInput(this); calculateLeave();">
            <input type="hidden" name="${type}-date" value="${date}">
        </td>
    `;
}

function generateSpecialLeaveCell(date) {
    return `
        <div class="no-wrap-cell">
            <select class="special-leave-type" onchange="handleSpecialLeaveTypeChange(this)">
                <option value="">â€”</option>
                <option value="å©šå‡">å©šå‡</option>
                <option value="ç”¢å‡">ç”¢å‡</option>
                <option value="é™ªç”¢å‡">é™ªç”¢å‡</option>
                <option value="ç”¢æª¢å‡">ç”¢æª¢å‡</option>
                <option value="å®¶åº­ç…§é¡§å‡">å®¶åº­ç…§é¡§å‡</option>
                </select>

            <!-- åªç•™æ™‚æ•¸ï¼›ç§»é™¤ã€Œ1å¤©ã€å‹¾é¸èˆ‡ max=8 é™åˆ¶ -->
            <input type="number" class="special-leave-hour" min="0" step="0.5" placeholder="æ™‚"
                   onchange="validateInput(this); calculateLeave()">
        </div>
    `;
}
function handleSpecialLeaveTypeChange(selectElement) {
    // é¸äº†ç¨®é¡å°±æŠŠåŸä¾†çš„æ™‚æ•¸æ¸…ç©ºï¼Œé¿å…æ®˜å€¼èª¤ç®—
    const td = selectElement.closest('td') || selectElement.closest('.no-wrap-cell')?.parentElement;
    const hourInput = td ? td.querySelector('.special-leave-hour') : null;
    if (hourInput) {
        hourInput.value = '';
    }
    calculateLeave();
}



/**
 * çµ±ä¸€æ ¼å¼è¼¸å‡ºçµ±è¨ˆæ®µè½
 * @param {string} label - å‡åˆ¥åç¨±
 * @param {number} days - è«‹å‡å¤©æ•¸
 * @param {number} hours - è«‹å‡æ™‚æ•¸
 * @param {Array} records - æ˜ç´°é™£åˆ—
 * @returns {string} çµ±ä¸€æ ¼å¼æ®µè½
 */
function appendResultBlock(label, days = 0, hours = 0, records = [], warning = "") {
    // ğŸ‘‰ ç‰¹åˆ¥è™•ç†ã€Œé²åˆ°ã€
    if (label === "é²åˆ°") {
        const minuteTotal = records
            .filter(r => typeof r.minutes === 'number')
            .reduce((sum, r) => sum + r.minutes, 0);

        if (minuteTotal === 0) return '';

        const minuteEntries = records
            .filter(r => typeof r.minutes === 'number')
            .map(r => formatEntry(r, 'minutes'))
            .filter(e => e)
            .join("ã€");

        return `ğŸ’¸ ${label}ï¼š${minuteTotal} åˆ†    ${minuteEntries}\n`;
    }

    // ğŸ‘‰ è‹¥å¤©èˆ‡æ™‚éƒ½ç‚º 0ï¼Œå°±ç•¥éè©²é …
    if (!days && !hours) return '';

    // âœ… å‹•æ…‹çµ„åˆã€Œx å¤© y æ™‚ã€çš„éƒ¨åˆ†
    const dayPart = days ? `${days} å¤©` : '';
    const hourPart = hours ? `${hours} æ™‚` : '';
    const dayHourDisplay = [dayPart, hourPart].filter(Boolean).join(" ");

    let unpaidLeaves = ["äº‹å‡", "ç—…å‡", "ç”Ÿç†å‡", "é²åˆ°", "å®¶åº­ç…§é¡§å‡"];
    let emoji = unpaidLeaves.includes(label) ? "ğŸ’¸" : "âœ…";
    let result = `${emoji} ${label}ï¼š${dayHourDisplay}`;


    const dayEntries = records.filter(r => r.days).map(r => formatEntry(r, 'days'));
    const hourEntries = records.filter(r => r.hours).map(r => formatEntry(r, 'hours'));
    const minuteEntries = records.filter(r => r.minutes).map(r => formatEntry(r, 'minutes'));

    const details = [...dayEntries, ...hourEntries, ...minuteEntries].filter(e => e).join("ã€");

    if (details) result += `    ${details}`;
    if (warning) result += ` ${warning}`;

    return result + '\n';
}



    /**
     * è¨ˆç®—æ‰€æœ‰å‡åˆ¥çš„ç¸½å’Œä¸¦é¡¯ç¤ºçµæœã€‚
     */
    // âœ… ä¸»è¨ˆç®—å‡½å¼
    function calculateLeave() {
    const rows = document.querySelectorAll("#formArea table tbody tr");

    // æ¸…æ‰åˆ—ç‹€æ…‹
    rows.forEach(row => {
        row.classList.remove("error-row");
        row.classList.remove("warned-incomplete-special-leave");
    });

    // é‡è¨­æ‰€æœ‰çµ±è¨ˆè¨˜éŒ„
    leaveRecords = [];            // äº‹å‡(æ™‚)
    sickRecords = [];             // ç—…å‡(æ™‚)
    lateRecords = [];             // é²åˆ°(åˆ†)
    lateNoDeductRecords = [];     // é²åˆ°ä¸æ‰£(åˆ†)
    punchCardMissRecords = [];    // æ¼æ‰“å¡
    menstrualRecords = [];        // ç”Ÿç†å‡(æ™‚)
    vacationRecords = [];         // ç‰¹ä¼‘/è£œä¼‘(æ™‚)
    funeralRecords = [];          // å–ªå‡(æ™‚)
    overtimeRecords = [];         // è¶…æ™‚(æ™‚)
    for (const type in specialLeaves) {
        specialLeaves[type] = { records: [], days: 0, hours: 0 }; // days ä¿ç•™çµæ§‹ï¼Œä½†ä¸æœƒç”¨
    }

    // åªä¿ç•™ã€Œæ™‚ã€çš„ç¸½é‡
    let totalVHours = 0;   // ç‰¹ä¼‘/è£œä¼‘(æ™‚)
    let totalPHours = 0;   // äº‹å‡(æ™‚)
    let totalSHours = 0;   // ç—…å‡(æ™‚)
    let totalLateMinutes = 0;
    let totalLateNoDeductMinutes = 0;
    let totalPunchInCount = 0, totalPunchOutCount = 0;
    let totalMHours = 0;   // ç”Ÿç†å‡(æ™‚)
    let totalFHours = 0;   // å–ªå‡(æ™‚)
    let totalOtHours = 0;  // è¶…æ™‚(æ™‚)

    rows.forEach(row => {
        if (!validateRowTotal(row)) return;

        const date = row.querySelector("td:first-child").innerText;
        const weekday = getWeekdayString(date);

        const getVal = (selector) => {
            const input = row.querySelector(selector);
            return input && !input.disabled ? parseNumber(input.value) : 0;
        };

        // ç‰¹ä¼‘/è£œä¼‘(æ™‚)
        const vHourVal = getVal("input[data-type='v-hour']");
        if (vHourVal > 0) {
            totalVHours += vHourVal;
            vacationRecords.push({ hours: vHourVal, date, weekday });
        }

        // äº‹å‡(æ™‚)
        const pHourVal = getVal("input[data-type='p-hour']");
        if (pHourVal > 0) {
            totalPHours += pHourVal;
            leaveRecords.push({ hours: pHourVal, date, weekday });
        }

        // ç—…å‡(æ™‚)
        const sHourVal = getVal("input[data-type='s-hour']");
        if (sHourVal > 0) {
            totalSHours += sHourVal;
            sickRecords.push({ hours: sHourVal, date, weekday });
        }

        // é²åˆ°(åˆ†)
        const lateMinVal = getVal("input[data-type='late-min']");
        if (lateMinVal > 0) {
            totalLateMinutes += lateMinVal;
            lateRecords.push({ minutes: lateMinVal, date, weekday });
        }

        // é²åˆ°ä¸æ‰£(åˆ†)
        const lateNoDeductMinVal = getVal("input[data-type='late-no-deduct-min']");
        if (lateNoDeductMinVal > 0) {
            totalLateNoDeductMinutes += lateNoDeductMinVal;
            lateNoDeductRecords.push({ minutes: lateNoDeductMinVal, date, weekday });
        }

        // æ¼æ‰“å¡
        const punchIn = row.querySelector("input[name='punch-card-miss'][data-type='punch-in']");
        const punchOut = row.querySelector("input[name='punch-card-miss'][data-type='punch-out']");
        if (punchIn && punchIn.checked && !punchIn.disabled) {
            punchCardMissRecords.push({ type: "ä¸Šç­", date, weekday });
            totalPunchInCount++;
        }
        if (punchOut && punchOut.checked && !punchOut.disabled) {
            punchCardMissRecords.push({ type: "ä¸‹ç­", date, weekday });
            totalPunchOutCount++;
        }

        // ç”Ÿç†å‡(æ™‚)
        const mHourVal = getVal("input[data-type='m-hour']");
        if (mHourVal > 0) {
            totalMHours += mHourVal;
            menstrualRecords.push({ hours: mHourVal, date, weekday });
        }

        // å–ªå‡(æ™‚)
        const fHourVal = getVal("input[data-type='f-hour']");
        if (fHourVal > 0) {
            totalFHours += fHourVal;
            funeralRecords.push({ hours: fHourVal, date, weekday });
        }

        // è¶…æ™‚(æ™‚)
        const otHourVal = getVal("input[data-type='overtime-hour']");
        if (otHourVal > 0) {
            totalOtHours += otHourVal;
            overtimeRecords.push({ hours: otHourVal, date, weekday });
        }

        // ç‰¹æ®Šå‡åˆ¥ï¼ˆåªçœ‹æ™‚æ•¸ï¼‰
        const typeSelect = row.querySelector(".special-leave-type");
        const selectedType = typeSelect?.value || "";
        const hourValue = getVal(".special-leave-hour");
        if (selectedType) {
            if (hourValue > 0) {
                specialLeaves[selectedType].hours += hourValue;
                specialLeaves[selectedType].records.push({ hours: hourValue, date, weekday });
            } else {
                if (!row.classList.contains("warned-incomplete-special-leave")) {
                    showToast(`ğŸ“Œ ${date} å·²é¸ã€Œ${selectedType}ã€ï¼Œè«‹å¡«å…¥æ™‚æ•¸`);
                    row.classList.add("warned-incomplete-special-leave");
                }
            }
        }
    });

    // é–‹å§‹è¼¸å‡º
    const name = document.getElementById("teacherNameLeave").value.trim();
    let result = name ? `${name}\n` : "";
    const format = (records, unit) => records.map(e => formatEntry(e, unit)).join("ã€");

    result += appendResultBlock("ç‰¹ä¼‘/è£œä¼‘", 0, totalVHours, vacationRecords);
    result += appendResultBlock("è¶…æ™‚", 0, totalOtHours, overtimeRecords);

    // å…¨å‹¤ç·©è¡
    const totalNoDeductMinutes = lateNoDeductRecords.reduce((sum, r) => sum + (r.minutes || 0), 0);
    const totalMissPunches = punchCardMissRecords.length;
    if (totalNoDeductMinutes || totalMissPunches) {
        result += `âœ… å…¨å‹¤ç·©è¡ï¼š`;
        if (totalNoDeductMinutes > 0) {
            result += `é²åˆ°ä¸æ‰£ ${totalNoDeductMinutes} åˆ† ${format(lateNoDeductRecords, "minutes")}`;
        }
        if (totalMissPunches > 0) {
            if (totalNoDeductMinutes > 0) result += "ï¼Œ";
            result += `æ¼æ‰“å¡ ${totalMissPunches} æ¬¡ ${punchCardMissRecords.map(r => `(${r.date} ${r.type})`).join("ã€")}`;
        }
        const totalBuffer = lateNoDeductRecords.length + totalMissPunches;
        if (totalBuffer > 3) result += " âš ï¸ è¶…é 3 æ¬¡ï¼Œå…¨å‹¤å–æ¶ˆ";
        result += "\n";
    }

    result += appendResultBlock("äº‹å‡", 0, totalPHours, leaveRecords);
    result += appendResultBlock("ç—…å‡", 0, totalSHours, sickRecords);
    result += appendResultBlock("ç”Ÿç†å‡", 0, totalMHours, menstrualRecords, "");
    result += appendResultBlock("é²åˆ°", 0, 0, lateRecords);
    result += appendResultBlock("å–ªå‡", 0, totalFHours, funeralRecords);

    Object.entries(specialLeaves).forEach(([type, data]) => {
        result += appendResultBlock(type, 0, data.hours, data.records);
    });

    // ç‰¹ä¼‘è£œä¼‘çµé¤˜ï¼ˆç¶­æŒä½ åŸæœ¬ã€Œå¤©ï¼‹æ™‚ã€UIï¼Œä½†å¤©ä¸æœƒå†è®Šå‹•ï¼‰
    const originalVacationDays = getValue("remainVacationDays");
    const originalVacationHours = getValue("remainVacationHours");

    let rawRemainingDays = originalVacationDays;                    // ä¸å†æ‰£å¤©
    let rawRemainingHours = originalVacationHours + totalOtHours - totalVHours;

    // è‹¥ä½ ä»æƒ³åšã€Œæ™‚æ•¸å€Ÿä¸€å¤©ã€çš„æ›ç®—ï¼Œé€™æ®µå¯ä»¥ä¿ç•™ï¼›ä¸æƒ³å°±æ‹¿æ‰
    while (rawRemainingHours < 0 && rawRemainingDays > 0) {
        rawRemainingHours += 8;
        rawRemainingDays -= 1;
    }

    rawRemainingHours = Math.floor(rawRemainingHours * 100) / 100;
    const balanceWarning = (rawRemainingDays < 0 || rawRemainingHours < 0) ? " âš ï¸" : "";

    let vacationSummary = '';
    vacationSummary += `ç‰¹ä¼‘è£œä¼‘è¨ˆç®—èªªæ˜ï¼š\n`;
    vacationSummary += `å‰æœˆçµé¤˜ï¼š${originalVacationDays} å¤© ${originalVacationHours} æ™‚\n`;
    vacationSummary += `æ‰£æœ¬æœˆç”¨ï¼š-0 å¤© -${totalVHours} æ™‚\n`;
    vacationSummary += `æœ¬æœˆè¶…æ™‚ï¼š+${totalOtHours} æ™‚\n`;
    vacationSummary += `æœ¬æœˆçµé¤˜ï¼š${rawRemainingDays} å¤© ${rawRemainingHours} æ™‚${balanceWarning}\n`;

    document.getElementById("vacationBreakdown").innerText = vacationSummary;

    if (rawRemainingDays < 0 || rawRemainingHours < 0) {
        showToast("âš ï¸ ç‰¹ä¼‘è£œä¼‘é€æ”¯äº†ï¼Œè«‹æ³¨æ„ï¼");
    }
    result += `ğŸ“Œ ç‰¹ä¼‘è£œä¼‘çµé¤˜ï¼š${rawRemainingDays} å¤© ${rawRemainingHours} æ™‚${balanceWarning}\n`;

    document.getElementById("resultsLeave").innerText = result;
}


    /**
     * è¤‡è£½å‡åˆ¥çµ±è¨ˆçµæœåˆ°å‰ªè²¼ç°¿ã€‚
     */
    function copyResultsLeave() {
        const resultText = document.getElementById("resultsLeave").innerText;
        if (!resultText) {
            showToast("âš ï¸ å°šæœªç”¢ç”Ÿçµæœ");
            return;
        }
        navigator.clipboard.writeText(resultText).then(() => {
            showToast("å·²è¤‡è£½çµ±è¨ˆçµæœï¼");
        }).catch(() => {
            showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–å…§å®¹ï¼");
        });
    }

    /**
     * å°‡å‡åˆ¥çµ±è¨ˆçµæœåŒ¯å…¥ä¸è¨ˆè–ªè¨ˆç®—å€å¡Šã€‚
     */
    function importLeaveResults() {
    // ä»¥ã€Œæ™‚ã€ç‚ºä¸»çš„åŒ¯å…¥ï¼ˆä½ çš„æœˆè¡¨æœ¬ä¾†å°±åªç®—ã€Œæ™‚ã€ï¼‰
    const totalLeaveHours = leaveRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);
    const totalSickHours = sickRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);
    const totalLateMinutes = lateRecords.filter(r => r.minutes).reduce((sum, r) => sum + r.minutes, 0);
    const totalMenstrualHours = menstrualRecords.filter(r => r.hours).reduce((sum, r) => sum + r.hours, 0);

    // âœ… æ–°å¢ï¼šå®¶åº­ç…§é¡§å‡ï¼ˆæ™‚ï¼‰å¾ specialLeaves å½™ç¸½
    const familyCare = specialLeaves["å®¶åº­ç…§é¡§å‡"] || { hours: 0 };
    const totalFamilyCareHours = familyCare.hours || 0;

    // å°æ‡‰è¼¸å…¥æ¡†ï¼ˆè‹¥é é¢ä¸Šæœ‰å°±å¡«ï¼Œé¿å…å ±éŒ¯ï¼‰
    const setIfExist = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };

    setIfExist("leaveHoursSalary", totalLeaveHours);
    setIfExist("sickHoursSalary", totalSickHours);
    setIfExist("lateMinutesSalary", totalLateMinutes);
    setIfExist("menstrualHoursSalary", totalMenstrualHours);
    setIfExist("familyCareHoursSalary", totalFamilyCareHours); // â† æ–°å¢å¸¶å…¥

    const teacherNameLeave = document.getElementById("teacherNameLeave").value.trim();
    if (teacherNameLeave) setIfExist("nameSalary", teacherNameLeave);

    showToast("å‡åˆ¥çµ±è¨ˆçµæœå·²åŒ¯å…¥ä¸æ”¯è–ªè¨ˆç®—ï¼");
}



    /**
     * è¨ˆç®—è–ªè³‡æ‰£æ¬¾ã€‚
     */
    function calculateSalaryDeduction() {
    const name = document.getElementById("nameSalary").value.trim();
    const salary = getValue("salary"); // æœˆè–ª

    if (salary <= 0) {
        document.getElementById("salaryResult").innerText = "âš ï¸ è«‹å¡«å…¥åŸå§‹æœˆè–ª";
        return;
    }

    // åªä»¥ã€Œæ™‚ã€ç‚ºå–®ä½
    const leaveHours = getValue("leaveHoursSalary");           // äº‹å‡ï¼ˆæ™‚ï¼‰â†’ å…¨é¡ä¸æ”¯è–ª
    const sickHours = getValue("sickHoursSalary");             // ç—…å‡ï¼ˆæ™‚ï¼‰â†’ åŠè–ª
    const menstrualHours = getValue("menstrualHoursSalary");   // ç”Ÿç†å‡ï¼ˆæ™‚ï¼‰â†’ åŠè–ª
    const familyCareHours = getValue("familyCareHoursSalary"); // å®¶åº­ç…§é¡§å‡ï¼ˆæ™‚ï¼‰â†’ å…¨é¡ä¸æ”¯è–ª
    const lateMinutes = getValue("lateMinutesSalary");

    const cashOutDays = getValue("cashOutDaysSalary");
    const cashOutHours = getValue("cashOutHoursSalary");

    // ç”Ÿæˆè©³ç´°è¨»è¨˜ï¼ˆæ²¿ç”¨ä½ æ—¢æœ‰çš„è¨˜éŒ„è³‡æ–™ï¼›è‹¥ç„¡å°æ‡‰å°±é¡¯ç¤ºç‚ºç©ºï¼‰
    const leaveHoursNote = leaveRecords.filter(r => r.hours).map(record => `ï¼ˆ${record.date} ${record.hours}æ™‚ï¼‰`).join('');
    const sickHoursNote = sickRecords.filter(r => r.hours).map(record => `ï¼ˆ${record.date} ${record.hours}æ™‚ï¼‰`).join('');
    const lateNote = lateRecords.map(record => `ï¼ˆ${record.date} ${record.minutes}åˆ†ï¼‰`).join('');
    const menstrualNote = menstrualRecords.map(record => `ï¼ˆ${record.date} ${record.hours}æ™‚ï¼‰`).join('');
    // å®¶åº­ç…§é¡§å‡å¯ç”±ä¸Šæ–¹æœˆä»½è¡¨æ ¼çš„ã€Œç‰¹æ®Šå‡ã€é¸å–®çµ±è¨ˆä¸¦åŒ¯å…¥ï¼›é€™è£¡ç›´æ¥ä½¿ç”¨è¼¸å…¥æ¡†æ•¸å€¼


    // å–®ä½æ›ç®—
    const perHour = salary / 30 / 8;
    const perMinute = perHour / 60;

    // åŸå§‹é‡‘é¡ï¼ˆå››æ¨äº”å…¥æ”¾åœ¨ç¸½é¡ï¼‰
    const rawLeaveHourDeduct = perHour * leaveHours;                 // äº‹å‡ï¼šå…¨é¡
    const rawSickHourDeduct = (perHour / 2) * sickHours;             // ç—…å‡ï¼šåŠè–ª
    const rawMenstrualDeduct = (perHour / 2) * menstrualHours;       // ç”Ÿç†å‡ï¼šåŠè–ª
    const rawFamilyCareDeduct = perHour * familyCareHours;           // å®¶åº­ç…§é¡§å‡ï¼šå…¨é¡
    const rawLateDeduct = perMinute * lateMinutes;

    const rawCashOutDayBonus = (salary / 30) * cashOutDays;
    const rawCashOutHourBonus = perHour * cashOutHours;

    const totalDeduct = Math.round(
        rawLeaveHourDeduct +
        rawSickHourDeduct +
        rawMenstrualDeduct +
        rawFamilyCareDeduct +
        rawLateDeduct
    );

    const totalCashOutBonus = Math.round(rawCashOutDayBonus + rawCashOutHourBonus);

    let formula = `${name ? name + "ï¼š" : ""}æ˜ç´°å¦‚ä¸‹ï¼š\n`;

    if (leaveHours)     formula += `â–äº‹å‡ ${leaveHours}æ™‚ Ã— ${salary}/30/8 = ${Math.round(rawLeaveHourDeduct)}å…ƒ ${leaveHoursNote}\n`;
    if (sickHours)      formula += `â–ç—…å‡ ${sickHours}æ™‚ Ã— ${salary}/30/8/2 = ${Math.round(rawSickHourDeduct)}å…ƒ ${sickHoursNote}\n`;
    if (menstrualHours) formula += `â–ç”Ÿç†å‡ ${menstrualHours}æ™‚ Ã— ${salary}/30/8/2 = ${Math.round(rawMenstrualDeduct)}å…ƒ ${Math.round(rawMenstrualDeduct) ? menstrualNote : ""}\n`;
    if (familyCareHours)formula += `â–å®¶åº­ç…§é¡§å‡ ${familyCareHours}æ™‚ Ã— ${salary}/30/8 = ${Math.round(rawFamilyCareDeduct)}å…ƒ\n`;
    if (lateMinutes)    formula += `â–é²åˆ° ${lateMinutes}åˆ† Ã— ${salary}/30/8/60 = ${Math.round(rawLateDeduct)}å…ƒ ${lateNote}\n`;

    // å…¨å‹¤æé†’ï¼šåªè¦äº‹å‡ã€ç—…å‡ï¼Œæˆ–ã€Œè¶…éä¸‰æ¬¡5åˆ†é˜çš„é²åˆ°ï¼ˆåˆ†é˜ï¼‰ã€ä»»ä¸€ä¸ç‚º 0 å°±æé†’
    if (leaveHours > 0 || sickHours > 0 || lateMinutes > 0) {
    formula += `âš ï¸ è¨˜å¾—æ‰£å…¨å‹¤\n`;
    }


    formula += `ä¸æ”¯è–ªé‡‘é¡ï¼š${totalDeduct} å…ƒ\n`;

    if (cashOutDays)  formula += `â•æŠ˜ç¾ ${cashOutDays}å¤© Ã— ${salary}/30 = ${Math.round(rawCashOutDayBonus)}å…ƒ\n`;
    if (cashOutHours) formula += `â•æŠ˜ç¾ ${cashOutHours}æ™‚ Ã— ${salary}/30/8 = ${Math.round(rawCashOutHourBonus)}å…ƒ\n`;
    if (cashOutDays || cashOutHours) {
        formula += `æŠ˜ç¾ç¸½é‡‘é¡ï¼š${totalCashOutBonus} å…ƒ\n`;
    }

    document.getElementById("salaryResult").innerText = formula;
}


    /**
     * è¤‡è£½è–ªè³‡è¨ˆç®—çµæœåˆ°å‰ªè²¼ç°¿ã€‚
     */
    function copyResultsSalary() {
        const text = document.getElementById("salaryResult").innerText;
        if (!text) {
            showToast("âš ï¸ å°šæœªç”¢ç”Ÿçµæœ");
            return;
        }
        navigator.clipboard.writeText(text)
            .then(() => showToast("âœ… å·²è¤‡è£½ç®—å¼ï¼"))
            .catch(err => showToast("âŒ è¤‡è£½å¤±æ•—ï¼š" + err));
    }
    function importToAll() {
     // å…ˆé‡æ–°è¨ˆç®—ï¼Œç¢ºä¿ resultsLeave èˆ‡å„å…¨åŸŸè¨˜éŒ„æ˜¯æœ€æ–°
     calculateLeave();

     // å…ˆæŠŠçµ±è¨ˆæ•¸æ“šåŒ¯å…¥åˆ°ã€Œä¸æ”¯è–ªã€å€å¡Š
     importLeaveResults();

     // å†é€åˆ° iframeï¼ˆç¼ºå‹¤åˆ†æé ï¼‰
     sendToIframe();

     showToast("âœ… å·²åŒ¯å…¥ç¼ºå‹¤åˆ†æèˆ‡ä¸æ”¯è–ªè¨ˆç®—");
    }


    /**
     * å°‡å‡åˆ¥æ•¸æ“šç™¼é€çµ¦ iframeã€‚
     */
    function sendToIframe() {
        const data = (document.getElementById('resultsLeave').innerText || '').trim();
        if (!data) {
            showToast("âš ï¸ æ²’æœ‰å¯å‚³é€çš„çµ±è¨ˆè³‡æ–™ï¼Œè«‹å…ˆè¼¸å…¥æˆ–é»è¡¨æ ¼æ¬„ä½è®“ç³»çµ±é‡ç®—");
            return;
        }
        
        const iframe = document.getElementById('absenceFrame');
        if (!iframe || !iframe.contentWindow) {
            showToast("âš ï¸ æ‰¾ä¸åˆ°ç¼ºå‹¤åˆ†æçš„ iframeï¼ˆabsenceFrameï¼‰");
            return;
        }
        
        if (!window.absenceFrameReady) {
            showToast("âŒ›ï¸ åˆ†æé é¢å°šåœ¨è¼‰å…¥ä¸­ï¼Œç¨å¾Œå†è©¦");
            return;
        }
        
        iframe.contentWindow.postMessage(
            { type: 'IMPORT_LEAVE_DATA', payload: data },
            'https://zh22331997.github.io' // å¿…é ˆç²¾æº–åŒ¹é… iframe çš„ä¾†æº
             );
            }



    // --- DOM åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ– (Initialization on DOMContentLoaded) ---
    window.addEventListener("DOMContentLoaded", () => {
        // è¨­å®šé è¨­æœˆä»½ç‚ºä¸Šå€‹æœˆ
        let now = new Date();
        let prevMonth = now.getMonth(); // 0 = ä¸€æœˆ

        if (prevMonth === 0) { // å¦‚æœç¾åœ¨æ˜¯ä¸€æœˆï¼Œå‰‡ä¸Šå€‹æœˆæ˜¯å»å¹´åäºŒæœˆ
            document.getElementById("monthInput").value = 12;
            document.getElementById("yearInput").value = now.getFullYear() - 1;
        } else {
            document.getElementById("monthInput").value = prevMonth;
            document.getElementById("yearInput").value = now.getFullYear();
        }

        // è¨­å®šå¹´ä»½ç‚ºç•¶å‰å¹´ä»½
        document.getElementById("yearInput").value = new Date().getFullYear();

        generateTable(); // åˆå§‹åŒ–æ™‚ç”Ÿæˆè¡¨æ ¼

        // ç›£è½å¹´ä»½å’Œæœˆä»½çš„è®ŠåŒ–ï¼Œé‡æ–°ç”Ÿæˆè¡¨æ ¼
        document.getElementById("yearInput").addEventListener("change", generateTable);
        document.getElementById("monthInput").addEventListener("change", generateTable);

        // ç¦æ­¢æ»¾è¼ªæ”¹è®Šæ•¸å­—è¼¸å…¥æ¡†çš„å€¼
        document.addEventListener('wheel', function(e) {
            if (document.activeElement && document.activeElement.type === 'number') {
                e.preventDefault(); // é˜»æ­¢æ»¾è¼ªé è¨­è¡Œç‚º
                document.activeElement.blur(); // ç§»é™¤ focus é¿å…æ•¸å€¼è¢«æ”¹å‹•
            }
        }, { passive: false });

        // è®“çˆ¶é çŸ¥é“ iframe ä»€éº¼æ™‚å€™è¼‰å¥½
        const absFrame = document.getElementById('absenceFrame');
        window.absenceFrameReady = false;
        if (absFrame) {
                        absFrame.addEventListener('load', () => {
    window.absenceFrameReady = true;
  });
}



        



    });
    function toggleBalanceInfo() {
    const block = document.getElementById("balanceDetails");
    block.style.display = block.style.display === "none" ? "block" : "none";
}
</script>
</body>
</html>
