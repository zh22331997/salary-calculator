<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TSV → 年月/分校/姓名/類型/小計/備註</title>
<style>
  :root{--bg:#f7f7fb;--card:#fff;--ink:#1f2937;--muted:#6b7280;--pri:#4f46e5;--border:#e5e7eb}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","Segoe UI",Roboto,Arial,"PingFang TC","Microsoft JhengHei","Helvetica Neue",sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .title{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .title h1{margin:0;font-size:20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 3px rgba(0,0,0,.04);padding:16px}
  textarea{width:100%;height:260px;border:1px solid var(--border);border-radius:12px;padding:12px;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button{border:0;border-radius:12px;background:var(--pri);color:#fff;padding:10px 14px;font-weight:600;cursor:pointer}
  button.secondary{background:#e5e7eb;color:#111827}
  .muted{color:var(--muted);font-size:12px;margin-top:6px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:8px 10px;vertical-align:top}
  th{background:#f3f4f6;text-align:left}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1>貼上考勤 TSV → 產生「年月／分校／姓名／假別/類型／小計／備註」</h1>
    </div>

    <div class="muted">支援有／無表頭；請確保是 <b>Tab 分隔</b>。分校直接讀取資料中的「分校／部門」欄；一天工時固定 <b>8 小時</b>。</div>

    <div class="card" style="margin-top:12px">
      <textarea id="raw" placeholder="在這裡貼上原始資料（含或不含表頭；欄位以 Tab 分隔）"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="run">產生表格</button>
        <button id="copyTSV" class="secondary">複製為 TSV（貼回 Google Sheet）</button>
        <button id="clear" class="secondary">清空</button>
      </div>
      <div class="muted">輸出欄位：年月、分校、姓名、假別/類型、<b>小計</b>（天/時 或 分鐘/次數）、備註（依你範例格式）。遲到分為「遲到(不扣)」與「遲到⚠️」（偵測「不扣」字樣歸入不扣，否則歸入⚠️）。</div>
    </div>

    <div id="out" class="card" style="margin-top:12px">
      <div class="hint">尚未輸出。</div>
    </div>
  </div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const DAY_HRS = 8; // 固定一天 8 小時

  const headersDefault = [
    "員工編號","姓名","部門","打卡日期","日期類別","班別","表定上班時間","表定下班時間",
    "休息時間","表定工時","打卡工時","計薪基準工時","上班打卡時間","遲到","下班打卡時間","早退",
    "出勤異常","提早上班原因","上班打卡方式","上班打卡地點","上班地點異常，不在範圍內的原因",
    "延後下班原因","下班打卡方式","下班打卡地點","下班地點異常，不在範圍內的原因",
    "請假時間","請假時數","假別","加班時間","加班時數"
  ];

  // 事件
  $("#run").addEventListener("click", run);
  $("#clear").addEventListener("click", ()=>{ $("#raw").value=""; $("#out").innerHTML='<div class="hint">尚未輸出。</div>'; });
  $("#copyTSV").addEventListener("click", copyTSV);

  // 主流程
  let lastTSV = ""; // for copy
  function run(){
    const text = ($("#raw").value||"").trim();
    const out = $("#out");
    if(!text){ out.innerHTML = '<div class="hint">（請先貼上資料）</div>'; return; }

    const {headers, rows, err} = tsvParse(text);
    if(err){ out.innerHTML = `<div style="color:#dc2626">解析失敗：${err}</div>`; return; }

    const H_DATE   = pickHeader(headers, /打卡日期/, "打卡日期");
    const H_NAME   = pickHeader(headers, /姓名/, "姓名");
    const H_BRANCH = pickHeader(headers, /分校|部門/, "部門"); // 從資料抓
    const H_LEAVE_H    = pickHeader(headers, /請假時數/, "請假時數");
    const H_LEAVE_KIND = pickHeader(headers, /假別/, "假別");
    const H_OT_H     = pickHeader(headers, /加班時數|加班工時|加班時間|超時|加班/, "加班時數");
    const H_OT_TIME  = pickHeader(headers, /加班時間/, "加班時間"); 
    const H_ABN   = pickHeader(headers, /出勤異常/, "出勤異常");

    // 聚合：key = 年月|分校|姓名|類型
    const map = new Map();

    rows.forEach(r=>{
      const dateStr = (r[H_DATE]||"").trim();
      const ym = toYM(dateStr);
      const md = toMD(dateStr); // 8/19
      const name = (r[H_NAME]||"").trim();
      const branch = (r[H_BRANCH]||"").trim();
      const abn = (r[H_ABN]||"").trim();

      // 1) 請假（小時計）
      const leaveKind = (r[H_LEAVE_KIND]||"").replace(/\s/g,"");
      const leaveH = toNumber(r[H_LEAVE_H]);
      if(leaveKind && leaveKind!=="--" && leaveH>0){
        addAgg(map, ym, branch, name, leaveKind, leaveH, `${md} ${fmtPiece(leaveH, DAY_HRS)}`, DAY_HRS);
      }

      // 2) 超時（加班）
      const otH        = toNumber(r[H_OT_H]);      // 若是純數字小時，照舊
      const otFromTime = hhmmToHours(r[H_OT_TIME]); // 若是 "01:30:00" 會轉 1.5 小時
      const ot = otH || otFromTime;               // 取到任一個就算
      if (ot > 0) {
        addAgg(map, ym, branch, name, "超時", ot, `${md} ${fmtPiece(ot, DAY_HRS)}`, DAY_HRS);
     }

      // 3) 出勤異常：遲到(不扣)/遲到⚠️、漏打卡（只依文字）
      if(abn){
        // 遲到：含「不扣」視為遲到(不扣)
        const lateM = abn.match(/遲到\s*(\d+)\s*分/);
        if(lateM){
          const mins = Number(lateM[1]);
          const typ = /不扣/.test(abn) ? "遲到(不扣)" : "遲到⚠️";
          addAgg(map, ym, branch, name, typ, {mins, cnt:1}, `${md} ${mins}分鐘`, DAY_HRS, true);
        }

        // 漏打卡（上班未打卡／下班未打卡／漏打卡），支援「…X 次」
        const timesM = abn.match(/(\d+)\s*次/);
        let totalTimes = timesM ? Number(timesM[1]) : 0;

        const upMiss    = (abn.match(/上班未打卡/gi) || []).length;
        const downMiss  = (abn.match(/下班未打卡/gi) || []).length;
        const plainMiss = (!upMiss && !downMiss) ? (abn.match(/漏打卡/gi) || []).length : 0;

        if(!timesM) totalTimes = upMiss + downMiss + plainMiss;

        if(totalTimes > 0){
          for(let i=0;i<upMiss;i++)   addAgg(map, ym, branch, name, "漏打卡", {miss:1}, `${md} 上班`, DAY_HRS, true);
          for(let i=0;i<downMiss;i++) addAgg(map, ym, branch, name, "漏打卡", {miss:1}, `${md} 下班`, DAY_HRS, true);
          for(let i=0;i<Math.max(0, totalTimes - upMiss - downMiss); i++){
            addAgg(map, ym, branch, name, "漏打卡", {miss:1}, `${md}`, DAY_HRS, true);
          }
        }
      }
    });

    // 組輸出列（固定忽略 0 天 0 時）
    const rowsOut = [];
    for (const [key, val] of map.entries()) {
      const [ym, branch, name, typ] = key.split("|");
      let subtotal = "";
      let remark = "";

      if (typ === "漏打卡") {
        subtotal = `${val.count} 次`;
        remark = val.detail.join("、");
        rowsOut.push([ym, branch, name, typ, subtotal, remark]);
        continue;
      }

      if (typ.startsWith("遲到")) {
        subtotal = `${val.totalMins}分鐘 (${val.count} 次)`;
        remark = val.detail.join("、");
        rowsOut.push([ym, branch, name, typ, subtotal, remark]);
        continue;
      }

      const hours = Number(val.totalHours || 0);
      if (hours === 0) continue; // 忽略 0 天 0 時
      subtotal = fmtDayHour(hours, DAY_HRS);
      remark = val.detail.join("、");
      rowsOut.push([ym, branch, name, typ, subtotal, remark]);
    }

    // 排序：年月、分校、姓名、類型
    rowsOut.sort((a,b)=> a[0].localeCompare(b[0]) || a[1].localeCompare(b[1]) || a[2].localeCompare(b[2]) || a[3].localeCompare(b[3]));

    // 畫表
    const thead = `<thead><tr><th>年月</th><th>分校</th><th>姓名</th><th>假別/類型</th><th>小計</th><th>備註</th></tr></thead>`;
    const tbody = `<tbody>${rowsOut.map(r=>`<tr>${r.map(c=>`<td>${escapeHtml(c)}</td>`).join("")}</tr>`).join("")}</tbody>`;
    $("#out").innerHTML = `<div class="hint" style="margin-bottom:8px">共 ${rowsOut.length} 列，可按「複製為 TSV」貼回 Google Sheet。</div><div style="overflow:auto"><table>${thead}${tbody}</table></div>`;

    // TSV
    const headerRow = ["年月","分校","姓名","假別/類型","小計","備註"];
    lastTSV = [headerRow, ...rowsOut].map(cols=>cols.map(v=>String(v??"").replaceAll("\t"," ")).join("\t")).join("\n");
  }

  function copyTSV(){
    if(!lastTSV){ alert("還沒有可複製的內容，請先產生表格。"); return; }
    navigator.clipboard.writeText(lastTSV).then(()=>{ alert("已複製 TSV，可直接貼到 Google Sheet！"); });
  }

  // —— 聚合輔助 —— 
  function addAgg(map, ym, branch, name, typ, val, detailStr, dayHrs){
    const key = `${ym}|${branch}|${name}|${typ}`;
    const rec = map.get(key) || {totalHours:0, totalMins:0, count:0, detail:[], dayHrs};
    if(typeof val === 'number'){ rec.totalHours += val; rec.detail.push(detailStr); }
    else if(val && typeof val === 'object'){
      if('mins' in val){ rec.totalMins += val.mins; rec.count += (val.cnt||1); rec.detail.push(detailStr); }
      if('miss' in val){ rec.count += val.miss; rec.detail.push(detailStr); }
    }
    map.set(key, rec);
  }

  // —— 工具 —— 
  function pickHeader(headers, pattern, fallback){ return headers.find(h=>pattern.test(h)) || fallback; }
  function tsvParse(text){
  const lines = text.split(/\r?\n/).filter(x => x.trim().length > 0);
  if(!lines.length) return {headers:[], rows:[], err:"空白內容"};
  const firstCols = lines[0].split("\t");
  const headerLike = firstCols.some(c => /員工編號|姓名|打卡日期|請假時數|假別|加班時數|出勤異常/.test(c));
  const headers = headerLike ? firstCols.map(h => h.trim()) : headersDefault.slice();
  const dataLines = headerLike ? lines.slice(1) : lines;
  const rows = dataLines.map(l => {
    const cols = l.split("\t");
    const o = {};
    headers.forEach((h,i) => o[h] = (cols[i] ?? "").trim());
    return o;
  });
  return {headers, rows, err:null};
}

  function toNumber(v){ const m = String(v??"").match(/-?\d+(?:\.\d+)?/); return m? Number(m[0]) : 0; }
  function hhmmToHours(v){
  const s = String(v || "").trim();
  // 例如 "1:30" 或 "01:30:00"
  const m = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(!m) return toNumber(s); // 不是時間格式就走原本數字擷取（支援 "1.5" 這種）
  const h = Number(m[1] || 0);
  const min = Number(m[2] || 0);
  const sec = Number(m[3] || 0);
  return h + min/60 + sec/3600;
}

  function toYM(yyyyMMdd){ const m = String(yyyyMMdd).match(/(\d{4})[\/\-](\d{1,2})/); if(!m) return yyyyMMdd||""; return `${m[1]}-${String(m[2]).padStart(2,'0')}`; }
  function toMD(yyyyMMdd){ const m = String(yyyyMMdd).match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/); if(!m) return yyyyMMdd||""; return Number(m[2])+"/"+Number(m[3]); }
  function pieceDayHour(h, dayHrs){ const d = Math.floor(h / dayHrs); const rem = Math.round((h - d*dayHrs)*100)/100; return {d, rem}; }
  function fmtDayHour(h, dayHrs){ const {d, rem} = pieceDayHour(Number(h)||0, dayHrs); return `${d} 天 ${rem} 時`; }
  function fmtPiece(h, dayHrs){ const {d, rem} = pieceDayHour(Number(h)||0, dayHrs); if(d>0 && rem===0) return `${d}天`; if(d===0 && rem>0) return `${rem}時`; if(d>0 && rem>0) return `${d}天 ${rem}時`; return `0時`; }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
})();
</script>
</body>
</html>
