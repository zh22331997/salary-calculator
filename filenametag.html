
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>正華資料夾名條產生器（印A4切3×7張）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
/* =========================
   Design System (Tokens)
   ========================= */
:root{
  --brand-500:#A1C6EA; --brand-600:#8FB9E2;
  --secondary-500:#BBD1EA; --secondary-600:#A8C5E6;
  --clear-500:#DAE3E5; --clear-600:#CFD9DC;

  --text-strong:#1f2937; --text-normal:#374151; --text-mute:#6b7280;
  --border:#d1d5db; --border-strong:#9ca3af;
  --bg-page:#f0f2f5; --bg-card:#ffffff; --bg-info:#f8fbff; --bg-info-border:#e1eefc;

  --font-sans:"Microsoft JhengHei","微軟正黑體","Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  --font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;

  --radius-sm:6px; --radius-md:8px; --radius-lg:12px;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.08);
  --shadow-md:0 2px 10px rgba(0,0,0,0.10);
  --shadow-lg:0 4px 20px rgba(0,0,0,0.12);

  --space-1:.25rem; --space-2:.5rem; --space-3:.75rem; --space-4:1rem; --space-5:1.25rem; --space-6:1.5rem;
  --input-height:2.75rem; --btn-height:2.9rem;

  --focus-ring:0 0 0 3px rgba(106,154,255,0.25);
  --focus-border:#6a9aff;

  --btn-text:#17324A;
}

/* =========================
   Base
   ========================= */
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:var(--font-sans);
  background:var(--bg-page);
  margin:0; padding:0;
  display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
  color:var(--text-normal);
}
.container{
  background:var(--bg-card); padding:2rem; margin:2rem 1rem; border-radius:var(--radius-lg);
  box-shadow:var(--shadow-lg); max-width:960px; width:100%;
}
h1{margin:0 0 var(--space-4); color:#0056b3; text-align:center; font-weight:800;}
h2,h3{color:var(--text-strong); border-bottom:2px solid #e0e0e0; padding-bottom:.5rem; margin-top:1.5rem; margin-bottom:1rem;}
label{font-weight:700; display:block; color:#555; margin-bottom:.5rem;}
p{color:#444; font-size:.95rem; line-height:1.6}

/* =========================
   表單/輸入
   ========================= */
.input-area{
  max-width:720px; margin:0 auto 30px auto; background:#fff; padding:20px;
  border-radius:var(--radius-md); box-shadow:var(--shadow-sm);
}
textarea,
.input-area input[type="text"]{
  width:100%;
  height:var(--input-height);
  padding:0 var(--space-4);
  border-radius:var(--radius-md);
  border:1px solid var(--border);
  font-size:16px; background:#fff; color:var(--text-normal);
  transition:border-color .2s, box-shadow .2s, background-color .2s;
}
textarea{
  height:auto; min-height:200px; resize:vertical;
  padding:var(--space-3); line-height:1.5; font-family:var(--font-mono);
  width:calc(100% - 1rem);
}
textarea:focus,
.input-area input[type="text"]:focus{
  outline:none; border-color:var(--focus-border)!important; box-shadow:var(--focus-ring);
}

/* =========================
   使用說明（可收合）
   ========================= */
.instructions-wrapper{margin:.8em 0 1.2em;}
.instructions-toggle{
  display:inline-block; background:var(--secondary-500); color:var(--btn-text);
  padding:.6em 1.2em; border-radius:var(--radius-md); cursor:pointer; font-weight:700;
  transition:background .2s, transform .15s; box-shadow:var(--shadow-sm);
}
.instructions-toggle:hover{background:var(--secondary-600); transform:translateY(-1px);}
.instructions-content{
  display:none; background:var(--bg-info); border:1px solid var(--bg-info-border);
  border-left:5px solid var(--secondary-500);
  border-radius:var(--radius-md); padding:1em 1.2em; color:#1b3a57; margin-top:.8em;
  line-height:1.6; font-size:1em; box-shadow:var(--shadow-sm);
}
.instructions-content ul{margin:.4em 0 .8em 1.2em; padding:0;}
.instructions-content pre{
  background:#fff; border:1px solid #e6edf7; border-radius:var(--radius-sm);
  padding:.6em .8em; white-space:pre-wrap; margin:.4em 0; font-size:.95em;
}

/* =========================
   按鈕（統一組件）
   ========================= */
button{
  display:inline-flex; align-items:center; justify-content:center;
  min-height:var(--btn-height); padding:0 var(--space-5);
  font-size:17px; font-weight:700; border:none; border-radius:var(--radius-md);
  cursor:pointer; color:var(--btn-text); background:var(--brand-500);
  transition:background-color .15s ease, transform .12s ease, box-shadow .2s;
  box-shadow:var(--shadow-sm);
}
button:hover{background:var(--brand-600); transform:translateY(-2px)}
button:active{transform:translateY(-1px)}
button:focus{outline:none; box-shadow:var(--focus-ring)}

.btn-secondary{ background:var(--secondary-500); color:var(--btn-text); }
.btn-secondary:hover{ background:var(--secondary-600); }
.btn-clear{ background:var(--clear-500); color:var(--btn-text); }
.btn-clear:hover{ background:var(--clear-600); }

.btn-row{ display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:.5rem; }
.btn-row > button{ width:200px; margin:0; }

/* =========================
   名條排版（A4 3×7）— 關鍵修正
   ========================= */
/* 每一頁固定 A4 尺寸與「剛好放入 3×7」的內距：上/下 6mm、左/右 10.5mm */
.sheet{
  width:210mm; height:297mm;
  padding:6mm 10.5mm;  /* 297 - 7*39 = 24 -> 上下各 6mm；210 - 3*63 = 21 -> 左右各 10.5mm */
  margin:0;
  background:#fff;
  display:grid;
  grid-template-columns:repeat(3, 63mm);
  grid-template-rows:repeat(7, 39mm);
  gap:0;               /* 不留縫，確保精準對齊 */
  align-content:start; /* 多頁時保險 */
  box-shadow:var(--shadow-md); /* 只影響螢幕預覽，列印會隱藏 */
}

#output{display:flex; flex-direction:column; gap:24px; align-items:center;}
.output-page{ /* 保留 class 名稱以相容你的 JS，但實際樣式由 .sheet 控制 */}
.output-page.sheet{}

/* 名條本體以 mm 定尺寸，含邊框 */
.namecard{
  width:63mm; height:39mm;
  margin:0; padding:2mm 0 0 0;
  border:.3px solid #000; border-radius:0;
  box-sizing:border-box; background:#fff; text-align:center;
  page-break-inside:avoid;
}

.line1{font-size:13pt;}
.line2{font-size:12pt; margin:1mm 0;}
.class{font-size:12pt; margin:1mm 0;}
.name{font-size:18pt; font-weight:800; display:inline-block; text-align:left; line-height:1.2;}
.name-row{display:flex; justify-content:center; align-items:center; gap:6mm; margin-top:2mm; max-width:80%; margin-left:auto; margin-right:auto;}
.logo{max-height:12mm; max-width:16mm; object-fit:contain; display:block;}

/* =========================
   列印
   ========================= */
@media print{
  @page{ size:A4 portrait; margin:0; }

  /* 只隱藏不必要的 UI */
  .input-area,
  .instructions-wrapper,
  h1,
  #printBtn{
    display:none !important;
  }

  /* 讓容器在列印時像一張白紙，保留裡面的 #output 與 .sheet */
  .container{
    display:block !important;
    background:#fff !important;
    box-shadow:none !important;
    padding:0 !important;
    margin:0 !important;
    border-radius:0 !important;
  }

  body{ background:#fff; }
  #output{ display:block; }
  .sheet{ box-shadow:none !important; }
  .output-page{ break-after:page; page-break-after:always; }
  .namecard{ page-break-inside:avoid; }
}

  </style>
</head>
<body>
  <div class="container">
    <h1>正華資料夾名條產生器（A4 3×7）</h1>

    <div class="instructions-wrapper">
      <span class="instructions-toggle" id="toggleGuide">使用說明（點我展開/收合）</span>
      <div class="instructions-content" id="guide">
        <ul>
          <li>請從 Excel 點名表直接貼上，<strong>必須包含標題列</strong>。</li>
          <li>欄位需求：<strong>班級、姓名</strong></li>
          <li>姓名欄名可支援以下名稱：姓名／學生／學生姓名／中文姓名／中文姓名英文姓名</li>
          <li>即使資料包含英文名字，系統會自動抓取中文姓名</li>
        </ul>
        <pre>範例（含標題，從 EXCEL 貼上即可，班級打什麼，名條上就顯示什麼喔！）：
班級	姓名
二A	陳小慈
二	劉小綸
</pre>
      </div>
    </div>

    <div class="input-area">
      <label>（第一列）營隊名稱</label>
      <input type="text" id="line1" placeholder="例：2025正華夏令營" value="2025正華夏令營">

      <label>（第二列）副標題</label>
      <input type="text" id="line2" placeholder="例：學習單資料夾" value="學習單資料夾">

      <label>（第三、四列）從 Excel 貼上班級與姓名資料（含標題列）</label>
      <textarea id="rawData" rows="8" placeholder="班級	姓名
二A	   陳小慈
二 	   劉小綸"></textarea>

      <div class="btn-row">
        <button id="genBtn" onclick="generateNamecards()">產生名條</button>
        <button id="printBtn" class="btn-secondary" onclick="window.print()" style="display:none;">列印名牌</button>
        <button id="clearBtn" class="btn-clear" onclick="clearAll()">清空</button>
      </div>
    </div>

    <div id="output"></div>
  </div>

  <script>
    // 說明開關
    document.getElementById('toggleGuide').addEventListener('click',()=>{
      const el=document.getElementById('guide');
      el.style.display=(el.style.display==='block')?'none':'block';
    });

    // 產生名條（必須含標題列）
    function generateNamecards(){
      const line1El=document.getElementById('line1');
      const line2El=document.getElementById('line2');
      const line1=(line1El.value||'').trim() || line1El.defaultValue || line1El.placeholder || '';
      const line2=(line2El.value||'').trim() || line2El.defaultValue || line2El.placeholder || '';
      const raw =document.getElementById('rawData').value;
      const output=document.getElementById('output');

      output.innerHTML='';
      if(!raw || !raw.trim()){ alert('請先貼上資料（需含標題列）。'); return; }

      // 解析 TSV（尊重引號＋欄內換行）
      const rows = parseTsvRespectingQuotes(raw);
      if(rows.length < 2){ alert('內容不足，請確認包含標題列與至少一筆資料。'); return; }

      // 只依標題列判斷欄位
      const header = rows[0].map(normalizeHeader);
      const idxClass = header.findIndex(h => h === '班級');
      const nameCandidates = new Set(['姓名','學生','學生姓名','中文姓名','中文姓名英文姓名']);
      let idxName = -1;
      for(let i=0;i<header.length;i++){ if(nameCandidates.has(header[i])){ idxName=i; break; } }

      if(idxClass < 0){ alert('找不到「班級」欄位，請確認標題列名稱為「班級」。'); return; }
      if(idxName < 0){ alert('找不到姓名欄位，請使用「姓名／學生／學生姓名／中文姓名／中文姓名英文姓名」。'); return; }

      const parsed = [];
      for(let r=1;r<rows.length;r++){
        const cells = rows[r];
        if(!cells || cells.length===0) continue;
        const className = (cells[idxClass] ?? '').trim();
        const rawName   = (cells[idxName]  ?? '').trim();
        const nameZh    = extractZh(rawName);
        if(className && nameZh) parsed.push({ className, nameZh });
      }
      if(parsed.length===0){ alert('標題已找到，但資料列未能擷取到有效的班級與中文姓名。'); return; }

      // 繪製：每 21 張一頁（A4 3×7）
      let page=createNewPage(); output.appendChild(page);
      parsed.forEach((item,idx)=>{
        const card=document.createElement('div');
        card.className='namecard';
        card.innerHTML = `
          <div class="line1">${escapeHtml(line1)}</div>
          <div class="line2">${escapeHtml(line2)}</div>
          <div class="class">${escapeHtml(item.className)}</div>
          <div class="name-row">
            <img class="logo" src="https://github.com/zh22331997/salary-calculator/blob/main/2019%20zh%20logo.png?raw=true" alt="logo">
            <div class="name">${escapeHtml(item.nameZh)}</div>
          </div>`;
        page.appendChild(card);
        if((idx+1)%21===0 && (idx+1)!==parsed.length){
          page=createNewPage(); output.appendChild(page);
        }
      });

      document.getElementById('printBtn').style.display='inline-flex';
      output.scrollIntoView({behavior:'smooth',block:'start'});
    }

    function clearAll(){
    // 僅清除使用者輸入，不清空預設值
    document.getElementById('line1').value = document.getElementById('line1').defaultValue || '2025正華夏令營';
    document.getElementById('line2').value = document.getElementById('line2').defaultValue || '學習單資料夾';

    // 清空貼上的 Excel 資料區域與產生結果
    document.getElementById('rawData').value = '';
    document.getElementById('output').innerHTML = '';
    document.getElementById('printBtn').style.display = 'none';
    }

    function createNewPage(){
      const div=document.createElement('div');
      div.className='output-page sheet';
      return div;
    }

    /* ===== TSV 解析器（尊重引號與欄內換行） ===== */
    function parseTsvRespectingQuotes(text){
      const rows=[]; let row=[]; let cell='';
      let inQuotes=false;

      for(let i=0;i<text.length;i++){
        const ch=text[i], next=text[i+1];

        if(ch === '"'){
          if(next === '"'){ cell+='"'; i++; }
          else { inQuotes = !inQuotes; }
          continue;
        }

        if(ch === '\t' && !inQuotes){ row.push(cell); cell=''; continue; }
        if((ch === '\n' || ch === '\r') && !inQuotes){
          if(ch === '\r' && next === '\n') i++;
          row.push(cell); cell='';
          if(row.some(c => (c && c.trim().length))) rows.push(row);
          row = [];
          continue;
        }
        cell += ch;
      }
      row.push(cell);
      if(row.some(c => (c && c.trim().length))) rows.push(row);

      for(let r=0;r<rows.length;r++){
        rows[r] = rows[r].map(c => (c ?? '').replace(/\r?\n/g,' ').trim());
      }
      return rows;
    }

    // 標題正規化
    function normalizeHeader(h){
      return (h||'')
        .toLowerCase()
        .replace(/\r?\n/g,'')
        .replace(/["']/g,'')
        .replace(/\s+/g,'')
        .replace(/　+/g,'')
        .replace(/[()（）]/g,'')
        .replace(/\./g,'');
    }

    // 抽中文姓名
    function extractZh(text){
      const m = (text||'').match(/[\u4E00-\u9FFF·．・‧－—\-\s]+/g);
      if(!m) return '';
      return m.join('').replace(/\s+/g,'').replace(/[．・‧－—-]/g,'').trim();
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
  </script>
</body>
</html>
