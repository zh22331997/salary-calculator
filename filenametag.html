<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>正華資料夾名條產生器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      font-family:'Noto Sans TC','Microsoft JhengHei',sans-serif;
      background:#f0f2f5;margin:0;padding:0;
      display:flex;justify-content:center;align-items:flex-start;min-height:100vh;
    }
    .container{
      background:#fff;padding:2rem;margin:2rem 1rem;border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.1);max-width:960px;width:100%;box-sizing:border-box;
    }
    h1{margin-top:0;color:#0056b3;text-align:center;}
    h2,h3{color:#333;border-bottom:2px solid #e0e0e0;padding-bottom:0.5rem;margin-top:1.5rem;margin-bottom:1rem;}
    label{font-weight:bold;display:block;color:#555;margin-bottom:0.5rem;}
    p{color:#666;font-size:0.95rem;line-height:1.6;}

    /* 輸入框 */
    textarea{
      width:calc(100% - 1rem);
      padding:0.75rem;margin-bottom:1rem;border-radius:8px;border:1px solid #ccc;
      font-size:16px;line-height:1.5;height:220px;min-height:200px;resize:vertical;
      box-sizing:border-box;transition:border-color 0.3s;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    }
    /* 聚焦一律亮藍框 */
    textarea:focus,
    .input-area input:focus{
      border-color:#6a9aff;outline:none;
      box-shadow:0 0 0 3px rgba(106,154,255,0.25);
    }

    /* 按鈕 */
    button{
      padding:0.8rem 1.5rem;font-size:17px;border:none;border-radius:8px;cursor:pointer;
      background-color:#4e73df;color:#fff;margin-right:0.8rem;margin-top:1rem;
      transition:background-color 0.3s,transform 0.2s;
    }
    button:hover{background-color:#2e59d9;transform:translateY(-2px);}
    #printBtn{background:#28a745;}
    #printBtn:hover{background:#218838;}
    #clearBtn{background:#6c757d;}
    #clearBtn:hover{background:#5a6268;}

    /* 使用說明（可收合） */
    .instructions-wrapper{margin:0.8em 0 1.2em;}
    .instructions-toggle{
      display:inline-block;background:#4e73df;color:#fff;padding:0.6em 1.2em;
      border-radius:8px;cursor:pointer;font-weight:600;
      transition:background 0.3s,transform 0.2s;
    }
    .instructions-toggle:hover{background:#2e59d9;transform:translateY(-1px);}
    .instructions-content{
      display:none;background:#f8fbff;border:1px solid #e1eefc;border-left:5px solid #4e73df;
      border-radius:8px;padding:1em 1.2em;color:#1b3a57;margin-top:0.8em;
      line-height:1.6;font-size:1em;box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }
    .instructions-content ul{margin:0.4em 0 0.8em 1.2em;padding:0;}
    .instructions-content pre{
      background:#fff;border:1px solid #e6edf7;border-radius:6px;padding:0.6em 0.8em;
      white-space:pre-wrap;margin:0.4em 0;font-size:0.95em;
    }

    /* 字型 */
    @font-face{
      font-family:'XiaolaiMonoSC';
      src:url('https://cdn.jsdelivr.net/gh/zh22331997/salary-calculator/ttf_XiaolaiMonoSC-Regular.ttf') format('truetype');
    }

    .input-area{
      max-width:720px;margin:0 auto 30px auto;background:#fff;padding:20px;border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .input-area label{display:block;margin-top:10px;}
    .input-area input,.input-area textarea{
      width:100%;padding:8px;margin-top:5px;box-sizing:border-box;
      font-family:'XiaolaiMonoSC','Noto Sans TC',sans-serif;border:1px solid #ccc;border-radius:8px;
    }

    /* 名條（A4 3x7） */
    .namecard{
      width:63mm;height:39mm;margin:0;padding:2mm 0 0 0;border:0.3px solid #000;
      box-sizing:border-box;text-align:center;page-break-inside:avoid;
    }
    #output{display:flex;flex-wrap:wrap;gap:1px;justify-content:center;}
    .output-page{
      width:100%;font-size:0;page-break-after:always;margin:0;padding:0;
      display:flex;flex-wrap:wrap;justify-content:center;
    }

    .line1{font-size:13pt;font-weight:normal;}
    .line2{font-size:12pt;font-weight:normal;margin:1mm 0;}
    .class{font-size:12pt;font-weight:normal;margin:1mm 0;}
    .name{font-size:18pt;font-weight:bold;display:inline-block;text-align:left;line-height:1.2;}

    .name-row{
      display:flex;justify-content:center;align-items:center;flex-direction:row;
      gap:6mm;margin-top:2mm;max-width:80%;margin-left:auto;margin-right:auto;
    }
    .logo{max-height:12mm;max-width:16mm;object-fit:contain;display:block;}

    @media print{
      @page{size:A4 portrait;margin:0;}
      .input-area,h1,#printBtn{display:none !important;}
      .output-page{display:flex;flex-wrap:wrap;justify-content:center;page-break-after:always;}
      .namecard{page-break-inside:avoid;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>正華資料夾名條產生器（A4 3×7）</h1>

    <div class="instructions-wrapper">
      <span class="instructions-toggle" id="toggleGuide">使用說明（點我展開/收合）</span>
      <div class="instructions-content" id="guide">
        <ul>
          <li>請從 Excel 點名表直接貼上，<strong>必須包含標題列</strong>。</li>
          <li>欄位需求：<strong>班級、姓名</strong></li>
          <li>姓名欄名可支援以下名稱：姓名／學生／學生姓名／中文姓名／中文姓名英文姓名</li>
          <li>即使資料包含英文名字，系統會自動抓取中文姓名</li>
        </ul>
        <pre>範例（含標題，從 EXCEL 貼上即可，班級打什麼，名條上就顯示什麼喔！）：
班級	姓名
二A	陳小慈
二	劉小綸
</pre>
      </div>
    </div>

    <div class="input-area">
      <label>（第一列）營隊名稱</label>
      <input type="text" id="line1" placeholder="例：2025正華夏令營" value="2025正華夏令營">

      <label>（第二列）副標題</label>
      <input type="text" id="line2" placeholder="例：學習單資料夾" value="學習單資料夾">

      <label>（第三、四列）從 Excel 貼上班級與姓名資料（含標題列）</label>
      <textarea id="rawData" rows="8" placeholder="班級	姓名
二A	   陳小慈
二 	   劉小綸"></textarea>
      <button id="genBtn" onclick="generateNamecards()">產生名條</button>
      <button id="printBtn" onclick="window.print()" style="display:none;">列印名牌</button>
      <button id="clearBtn" onclick="clearAll()">清空</button>
    </div>

    <div id="output"></div>
  </div>

  <script>
    // 說明開關
    document.getElementById('toggleGuide').addEventListener('click',()=>{
      const el=document.getElementById('guide');
      el.style.display=(el.style.display==='block')?'none':'block';
    });

    // 產生名條（必須含標題列）
    function generateNamecards(){
      const line1El=document.getElementById('line1');
      const line2El=document.getElementById('line2');
      const line1=(line1El.value||'').trim() || line1El.defaultValue || line1El.placeholder || '';
      const line2=(line2El.value||'').trim() || line2El.defaultValue || line2El.placeholder || '';
      const raw =document.getElementById('rawData').value;
      const output=document.getElementById('output');

      output.innerHTML='';
      if(!raw || !raw.trim()){ alert('請先貼上資料（需含標題列）。'); return; }

      // 使用：TSV 解析器（尊重引號＋欄內換行）
      const rows = parseTsvRespectingQuotes(raw);
      if(rows.length < 2){ alert('內容不足，請確認包含標題列與至少一筆資料。'); return; }

      // 只依標題列判斷欄位
      const header = rows[0].map(normalizeHeader);
      const idxClass = header.findIndex(h => h === '班級');
      const nameCandidates = new Set(['姓名','學生','學生姓名','中文姓名','中文姓名英文姓名']);
      let idxName = -1;
      for(let i=0;i<header.length;i++){ if(nameCandidates.has(header[i])){ idxName=i; break; } }

      if(idxClass < 0){ alert('找不到「班級」欄位，請確認標題列名稱為「班級」。'); return; }
      if(idxName < 0){ alert('找不到姓名欄位，請使用「姓名／學生／學生姓名／中文姓名／中文姓名英文姓名」。'); return; }

      const parsed = [];
      for(let r=1;r<rows.length;r++){
        const cells = rows[r];
        if(!cells || cells.length===0) continue;
        const className = (cells[idxClass] ?? '').trim();
        const rawName   = (cells[idxName]  ?? '').trim();
        const nameZh    = extractZh(rawName);
        if(className && nameZh) parsed.push({ className, nameZh });
      }
      if(parsed.length===0){ alert('標題已找到，但資料列未能擷取到有效的班級與中文姓名。'); return; }

      // 繪製
      let page=createNewPage(); output.appendChild(page);
      parsed.forEach((item,idx)=>{
        const card=document.createElement('div');
        card.className='namecard';
        card.innerHTML = `
          <div class="line1">${escapeHtml(line1)}</div>
          <div class="line2">${escapeHtml(line2)}</div>
          <div class="class">${escapeHtml(item.className)}</div>
          <div class="name-row">
            <img class="logo" src="https://github.com/zh22331997/salary-calculator/blob/main/2019%20zh%20logo.png?raw=true" alt="logo">
            <div class="name">${escapeHtml(item.nameZh)}</div>
          </div>`;
        page.appendChild(card);
        if((idx+1)%21===0 && (idx+1)!==parsed.length){
          page=createNewPage(); output.appendChild(page);
        }
      });

      document.getElementById('printBtn').style.display='inline-block';
      // 捲到結果區
      output.scrollIntoView({behavior:'smooth',block:'start'});
    }

    function clearAll(){
      document.getElementById('line1').value='';
      document.getElementById('line2').value='';
      document.getElementById('rawData').value='';
      document.getElementById('output').innerHTML='';
      document.getElementById('printBtn').style.display='none';
    }

    function createNewPage(){
      const div=document.createElement('div');
      div.className='output-page';
      return div;
    }

    /* ===== TSV 解析器（尊重引號與欄內換行） =====
       - 欄分隔：\t（Excel 貼上即為 Tab）
       - 欄位可被 " 包住；欄內可以含換行、Tab，會被保留在同一格
       - 連續兩個 "" 代表字面上的 "
    */
    function parseTsvRespectingQuotes(text){
      const rows=[]; let row=[]; let cell='';
      let inQuotes=false;

      for(let i=0;i<text.length;i++){
        const ch=text[i], next=text[i+1];

        if(ch === '"'){
          if(next === '"'){ cell+='"'; i++; } // 轉義的雙引號
          else { inQuotes = !inQuotes; }
          continue;
        }

        if(ch === '\t' && !inQuotes){ // 分欄
          row.push(cell); cell=''; continue;
        }

        if((ch === '\n' || ch === '\r') && !inQuotes){ // 分列
          if(ch === '\r' && next === '\n') i++; // CRLF
          row.push(cell); cell='';
          // 若整列都是空白就跳過
          if(row.some(c => (c && c.trim().length))) rows.push(row);
          row = [];
          continue;
        }

        // 其他字元（包含欄內換行）
        cell += ch;
      }
      // 收尾
      row.push(cell);
      if(row.some(c => (c && c.trim().length))) rows.push(row);

      // 去除每格外圍空白
      for(let r=0;r<rows.length;r++){
        rows[r] = rows[r].map(c => (c ?? '').replace(/\r?\n/g,' ').trim());
      }
      return rows;
    }

    // 標題正規化：去換行、引號、空白、全形空白、括號、點號，轉小寫
    function normalizeHeader(h){
      return (h||'')
        .toLowerCase()
        .replace(/\r?\n/g,'')
        .replace(/["']/g,'')
        .replace(/\s+/g,'')
        .replace(/　+/g,'')
        .replace(/[()（）]/g,'')
        .replace(/\./g,'');
    }

    // 只取中文字（保留常見連字）
    function extractZh(text){
      const m = (text||'').match(/[\u4E00-\u9FFF·．・‧－—\-\s]+/g);
      if(!m) return '';
      return m.join('').replace(/\s+/g,'').replace(/[．・‧－—-]/g,'').trim();
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
  </script>
</body>
</html>
